<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for Windows (x86-64) 2018.1 (Build 184U)" ts="2020-01-26 21:40:55">
<Class name="App.Action">
<Description>
Withdraw the necessary actions</Description>
<ClassType/>
<IncludeCode>App.LogMacro</IncludeCode>
<ProcedureBlock>1</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeChanged>65393,37468.086824</TimeChanged>
<TimeCreated>64746,75062.988786</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Method name="GetParam">
<Description>
s par=##class(App.Action).GetParam(.%request,"ns",param)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>req,paramName,param</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 if $d(req) { q $tr(req.Get(paramName),"#")
 }
 else { set val=$p($p(param,("&"_paramName_"="),2),"&",1)
 }
]]></Implementation>
</Method>

<Method name="OnPage">
<Description>
Main method generate the content of page</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>param</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set $zt="Err"
 	#dim %request as %CSP.Request

	if '$d(%request) {
		d ##class(App.type).ParseURL(param,.appPar,"&")
		if $g(appPar("appAct"))'="" {
			d ..RunMethod($p(appPar,":",1),$p(appPar,":",2),$p(appPar,":",3),.appPar)
			q $$$OK
		}
		if $g(appPar("appClass"))'="" {
			d ..RunMethod($g(appPar("appNsp")),$g(appPar("appClass")),$g(appPar("appMethod")),.appPar)
			q $$$OK
		}
		
		q $$$OK
	}

 	;set $$$AppL("MSW","req")=$$$AppObJs(%request)
 	;merge $$$AppL("MSW","%request.Data")=%request.Data
	;set $$$AppL("MSW","%request.AppData")=%request.AppData

 	if %request.Get("appAct")'="" { ;AppAct=NameSpace:Packet.ClassName:Method:@Par1=Val1@Par2=Val2...
 		set appPar=$p(%request.Get("appAct"),"AppAct=",2,*)
		set i=""
		for { set i=$o(%request.Data(i)) quit:i=""
			set:$o(%request.Data(i,""),-1)'="" appPar("%request.Data",i)=$g(%request.Data(i,$o(%request.Data(i,""),-1)))
		}
		d ..RunMethod($p(appPar,":",1),$p(appPar,":",2),$p(appPar,":",3),.appPar)
		q $$$OK
 	} else {
	 	set appNsp=%request.Get("appNsp")
		set appMethod=%request.Get("appMethod")
		set appClass=%request.Get("appClass")
		set appPar=%request.Get("appPar")
		set appJson=%request.Get("appJson")
		set i=""
		for { set i=$o(%request.Data(i)) quit:i=""
			if i["appNsp",appNsp="" s appNsp=$g(%request.Data(i,$o(%request.Data(i,""),-1)))
			if i["appMethod",appMethod="" s appMethod=$g(%request.Data(i,$o(%request.Data(i,""),-1)))
			if i["appClass",appClass="" s appClass=$g(%request.Data(i,$o(%request.Data(i,""),-1)))
			if i["appPar",appPar="" s appPar=$g(%request.Data(i,$o(%request.Data(i,""),-1)))
			if i["appJson" s appJson=$g(%request.Data(i,$o(%request.Data(i,""),-1)))
			set:$o(%request.Data(i,""),-1)'="" appPar("%request.Data",i)=$g(%request.Data(i,$o(%request.Data(i,""),-1)))
		}
		;if appNsp'="" try {zn appNsp set NSpace=appNsp } catch e {}
		;set NSpace=$zu(5)

	 	if $isobject(%request.Content) { 
		 	set stream=%request.Content
			set sc=##class(App.files).Stream2String(%request.Content,.str)
			if 'sc quit sc
		 	if $g(str)["{" d ..ParseJson(.str,.appClass,.appMethod,.appPar) ;m appPar("%request.Content")=str  m appPar("%request")=$$$AppObJs(%request)
		 	;merge $$$AppL("MSW","Content")=str
	 	}
	  	i $g(appJson)["{" d ..ParseJson(.appJson,.appClass,.appMethod,.appPar) ;m appPar("%request")=$$$AppObJs(%request)
  	}
 	
	if appMethod="" {
		$$$jsstart
 		write "alert('"_$$$aText("The appMethod parameter is empty","")_"');"
 		$$$jsstop
		quit $$$OK
	}
	elseif appMethod="ShowJson" {
		if appNsp'="" try {zn appNsp set NSpace=appNsp } catch e {}
		d ..ShowJson(appPar)
	}
	elseif appMethod="ShowXML" {
		if appNsp'="" try {zn appNsp set NSpace=appNsp } catch e {}
		d ..ShowXML(appPar)
	}
	else {
		d ..RunMethod(appNsp,appClass,appMethod,.appPar)
	}
	
	quit $$$OK
Err 
	write $zconvert($ze,"O","HTML")
	quit $$$OK
]]></Implementation>
</Method>

<Method name="RunMethod">
<Description>
To execute the method</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>appNsp,appClass,appMethod,appPar</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	if appNsp'="" try {zn appNsp set NSpace=appNsp } catch e {}
	set NSpace=$zu(5)
		set:appClass="" appClass="App.Action"
		if $e(appPar,1)="{" {
			;Parse json TODO
		}
		elseif appPar["~" {
			do ##class(App.type).ParseURL(appPar,.appPar,"~")  ;parse in array
		}
		elseif appPar["&" {
			d ##class(App.type).ParseURL(appPar,.appPar,"&")
		}
		Do $CLASSMETHOD(appClass,appMethod,.appPar)
]]></Implementation>
</Method>

<Method name="ShowJson">
<Description>
Show a formatted json </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>appPar,json</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set gn=$zconvert(appPar,"I","URL")
	try {
		write "<h3>"_gn_" in NameSpace :"_$zu(5)_"</h3>"
		if '$d(@gn) w $$$appError("Global node does not exist") q
		write "<pre>" write $g(@gn) write "</pre>" 
	} catch e { w $ze }
	quit $$$OK
]]></Implementation>
</Method>

<Method name="ShowXML">
<Description>
Show formatted XNL</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>appPar,json</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set gn=$zconvert(appPar,"I","URL")
	try {
		write "<h3>"_gn_" in NameSpace "_$zu(5)_"</h3>"
		if '$d(@gn) w $$$appError("Global node does not exist") q
		write $zconvert($g(@gn),"O","HTML")
	} catch e { write $ze }
	quit $$$OK
]]></Implementation>
</Method>

<Method name="Test">
<Description>
To disassemble the drain to Json</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>appPar,json</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	write "ClassMethod Test."
	zwrite appPar
	quit $$$OK
]]></Implementation>
</Method>

<Method name="ParseJson">
<Description>
To disassemble the drain to Json</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>jsonStr,appClass,appMethod,appPar</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 try {
	set appClass={}.$$$jsonFromJSON(jsonStr).appClass
	set appMethod={}.$$$jsonFromJSON(jsonStr).appMethod
	set appPar={}.$$$jsonFromJSON(jsonStr).appPar
	set appPar("jsonStr")=jsonStr
	}
 catch e { 
 	write $zconvert($ze,"O","HTML")
 }
 quit $$$OK
]]></Implementation>
</Method>

<Method name="WriteWinOpenREST">
<Description>
Write Action Js 
w ##class(App.Action).WriteWinOpenREST(%request)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>req</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  	if req.URL[(req.Application_"get-html")||(req.URL[(req.Application_"post-json")) { //is static content
  		q req.Application_"post-json"
  	} else {
  		q ""
  	}
]]></Implementation>
</Method>

<Method name="WriteAppAct">
<Description>
Write Action Js 
w ##class(App.Action).WriteActJs(%request,pref_"MainForm",mhead,..%ClassName(1),pref_"FirstHead",key)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>req,fornId,resultDivId,ns,classname,method,CGIVar=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
  	;s $$$AppL("MML","%request-WriteActJs-")=$$$AppObJs(req)
  	set:CGIVar'["'" CGIVar=CGIVar_"'"
  	if req.URL[(req.Application_"get-html")||(req.URL[(req.Application_"post-json")) { //is static content
  		q "AppRpc('"_fornId_"','"_resultDivId_"','"_$zu(5)_":"_classname_":"_method_":"_CGIVar_",'"_req.Application_"post-json');"
  	} else {
	  	q "AppAct('"_fornId_"','"_resultDivId_"','AppAct="_ns_":"_classname_":"_method_":"_CGIVar_");"
  		
  	}
	quit ""
]]></Implementation>
</Method>

<Method name="WriteActJs">
<Description>
Write Action Js 
w ##class(App.Action).WriteActJs(%request,pref_"MainForm",mhead,..%ClassName(1),pref_"FirstHead",key)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>req,fornId,resultDivId,classname,method,CGIVar=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
  	;s $$$AppL("MML","%request-WriteActJs-")=$$$AppObJs(req)
  	set:CGIVar'["'" CGIVar=CGIVar_"'"
  	if req.URL[(req.Application_"get-html")||(req.URL[(req.Application_"post-json")) { //is static content
  		q "AppRpc('"_fornId_"','"_resultDivId_"','"_$zu(5)_":"_classname_":"_method_":"_CGIVar_",'"_req.Application_"post-json');"
  	} else {
  		q "ActionJs('"_fornId_"','"_resultDivId_"','','"_method_"','"_CGIVar_");"
  	}
	quit ""
]]></Implementation>
</Method>

<Method name="GetElemParseForm">
<Description>
Write Action Js 
w ##class(App.Action).GetElemParseForm(form,.Par,pref_"text")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>form,Par,divIdname,convert=1</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 i form'="" {
	s aray=[].$$$jsonFromJSON(form)
	for i=0:1:aray.$$$jsonSize()-1 {
		set item = aray.$$$jsonGet(i)
		i $isobject(item) {
			;s $$$AppL("MML","%request-GetElemForm-item")=$zconvert(item.value,"I","UTF8")
			s value=item.value
			if convert s value=$zconvert(item.value,"I","UTF8")
			;if item.name=divIdname set val=value
			s:item.name'="" Par("%request.Data",item.name)=value
		}
	}
 }
 q $$$OK
]]></Implementation>
</Method>

<Method name="GetElemForm">
<Description>
Write Action Js 
w ##class(App.Action).GetElemForm(%request,.Par,pref_"text")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>req,Par,divIdname</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
  	;s $$$AppL("MML","%request-GetElemForm-")=$$$AppObJs(req)
	;s $$$AppL("MML","%request.Cont")=$$$AppObJs(req.Content)

  	if req.URL[(req.Application_"get-html")||(req.URL[(req.Application_"post-json")) {
  		if $isobject(req.Content) {
	  		set stream=req.Content
			set sc=##class(App.files).Stream2String(req.Content,.str)
			if 'sc quit sc
			;s $$$AppL("MML","%request.str")=str
			if $g(str)["{" {
				s form={}.$$$jsonFromJSON(str).params.form
   				;s $$$AppL("MML","%request-GetElemForm-aray")=form
				d ..GetElemParseForm(form,.Par,divIdname)
			}
		 	;merge $$$AppL("MSW","Content")=str
  			;s val=req.Content.$$$jsonGet(name)
  		}
  	} else {	
  	}
	quit $g(Par("%request.Data",divIdname))
]]></Implementation>
</Method>
</Class>


<Class name="App.AutoPage">
<Description>
Updated at 12/08/2017 16:19:10</Description>
<Super>%CSP.Util.AutoPage</Super>
<TimeChanged>65316,58993.352192</TimeChanged>
<TimeCreated>64621,43886.94639</TimeCreated>

<Parameter name="DOMAIN">
<Description>
Default Localization Domain</Description>
<Default>portalutils</Default>
</Parameter>

<Parameter name="ERRORPAGE">
<Description>
Specify a custom error page to call if there are any problems with generating this page.
If this is not specified it will use the default error page specified for this CSP
application, and if this is not specified it will use the system default error page.
For example this could be set to '/csp/samples/error.csp' to display the sample error
page.</Description>
<Default>App.errorpage.cls</Default>
</Parameter>

<Parameter name="STYLESHEET">
<Description>
Name of the external style sheet file</Description>
<Default>intersystems.css</Default>
</Parameter>

<Method name="OnCompile">
<Internal>1</Internal>
<ClassMethod>1</ClassMethod>
<CodeMode>generator</CodeMode>
<ServerOnly>1</ServerOnly>
<Implementation><![CDATA[
	s tSC=$$$OK
	// Skip the test if the compiled template class
	s isTemplate=%class="App.AutoPage"
	q:isTemplate $$$OK
	
	s cspurl=%class_".cls"
	s pvalue=$$$comMemberKeyGet(%class,$$$cCLASSparameter,"CSPURL",$$$cPARAMdefault)
	i (pvalue'=cspurl) {
		$$$defMemberKeySet(%class,$$$cCLASSparameter,"CSPURL",$$$cPARAMdefault,cspurl)
		s updateClass=##class("%Dictionary.ClassDefinition").%OpenId(%class)
		s updateClass.Modified=0
		d updateClass.%Save()
		d updateClass.%Close()
 	}

	f param="PAGENAME","PARENTPAGE" {
		s pvalue=$$$comMemberKeyGet(%class,$$$cCLASSparameter,param,$$$cPARAMdefault)
		i (pvalue="") {
			$$$defMemberKeySet(%class,$$$cCLASSparameter,param,$$$cPARAMdefault," ")
			s updateClass=##class("%Dictionary.ClassDefinition").%OpenId(%class)
			s updateClass.Modified=0
			d updateClass.%Save()
			d updateClass.%Close()
	 	}
	}
	q tSC
]]></Implementation>
</Method>

<Method name="GetTitlePane">
<ClassMethod>1</ClassMethod>
<CodeMode>objectgenerator</CodeMode>
<FormalSpec>pInstance:%CSP.Util.PageInstance</FormalSpec>
<ReturnType>%CSP.Util.Pane</ReturnType>
<Implementation><![CDATA[
	Do %code.WriteLine(" Set tPane = ##class(%CSP.Util.SMTitlePane).%New()")
	Do %code.WriteLine(" Set tPane.Text =  $$$Text("""_$G(%parameter("PAGENAME"),"N/A")_""")")
	Do %code.WriteLine(" Quit tPane")
	q $$$OK
]]></Implementation>
</Method>

<Method name="GetDetailPane">
<Description>
Get the detail pane info object</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pInstance:%CSP.Util.PageInstance</FormalSpec>
<ReturnType>%CSP.Util.Pane</ReturnType>
<Implementation><![CDATA[
	Set tDetailPane = ""
	Quit tDetailPane
]]></Implementation>
</Method>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	Quit ..DrawHTML()
]]></Implementation>
</Method>
</Class>


<Class name="App.Chart">
<Super>App.AutoPage</Super>
<TimeChanged>65308,60542.541507</TimeChanged>
<TimeCreated>64985,34590.862384</TimeCreated>

<Parameter name="CSPURL">
<Default>App.Chart.cls</Default>
</Parameter>

<Parameter name="PAGENAME">
<Expression>"Chart"</Expression>
</Parameter>

<Parameter name="PARENTPAGE">
<Default>App.AutoPage.cls</Default>
</Parameter>

<Method name="GetDetailPane">
<Description>
Get the detail pane info object</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pInstance:%CSP.Util.PageInstance</FormalSpec>
<ReturnType>%CSP.Util.Pane</ReturnType>
<Implementation><![CDATA[	quit ##class(App.ChartPanel).%New()
]]></Implementation>
</Method>
</Class>


<Class name="App.ChartPanel">
<IncludeCode>App.LogMacro</IncludeCode>
<Super>App.LogInfoPane</Super>
<TimeChanged>65315,28952</TimeChanged>
<TimeCreated>64985,34799.861897</TimeCreated>

<Method name="DrawBODY">
<Description>
Drawing graphs</Description>
<FormalSpec>pInstance:PageInstance</FormalSpec>
<PublicList>nsp,what,field,value,type,typeclass,caption</PublicList>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 	write ##class(App.LogInfoPane).AddJsScripts("chart")
	set $ZT="errors"
	set nsp=%request.Get("NSP")
	if nsp'="" try {zn nsp set NSpace=nsp } catch e {}
	set NSpace=$zu(5)

	s arg("header")="Error"
	s arg("labels")="[""Error""]"
	s arg("type")="bar" ;line
	s arg("datasets")="{   label: """_$$$aText("Error display on the graph","")_""", borderColor: 'rgb(255, 199, 132)',  data: [30],  }"

	s days=1000
	i %request.Get("days") S days=%request.Get("days")
	
	if %request.Get("panel")'="" {
		s class=$p($p(%request.Get("panel"),"(",2),")"),method=$p($p(%request.Get("panel"),")",2),".",2)
		s st=$classmethod(class,method,.arg,days)
	}
	&html< <canvas id="Chart"></canvas>
	>
	$$$jsstart
 	w "var ctx = document.getElementById('Chart').getContext('2d');"
 	w "var chart = new Chart(ctx, {   type: '"_$g(arg("type"),"bar")_"',"
    // The data for our dataset
    w "data: {  labels: "_$g(arg("labels"))_","   // ["January", "February", "March", "April", "May", "June", "July"],
    w "   datasets: ["_$g(arg("datasets"))
    w " ] },  options: {    hover: { mode: 'index' }, tooltips: { mode: 'index' }	, title: { display: true, text: '"_$tr($g(arg("header")),"'""")_"'  }    } });"
	$$$jsstop
	quit $$$OK
errors
 	write !,$ze
 	quit $$$OK
]]></Implementation>
</Method>

<Method name="ColorRGBa">
<Description>
d ##class(App.ChartPanel).ColorRGBa(32,0.2)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>num,alfa=1</FormalSpec>
<Implementation><![CDATA[
 
	s c=$e(+num,*)
	;i +num>9 
	;the same light alfa=1 because the opacity: 100% *
	i c=0 q "rgba(255, 0, 0, "_alfa_")" ;pure red
	i c=1 q "rgba(255, 99, 132, "_alfa_")" ;red
    i c=2 q "rgba(255, 159, 64, "_alfa_")" ;orange
    i c=3 q "rgba(255, 206, 86, "_alfa_")" ;yellow
    i c=4 q "rgba(0, 255, 0, "_alfa_")" ;pure green
    i c=5 q "rgba(75, 192, 192, "_alfa_")" ;green
    i c=6 q "rgba(12, 164, 240, "_alfa_");" ;blue
    i c=7 q "rgba(0, 0, 255, "_alfa_")" ;clear blue
    i c=8 q "rgba(54, 162, 235, "_alfa_")" ;blue
    i c=9 q "rgba(153, 102, 255, "_alfa_")" ;purple
]]></Implementation>
</Method>

<Method name="FinishArg">
<Description>
Complete the chart objects</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>res,data,labels,arg</FormalSpec>
<Implementation><![CDATA[
	s datasets=""
	s a="" f num=1:1 { s a=$o(res(a)) q:a=""
		s data(a)=$e(data(a),1,*-1)_"], }"
		s datasets=datasets_data(a)_","
	}
	s datasets=$e(datasets,1,*-1)
	s labels=$e(labels,1,*-1)_"]"
	s arg("datasets")=datasets
	s arg("labels")=labels
	q 1
]]></Implementation>
</Method>

<Method name="ChartLicUsed">
<Description>
Dynamics of consumption of license on the basis of regular job 
with legacy method: s st=##class(App.sys).SaveQuery("%SYSTEM.License:Counts")
d ##class(App.ChartPanel).ChartLicUsed(.arg,1200,.res)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>arg,days,res,gn="^%App.Task"</FormalSpec>
<Implementation><![CDATA[
 s par=$p(days,",",2,999)
 s days=+days
 s ToDay=$zd($h,3),FromDay=$zd($h-days,3)
 s arg("header")=$$$aText("The dynamics of license spending based on a regular job in a date range ","")_FromDay_" - "_ToDay
 s arg("type")="line"
 s GN=$na(@gn@("%SYSTEM.License:Counts"))
 s dt=""
 f i=1:1:10 { s dt=$o(@GN@(dt),1) q:dt=""
 	w !,dt," ",$g(@GN@(dt,4,2))
 }
]]></Implementation>
</Method>

<Method name="ChartAlert">
<Description>
Search in the Protocol cconsole.log important events
d ##class(App.ChartPanel).ChartAlert(.arg,1200,.res)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>arg,days,res,list,mm</FormalSpec>
<Implementation><![CDATA[
 	s method="class(App.files).Alert" 
	d ##class(App.files).FindContextInLog(days,method,.res) // to parse a Protocol to calculate important events
	s df=$p(res," ",1)
	s dt=$p(res," ",2)
	s arg("header")=$$$aText("Important system events in the date range ","")_df_" - "_dt
	s arg("type")="line"
	s labels="["
	f yyyy=$p(df,".",3):1:$p(dt,".",3) {
		for m=1:1:12 {
			i yyyy=$p(df,".",3),m<$p(df,".",2)  continue
			i yyyy=$p(dt,".",3),m>$p(dt,".",2)  continue
			i m?1n s mm="0"_m
			e  s mm=m
			s labels=labels_""""_##class(App.type).GetTextMonth(mm)_"."_yyyy_""","
			s a="" f num=1:1 { s a=$o(res(a)) q:a=""
				i '$d(color(a)) s color(a)=num
				i '$d(data(a)) s data(a)="{  label: """_a_""", borderColor: '"_..ColorRGBa(color(a),1)_"',  data: ["
				s data(a)=data(a)_+$g(res(a,yyyy,mm))_","
			}

		}
	}
 d ..FinishArg(.res, .data, .labels, .arg)
 q $$$OK
]]></Implementation>
</Method>

<Method name="ChartDbSize">
<Description>
Retrospective database sizes
d ##class(App.ChartPanel).ChartDbSize(.arg,1200,.res,.list,.mm)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>arg,days,res,list,mm</FormalSpec>
<Implementation><![CDATA[
	s method="class(App.files).ExpansionDB" 
	d ##class(App.files).FindContextInLog(days,method,.res) //to disassemble the Protocol to calculate the monthly growth of the database in megabytes
	d ##class(App.RestMetrics).getDBsize("dbsize",.list) //to calculate the current database size in gigabytes
	//let's go back in time taking masany growth
	s df=$p(res," ",1)
	s dt=$p(res," ",2)
	s arg("header")=$$$aText("Dynamics of database growth in the date range ","")_df_" - "_dt
	s arg("type")="line"
	s labels="["
	s datasets="{  label: """_$$$aText("Error display on the graph","")_""", borderColor: '"_..ColorRGBa(0,1)_"',  data: [30],  }"
	s bd="",(max,free,maxbd)=0
	f num=1:1 { s bd=$o(list(bd)) q:bd=""  
		s list(bd)=list(bd)*1024
		i list(bd)>max s max=list(bd),free=list(bd,"free")*1024,maxbd=list(bd,"name")
		s order(list(bd))=bd //Rangiroa size
		s color(bd)=num
	}
	s list("free","name")="Disk Free Size + "_$g(maxbd)
	s list("free")=max+free
	s order(max+free)="free"
	s color("free")=0
	;zw order	zw list
	//translate into megabytes
	s mm=$p(dt,".",2)
	f yyyy=$p(dt,".",3):-1:$p(df,".",3) {
		for {
			i mm?1n s mm="0"_mm
			;w !,yyyy,"-",mm
			s bd=""	f { s bd=$o(list(bd)) q:bd=""   continue:bd="total"
				s mm(yyyy,mm,bd)=list(bd) ;,1,2) ;the current size of the gig
				i $d(res(bd,yyyy,mm)) {
					s list(bd)=list(bd)-($g(res(bd,yyyy,mm))) //subtract monthly increase in moving Gigi
					i list(bd)<0 s list(bd)=0
				}
			}
			s mm=mm-1
			i mm<1 s mm=12 q
			i yyyy=$p(df,".",3),mm<$p(df,".",2) q

		}
	}
	s yyyy="" f { s yyyy=$o(mm(yyyy)) q:yyyy=""
		f mon=1:1:12 { 
			s mm=mon i mm?1n s mm="0"_mm
			continue:'$d(mm(yyyy,mm))
			s labels=labels_""""_##class(App.type).GetTextMonth(mm)_"."_yyyy_""","
			s bd2="" f { s bd2=$o(order(bd2),-1,bd) q:bd2=""
				i '$d(data(bd)) s data(bd)="{  label: """_list(bd,"name")_""", borderColor: '"_..ColorRGBa(color(bd),1)_"',  data: ["
				s data(bd)=data(bd)_$g(mm(yyyy,mm,bd))_","
			}
		}
	}
	s datasets=""
	s bd2="" f { s bd2=$o(order(bd2),-1,bd) q:bd2=""
		s data(bd)=$e(data(bd),1,*-1)_"], }"
		s datasets=datasets_data(bd)_","
	}
	s datasets=$e(datasets,1,*-1)
	s labels=$e(labels,1,*-1)_"]"
	s arg("datasets")=datasets
	s arg("labels")=labels
	q 1
]]></Implementation>
</Method>

<Method name="ChartEnsUtilLog">
<Description>
Plot the error of the ensemble Protocol Ens_Util.Log where Type='2' </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>arg,days,res,list</FormalSpec>
<Implementation><![CDATA[
 s ns=$p(days,",",2,999)
 s days=+days
 s ToDay=$zd($h,3),FromDay=$zd($h-days,3)
 s sql="select Convert(VarChar,TimeLogged, 103) as days,count(*) as erro from Ens_Util.Log where Type='2' and TimeLogged>'"_FromDay_"' and TimeLogged<'"_ToDay_"' and (Text not like '%ErrFTP%' and Text not like '%"_$$$aText("Not implemented","")_"%' and text not like '%"_$$$aText("The key is not defined uniquely","")_"%' and text not like '%Could not get%') group by Convert(VarChar,TimeLogged, 103)"
 f i=1:1:$l(ns,",") {
	 s nspace=$p(ns,",",i)
	 continue:nspace=""
	 $$$NspGoto(curNs,nspace)
	 i nspace=$zu(5) {
		s gn="^||tmpCount" ;_$tr(nspace,"-")
		;w "<br>"_gn
		s res(nspace)=""
		d ##class(App.sys).SaveSQL(sql,gn)
		f ii=1:1 {  q:'$d(@gn@(ii))
			s count=+$lg($g(@gn@(ii)),2)
			s dat=$lg($g(@gn@(ii)),1)
			s dd=$p(dat,"/",1),mm=$p(dat,"/",2)
			s res(nspace,$p(dat,"/",3)_"-"_mm_"-"_dd)=count
		}
	 }
	 $$$NspReturn(curNs)
 }
 s arg("header")=$$$aText("Number of Ens_Util errors.Log in date range","")_FromDay_" - "_ToDay
 s arg("type")="line"
 s labels="["
 for day=$h-days:1:+$h {
	s labels=labels_""""_$zd(day,3)_""","
	s a="" f num=1:1 { s a=$o(res(a)) q:a=""
		i '$d(color(a)) s color(a)=num
		i '$d(data(a)) s data(a)="{  label: """_a_""", borderColor: '"_..ColorRGBa(color(a),1)_"',  data: ["
		s data(a)=data(a)_+$g(res(a,$zd(day,3)))_","
	}
 }
 d ..FinishArg(.res, .data, .labels, .arg)
 q 1
]]></Implementation>
</Method>
</Class>


<Class name="App.DownloadCSP">
<IncludeCode>App.LogMacro</IncludeCode>
<Super>%CSP.Page</Super>
<TimeChanged>65322,31001.107873</TimeChanged>
<TimeCreated>60726,81968.378213</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Method name="OnPreHTTP">
<Description><![CDATA[
Event handler for <b>PreHTTP</b> event: this is invoked before
the HTTP headers for a CSP page have been sent.  All changes to the
<class>%CSP.Response</class> class, such as adding cookies, HTTP headers,
setting the content type etc. must be made from within the OnPreHTTP() method.
Also changes to the state of the CSP application such as changing
%session.EndSession or %session.AppTimeout must be made within the OnPreHTTP() method.
It is prefered that changes to %session.Preserve are also made in the OnPreHTTP() method
as this is more efficient, although it is supported in any section of the page.
Return <b>0</b> to prevent <method>OnPage</method> from being called.]]></Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<ServerOnly>1</ServerOnly>
<Implementation><![CDATA[
	if %request.Get("fileName")'="" {
		s file=%request.Get("fileName")
	}
	elseif %request.Get("fileId")'="" {
		s file=..GetfileName(%request.Get("fileId"),,.origname)
	}
	elseif %request.Get("Id")'="" {
		s file=..GetfileName(%request.Get("Id"),,.origname)
	}
	if file="" {set fileName=$$$aText("Link already invalid","")}
	else {set fileName = $p(file,$$$slash,*)}
	s %response.ContentType="application/force-download"
	;s %response.CharSet="windows-1251"
	d %response.SetHeader("Expires", "0")
	;d %response.SetHeader("Accept-Ranges","bytes")
	set f=##class(%File).%New()
 	s size=f.GetFileSize(file)
	d %response.SetHeader("Content-Length",size)
	set name=fileName
	if origname'="" set name=origname
	set name=$ZCVT($ZCVT(name,"O","UTF8"),"O","URL")
	d %response.SetHeader("Content-Disposition","attachment;filename="_name)
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPage">
<Description><![CDATA[
Event handler for <b>PAGE</b> event: this is invoked in order to  
generate the content of a csp page.
w "<a title=""Save this file to disk"" href=""App.DownloadCSP.cls?fileId=221212"">"]]></Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<ServerOnly>1</ServerOnly>
<Implementation><![CDATA[
	if %request.Get("fileName")'="" {
		s file=%request.Get("fileName")
	}
	elseif %request.Get("fileId")'="" {
		set fileId=%request.Get("fileId")
		s file=..GetfileName(fileId)
		d ..DeleteFileId(fileId)
	}
	elseif %request.Get("Id")'="" {
		set fileId=%request.Get("Id")
		s file=..GetfileName(fileId)
	}
	
	set stream=##class(%FileBinaryStream).%New()
	set stream.Filename=file
	while 'stream.AtEnd {
		set line=stream.Read()
		write line
	}
	
	/*
	#dim f As %File
	set f=##class(%File).%New(file)
 	set ok=f.Open("RS")     
 	if 'ok do f.%Close() Q ok
 	;set len=$zu(140,1,file)
 	d f.Rewind()
 	while 'f.AtEnd {
    	Write f.Read($$$MaxLocalLength)
	}
 	do f.%Close()
 	*/
 	if %request.Get("log")'="" {
 		try {
 			Do $classmethod(%request.Get("log"),"AddRecord","App.DownloadCSP","OnPage",$st($st(-1),"PLACE"),"INFO",file,"DownLoad")
 		} catch e {}
 	}
     Quit $$$OK
]]></Implementation>
</Method>

<Method name="GetGN">
<Description>
To global link</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	quit $na(^CacheTemp.App.tmpDownloadCSP(+$h)) ;global should be available from any region
]]></Implementation>
</Method>

<Method name="DeleteFileId">
<Description>
Remove the ID for download</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>FileId,gn=..GetGN()</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	KILL @gn@(FileId)
	quit $$$OK
]]></Implementation>
</Method>

<Method name="GetfileName">
<Description>
To obtain the full name of the file ID for download</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>FileId,gn=..GetGN(),origname=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if '$d(@gn@(FileId)) quit ""
	set origname=$g(@gn@(FileId,"origname"))
	if $g(@gn@(FileId))'=""	quit $g(@gn@(FileId))
	quit ""
]]></Implementation>
</Method>

<Method name="GetFileId">
<Description><![CDATA[
To ID to download the file
if ##class(App.DownloadCSP).GetFileId(fileName,.url) { set fn="<a href='"_url_"'>DownLoad</a>"	}
cgivar="Id" to send a file during the day
cgivar="fileId" give the file only once
cgivar="fileName" to send a file via the full path (insecure)]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[FileName,&URL,&id,cgivar="Id",gn=..GetGN()]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set URL=""
	set st=$$$OK
	set origname=$p(FileName,"*",2)
	set FileName=$p(FileName,"*",1)
	TRY {
		set f=##class(%File).%New(FileName)
 		set st=f.Open("RS")     
 		if 'st do f.%Close() Q
 		if cgivar="fileName" {
	 		s id=FileName
	 	} else {
 			set id=$r(+$h)_$zcrc(7,FileName)_$r(+$h)
 			set @gn@(id)=FileName
 			set @gn@(id,"origname")=origname
	 	}
 		set URL=..%ClassName(1)_".cls?"_cgivar_"="_id
	} catch (e) {  
		s st=$System.Status.GetErrorText(e) 
	}
 	quit st
]]></Implementation>
</Method>
</Class>


<Class name="App.Form">
<Description>
The representation of the stored classes for viewing and editing</Description>
<Abstract>1</Abstract>
<IncludeCode>App.LogMacro</IncludeCode>
<TimeChanged>65394,57516.733481</TimeChanged>
<TimeCreated>64751,31992.250217</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Parameter name="PREFIXFIELD">
<Description>
prefix the field name of the object</Description>
<Default>appfield</Default>
</Parameter>

<Method name="GetSubclassOf">
<Description>
To get all descendants for a class</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>super="App.Form"</FormalSpec>
<Implementation><![CDATA[
 set query=##class(%Library.ResultSet).%New("%Dictionary.ClassDefinition:SubclassOf")
 set st=query.Execute(super)
 Q query
]]></Implementation>
</Method>

<Method name="GetJsonProp">
<Description>
To obtain the extended properties of the field object</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>obj,propName,gn,out</FormalSpec>
<Implementation><![CDATA[
	set out("description")=..GetPropVal(obj,propName,.gn,"Description")
	set out("inputtype")=""
	if out("description")["{" {
		set json="{"_$p(out("description"),"{",2,*)
		try {
			;2017 set title={}.%FromJSON(json).title 
			;2016.1 set title={}.$fromJSON(json).title
			set out("title")={}.$$$jsonFromJSON(json).title
			set out("inputtype")={}.$$$jsonFromJSON(json).inputtype
			set out("displayname")={}.$$$jsonFromJSON(json).displayname
			set out("inputpattern")={}.$$$jsonFromJSON(json).inputpattern
			if $g(out("inputpattern"))="autocomplete" {
				s out("autocompleteMethod")={}.$$$jsonFromJSON(json).autocompleteMethod
			}
			elseif $g(out("inputpattern"))="files" {
				s out("filesMethod")={}.$$$jsonFromJSON(json).filesMethod
				s out("filesStore")={}.$$$jsonFromJSON(json).filesStore
				if out("filesMethod")="" set out("filesMethod")="##class(App.type).UploadFilesJS(%id)"
				if "TempDir"[out("filesStore") set out("filesStore")=##class(%File).GetDirectory(##class(%File).TempFilename())
				if "stream"=out("filesStore") set out("filesStore")=$$defdir^%SYS.GLO($ZU(5))_"stream"_$$$slash
			}
			elseif $g(out("inputpattern"))["select" {
				s out("selectMethod")={}.$$$jsonFromJSON(json).selectMethod
			}
			set out("attr")={}.$$$jsonFromJSON(json).attr
			set out("onchange")={}.$$$jsonFromJSON(json).onchange
			set out("readOnly")={}.$$$jsonFromJSON(json).ReadOnly
			if out("displayname")'="" set out("description")=out("displayname")
			else  s out("description")=$p(out("description"),"{",1)
			// enable the event handler
			if $g(out("onchange"))'="" {
				s out("attr")=out("attr")_" onchange='"_out("onchange")_"'" ;alert(this.value)'"
			}
			
		} catch e { w "Error: "_$ze }
	}
	elseif out("description")="" {
		set out("description")=propName
	}
]]></Implementation>
</Method>

<Method name="GetPropVal">
<Description>
Get all property values</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>obj,propName,gn,nameAttr</FormalSpec>
<Implementation><![CDATA[
	;q:nameAttr=""||(propName="")||('$g(gn)) "" 
	;i '$d(gn("Properties",propName)) q ""
	q $g(gn("Properties",propName,nameAttr))
	;set col=$g(@gn@(-1,nameAttr))
	;quit:'col ""
	;quit $lg($g(@gn@(row)),col)
]]></Implementation>
</Method>

<Method name="ShowProp">
<Description>
Write the string object properties</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>obj,propName,gn,PrefixIdDIV,Mode</FormalSpec>
<Implementation><![CDATA[
	set sysType=..GetPropVal(obj,propName,.gn,"Type")
	if sysType["%Stream." q $$$OK ;TODO exception
	set Name=..GetPropVal(obj,propName,.gn,"Name")
	if Name="" q $$$ERROR($$$GeneralError,"No Exsist Property "_propName) 
	set Required=..GetPropVal(obj,propName,.gn,"Required")
	set ReadOnly=..GetPropVal(obj,propName,.gn,"ReadOnly")
	set Parameters=..GetPropVal(obj,propName,.gn,"Parameters")
	set Value=$property(obj,Name)
	set redstar="" if Required s redstar="<font color=red title='"_$$$aText("Required field","")_"'>*</font>"
	
	do ..GetJsonProp(obj, propName, .gn, .pr)
	if 'ReadOnly set ReadOnly=$g(pr("readOnly"))
	if 'Mode set ReadOnly=1
	
	set label=pr("description")_redstar
	if Mode["ShowFieldName" set label=label_"<br>("_propName_")"
	if $g(pr("inputpattern"))="hidden" set label=""
	write "<td style='text-align: right;' title='"_$g(pr("title"))_"' ><label>"_label_"</label></td>"
	write "<td style='text-align: left;' title='"_$g(pr("title"))_"' >"
	s pr("attr")=$g(pr("attr"))_" "_$s(Required:"Required",1:"")_" "_$s(ReadOnly:"disabled",1:"")
	
	s %id=$g(PrefixIdDIV)_..#PREFIXFIELD_Name
	s %val=$g(Value)
	s pr("WebComp-size")=" size=50 " if pr("attr")["size" set pr("WebComp-size")=""
	
	if sysType="%Boolean",pr("inputtype")'="checkbox" {
		d ##class(App.Form).SelectFieldYesNo(%id,%val)
	}
	elseif sysType="%Date" {
	 	write $$$appText(%id," size=10 "_pr("attr"),%val)
	}
	else {  //%String
		if $g(pr("inputpattern"))="textarea" {
			if pr("attr")'["cols" s pr("attr")=pr("attr")_" cols=77 "
			if pr("attr")'["rows" s pr("attr")=pr("attr")_" rows=3 "
			write $$$appTextarea(%id,pr("attr"),%val)
		}
		elseif $g(pr("inputpattern"))="hidden" {
			write "<input type='hidden' id='"_%id_"' name='"_%id_"' "_$g(pr("attr"))_" value='"_%val_"'>"
		}
		elseif $g(pr("inputpattern"))="autocomplete" {
			set met=$g(pr("autocompleteMethod"))
			if met'=""  xecute "do "_met
			write $$$appAutocomplete(%id," "_pr("attr"),%val)
		}
		elseif $g(pr("inputpattern"))="files" {
			write ..WebCompShowFiles(obj,.pr,Mode,%id,%val)
		}
		elseif $g(pr("inputpattern"))="select" {
			set met=$g(pr("selectMethod"))
			if met'="" {
				;;w met
				if (met["{") { //a list of json
					;TODO
				}
				else { //a list of functions
					xecute "do "_met
				}
			}
			;w $$$appInputHidden(.%id," "_attr,%val)
		}
		elseif $g(pr("inputpattern"))="selectize" {
			s met=$g(pr("selectMethod"))
			write "<input type='text' id='"_%id_"' name='"_%id_"' class='input-tags demo-default ui-corner-all ui-widget ui-widget-content' value='"_%val_"'>"
			if met'="" {
				xecute "do "_met
			}
		}
		elseif pr("inputtype")="checkbox" {
			;set onclick="$('#"_%id_"').attr('value',$('#"_%id_"checkbox').prop('checked') ? 1 : 0 );"
			;write $$$appInput(%id_"checkbox"," onclick="""_onclick_""" type='"_pr("inputtype")_"' "_pr("WebComp-size")_pr("attr")_" "_$s(%val:"checked ",1:""),%val)
			;write $$$appInputHidden(%id,"",%val)
			write ..WebCompShowCheckbox(,.pr,Mode,%id,%val)
		}
		elseif pr("inputtype")'="" {
			write $$$appInput(%id," type='"_pr("inputtype")_"' "_pr("WebComp-size")_pr("attr"),%val)
		}
		elseif Parameters["{" {
			if {}.$$$jsonFromJSON(Parameters).VALUELIST'="" {
			  set vl={}.$$$jsonFromJSON(Parameters).VALUELIST
			  set dl={}.$$$jsonFromJSON(Parameters).DISPLAYLIST
			  ;	s ^tmpMSW(1,$i(^tmpMSW),"Parameters")=$lb(propName,vl,dl)
			  set:dl="" dl=vl
			  do ..SelectField($lfs(vl),,$lfs(dl),.gn2,,%id,%val,600)
			} else {
				write $$$appText(%id,pr("WebComp-size")_pr("attr"),%val)
			}
		}
		else {write $$$appText(%id,pr("WebComp-size")_pr("attr"),%val)
		}
	}
	write "</td>"
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="WebCompShowCheckbox">
<Description>
Display checkbox</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[obj,&pr,Mode,%id,%val,&ext]]></FormalSpec>
<Implementation><![CDATA[
	set onclick="$('#"_%id_"').attr('value',$('#"_%id_"checkbox').prop('checked') ? 1 : 0 );"
	;set ret=$$$appInput(%id_"checkbox"," onclick="""_onclick_""" type='checkbox' "_$g(pr("WebComp-size"))_$g(pr("attr"))_" "_$s(%val:"checked ",1:""),%val)
	set ret=$$$appCheck(%id_"checkbox"," onclick="""_onclick_""" "_$g(pr("WebComp-size"))_$g(pr("attr"))_" "_$s(%val:"checked ",1:""),%val)
	set ret=ret_$$$appInputHidden(%id,"",%val)
	quit ret
]]></Implementation>
</Method>

<Method name="WebCompShowFiles">
<Description>
Display component Files</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[obj,&pr,Mode,%id,%val,&ext]]></FormalSpec>
<Implementation><![CDATA[
	set ret=""
	set met=$g(pr("filesMethod"))
	set attr=$g(pr("WebComp-size"))_$g(pr("attr"))
	;if attr'["disabled" set attr=attr_" disabled "
	for ff="filesStore" set %id(ff)=$g(pr(ff))
	if Mode {
		if met'="" 	s %obj=obj  x "set %ret="_$e(met,1,*-1)_",.%id)"
		set ret=$g(%ret)_$$$appText(%id,attr,%val)
	} else {
		set ret=ret_$$$appText(%id,attr,%val)
	}
	;pr("sysType")
	if %val'="" {
		set fileName=$g(pr("filesStore"))_%val
		;W fileName
		if ##class(App.DownloadCSP).GetFileId(fileName,.url) { 
			set ext("aurl")="<a href='"_url_"'>"_$$$aText("DownLoad","")_"</a>"
			set ext("url")=url
			set ext("fileName")=fileName
			s ret=ret_" "_ext("aurl")
		}
	}
	quit ret
]]></Implementation>
</Method>

<Method name="ObjectDelete">
<Description>
Keep object default</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Param="",Ref=0</FormalSpec>
<Implementation><![CDATA[
	set id=$g(Param("objId")) ;$p(Param,",")
	set Class=$g(Param("ClassName")) ;$p(Param,",",2)
	set PrefixIdDIV=$g(Param("pref")) ;$p(Param,",",3)
	#dim obj As %Persistent
	if id="" w $$$appError($$$aText("Undefined object identifier",""))_"<br>" d:'Ref ..ButtonRef() q
	set obj=$classmethod(Class,"%OpenId",id)
	if '$isobject(obj) w $$$appError($$$aText("Undefined object",""))_"<br>" d:'Ref ..ButtonRef() q
	set st=obj.%DeleteId(obj.%Id())
	if 'st w $$$appError($System.Status.GetErrorText(st)) w "<br>" d:'Ref ..ButtonRef() q
	write $$$appMsg($$$aText("The object is removed",""))
	write "<br>" d:'Ref ..ButtonRef() 
	q
]]></Implementation>
</Method>

<Method name="ObjectSaveAsNew">
<Description>
To create the object as new</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Param=""</FormalSpec>
<Implementation><![CDATA[
	s Param("objId")=""
 d ..ObjectSave(.Param)
]]></Implementation>
</Method>

<Method name="ObjectNew">
<Description>
To create a new object by default</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Param=""</FormalSpec>
<Implementation><![CDATA[
 s obj=..GetObj(Param)
 d ..Show(obj,$p(Param,",",3,99))
 q $$$OK
]]></Implementation>
</Method>

<Method name="GetObj">
<Description>
To get the object from the argument</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	if $p(Par,",",1) = "" s obj=$classmethod($p(Par,",",2),"%New")
	else  s obj=$classmethod($p(Par,",",2),"%OpenId",$p(Par,",",1))
	q obj
]]></Implementation>
</Method>

<Method name="ObjectSave">
<Description>
Save the default object</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Param="",Ref=0</FormalSpec>
<Implementation><![CDATA[
	set id=$g(Param("objId")) ;$p(Param,",")
	set Class=$g(Param("ClassName")) ;$p(Param,",",2)
	set PrefixIdDIV=$g(Param("pref")) ;$p(Param,",",3)
	set Mode=$g(Param("mode"))
	if Mode["WithoutRef" s Ref=1
	if id="" s obj=$classmethod(Class,"%New")
	else  s obj=$classmethod(Class,"%OpenId",id)
	if '$isobject(obj) w $$$appError(..UikitNote($$$aText("Undefined object","")))_"<br>" d:'Ref ..ButtonRef() q ""
	;set gn="%prop"
	set st=..GetPropertyDefinition(obj,.gn)
	if 'st w $$$appError(..UikitNote($System.Status.GetErrorText(st)))_"<br>" d:'Ref ..ButtonRef() q ""
	set prefix=$g(PrefixIdDIV)_..#PREFIXFIELD
	set i=prefix
	;m $$$AppL("SPZ",".gn")=gn
	;m m=%request.Data	zw m
	;zw gn
	;zw Param
	if '$d(Param("%request.Data")) {
		for { set i=$o(%request.Data(i)) quit:i=""  quit:i'[prefix
			set nameProp=i
			s Value=$g(%request.Data(i,1))
			set:nameProp'="" Param("%request.Data",nameProp)=Value
		}
	} 
	s i=""
	for { set i=$o(Param("%request.Data",i)) quit:i=""
			set nameProp=$p(i,prefix,2)  
			continue:nameProp=""
			set Value=$g(Param("%request.Data",i))
			continue:'$d(gn("Properties",nameProp))
			
			if ..GetPropVal(obj,nameProp,.gn,"Required"),Value="" {
				;to get property - description of pr("description")
				d ..GetJsonProp(obj, nameProp, .gn, .pr)
				s err=$g(err)_"<li>"_nameProp_" "_$$$aText("Mandatory field is empty","")_" ("_$g(pr("description"))_")</li>" continue
			}
			if $d(gn("Properties",nameProp)) {
				;set sysType=..GetPropVal(obj,nameProp,.gn,"Type")
				; if the property is - the stream from the stored file
				if 0,sysType["%Stream." {
					set filename=##class(%File).GetDirectory(##class(%File).TempFilename())_Value
					Set file = ##class(%File).%New(filename)
  					set sc=file.Open("RU") // same flags as the OPEN command
					;Do $method(obj,nameProp,"CopyFrom",file)
					;write "<br>"_filename ;continue
					;s stream=##class(%Stream.FileBinary).%New()
					;Set sc=stream.LinkToFile(filename)
					if 'sc {
						;write $$$appError($System.Status.GetErrorText(sc))
					} else {
						set $property(obj,nameProp)=file ;stream
						set file=""
					}
				}
				else {
					set $property(obj,nameProp)=Value
				}
			}
	}
	if $d(err) w "<br><br>"_$$$appError(..UikitNote($$$aText("Error checking properties",""))_"<hr>"_$g(err)) d:'Ref ..ButtonRef() q ""
	set st=obj.%Save()
	if 'st w "<br><br>"_$$$appError(..UikitNote($System.Status.GetErrorText(st)))_" <br>" d:'Ref ..ButtonRef() q ""
	write "<br><br>"_$$$appMsg(..UikitNote($$$aText("Saved",""),"success"))_"<br>" d:'Ref ..ButtonRef()
	quit obj
]]></Implementation>
</Method>

<Method name="UikitNote">
<Description>
To list the properties of a class</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>msg,status="warning"</FormalSpec>
<Implementation><![CDATA[
	$$$jsstart
	w "UIkit.notification({message: '"_msg_"', status: '"_status_"',pos: 'top-center'});"
	$$$jsstop
	q msg
]]></Implementation>
</Method>

<Method name="GetPropertyDefinition">
<Description>
To list the properties of a class</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>obj,gn</FormalSpec>
<Implementation><![CDATA[
	; Get all object properties
	;s sql="SELECT cls.Name, prop.Name, prop.Type, prop.Description FROM ""%Dictionary"".ClassDefinition cls  JOIN ""%Dictionary"".PropertyDefinition prop ON cls.Name = prop.parent WHERE cls.Name = '"_obj.%ClassName(1)_"'"
	;set sql="SELECT * from ""%Dictionary"".PropertyDefinition where parent like '"_obj.%ClassName(1)_"'"
	;set st=##class(App.sys).SaveSQL(sql,gn,1)
	set st=##class(App.LogInfoPane).GetClassDef(obj.%ClassName(1),"",.gn,0)
	if 'st q st
	;zw gn("Properties")
	quit $$$OK
]]></Implementation>
</Method>

<Method name="SelectFieldYesNo">
<Description>
The output type field select Yes or no
do ##class(App.Form).SelectFieldYesNo("test","0")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>idSelect="selectmenu",dfltKey=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ..SelectField($lb(0,1),,$lb($$$aText("No",""),$$$aText("Yes","")),.gn,,idSelect,dfltKey,100)
	q $$$OK
]]></Implementation>
</Method>

<Method name="SelectField">
<Description>
The output fields of type select
do ##class(App.Form).SelectField($lb("",0,1),"alert(1);",$lb("","No","Yes"),.gn,,"test","0",50) </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>KeyList="",ONCHANGE="",ValueList="",gnRet,order=1,idSelect="selectmenu",dfltKey="",width=500,NoWrite=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	kill gnRet
	set selectNS="<SELECT id='"_idSelect_"' name='"_idSelect_"' "_$s(NoWrite:"ONCHANGE='"_ONCHANGE_"'",1:"")_">"
	;set selectNS=selectNS_" <OPTION  VALUE=''></OPTION>"
	set gnRet($i(gnRet))=selectNS
	for i=1:1:$ll(KeyList) { 
		;continue:$lg(KeyList,i)=""
		set selected=""
		if dfltKey'="",dfltKey=$lg(KeyList,i) s selected="selected"
		set select=" <OPTION "_$g(selected)_" VALUE="""_$lg(KeyList,i)_""">"_$lg(ValueList,i)_"</OPTION>"
  		set gnRet($i(gnRet))=select
	}
	set gnRet($i(gnRet))="</SELECT>"
	if NoWrite q $$$OK
	for i=1:1 {q:'$DATA(gnRet(i))  write gnRet(i)}
	$$$jsstart
		w "$( '#"_idSelect_"' ).selectmenu({ change: function( event, data ) { "_ONCHANGE_" }, width:"_width_" }).selectmenu('menuWidget');" ;;.selectmenu('refresh') .addClass('overflow');"
		w "$( '#"_idSelect_"-menu' ).css( 'max-height','500px');"
	$$$jsstop
	q $$$OK
]]></Implementation>
</Method>

<Method name="SelectObj">
<Description>
To objects in the selector for small samples 
Return in the same row or in the global
sql query
ONCHANGE = js function on the event in the ONCHANGE salestore
ValueList = list of fields for the output Value
gnRet - return the array by reference</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>sql,ONCHANGE="",ValueList="",gnRet,idSelect="selectmenu"</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	kill gnRet
	set gn="^||TempPack"
	set selectNS="<SELECT id='"_idSelect_"' > "
	set selectNS=selectNS_" <OPTION  VALUE=''></OPTION>"
	set gnRet($i(gnRet))=selectNS
	set st=##class(App.sys).SaveSQL(sql,gn)
	if 'st quit st
	if ValueList="" set ValueList=$lg(@gn@(0),1)_","_$lg(@gn@(0),1) ///The first field of the query should be identificator
	set NameFieldVALUE=$p(ValueList,",",1)
	s ns=""
	for { s ns=$o(@gn@(ns)) Q:ns=""
		continue:ns<1
		set VALUE=$lg(##class(App.sys).GetValueGN(gn,ns,NameFieldVALUE),1)
		set OPTION=$e($lts(##class(App.sys).GetValueGN(gn,ns,$p(ValueList,",",2,*))," "),1,100)
		s select=" <OPTION "_$g(selected)_" VALUE="""_VALUE_""">"_OPTION_"</OPTION>"
  		set gnRet($i(gnRet))=select
	}
	set gnRet($i(gnRet))="</SELECT>"
	for i=1:1 {q:'$DATA(gnRet(i))  write gnRet(i)}
	$$$jsstart
		w "$( '#"_idSelect_"' ).selectmenu({ change: function( event, data ) { "_ONCHANGE_" }, width:1000 }).selectmenu('menuWidget');" ;;.selectmenu('refresh', true).addClass('overflow');"
		w "$( '#"_idSelect_"-menu' ).css( 'max-height','500px');"
	$$$jsstop
	quit $$$OK
]]></Implementation>
</Method>

<Method name="BlockUI">
<Description>
To block or unblock the screen
do ##class(App.Form).BlockUI(1,"Loading form")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>mode=1,msg="...Loading"</FormalSpec>
<Implementation><![CDATA[
 $$$jsstart 
  w:mode $$$blockui(msg)
  w:'mode "$.unblockUI();"
 $$$jsstop
 q $$$OK
]]></Implementation>
</Method>

<Method name="Show">
<Description>
Show object 
Obj - the class instance
Mode = 0 safe mode
Mode = 1 edit mode with all buttons
Mode = "1,WithoutSave,WithoutDel,WithCreate,WithoutRef" edit mode without buttons
Mode = "1,ShowFieldName" - show the field names</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>obj,Mode=0,PrefixIdDIV="",orderProp=""</FormalSpec>
<Implementation><![CDATA[
	if '$isobject(obj) w $$$aText("No object","") quit
	set st=..GetPropertyDefinition(obj,.gn)
	if 'st w $System.Status.GetErrorText(st) quit  ;##class(%Library.Global).Quote(
	if orderProp=""	set orderProp=obj.#AppORDERPROPERTY
	write "<table>"
	// An ordered display of fields
	if orderProp'="" {
		if orderProp[":" { ;In multiple columns
			for ii=1:1:$l(orderProp,":") { s col=$ZStrip($p(orderProp,":",ii),"<>WCP")
				continue:col=""
				write "<tr>"
				for i=1:1:$l(col,",") { s nameProp=$ZStrip($p(col,",",i),"<>WCP")
			 		if nameProp="" w "<td></td><td></td>" continue
					do ..ShowProp(obj,nameProp,.gn,PrefixIdDIV,Mode)
				}
				write "</tr>"
			}
		}
		else { ;in one column
			for i=1:1:$l(orderProp,",") { s nameProp=$ZStrip($p(orderProp,",",i),"<>WCP")
			 	continue:nameProp=""
			 	write "<tr>"
				do ..ShowProp(obj,nameProp,.gn,PrefixIdDIV,Mode) ;gn("Properties")
				write "</tr>"
			}
		}
	} //the output fields by default
	else {
		set p=""
		for  { s p=$o(gn("Properties",p)) q:p=""  ;q:'$d(@gn@(p))  
			write "<tr>"
			do ..ShowProp(obj,p,.gn,PrefixIdDIV,Mode)
			write "</tr>"
		}
	}
	write "<tr><td style='text-align: right;'>"
		;set onclick="AppAct('"_PrefixIdDIV_"MainForm','"_PrefixIdDIV_"MainContent','AppAct="_$zu(5)_":"_..%ClassName(1)_":*:&objId="_obj.%Id()_"&ClassName="_obj.%ClassName(1)_"&pref="_PrefixIdDIV_"&mode="_Mode_"');"
		set onclick=##class(App.Action).WriteAppAct(%request,PrefixIdDIV_"MainForm",PrefixIdDIV_"MainContent",$zu(5),..%ClassName(1),"*","&objId="_obj.%Id()_"&ClassName="_obj.%ClassName(1)_"&pref="_PrefixIdDIV_"&mode="_Mode)
		
		if Mode {
			
			if Mode'["WithoutSave" {
				set buttval=$s(obj.%Id()'="":$$$aText("Save",""),1:$$$aText("Create",""))
				do ..ButtonMake(buttval,$replace(onclick,"*","ObjectSave"),"appButtonSave") ;ObjectSaveAsNew
			}
			if Mode'["WithoutDel" {
				if obj.%Id() w "&nbsp; " d ..ButtonMake($$$aText("Delete",""),"if (confirm('"_$$$aText("Delete, are you sure?","")_"')) { "_$replace(onclick,"*","ObjectDelete")_"}","appButtonDelete")
			}
			if obj.%Id(),Mode["WithCreate" {
			  w "&nbsp; " do ..ButtonMake($$$aText("Save As New",""),$replace(onclick,"*","ObjectSaveAsNew"),"appButtonSaveAsNew")
			}
		}
		if Mode'["WithoutCancel" {
			write "</td><td style='text-align: left;'>"
				do ..ButtonMake($$$aText("Cancel",""),"","appButtonCancel")
			write "</td><tr>"
		}
	write "</table>"
	;do ##class(App.Form).BlockUI(0)
	quit $$$OK
]]></Implementation>
</Method>

<Method name="ButtonRef">
<Description>
Bring the first button</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>value={$$$aText("Begin","")},onclick="top.document.location.reload();",id="appButtonRef"</FormalSpec>
<Implementation><![CDATA[
	do ..ButtonMake(value,onclick,id)
	quit $$$OK
]]></Implementation>
</Method>

<Method name="ButtonBack">
<Description>
Display back button</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>value={$$$aText("Back","")},onclick="window.history.back();",id="appButtonBack"</FormalSpec>
<Implementation><![CDATA[
	do ..ButtonMake(value,onclick,id)
	quit $$$OK
]]></Implementation>
</Method>

<Method name="ButtonMake">
<Description>
Withdraw button</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>value="",onclick="",id,title=""</FormalSpec>
<Implementation><![CDATA[
  	write $$$appButton(id,"onclick="""_$g(onclick)_""" "_$s(title="":"",1:"title="""_title_""""),value)
  	;w " <input id='appButtonSave' class='ui-button ui-corner-all ui-widget' type=button onclick='"_$g(onclick)_"' value='"_value_"'>"
	quit $$$OK
]]></Implementation>
</Method>

<Method name="GetValueByName">
<Description>
To obtain the value of the parameter named 
ExtProp=1 to extended properties, for example for the type of file
if ##class(App.Form).GetValueByName("App.Parameter","TestFiles","Value",.Val,1) zwrite Val</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[class,name,NameField="Value",&Val,ExtProp=0]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	KILL Val
	set Val=""
	set st=$$$OK
	s gn="^||tmpGetValueName"
	set tab=##class(App.type).GetTableName(class)
	s st=##class(App.sys).SaveSQL("select top 1 * from "_tab_" where Name='"_name_"'",gn)
	if 'st quit st
	i $g(@gn@(-1,NameField))="" q $$$ERROR($$$GeneralError,"undefined field: "_NameField)
 	i '$d(@gn@(1)) q $$$ERROR($$$GeneralError,"undefined "_name)
 	s Val=$lg(@gn@(1),@gn@(-1,NameField))
 	if ExtProp {
	 	set id=##class(App.sys).GetValue(gn,1,"ID")
	 	set obj=##class(App.Form).GetObj(id_","_class)
	 	if $isobject(obj) {
			set st=..GetPropertyDefinition(obj,.prop)
			if 'st quit st
			m Val("Properties")=prop("Properties",NameField)
			d ..GetJsonProp(obj, NameField, .prop, .pr)
			m Val("PropJson")=pr
			m Val("obj")=obj
			if $g(pr("inputpattern"))="files" {
				set comp=..WebCompShowFiles(obj,.pr,0,NameField,Val,.Ext)
				m Val=Ext
			}
	 	}
 	}
	q st
]]></Implementation>
</Method>

<Method name="GetValueByIdField">
<Description>
To obtain the value of parameter ID 
ExtProp=1 to extended properties, for example for the type of file
if ##class(App.Form).GetValueByIdField("App.Parameter","15","ImageFile",.Val,1) zwrite Val</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[class,id,NameField,&Val,ExtProp=0]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	KILL Val
	set Val=""
	set st=$$$OK
	s gn="^||tmpGetValueName"
	set tab=##class(App.type).GetTableName(class)
	s st=##class(App.sys).SaveSQL("select top 1 * from "_tab_" where id='"_id_"'",gn)
	if 'st quit st
	i $g(@gn@(-1,NameField))="" q $$$ERROR($$$GeneralError,"undefined field: "_NameField)
 	i '$d(@gn@(1)) q $$$ERROR($$$GeneralError,"undefined "_name)
 	s Val=$lg(@gn@(1),@gn@(-1,NameField))
 	if ExtProp {
	 	;set id=##class(App.sys).GetValue(gn,1,"ID")
	 	set obj=##class(App.Form).GetObj(id_","_class)
	 	if $isobject(obj) {
			set st=..GetPropertyDefinition(obj,.prop)
			if 'st quit st
			m Val("Properties")=prop("Properties",NameField)
			d ..GetJsonProp(obj, NameField, .prop, .pr)
			m Val("PropJson")=pr
		    m Val("obj")=obj
			if $g(pr("inputpattern"))="files" {
				set comp=..WebCompShowFiles(obj,.pr,0,NameField,Val,.Ext)
				m Val=Ext
			}
	 	}
 	}
	q st
]]></Implementation>
</Method>

<Method name="DrawTable">
<Description>
Display a table from a matrix
do ##class(App.Form).DrawTable(.matrix) </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>matrix</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set r=$o(matrix(""))
	quit:r="" $$$OK
	&html<
 <table>
    <thead>
      <tr>
        <th></th>>
        s c=""
        for { set c=$o(matrix(r,c)) quit:c=""
        	write "<th>"_$g(matrix(r,c))_"</th>"
        }
      &html<
      </tr>
    </thead>
    <tbody>
>
     for { set r=$o(matrix(r)) quit:r=""
     	set c=""
     	set first=1
     	write "<tr>"
 		for { set c=$o(matrix(r,c)) quit:c=""
        	if first {
	        	write "<th>"_$g(matrix(r,c))_"</th>" set first=0
        	}
        	else {
         		write "<td>"_$g(matrix(r,c))_"</td>"
        	}
 		}
 		write "</tr>"
       }
    &html<
    </tbody>
   </table>
	>
]]></Implementation>
</Method>
</Class>


<Class name="App.FormExp">
<IncludeCode>App.LogMacro</IncludeCode>
<Modified>0</Modified>
<Super>App.AutoPage</Super>
<TimeChanged>65310,58523.230178</TimeChanged>
<TimeCreated>64760,78939.721801</TimeCreated>

<Parameter name="CSPURL">
<Default>App.FormExp.cls</Default>
</Parameter>

<Parameter name="PAGENAME">
<Expression>"Objects Explorer"</Expression>
</Parameter>

<Parameter name="PARENTPAGE">
<Default>App.AutoPage.cls</Default>
</Parameter>

<Method name="GetDetailPane">
<Description>
Get the detail pane info object</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pInstance:%CSP.Util.PageInstance</FormalSpec>
<ReturnType>%CSP.Util.Pane</ReturnType>
<Implementation><![CDATA[	quit ##class(App.FormExplorer).%New()
]]></Implementation>
</Method>
</Class>


<Class name="App.FormExplorer">
<Description>
</Description>
<IncludeCode>App.LogMacro</IncludeCode>
<Super>App.LogInfoPane</Super>
<TimeChanged>65392,35889.578814</TimeChanged>
<TimeCreated>64760,79525.802682</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Method name="DrawBODY">
<Description>
Draw a shape for input information</Description>
<FormalSpec>pInstance:PageInstance</FormalSpec>
<PublicList>nsp,what,field,value,type,typeclass,caption</PublicList>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 	write ##class(App.LogInfoPane).AddJsScripts("grid")
	set $ZT="errors"
	set nsp=%request.Get("NSP")
	if nsp'="" try {zn nsp set NSpace=nsp } catch e {}
	set NSpace=$zu(5)
	set SelClass=$tr(%request.Get("SelClass"),"_",".")
	// Navigator system
	if %request.Get("panel")="AccordionExp" {
	&html<
	 <div id="accordion" style='width: 100%; height: 100%'>
		<h3 id=aNSPh>Namespace: <span id=aNSPhead></span></h3>
		<div id=aNSP></div>
		
		<h3 id=aCLSh >Classes: <span id=aCLShead></span></h3>
		<div id=aCLS></div>
		
		<h3 id=aOBJh>Objects: <span id=aOBJhead></span></h3>
		<div id=aOBJ></div>
		
		<h3 id=aPROh>Propertis: <span id=aPROhead></span></h3>
		<div id=aPRO></div>
	 </div>
	>
	d ##class(App.LogInfoPane).AddJS(NSpace,..%ClassName(1))
	$$$jsstart	// To load a list of fields
		w "$( '#accordion' ).accordion({"
	 	w " collapsible: true, icons: { header: ""ui-icon-zoomin"",  headerSelected: ""ui-icon-zoomout"" }"
		w "});"
	    w " var Namespace = ["
    	s ns=##class(App.sys).ListNS(.info)
    	f i=1:1:$l(ns,",") {
    		continue:$p(ns,",",i)="%All"
    		continue:$p(ns,",",i)=""
    		w "{ ""Namespace"": """_$p(ns,",",i)_""" }"_$s($p(ns,",",i+1)="":"",1:",")
    	}
   		w "];"
    
    $$$jsstop
 	&js< <script>
    $("#aNSP").jsGrid({
        width: "*",
        height: "auto",
 
        inserting: false,
        editing: false,
        sorting: true,
        paging: true,
  		rowClick: function(args) {
            console.log(args.item);
            $("#aNSPhead").html(args.item.Namespace);
            $("#aCLS").empty();
            $("#aCLShead").html("");
			$.blockUI( { message: '...Loading' , css: { border: 'none', padding: '15px', backgroundColor: '#000', '-webkit-border-radius': '10px','-moz-border-radius': '10px', opacity: .5, color: '#fff' }} );
            $("#aCLS").load("App.Action.cls","appClass=App.FormExplorer&appMethod=Class2Grid&appNsp="+args.item.Namespace+"&appPar="+args.item.Namespace);
        },
        data: Namespace,
        fields: [
            { name: "Namespace", type: "text", width: 150, validate: "required" }
            
        ]
    });
	</script>>
	}
	/// Navigator of selectors
	else {
	&html<
		<!-- ui-dialog -->
	<div id="dialog" title="Dialog Title">
		<div id=dialogContent></div>
	</div>
		<form name="loginfo" id="loginfo">
		<table width="90%" style="border-radius: 10px; border: 1px solid #72a7cf" cellpadding="2" cellspacing="0" class="DetailTable" bgcolor="#c4d6d6" >
		<tr>
		  <td>#(##class(App.LogInfo).GetInfoImg("search"))# 
			 <DIV id='MainNamespaces'></div>
			 <DIV id='MainClasses'></div>
			 <DIV style='overflow: auto;' id='MainObjects'></div>
			</td>
		 </tr>
		 <tr>
		   <td>
	 		<div id="MainContent">
	 		</div>
		   </td>
		 </tr>
		</table>
		>
		 d ##class(App.LogInfoPane).AddJS(NSpace,..%ClassName(1))
		 $$$jsstart	// To load a list of fields
		   	; to calculate the height of the container as a result of wijetunge victory container-Taba height of the container header
		 	w "$('#MainObjects').height(window.innerHeight-200);"

		 	write "$('#MainNamespaces').load('App.Action.cls','appClass=App.FormExplorer&appMethod=SelectNsp&appNsp="_$zu(5)_"');"
		 	write "$('#MainClasses').load('App.Action.cls','appClass=App.FormExplorer&appMethod=SelectClasses&appNsp="_$zu(5)_"&appPar="_$g(SelClass)_"');"
		 $$$jsstop
		write "<br><br><form>"
	}
	quit $$$OK

errors
 	write !,$ze
 	quit $$$OK
]]></Implementation>
</Method>

<Method name="Class2Grid">
<Description>
The list of classes in a table</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<Implementation><![CDATA[
	set ListClasses=""
	do ..SelectClasses("",.ListClasses)
	$$$jsstart	// Download a list of classes
    write " var classes = ["
    	set i=""
    	for { s i=$o(ListClasses(i)) quit:i=""
    		write "{ ""ClassNames"": """_i_""",""SuperClass"": """_$lg(ListClasses(i),3)_""" }"_$s($o(ListClasses(i))="":"",1:",")
    	}
   		 write "];"
    
    $$$jsstop
 	&js< <script>
 	 console.log(classes);
    $("#aCLS").jsGrid({
        width: "*",
        height: "auto",
        inserting: false,
        editing: false,
        sorting: true,
        paging: true,
  		rowClick: function(args) {
            console.log(args.item);
            $("#aCLShead").html(args.item.ClassNames);
            $("#aOBJ").empty();
            $("#aOBJhead").html("");
			$.blockUI( { message: '...Loading' , css: { border: 'none', padding: '15px', backgroundColor: '#000', '-webkit-border-radius': '10px','-moz-border-radius': '10px', opacity: .5, color: '#fff' }} );
            $("#aOBJ").load("App.Action.cls","appClass=App.FormExplorer&appMethod=Obj2Grid&appNsp="+$("#aNSPhead").html()+"&appPar="+args.item.ClassNames);
        },
        data: classes,
         fields: [
            { "name": "ClassNames", "type": "text", "width": "50%", "validate": "required" ,autosearch: true},
            { "name": "SuperClass", "type": "text", "width": "*", "validate": "required" }
                   
        ]
    });
      $("#aCLSh").click();
      $.unblockUI();
	</script>
	>
]]></Implementation>
</Method>

<Method name="Obj2Grid">
<Description>
A list of instances of classes in a table</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<Implementation><![CDATA[
	#define tra(%s) $zconvert(%s,"O","JS")
	set count=..GetCountTab(Par,.tab)
	set sql="select * from "_tab
	set gn="^||tmpAppExpObj2Grid"
	do ##class(App.sys).SaveSQL(sql,gn)
	set nl=$c(13,10)
	$$$jsstart
   // To load the list of query fields
      set field = "["
    	for f=1:1:$ll(@gn@(0)) { 
    		set field=field_"{ name: """_$$$tra($lg(@gn@(0),f))_""", type: ""text"", validate: ""required"" }"_$s($ll(@gn@(0))'=f:",",1:"")
    	}
   		 set field=field_"]"
   	write !,nl,"var field = "_field_";",!,nl
   	;w "var field2=JSON.parse(field);",!,nl
    // Download a list of classes
    set max=$$$MAXSHOW
    write " var objects = [",!
    	set i="0"
    	for { s i=$o(@gn@(i)) q:i=""  q:i>max  ;limit
    		write "{ "
    		for f=1:1:$ll(@gn@(0)) {
	    		set val=$lg(@gn@(i),f)
	    		set:$l(val)>80 val=$e(val,1,50)_"..."
    			write """"_$$$tra($lg(@gn@(0),f))_""": """_$$$tra(val)_""" "_$s($ll(@gn@(0))'=f:",",1:"")
    		}
    		write "}"_$s($o(@gn@(i))'="":",",1:""),!
    	}
   		 write "];",!,nl
    	write "$('#aOBJhead').html('Total: "_+count_"');",!,nl
    $$$jsstop
 	&js< <script>
 	   $("#aPROhead").html("");
 	   console.log(objects);
    $("#aOBJ").jsGrid({
        width: "*",
        height: "auto",
        inserting: false,
        sorting: true,
        paging: true,
  		rowClick: function(args) {
            console.log(args.item);
            var pro='';
            for (var item in args.item) { // "foreach"
     		   console.log(args.item[ item ]);
     		   pro=pro+' '+args.item[ item ]
    		}
            $("#aPROhead").html(pro);
            $("#aPRO").load("App.Action.cls","appClass=App.FormExplorer&appMethod=PRO2Grid&appNsp="+$("#aNSPhead").html()+"&appPar="+args.item.ID+","+$("#aCLShead").html());
            $("#aPRO").click();
        },
        fields: field,
        data: objects
          
    });
 	$("#aOBJh").click();
  	$.unblockUI();
	$("#aPROhead").html("Create new");
	$("#aPRO").load("App.Action.cls","appClass=App.FormExplorer&appMethod=PRO2Grid&appNsp="+$("#aNSPhead").html()+"&appPar=,"+$("#aCLShead").html());
	</script>
	>
]]></Implementation>
</Method>

<Method name="PRO2Grid">
<Description>
To open an instance of the class</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<Implementation><![CDATA[
	write "<form id='MainForm'><div id='MainContent'>"
	set class=$p(Par,",",2)
	set id=$p(Par,",",1)
	set obj=##class(App.Form).GetObj(Par)
	if '$isobject(obj) { 
		write $$$appError($$$aText("Failed to open object",""))
	}
	else {
		set mode=($roles["%All")_",WithoutCancel,WithCreate"
		do ##class(App.Form).Show(obj,mode)
	}
	$$$jsstart
	write "$('#aPRO').height('80%');"
	write:id'="" "$('#aPROh').click();"
 	$$$jsstop
	write "</div></form>"
	quit $$$OK
]]></Implementation>
</Method>

<Method name="SelectNsp">
<Description>
To get a list of fields in the select</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<Implementation><![CDATA[
	set NSpace=$zu(5)
	// To get a list of fields
	set listNs=##class(App.sys).ListNS(.info)
	set onc="$('#MainClasses').empty();$('#MainObjects').empty();$('#MainClasses').load('App.Action.cls','appClass=App.FormExplorer&appMethod=SelectClasses&appNsp='+this.options[this.selectedIndex].value+'&appPar='+this.options[this.selectedIndex].value);"
	set selectNS="<SELECT title="""_$$$aText("NameSpace","")_""" name=""NSP"" id=""NSP""  > "
	for ns=1:1:$l(listNs,",") { continue:$p(listNs,",",ns)=""
		continue:$p(listNs,",",ns)["%ALL"
  		set selected=$select(NSpace=$p(listNs,",",ns):"selected",1:"")
  		set selectNS=selectNS_" <OPTION "_selected_" VALUE="""_$p(listNs,",",ns)_""">"_$p(listNs,",",ns)_"</OPTION>"
	}
	set selectNS=selectNS_"</SELECT>"
	write selectNS
	$$$jsstart
		w "$( '#NSP' ).selectmenu({ change: function( event, data ) { "_onc_" }, width:1000 }).selectmenu('menuWidget');" ;;.selectmenu('refresh', true).addClass('overflow');"
		w "$( '#NSP-menu' ).css( 'max-height','500px');"
	$$$jsstop
	quit $$$OK
]]></Implementation>
</Method>

<Method name="SelectClasses">
<Description>
To obtain a list of classes in the form of select</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>SelectClass="",ListClasses</FormalSpec>
<Implementation><![CDATA[
	set query=##class(%Library.ResultSet).%New("%Dictionary.ClassDefinition:Summary")
 	set st=query.Execute() ;"%Persistent")
	set onc="$('#MainObjects').load('App.Action.cls','appClass=App.FormExplorer&appMethod=SelectObjects&appNsp="_$zu(5)_"&appPar='+this.options[this.selectedIndex].value);"
 	set selectNS="<SELECT title="""_$$$aText("Classes","")_""" name=""SelClass"" id=""SelClass"" > "
 	while query.Next() { 
 		if 'query.Get("Persistent") continue
		set class=query.Get("Name"),f1=""
		if $zu(5)'="%SYS" continue:$e(class,1)="%"  
		if $e($zu(5),1,3)'="ENS" continue:$e(class,1,3)="Ens"
		set selected=""
		if class=SelectClass s selected="selected",forceONC=1
		if query.Get("Super")["App.Form" s f1="style='color:red;' title='Inheritor App.Form'"
		set selectNS=selectNS_" <OPTION "_$g(selected)_" "_f1_" VALUE="""_class_""">"_class_"</OPTION>"
		if $D(ListClasses) s ListClasses(class)=$lb($g(selected),f1,query.Get("Super"),query.Get("System"),query.Get("TimeChanged"),,query.Get("SqlTableName"))
	}
	quit:$D(ListClasses) $$$OK
	
	set selectNS=selectNS_"</SELECT>"
	write selectNS
	$$$jsstart
		write "$( '#SelClass' ).selectmenu({ change: function( event, data ) { "_onc_" }, width:1000 }).selectmenu('menuWidget');" ;;.selectmenu('refresh', true).addClass('overflow');"
		write "$( '#SelClass-menu' ).css( 'max-height','500px');"
	$$$jsstop
	if $g(forceONC) {
		$$$jsstart
			write "$('#MainObjects').load('App.Action.cls','appClass=App.FormExplorer&appMethod=SelectObjects&appNsp="_$zu(5)_"&appPar="_SelectClass_"');"
		$$$jsstop
	}
	quit $$$OK
]]></Implementation>
</Method>

<Method name="GetCountTab">
<Description>
To obtain the Number of records in the table</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[SelectClass,&tab]]></FormalSpec>
<Implementation><![CDATA[
	set tab=##class(App.type).GetTableName(SelectClass)
	set sql="select * from "_tab
	set gn="^||tmpAppExpCount"
	do ##class(App.sys).SaveSQL("select count(*) from "_tab,gn)
	set count=+$lg($g(@gn@(1)),1)
	quit count
]]></Implementation>
</Method>

<Method name="SelectObjects">
<Description>
To obtain a list of instances of a class in a table</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>SelectClass,sql="",exec=""</FormalSpec>
<Implementation><![CDATA[
	set count=..GetCountTab(SelectClass,.tab)
	set:sql="" sql="select * From "_tab
	set add=" <span style='"_$$$styleurl_"' onclick=""WinOpen('"_$zu(5)_"','"_..%ClassName(1)_"','WinOpenEditObj','SelectClass="_SelectClass_"&ID=','','"_##class(App.Action).WriteWinOpenREST(%request)_"');"" title='"_$$$aText("To create an object","")_"' >"_$$$aText("To create","")_"</span>"_sql
	$$$jsstart
		write "$('#MainObjEdit').empty();"
	$$$jsstop
	set %SelectClass=SelectClass
	if exec="" set exec="##class(App.FormExplorer).WinEditObj(.%AppLogInfoVal, %AppLogInfoCol, %AppLogInfoHead, .%AppLogInfoTemp,"""_$zu(5)_""")"
	set st=##class(App.LogInfoPane).DrawSQL(sql,$$$MAXSHOW,$zu(5),$$$FormatText($$$aText("Instances of class %1 in namespace %2",""),SelectClass,$zu(5))_" "_add,exec)
	quit st
]]></Implementation>
</Method>

<Method name="EditObj">
<Description>
To form active links for editing</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Val,Col,Head,Temp,nspace,DSN</FormalSpec>
<Implementation><![CDATA[
	set res=Val
	if $g(Head) {
		i $g(Val)="ID" s Temp("ID",Col)=""
	}
	else {
		if $D(Temp("ID",Col)) {
			set res=$replace(Val,Val,"<span style='"_$$$styleurl_"' onclick=""$('#MainObjEdit').load('App.Action.cls','appClass=App.FormExplorer&appMethod=PRO2Grid&appNsp="_nspace_"&appPar="_Val_","_%SelectClass_"');"" >"_Val_"</span>")
		}
	}
	quit res
]]></Implementation>
</Method>

<Method name="WinEditObj">
<Description>
Forming an active link for editing in the window</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Val,Col,Head,Temp,nspace,DSN</FormalSpec>
<Implementation><![CDATA[
	set res=Val
	if $g(Head) {
		if $g(Val)="ID" s Temp("ID",Col)=""
	}
	else {
		if $D(Temp("ID",Col)) {
			s %id=Val
		}
		set res=$replace(Val,Val,"<span title='"_$$$aText("Edit","")_"' style='"_$$$styleurl_"' onclick=""WinOpen('"_nspace_"','"_..%ClassName(1)_"','WinOpenEditObj','&SelectClass="_%SelectClass_"&ID="_$zconvert(%id,"O","URL")_"','','"_##class(App.Action).WriteWinOpenREST(%request)_"');"" >"_Val_"</span>")
	}
	quit res
]]></Implementation>
</Method>

<Method name="WinOpenEditObj">
<Description>
To open the window to edit the object instance</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par,json</FormalSpec>
<Implementation><![CDATA[
	set id=$g(Par("ID"))
	set ClassName=$tr($get(Par("SelectClass")),"_",".")
	set obj=##class(App.Form).GetObj(id_","_ClassName)
	set PrefixIdDIV="WinOpenEditObj"
	write "<form id='"_PrefixIdDIV_"MainForm'>"
		do ##class(App.Form).Show(obj,"1,WithoutCancel,WithoutRef",PrefixIdDIV) 
	write "</form><div id='"_PrefixIdDIV_"MainContent'></div>"
	q $$$OK
]]></Implementation>
</Method>
</Class>


<Class name="App.Installer">
<Description>
Importing this class will install App Tools properly.
fork from </Description>
<IncludeCode>App.LogMacro</IncludeCode>
<Super>%Projection.AbstractProjection</Super>
<TimeChanged>65392,30639</TimeChanged>
<TimeCreated>63890,71053.144208</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Parameter name="DispatchClass">
<Default>App.rest</Default>
</Parameter>

<Parameter name="ResourceName">
<Default>%AppTools</Default>
</Parameter>

<Parameter name="Repository">
<Default>cache-iris-app-tools</Default>
</Parameter>

<Parameter name="RoleName">
<Default>AppTools</Default>
</Parameter>

<Parameter name="AppRest">
<Default>apptoolsrest</Default>
</Parameter>

<Parameter name="AppCSP">
<Default>apptools</Default>
</Parameter>

<Parameter name="AppName">
<Default>AppTools</Default>
</Parameter>

<Projection name="Reference">
<Type>Installer</Type>
</Projection>

<Parameter name="VERSION">
<Default>1.0</Default>
</Parameter>

<Method name="CreateProjection">
<Description>
This method is invoked when a class is compiled.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[cls:%String,&params]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	new $Namespace
	set ns = $Namespace // ought to be package home namespace!
	if $g(@$$$GNEnsConf@("HomeNamespace"))'="",$g(@$$$GNEnsConf@("HomeNamespace"))'=ns {
		 QUIT $$$OK
	}
	if $g(@$$$GNEnsConf@("HomeNamespace"))="" {
	;Filling the global default values
	 set @$$$GNEnsConf@("DBCACHESizeMon")="CACHESYS,CACHEAUDIT"
	 set @$$$GNEnsConf@("EMAILAUTH")="user_from_send_mail@server.com"
	 set @$$$GNEnsConf@("EMAILAUTHPASS")=12345
	 set @$$$GNEnsConf@("EMAILSERVERIP")="127.0.0.1"
	 set @$$$GNEnsConf@("EMAILSERVERPORT")=25
	 set @$$$GNEnsConf@("EMAILSUPPORT")="user_to_send_mail@server.com"
	 set @$$$GNEnsConf@("EMAILXLSPATH")="c:\temp\"
	 set @$$$GNEnsConf@("EXPORDPROJPATH")="c:\temp\source\"
	 set @$$$GNEnsConf@("Language")="en"
	 set @$$$GNEnsConf@("PATHCSP")="/"_..#AppCSP_"/"
	}
    set @$$$GNEnsConf@("HomeNamespace") = ns
    write !, "Installing "_..#AppName_" application to " _ ns
    set dbdir = $$$defdir
    $$$NspGoto(curNs,"%SYS")
    try {
        set $Namespace = "%SYS"
    } catch (e) {
        set mes = "<PROTECT> The user " _ $Username _ " has no privileges"
            _ " to enter the %SYS namespace. Please, log in as a privileged user"
            _ " to set up the "_..#AppName_" application."
        set err = $$$ERROR($$$GeneralError, mes)
        write !, mes
        return err
    }
    
   	s result=##CLASS(%ResultSet).%New("%DynamicQuery:SQL")
	s tSC=result.Prepare("select * FROM Security.Applications where Name=?")
	s:tSC tSC=result.Execute("/csp/"_ns)
	i '$$$ISOK(tSC) {
		s text="Error application :"_$SYSTEM.Status.GetErrorText(tSC)  w !,text QUIT $$$ERROR(text)
	}
	else {
		while result.Next() {
			set cspProperties("Path")=result.Data("Path")
		}
	}
    if '$data(cspProperties("Path")) {
	    set tempdir=$p($zu(12),$$$slash,1,*-2)_$$$slash_"CSP"_$$$slash_ns
		w !,"Create directory ",tempdir
		s st=##class(%File).CreateDirectory(tempdir)
		i 'st w !,"Error creating directory " q $$$OK
	    set cspProperties("Path")=tempdir
    }
    set cspProperties("AutheEnabled") = $$$AutheCache ;$$$AutheUnauthenticated ;
    set cspProperties("NameSpace") = ns
    set cspProperties("Description") = "A WEB application for "_..#AppName_"."
    set cspProperties("IsNameSpaceDefault") = $$$NO
    set st = ..RegisterWebApplication("/"_..#AppCSP, .cspProperties)
    return:$$$ISERR(st) st
    
 
	s @$$$GNEnsConf@("CSP-Path")=cspProperties("Path")
	KILL cspProperties("Path")
	
    set cspProperties("AutheEnabled") = $$$AutheCache ;$$$AutheUnauthenticated
    set cspProperties("NameSpace") = ns
    set cspProperties("Description") = "A WEB application for "_..#AppName_"."
    set cspProperties("IsNameSpaceDefault") = $$$NO
    set cspProperties("DispatchClass") = ..#DispatchClass
    set st = ..RegisterWebApplication("/"_..#AppRest, .cspProperties)
    return:$$$ISERR(st) st
  	set @$$$GNEnsConf@("PATHCSP")="/"_..#AppCSP_"/"
    do ..CreateAllNamespace()
    
    write !, "Mapping "_..#AppName_" package into all namespaces:"
    set st = ..Map(ns)
    if ($$$ISERR(st)) {
        do $System.Status.DisplayError(st)
    } else {
	    write !, ""_..#AppName_" package successfully mapped into all namespaces."
    }

    if (##class(Security.Resources).Exists(..#ResourceName) = 0) {
        set st = ##class(Security.Resources).Create(..#ResourceName,
            "Grants access to "_..#AppName_" if set up.", "")
    }

    if (##class(Security.Roles).Exists(..#RoleName) = 0) {
        set st = ##class(Security.Roles).Create(..#RoleName,
            "AppTools user role which may grant access to /"_..#AppCSP_" application if set up.",
            ..#ResourceName_":RWU")
    }

	s Status=##Class(Config.Startup).Get(.Properties)
	i Status s ServerPort="http://"_$zu(110)_":"_$g(Properties("WebServerPort"),57772)
	w !
   d ..AddAndWriteFavorite(..#AppName,"/"_..#AppCSP_"/App.LogInfo.cls",$g(ServerPort))
   d ..AddAndWriteFavorite(..#AppName_" Permission Matrx","/"_..#AppCSP_"/App.TabsPanelUikitPermissMatrx.cls?autoload=Matrix",$g(ServerPort))
   d ..AddAndWriteFavorite(..#AppName_" Samples Admin Panel","/"_..#AppCSP_"/App.TabsPanelUikitAdmin.cls?autoload=Matrix",$g(ServerPort))
   d ..AddAndWriteFavorite(..#AppName_" REST service Admin Panel","/"_..#AppCSP_"rest/get-html/App.TabsPanelUikitAdmin.cls?autoload=Find",$g(ServerPort))
   	w !
	$$$NspReturn(curNs)
    d ##class(App.net).ImportCSPFromGitHub("https://codeload.github.com/SergeyMi37/"_..#Repository_"/zip/master",..#Repository,@$$$GNEnsConf@("CSP-Path"))
    return st
]]></Implementation>
</Method>

<Method name="AddAndWriteFavorite">
<Description>
AddFavorite</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>name:%String,url,ServerPort</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    Set tSC = ##class(%SYS.Portal.Users).%AddFavorite(name,url) 
    if ServerPort'="" w !,ServerPort_url
]]></Implementation>
</Method>

<Method name="RegisterWebApplication">
<ClassMethod>1</ClassMethod>
<FormalSpec>name:%String,spec</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    new $Namespace
    set $Namespace = "%SYS"
    set st = $$$OK
    if ('##class(Security.Applications).Exists(name)) {
        write !,"Creating WEB application """_name_"""..."
        set st = ##class(Security.Applications).Create(name, .spec)
        write !, "WEB application """_name_""" is created."
    } else { // ensure configuration matches in case of updating from old terminal versions
        write !, "Updating web application """_name_"""..."
        set st = ##class(Security.Applications).Modify(name, .spec)
        write !, "WEB application """_name_""" is updated."
    }
    return st
]]></Implementation>
</Method>

<Method name="RemoveWebApplication">
<ClassMethod>1</ClassMethod>
<FormalSpec>name:%String</FormalSpec>
<Implementation><![CDATA[
    new $Namespace
    set $Namespace = "%SYS"
    set st = $$$OK
    if (##class(Security.Applications).Exists(name)) {
        do ##class(Security.Applications).Get(name, .props)
        if (props("DispatchClass") '= ..#DispatchClass) && (name = "/"_..#AppCSP) {
            write !, "Won't delete WEB-application """_name_""" because it does not refer to dispatch class anymore."
        } else {
            write !, "Deleting WEB application """_name_"""..."
            set st = ##class(Security.Applications).Delete(name)
            write !, "WEB application """_name_""" was successfully deleted."
        }
    }
    return st
]]></Implementation>
</Method>

<Method name="RemoveProjection">
<Description>
This method is invoked when a class is 'uncompiled'.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[cls:%String,&params,recompile:%Boolean]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	new $Namespace

	write:(recompile) !, "Recompiling "_..#AppName_", skipping the deletion..."
    return:(recompile) $$$OK

	set ns = $get(@$$$GNEnsConf@("HomeNamespace"), $Namespace)
    write !, "Uninstalling "_..#AppName_" application from ", ns
    zn "%SYS"
    set st = ..RemoveWebApplication("/"_..#AppCSP)
    return:($$$ISERR(st)) st
    
    set st = ..RemoveWebApplication("/"_..#AppRest)
    return:($$$ISERR(st)) st
    
    if (##class(Security.Resources).Exists(..#ResourceName) = 1) {
        set st = ##class(Security.Resources).Delete(..#ResourceName)
        return:($$$ISERR(st)) st
    }
    if (##class(Security.Roles).Exists(..#RoleName) = 1) {
        set st = ##class(Security.Roles).Delete(..#RoleName)
        return:($$$ISERR(st)) st
    }

    kill:st @$$$GNEnsConf
    write !, "Global "_$$$GNEnsConf_" removed."

    kill:st @$$$GNLang
    write !, "Global "_$$$GNLang_" removed."

    write !, "Unmapping App package from all namespaces:"
	set st = ..UnMap(ns)
    if ($$$ISERR(st)) {
        do $System.Status.DisplayError(st)
       
    } else {
	    write !, "Unmapping complete."
    }

    return st
]]></Implementation>
</Method>

<Method name="CreateAllNamespace">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	new $Namespace
    set $Namespace = "%SYS"
	set ns = "%All"
	set st = $$$OK
	if ('##Class(Config.Namespaces).Exists(ns)) {

        if ($system.Version.GetISCProduct() >= 4) {
            set Properties("Globals") = "IRISTEMP"
            set Properties("Library") = "IRISLIB"
            set Properties("Routines") = "IRISTEMP"
            set Properties("SysGlobals") = "IRISSYS"
            set Properties("SysRoutines") = "IRISSYS"
            set Properties("TempGlobals") = "IRISTEMP"
        } else {
            set Properties("Globals") = "CACHETEMP"
            set Properties("Library") = "CACHELIB"
            set Properties("Routines") = "CACHETEMP"
            set Properties("SysGlobals") = "CACHESYS"
            set Properties("SysRoutines") = "CACHESYS"
            set Properties("TempGlobals") = "CACHETEMP"
        }
		
		set st = ##Class(Config.Namespaces).Create(ns, .Properties)
		if ($$$ISERR(st)) {
        	do $System.Status.DisplayError(st)
    	} else {
        	write !, "%All namespace is created."
    	}
	}
	return st
]]></Implementation>
</Method>

<Method name="Map">
<ClassMethod>1</ClassMethod>
<FormalSpec>fromNS=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	new $Namespace
    set $Namespace = "%SYS"
    set st = $$$OK

    set mapTo = $LISTBUILD("%All", "SAMPLES", "DOCBOOK")
    do ##Class(Config.Namespaces).Get(fromNS, .InstallNSProps)
    set Properties("Database") = $get(InstallNSProps("Routines"))
    set ptr = 0
    while $LISTNEXT(mapTo, ptr, namespace) {
        continue:(fromNS = namespace)
        continue:('##Class(Config.Namespaces).Exists(namespace))
        write " ", namespace
        if ('##Class(Config.MapPackages).Exists(namespace, "App")) {
        	set st1 = ##Class(Config.MapPackages).Create(namespace, "App", .Properties)
        }
        if ('##Class(Config.MapGlobals).Exists(namespace, "App")) {
	        set st2 = ##Class(Config.MapGlobals).Create(namespace, "App", .Properties)
        }
        set st = $$$ADDSC(st,$$$ADDSC($get(st1,$$$OK),$get(st2,$$$OK)))
    }
    return st
]]></Implementation>
</Method>

<Method name="UnMap">
<ClassMethod>1</ClassMethod>
<FormalSpec>fromNS:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	new $Namespace
    set $Namespace = "%SYS"
    set st = $$$OK
    
	set mapTo = $LISTBUILD("%All", "SAMPLES", "DOCBOOK")
    set ptr = 0
    while $LISTNEXT(mapTo, ptr, namespace) {
	    continue:(fromNS = namespace)
	    continue:('##Class(Config.Namespaces).Exists(namespace))
        write " ", namespace
        if (##Class(Config.MapPackages).Exists(namespace, "App")) {
        	set st1 = ##Class(Config.MapPackages).Delete(namespace, "App", .Properties)
        }
        if (##Class(Config.MapGlobals).Exists(namespace, "App")) {
	        set st2 = ##Class(Config.MapGlobals).Delete(namespace, "App", .Properties)
        }
        set st = $$$ADDSC(st,$$$ADDSC($get(st1,$$$OK),$get(st2,$$$OK)))
    }
    return st
]]></Implementation>
</Method>
</Class>


<Routine name="App.JsonUtils" type="INC" timestamp="65344,34759.663222"><![CDATA[
#; ver 20191127
#include %occReference

#define formatJSON 		"aelotwc"
#define formatJSONSQL	"tw"
#define formatDate		3
#define formatTime		7

#define toJSONClassMethod "toJSON"
#define updateClassMethod "updateIdFromObject"
#define IsNewJSON ##Expression($$$comClassDefined("%Library.DynamicAbstractObject"))

#if $$$IsNewJSON
    #define NewDynObj {}
    #define NewDynDTList []
    #define NewDynObjList $$$NewDynDTList
    #define Insert(%obj,%element) do %obj.%Push(%element)
    #define DynObjToJSON(%obj) w %obj.%ToJSON()
    #define ListToJSON(%obj) $$$DynObjToJSON(%obj)
    #define ListSize(%obj) %obj.%Size()
    #define ListGet(%obj,%i) %obj.%Get(%i-1)
    #define jsonClassIsLatestVersion %ClassIsLatestVersion 	
    						//usage: obj.$$$jsonClassIsLatestVersion()
    #define jsonExtends %Extends							
    						//usage: {}.$$$jsonExtends(classname) 
    #define jsonFromJSON %FromJSON							
    						//usage: {}.$$$jsonFromJSON(string) 
    #define jsonGetIterator %GetIterator 					
    						//usage: obj.$$$jsonGetIterator()
	#define jsonGetNext %GetNext 					
    						//usage: iterator.$$$jsonGetNext(.key, .value)
	#define jsonIsA %IsA									
    						//usage: obj.$$$jsonIsA(className)
    #define jsonToJSON %ToJSON								
    						//usage: obj.$$$jsonToJSON()
    #define jsonGet %Get									
    #define jsonNew %New									
    						//usage: obj.$$$jsonGet(key)
    #define jsonIsDefined %IsDefined						
    						//usage: obj.$$$jsonIsDefined(key) 
    #define jsonRemove %Delete								
    						//usage: obj.$$$jsonRemove(key)
    #define jsonSet %Set									
    						//usage: obj.$$$jsonSet(key, val)
    #define jsonSize %Size									
    						//usage: obj.$$$jsonSize()
    #define jsonPop %Pop									
    						//usage: obj.$$$jsonPop()
    #define jsonPush %Push									
    						//usage: obj.$$$jsonPush(val) 
	#define jsonAbstractClass %Library.AbstractDynamicObject
	#define jsonObjectClass %Library.DynamicObject
	#define jsonArrayClass %Library.DynamicArray
	
	#define jsonInitialArrayIndex 1
	
	#define jsonGetTypeOf %GetTypeOf
    						//usage: obj.$$$jsonGgetTypeOf()
#else
    #define NewDynObj ##class(%ZEN.proxyObject).%New()
    #define NewDynDTList ##class(%ListOfDataTypes).%New()
    #define NewDynObjList ##class(%ListOfObjects).%New()
    #define Insert(%obj,%element) do %obj.Insert(%element)
    #define DynObjToJSON(%obj) do %obj.%ToJSON()
    #define ListToJSON(%obj) do ##class(%ZEN.Auxiliary.jsonProvider).%ObjectToJSON(%obj)
    #define ListSize(%obj) %obj.Count()
    #define ListGet(%obj,%i) %obj.GetAt(%i)

   #define jsonClassIsLatestVersion $classIsLatestVersion 	
    						//usage: obj.$$$jsonClassIsLatestVersion()
    #define jsonExtends $extends							
    						//usage: {}.$$$jsonExtends(classname) 
    #define jsonFromJSON $fromJSON							
    						//usage: {}.$$$jsonFromJSON(string) 
    #define jsonGetIterator $getIterator 					
    						//usage: obj.$$$jsonGetIterator()
    #define jsonGetNext $getNext 					
    						//usage: iterator.$$$jsonGetNext(.key, .value)
    #define jsonIsA $isA									
    						//usage: obj.$$$jsonIsA(classname)
    #define jsonToJSON $toJSON								
    						//usage: obj.$$$jsonToJSON()
    #define jsonGet $get									
    #define jsonNew $new									
    						//usage: obj.$$$jsonGet(key)
    #define jsonIsDefined $isDefined						
    						//usage: obj.$$$jsonIsDefined(key) 
    #define jsonRemove $remove								
    						//usage: obj.$$$jsonRemove(key)
    #define jsonSet $set									
    						//usage: obj.$$$jsonSet(key, val)
    #define jsonSize $size									
    						// usage: obj.$$$jsonSize()
    #define jsonPop $pop									
    						//usage: obj.$$$jsonPop()
    #define jsonPush $push									
    						//usage: obj.$$$jsonPush(val) 
 	#define jsonAbstractClass %Library.AbstractObject
	#define jsonObjectClass %Library.Object
	#define jsonArrayClass %Library.Array
	#define jsonInitialArrayIndex 0
	#define jsonGetTypeOf $getTypeOf
    						//usage: obj.$$$jsonGgetTypeOf()
#endif


#def1arg jsonIsAbstract %IsA(##Quote($$$jsonAbstractClass))
							//usage: obj.$$$jsonIsAbstract
#def1arg jsonIsObject %IsA(##Quote($$$jsonObjectClass))
							//usage: obj.$$$jsonIsObject
#def1arg jsonIsArray %IsA(##Quote($$$jsonArrayClass))
							//usage: obj.$$$jsonIsArray
]]></Routine>


<Class name="App.Log">
<Super>%Persistent</Super>
<TimeChanged>65310,42070.872536</TimeChanged>
<TimeCreated>63685,63064.148177</TimeCreated>

<Parameter name="Null">
<Description>
Replacement for missing values</Description>
<Default>Null</Default>
</Parameter>

<Property name="EventType">
<Description>
Type of event</Description>
<Type>%String</Type>
<InitialExpression>"INFO"</InitialExpression>
<Parameter name="MAXLEN" value="10"/>
<Parameter name="VALUELIST" value=",NONE,FATAL,ERROR,WARN,INFO,STAT,DEBUG,RAW"/>
</Property>

<Property name="ClassName">
<Description>
Name of class, where event happened</Description>
<Type>%String</Type>
<Parameter name="MAXLEN"/>
</Property>

<Property name="MethodName">
<Description>
Name of method, where event happened</Description>
<Type>%String</Type>
<Parameter name="MAXLEN"/>
</Property>

<Property name="Source">
<Description>
Line of int code</Description>
<Type>%String</Type>
<Parameter name="MAXLEN"/>
</Property>

<Property name="UserName">
<Description>
Cache user</Description>
<Type>%String</Type>
<InitialExpression>$username</InitialExpression>
<Parameter name="MAXLEN" value="128"/>
</Property>

<Property name="Arguments">
<Description>
Arguments' values passed to method</Description>
<Type>%String</Type>
<Parameter name="MAXLEN"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="TimeStamp">
<Description>
Date and time</Description>
<Type>%TimeStamp</Type>
<InitialExpression>$zdt($h, 3, 1)</InitialExpression>
</Property>

<Property name="Job">
<Description>
Identifies the job from which this event was logged.</Description>
<Type>%String</Type>
<InitialExpression>$job</InitialExpression>
</Property>

<Property name="Message">
<Description>
User message</Description>
<Type>%String</Type>
<Parameter name="MAXLEN"/>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Property name="ClientIPAddress">
<Description>
User IP address</Description>
<Type>%String</Type>
<InitialExpression>..GetClientAddress()</InitialExpression>
<Parameter name="MAXLEN" value="32"/>
</Property>

<Index name="idxEventType">
<Type>bitmap</Type>
<Properties>EventType</Properties>
</Index>

<Index name="idxUserName">
<Type>bitmap</Type>
<Properties>UserName</Properties>
</Index>

<Index name="idxClassName">
<Type>bitmap</Type>
<Properties>ClassName</Properties>
</Index>

<Index name="idxTimeStamp">
<Type>bitslice</Type>
<Properties>TimeStamp</Properties>
</Index>

<Index name="idxClientIPAddress">
<Properties>ClientIPAddress</Properties>
</Index>

<Method name="GetClientAddress">
<Description>
Determine user IP address</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	// %CSP.Session source is preferable
	#dim %request As %CSP.Request
	If ($d(%request)) {
		Return %request.CgiEnvs("REMOTE_ADDR")
	}
	Return $system.Process.ClientIPAddress()
]]></Implementation>
</Method>

<Method name="AddRecord">
<Description>
Add new log event
Use via $$$LogEventTYPE().
Return ID log
Example do ##class(App.Log).AddRecord("I want", "log", "everything", "INFO", "actions", "users")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>ClassName:%String="",MethodName:%String="",Source:%String="",EventType:%String="",Arguments:%String="",Message:%String=""</FormalSpec>
<Implementation><![CDATA[
	try {
		Set record = ..%New()
		Set record.Arguments = Arguments
		Set record.ClassName = ClassName
		Set record.EventType = EventType
		Set record.Message = Message
		Set record.MethodName = MethodName
		Set record.Source = Source
		set sc=record.%Save()
		set:sc id=record.%Id()
	} catch err {
		set id=""
	}
	
	quit $g(id)
]]></Implementation>
</Method>

<Method name="GetMethodArguments">
<Description>
Entry point to get method arguments string </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>ClassName:%String,MethodName:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	Set list = ..GetMethodArgumentsList(ClassName,MethodName)
	Set string = ..ArgumentsListToString(list)
	Return string
]]></Implementation>
</Method>

<Method name="GetMethodArgumentsList">
<Description>
Get a list of method arguments</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>ClassName:%String,MethodName:%String</FormalSpec>
<ReturnType>%List</ReturnType>
<Implementation><![CDATA[
	Set result = ""
	Set def = ##class(%Dictionary.CompiledMethod).%OpenId(ClassName _ "||" _ MethodName)
	If ($IsObject(def)) {
		Set result = def.FormalSpecParsed
	}
	Return result
]]></Implementation>
</Method>

<Method name="ArgumentsListToString">
<Description>
Convert list of method arguments to string</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>List:%List</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	Set result = ""
	For i=1:1:$ll(List) {
		Set result = result _ $$$quote($s(i>1=0:"",1:"; ") _ $lg($lg(List,i))_"=") 
		_ ..GetArgumentValue($lg($lg(List,i)),$lg($lg(List,i),2))
		_$S(i=$ll(List)=0:"",1:$$$quote(";"))
	}
	Return result
]]></Implementation>
</Method>

<Method name="GetArgumentValue">
<ClassMethod>1</ClassMethod>
<FormalSpec>Name:%String,ClassName:%Dictionary.CacheClassname</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	If $ClassMethod(ClassName, "%Extends", "%RegisteredObject") {
		// it's an object
		Return "_##class(App.Log).SerializeObject("_Name _ ")_"
	} Else {
		// it's a datatype
		Return "_$g(" _ Name _ ","_$$$quote(..#Null)_")_"
	}
]]></Implementation>
</Method>

<Method name="SerializeObject">
<Description>
Serialize the object to json
obj - the object
gn - global link to save flow
mode - the storage mode of the object see: /csp/log/App.LogInfo.cls?WHAT=?
w ##class(App.Log).SerializeObject(obj,"^gn","sveta")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Object,gn="",mode=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	Return:'$IsObject(Object) Object
	if $ClassMethod(Object.%ClassName(1), "%Extends", "%Stream.Object") {
		d Object.Rewind() while '(Object.AtEnd) { 
			set:gn'="" @gn@($i(inc))=$zconvert(Object.Read(32000),"I","UTF8")
		}
		Return Object.%ClassName(1)_" %Extends %Stream.Object"
	} 
	Return ..WriteJSONFromObject(Object)
]]></Implementation>
</Method>

<Method name="WriteJSONFromObject">
<Description>
w ##class(App.Log).WriteJSONFromObject(b) ;format As %String = "aeos" ;aceloqtw</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>obj,format:%String="tw"</FormalSpec>
<ProcedureBlock>0</ProcedureBlock>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set tOldIORedirected = ##class(%Device).ReDirectIO()
    set tOldMnemonic = ##class(%Device).GetMnemonicRoutine()
    set tOldIO = $io
    try {
        set str = ""
        use $io::("^" _ $ZNAME)
        do ##class(%Device).ReDirectIO(1)
        do ##class(%ZEN.Auxiliary.jsonProvider).%ObjectToJSON(obj,,,format)
    } catch ex {
        set str = ""
    }
    if (tOldMnemonic '= "") {
        use tOldIO::("^" _ tOldMnemonic)
    } else {
        use tOldIO
    }
    do ##class(%Device).ReDirectIO(tOldIORedirected)
    return str

rchr(c)
    quit
rstr(sz,to)
    quit
wchr(s)
    do output($char(s))
    quit
wff()
    do output($char(12))
    quit
wnl()
    do output($char(13,10))
    quit
wstr(s)
    do output(s)
    quit
wtab(s)
    do output($char(9))
    quit
output(s)
    set str = str _ s
    quit
]]></Implementation>
</Method>

<Method name="Load">
<Description>
Download the context of Protocol global
Example: d ##class(App.Log).Load("^logMSWstack(3)")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>gn</FormalSpec>
<ProcedureBlock>0</ProcedureBlock>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Return:gn'["^"||('$d(@gn)) $$$OK
	set key = ""
	if gn'["varList" {
		set GN=$na(@gn@("varList"))
		For { set key=$order(@GN@(key)) quit:key=""
			continue:key["%%%$$LOG^%ETN"||(key["%AppLogId")
			if key="%zlog" {
				set keyzlog="" 
				for { set keyzlog=$order(@GN@(key,keyzlog)) 
					quit:keyzlog=""
					do LoadNode($na(@GN@(key,keyzlog)),keyzlog)
				}
			} else {
				do LoadNode($na(@GN@(key)),key)
			}
		}
	} else {
		do LoadNode(gn,$qs(gn,$ql(gn)))
	}
	Kill key,gn,GN
	Return $$$OK
LoadNode(GNkey,key)
	try {
		// If in the json there is a _class
		if $Get(@GNkey)["_class"":" {
			set @key = ..DeserializeObject($Get(@GNkey),$p($p($Get(@GNkey),"_class"":",2),$c(34),2))
		}
		else {
			set @key=$Get(@GNkey)
		}
	} catch e { set LastErrorLoad=$ze}
	q
]]></Implementation>
</Method>

<Method name="LoadContext">
<Description>
To load the context from the table Protocol</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Id</FormalSpec>
<ProcedureBlock>0</ProcedureBlock>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Return:'..%ExistsId(Id) $$$OK
	Set Obj = ..%OpenId(Id)
	Set Arguments = Obj.Arguments
	Set List = ..GetMethodArgumentsList(Obj.ClassName,Obj.MethodName)
	For i=1:1:$Length(Arguments,";")-1 {
		Set Argument = $Piece(Arguments,";",i)
		Set @$lg($lg(List,i)) = ..DeserializeObject($Piece(Argument,"=",2,*),$lg($lg(List,i),2))
	}
	Kill Obj,Arguments,Argument,i,Id,List
]]></Implementation>
</Method>

<Method name="DeserializeObject">
<ClassMethod>1</ClassMethod>
<FormalSpec>String,ClassName</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	If $ClassMethod(ClassName, "%Extends", "%RegisteredObject") {
		// it's an object
		Set st = ##class(%ZEN.Auxiliary.jsonProvider).%ConvertJSONToObject(String,,.obj)
		Return:$$$ISOK(st) obj
	}
	Return String
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^App.LogD</DataLocation>
<DefaultData>LogDefaultData</DefaultData>
<IdLocation>^App.LogD</IdLocation>
<IndexLocation>^App.LogI</IndexLocation>
<StreamLocation>^App.LogS</StreamLocation>
<Data name="LogDefaultData">
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>EventType</Value>
</Value>
<Value name="3">
<Value>ClassName</Value>
</Value>
<Value name="4">
<Value>UserName</Value>
</Value>
<Value name="5">
<Value>MethodName</Value>
</Value>
<Value name="6">
<Value>Arguments</Value>
</Value>
<Value name="7">
<Value>TimeStamp</Value>
</Value>
<Value name="8">
<Value>Message</Value>
</Value>
<Value name="9">
<Value>ClientIPAddress</Value>
</Value>
<Value name="10">
<Value>Source</Value>
</Value>
<Value name="11">
<Value>Job</Value>
</Value>
</Data>
</Storage>

<Query name="FindLog">
<Type>%SQLQuery</Type>
<SqlQuery>SELECT %ID,ClassName,ClientIPAddress,EventType,Message,MethodName,Source,TimeStamp,UserName FROM Log</SqlQuery>
<Parameter name="CONTAINID" value="1"/>
</Query>
</Class>


<Class name="App.LogInfo">
<IncludeCode>App.LogMacro</IncludeCode>
<Modified>0</Modified>
<Super>App.AutoPage</Super>
<TimeChanged>65317,30981</TimeChanged>
<TimeCreated>64621,44286.491046</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Parameter name="CSPURL">
<Default>App.LogInfo.cls</Default>
</Parameter>

<Parameter name="PAGENAME">
<Default>App.Tools</Default>
</Parameter>

<Parameter name="PARENTPAGE">
<Default>App.AutoPage.cls</Default>
</Parameter>

<Method name="GetDetailPane">
<Description>
Get the detail pane info object</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pInstance:%CSP.Util.PageInstance</FormalSpec>
<ReturnType>%CSP.Util.Pane</ReturnType>
<Implementation><![CDATA[	quit ##class(App.LogInfoPane).%New()
]]></Implementation>
</Method>

<Method name="ClearFields">
<Description>
To INPUT button to clear form fields
fields - field names separated by commas
w ##class(App.LogInfo).ClearFields("a,b")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>fields="",onclick</FormalSpec>
<Implementation><![CDATA[
	set res="<span class='ui-icon ui-icon-trash' name='clearFields' id='clearFields' onclick=""#"" title='clear form fields'></span>"
	for f=1:1:$l(fields,",") {
		continue:$p(fields,",",f)=""
		s onclick=$g(onclick)_"try{document.getElementById('"_$p(fields,",",f)_"').value=''}catch(e){};"
	}
	quit $replace(res,"#",$g(onclick,"alert('not fields');"))
]]></Implementation>
</Method>

<Method name="MarkRed">
<Description>
Mark in red the context in the original string
Source - the Source string
Mark - the context to mark a comma
w ##class(App.LogInfo).MarkRed("ssssazzzzbssss","a,b")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Source,Mark</FormalSpec>
<Implementation><![CDATA[
	set res=Source
	for f=1:1:$l(Mark,",") {
		continue:$p(Mark,",",f)=""
		s res=$replace(res,$p(Mark,",",f),"<font color=red>"_$p(Mark,",",f)_"</font>")
	}
	quit res
]]></Implementation>
</Method>

<Method name="IncludTags">
<Description>
To include in the string frame tag
Source - the Source string
Mark - the context of the phrases to insert this list
TagBeg, TagEnd - borders tag for each phrase needs to be your list
w ##class(App.LogInfo).IncludTags("ssssazzzzbssss","a,b",")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Source,Mark,TagBeg,TagEnd</FormalSpec>
<Implementation><![CDATA[
	set res=Source
	for f=1:1:$ll(Mark) {
		continue:$lg(Mark,f)=""
		s res=$replace(res,$lg(Mark,f),$lg(TagBeg,f)_$lg(Mark,f)_$lg(TagEnd,f))
	}
	quit res
]]></Implementation>
</Method>

<Method name="GetInputXLSTags">
<Description><![CDATA[
To obtain a set of input elements to discharge flow in Excel and sending by mail
w ##class(App.LogInfo).GetInputXLSTags()
To upload a XLS <input type="checkbox" name="exportXLS" id="exportXLS" #($s($g(exportXLS):"checked",1:""))#>]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>exportXLS,exportXLSfile,exportXLSfileEmail</FormalSpec>
<Implementation><![CDATA[
 &html<
 #($$$aText("Unload in",""))# XLS <input type="checkbox" name="exportXLS" id="exportXLS" >
 #($$$aText("file",""))# <input type="text" size=30 name="exportXLSfile" id="exportXLSfile" value="#($g(exportXLSfile))#">
 #($$$aText("and send on",""))# <input placeholder="email@mail.com,email2@mail.com" type="text" size=30 name="exportXLSfileEmail" id="exportXLSfileEmail" value="#($g(exportXLSfileEmail))#">
 >
 quit ""
]]></Implementation>
</Method>

<Method name="GetInputXLSTagsVal">
<Description>
To obtain the values of input elements to discharge flow in Excel and sending by mail
d ##class(App.LogInfo).GetInputXLSTagsVal(.exportXLS, .exportXLSfile, .exportXLSfileEmail)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>exportXLS,exportXLSfile,exportXLSfileEmail,SDNum,suffix=""</FormalSpec>
<Implementation><![CDATA[
	set:$d(%request) exportXLSfile=%request.Get("exportXLSfile")
	if $g(exportXLSfile)="" s exportXLSfile=$$$EMAILXLSPATH_$zd($h,3)_"_"_$tr($zt($p($h,",",2),1),":")_"_"_suffix_".xls"
	set:$d(%request) exportXLS=%request.Get("exportXLS")["on"
	set:$d(%request) exportXLSfileEmail=%request.Get("exportXLSfileEmail")
	if $g(exportXLSfileEmail)="" s exportXLSfileEmail=$$$EMAILSUPPORT
	set:$d(%request) SDNum=%request.Get("SDNum")
	quit ""
]]></Implementation>
</Method>

<Method name="SendEmail">
<Description>
To send a file to the user with the message
w ##class(App.LogInfo).SendEmail("mihaylenko_sv@mosvodokanal.ru", "Test", "Test message", "c:\temp\2019-01-16_32309.xls")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>supportemail="",subj="",msg="",file=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
		set subj=$$$aText("Server","")_" : "_$zu(110)_", "_subj
		set text="<html><head></head><body color=greay><h4>"_$$$aText("Hello","")_"</h4><br><br>"_$g(msg)
		set text=text_"</body></html>"
		// support
		if supportemail="" set supportemail=$$$EMAILSUPPORT		
		set email=supportemail //only 
		
		set authFrom=$$$EMAILAUTH
		set authFromPass=$$$EMAILAUTHPASS
		if file'="" {
			s path=$p(file,$$$slash,1,*-1)
			s file=$lb($p(file,$$$slash,1,*-1)_$$$slash,$p(file,$$$slash,*))
		}
		set sc=##class(App.net).SendMail($$$EMAILSERVERIP,$$$EMAILSERVERPORT, 0, 0, "", authFrom, authFromPass, authFrom, email_","_supportemail, subj, text,.file)
		if 'sc {
			w !,"Error "_$System.Status.GetErrorText(sc) 
			$$$AppLogTab("ERROR","()",$System.Status.GetErrorText(sc))
		}
		else { w !,$$$aText("Sent to","")_" "_email
		 	$$$AppLogTab("INFO","()",$$$FormatText($$$aText("Sent to %1 file %2",""),email,$g(file)))
		}
		quit sc
]]></Implementation>
</Method>

<Method name="GetInfoImg">
<Description>
w ##class(App.LogInfo).GetInfoImg("tools")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>code</FormalSpec>
<Implementation><![CDATA[	quit "<a title='to tools' target=tools href=""App.LogInfo.cls?NSP="_$zu(5)_"&WHAT="_$zconvert("?","O","URL")_""">"_##class(App.LogInfo).GetImg(code)_"</a>"
]]></Implementation>
</Method>

<Method name="GetImg">
<Description>
w ##class(App.LogInfo).GetImg("help")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>code</FormalSpec>
<Implementation><![CDATA[
	quit:code="help" "<span class='ui-icon ui-icon-help'></span>"
	quit:code="search" "<span class='ui-icon ui-icon-search'></span>"
	;quit:code="apptools" "<img src="""_$$$PATHCSP_"jqueryui/img/apptools-ico-lofel.ico"" width=""1%""/>" 
	;quit:code="apptools" "<img src="""_$$$PATHCSP_"jqueryui/img/apptools-ico.ico"" width=""1%""/>" ;gear
	quit:code="tools" "<span class='ui-icon ui-icon-wrench'></span>" ;gear
	quit:code="trash" "<span class='ui-icon ui-icon-trash'></span>"
	quit:code="check" "<span class='ui-icon ui-icon-check'></span>"
	quit:code="closethick" "<span class='ui-icon ui-icon-closethick'></span>"
	quit ""
]]></Implementation>
</Method>

<Method name="ExportProjects">
<Description>
Export all projects to XML</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Dir,files</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	$$$NspGoto(curNs,"AAA")
	d ..ExportAppProj(Dir,"app",.files)
	$$$NspReturn(curNs)
	d ##class(App.net).SendFilesToEmail($zn,Dir,.files)
	q $$$OK
]]></Implementation>
</Method>

<Method name="ExportAppProj">
<Description>
Export all projects to XML
d ##class(App.LogInfo).ExportProj("/backup/source/","app")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Dir,proj="",files</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	/*
The items to export.
Each of the items must have a type determined by an extension selected from the following list of basic types, additional types are supported under the abstract routine interface so this list is not exhaustive.

CLS - Classes
CSP - Cache Server Pages
CSR - Cache Rule files
MAC - Macro routines
INT - Non-macro routines
BAS - Basic routines
INC - Include files
GBL - Globals
PRJ - Studio projects
OBJ - Compiled object code
PKG - Package definitions
If exporting multiple items, separate them with commas, pass the items("item")="" as an array. You can also use ? or * wild cards and if you wish to exclude items pass ' before the item name which also supports wild card, e.g. "User.*.cls,'User.T*.cls".
	*/
	new $namespace
	try {
	s pFileName=Dir_$zu(110)_"-"_$zu(5)_"-"_proj_"-"_$tr(##class(App.type).GetDateTime($h),":T","-_")_".xml"
	s list("App*.CLS")=""
	s list("App*.INC")=""
	s list("App.ParameterD.GBL")=""
	s st=$SYSTEM.OBJ.Export(.list, pFileName)
	i st w !,pFileName s files(pFileName)=""

	k list
	s list("/apptools/*.*")=""
	s pFileName=Dir_$zu(110)_"-"_$zu(5)_"-"_proj_"-CSP-"_$tr(##class(App.type).GetDateTime($h),":T","-_")_".xml"
	s st=$SYSTEM.OBJ.Export(.list, pFileName)
	i st w !,pFileName s files(pFileName)=""

	k list
	s list("%App.Setting.GBL")=""
	s list("%AppCacheMsg.GBL")=""
	s list("%App.Proj.GBL")=""
	s list("%App.ParameterD.GBL")=""
	
	s pFileName=Dir_$zu(110)_"-"_$zu(5)_"-"_proj_"-AppSett-"_$tr(##class(App.type).GetDateTime($h),":T","-_")_".xml"
	s $namespace="%SYS"
	s st=$SYSTEM.OBJ.Export(.list, pFileName)
	i st w !,pFileName s files(pFileName)=""

	} catch e { w !,"Error: "_$ze}
	w !,$System.Status.GetErrorText(st)
	
	q $$$OK
]]></Implementation>
</Method>
</Class>


<Class name="App.LogInfoPane">
<IncludeCode>App.LogMacro</IncludeCode>
<Super>%CSP.Util.Pane</Super>
<TimeChanged>65395,36995</TimeChanged>
<TimeCreated>64621,44280.911124</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Method name="GetLink">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	s link="<link type=""text/css"" rel=""stylesheet"" href="""_$$$PATHCSP_"jqueryui/jsgrid/jsgrid.min.css"" />"_$c(13,10)_
	"<link type=""text/css"" rel=""stylesheet"" href="""_$$$PATHCSP_"jqueryui/jsgrid/jsgrid-theme.min.css"" />"_$c(13,10)_
	//"<link rel=""icon"" href="""_$$$PATHCSP_"jqueryui/favion.ico"" type=""image/x-icon""/>"_$c(13,10)_$c(13,10)_
	//"<link rel=""shortcut icon"" href="""_$$$PATHCSP_"jqueryui/favion.ico"" type=""image/x-icon""/>"_$c(13,10)_
	"<link type=""text/css"" rel=""stylesheet"" href="""_$$$PATHCSP_"uikit/css/uikit.min.css""/>"
	q " <link href="""_$$$PATHCSP_"jqueryui/jquery-ui.css"" rel=""stylesheet"">"_link_$c(13,10)
]]></Implementation>
</Method>

<Method name="AddJsScripts">
<Description>
Add libraries and functions js to the panel
write ##class(App.LogInfoPane).AddJsScripts() </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>mode</FormalSpec>
<Implementation><![CDATA[
	set scr="<script src="""_$$$PATHCSP_"jqueryui/external/jquery/jquery.js""></script>"_$c(13,10)_"<script src="""_$$$PATHCSP_"jqueryui/jquery-ui.js""></script>"_$c(13,10)_
	"<script src="""_$$$PATHCSP_"uikit/js/uikit.min.js""></script><script src="""_$$$PATHCSP_"uikit/js/uikit-icons.min.js""></script><script type=""text/javascript"" src="""_$$$PATHCSP_"jqueryui/jquery.blockui.js""></script>"_$c(13,10)
	set:$g(mode)["grid" scr=scr_"<script type=""text/javascript"" src="""_$$$PATHCSP_"jqueryui/jsgrid/jsgrid.min.js""></script>"_$c(13,10)
	set:$g(mode)["chart" scr=scr_"<script type=""text/javascript"" src="""_$$$PATHCSP_"jqueryui/chart.js""></script>"_$c(13,10)
	q scr_$c(13,10)
]]></Implementation>
</Method>

<Method name="AddJS">
<Description>
add javascript
/// /*! \example d ##class(App.LogInfoPane).AddJS("MSW")*/</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>ns="",class=""</FormalSpec>
<Implementation><![CDATA[
 	$$$jsstart	
 &js<	
$('#tWHAT').keydown(function (e) {
  	if (e.ctrlKey && e.keyCode == 13) {
    // Ctrl-Enter pressed
    document.getElementById('WHAT').value=document.getElementById('tWHAT').value;
    document.forms['loginfo'].submit();
   }
});
// 
function ActionJs(FormId,ResultId,appClass,appMethod,appPar,appNsp){
	var $data =[];
	;var appNspace ='#(ns)#';
	;if (!appNsp) {appNsp =appNspace;}
	var classname ='#(class)#';
	if (!appClass) var appClass =classname;
	if (FormId) {
		$data = $('#'+FormId).serializeArray(); 
		//alert(FormId);
	}
	//Add to array
	$data.push({name:"appClass",value:appClass});
	$data.push({name:"appMethod",value:appMethod});
	$data.push({name:"appNsp",value:appNsp});
	$data.push({name:"appPar",value:appPar});
	$.ajax({
	  url: 'App.Action.cls',
	  type: 'post',
	  data: $data,
	  crossDomain: true,
	  success: function(result) {
	  if (ResultId) {$('#'+ResultId).html(result);}
	  }
	});
}
// Collect data from the form, serialize, send to the server, execute and paste the result into the container
// FormId - source form identifier <form id='FormInpur'>...</form>
// ResultId -  identifier of the target container <div id='ResultDiv'>...</div>
// appAct -  parameters for executing code on the server
//     namespace:classname:methodname:par1=val1&par2=val2...&parX-valX
function AppAct(FormId,ResultId,appAct){
	var $data =[]; //json array initialization
	$data.push({name:"params",value:{}});
	if (FormId) { //if the form id is specified, then we collect all input elements from it
		// elements must have an id attribute matching the name.
		// For example <input type='text' id='elem2' name='elem2'>
		$data = $('#'+FormId).serializeArray();
	}
	$data.push({name:"appAct",value:appAct}); //add execution parameters that will be parsed in App.Action.cls
	//if (jsonExt) {
	//  if there is additional json, then add it
	//	$data.push({"jsonExt":jsonExt});
	//	}
	//var url1='App.Action.cls';	if (url2) { url1=url2;}
	//execute an asynchronous request to the App.Action.cls
	$.ajax({  
	  url: 'App.Action.cls',
	  type: 'post',
	  data: $data,
	  success: function(result) {  // if successful
	  	// if the resulting container is specified, put everything sent from the server into it
	  	if (ResultId) {$('#'+ResultId).html(result);}
	  }
	});
}
// Collect data from the form, serialize, send to the server, execute and paste the result into the container
// FormId - source form identifier <form id='FormInpur'>...</form>
// ResultId -  identifier of the target container <div id='ResultDiv'>...</div>
// appAct -  parameters for executing code on the server
//     namespace:classname:methodname:par1=val1&par2=val2...&parX-valX
//     namespace:routine:label:par1=val1&par2=val2...&parX-valX
function AppRpc(FormId,ResultId,appAct,url,json){
	var data ={"jsonrpc":"2.0",params:{}};
	
	if (FormId) {
		data.params.formId=FormId;
		data.params.form=JSON.stringify($('#'+FormId).serializeArray());
	}
	if (json) {
		data.params.json = json;
	}
	
	data.method=appAct;
	$.ajax({
	  url: url,
	  type: 'post',
	  contentType:'application/json; charset=UTF-8',
	  dataType:'html', 
	  crossDomain: true,
	  data: JSON.stringify(data),
	  success: function(result) {
	  if (ResultId) {
		  $('#'+ResultId).html(result);
	  }
	  else {
		  return result;
	  	}
	  }
	});
}

// The function of opening the dialog box
function WinOpen(ns,classname,met,el,title,rest) {
	
	var titlename="Method "+met+" parameter "+decodeURIComponent(el);
	if (title) {titlename=title;}

	//$("#dialogContent").load("App.Action.cls","appClass="+classname+"&appMethod="+met+"&appNsp="+ns+"&appPar="+el);
	
	if (rest) {AppRpc('anyForm','dialogContent',ns+':'+classname+':'+met+':'+decodeURIComponent(el),rest);}
	else { ActionJs('anyForm',"dialogContent",classname,met,el,ns);}
	$( "#dialog" ).dialog({
		modal: true, 
        title: titlename, 
        autoOpen: true, 
        width:window.innerWidth-200, 
        height:window.innerHeight-300,
		position: { my: 'top', at: 'top+150' },
		buttons: [
		{
			text: "Cancel",
			click: function() {
				$( this ).dialog( "close" );
			}
		}
		]
		});
	try { event.preventDefault();
	} catch (e){};
}
>
	$$$jsstop
]]></Implementation>
</Method>

<Method name="AddStyle">
<Description>
add javascript
/// /*! \example d ##class(App.LogInfoPane).AddStyle()*/</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
 &html<
 <style type="text/css">
 
 	/* https://habr.com/ru/post/453744/
table {
  overflow: hidden;
}

tr:hover {
  background-color: #ffa;
}

td, th {
  position: relative;
}
td:hover::after,
th:hover::after {
  content: "";
  position: absolute;
  background-color: #ffa;
  left: 0;
  top: -5000px;
  height: 10000px;
  width: 100%;
  z-index: -1;
}
*/

 
 /*
	div {
  max-width: 400px;
  max-height: 150px;
  overflow: scroll;
}
*/

/* Use position: sticky to have it stick to the edge
 * and top, right, or left to choose which edge to stick to: */

thead th {
  position: -webkit-sticky; /* for Safari */
  position: sticky;
  top: 0;
}

tbody th {
  position: -webkit-sticky; /* for Safari */
  position: sticky;
  left: 0;
}

/* To have the header in the first column stick to the left: */

thead th:first-child {
  left: 0;
  z-index: 1;
}


/* Just to display it nicely: */

thead th {
  background: #E7EBF9;

}

tbody th {
  background: #E7EBF9;

}

table {
  border-radius: 10px; 
  border: 1px solid #72a7cf
}

td,
th {
  padding: 0.5em;
}

.bigbox { 
height: 20px; width: 20px 
}
 
</style>
>
]]></Implementation>
</Method>

<Method name="Init">
<Description>
The method initializes the developer in the system
/// /*! \example d ##class(App.LogInfoPane).Init(,"MSW")*/</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>username=$username,fio="DEV"</FormalSpec>
<Implementation><![CDATA[	set @$$$MgtPortalSettings@($Username,"DeveloperName")=$g(fio,"DEV")
]]></Implementation>
</Method>

<Method name="DrawHEAD">
<Description>
Add libraries and functions js to the panel</Description>
<FormalSpec>pInstance:PageInstance</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	write ##class(App.LogInfoPane).GetLink()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="DrawBODY">
<Description>
Drawing the form to enter information</Description>
<FormalSpec>pInstance:PageInstance</FormalSpec>
<PublicList>nsp,what,field,value,type,typeclass,caption</PublicList>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	write ##class(App.LogInfoPane).AddJsScripts() 
	set $ZT="errors"
	set color="red"
	if $zu(110)=$$$TESTSERVER s color="blue" 
	set lang=%request.Get("AppLang")
	if lang'="",lang'=$g(@$$$GNEnsConf@("Language")) {
		do ##class(%MessageDictionary).SetSessionLanguage(lang) 
		set $$$SessionLanguageNode=lang 
		set @$$$GNEnsConf@("Language")=lang ;^||%Language=lang
	}
	set nsp=%request.Get("NSP")
	set what=$zstrip(%request.Get("WHAT"),"<>WC")
	if nsp'="" try {zn nsp set NSpace=nsp } catch e {}
	set NSpace=$zu(5)
	set Next=%request.Get("Next"),Filtr=%request.Get("Filtr")
	set:Next="" Next=1
	set MaxNode=%request.Get("MaxNode") 
	if 'MaxNode set MaxNode=$$$MAXSHOW
	if what=($$$HISTORYGN_"-") KILL @$$$HISTORYGN
	set:$e(what,*)="-" what=$e(what,1,*-1),exp="-"
	set:$e(what,*)="+" what=$e(what,1,*-1),Next="-1"
	if $p(what,"-p",2)?1n.n set exp=$p(what,"-p",2),what=$p(what,"-p")
	s (%DSN,DSN)=%request.Get("selectDSN")
	s SDNum=%request.Get("SDNum")

	//code to use when displaying tables
	s ExecuteDraw=%request.Get("ExecuteDraw") 
	s:$e(ExecuteDraw,1)="(" ExecuteDraw="##class"_ExecuteDraw_"(.%AppLogInfoVal,%AppLogInfoCol,%AppLogInfoHead,.%AppLogInfoTemp,"""_NSpace_""","""_DSN_""")"

	// Preparing variables for export to Excel
	d ##class(App.LogInfo).GetInputXLSTagsVal(.exportXLS, .exportXLSfile, .exportXLSfileEmail)
	d ..AddHistory(what,NSpace,DSN,MaxNode,Next,Filtr)
	if ($e(what,1)="^"),what'="^" {
		set gn=""
		if $e(what)="^" { set gn=what }
	}
	elseif what="?" {
		do ..GetHelp(.%help)
		// ExecuteArray = code for ison when outputting arrays
		set gn="%help",what="",Message=$$$aText("help command","")
		set ExecuteDraw="##class(App.LogInfoPane).DrawHelp(.%AppLogInfoVal,%AppLogInfoCol,%AppLogInfoHead,.%AppLogInfoTemp,"""_NSpace_""","""_DSN_""")"
	}
	#; queries and query results
	elseif ",query,result,select,s,q,r,begin,"[(","_$zconvert($p(what," ",1),"L")_",") {
			set sql=what
			i sql["p.party_id( )" s sql=$replace(sql,"p.party_id( )","p.party_id(+)")
	}
	#; SQL table query 
	elseif $e($zconvert($p(what," ",1),"L"),1,3)="log" {
		#; Delete the protocol table
		if $g(exp)="-" Do ##class(App.Log).%KillExtent() set msg=" "_$$$aText("Cleaned the protocol","")
		set (what,sql)="select * FROM App.Log order by id desc"
	}
	#; Run class methods
	elseif $p($zconvert(what,"L")," ",1)="xec" {
		s execute=$e(what,5,*)
	}
	#; Description of the class or instance of the class
	elseif $p($zconvert(what,"L")," ",1)="obj" { ;,$zconvert($e(what,1,2),"L")="##"||($zconvert($e(what,1,2),"L")="=#") {
		set classname=$p($p(what,"(",2),")",1)
		set id=$p($p(what,"%OpenId(",2),")",1) set:id[$c(34) id=$tr(id,$c(34))
		s Message=$$$aText("Class description","")_classname_"<br> "_$$$aText("An example of obtaining an array of descriptions","")_"<br>"_$zu(5)_">do ##class(App.LogInfoPane).GetClassDef("""_classname_""",,.out)"
		try { if id="" set Obj=$classmethod(classname,"%New"),id=0 
			  else  set Obj=$classmethod(classname,"%OpenId",id)
			if $isobject(Obj) {
				do ##class(App.LogInfoPane).GetClassDef(classname,Obj,.out)
	 			if $e($p(what," ",2,99))'="=" {
		 			do ##class(App.LogInfoPane).GetValueObj(Obj,.out,.out) m %obj(id)=out
	 			}
	 			else {
		 			 do ##class(App.LogInfoPane).GetValueObj(Obj,.out,.res) m %obj(id)=res
	 			}
			} else { d ##class(App.LogInfoPane).GetClassDef(classname,"",.out)
				merge %obj=out
				set:id'="" %obj="<font color=red>"_$$$FormatText($$$aText("Object with id = %1 Does not exist",""),id)_"</font>" 
			}
			set gn="%obj"
		} catch e {set gn="%err",%err=$zconvert($ze,"O","HTML")
		}
	}
	set title=$$$aText("Get help","")_" ?"
	set ver=""
	// Get a list of namespaces
	s listNs=##class(App.sys).ListNS(.info)
	s selectNS="<SELECT title="""_$$$aText("Namespace","")_""" name=""NSP"" id=""NSP""  ONCHANGE=""document.forms['loginfo'].submit();""> "
	for ns=1:1:$l(listNs,",") { continue:$p(listNs,",",ns)=""
		continue:$p(listNs,",",ns)["%ALL"
  		s selected=$select(NSpace=$p(listNs,",",ns):"selected",1:"")
  		s selectNS=selectNS_" <OPTION "_selected_" VALUE="""_$p(listNs,",",ns)_""">"_$p(listNs,",",ns)_"</OPTION>"
	}
	set listDSN=##class(App.sys).getSQLConnection(.listDSN)
	s selectNS=selectNS_"</SELECT>"
	s selectDSN="<SELECT title="""_$$$aText("DSN ODBC/JDBC","")_""" name=""selectDSN"" id=""selectDSN"" ><OPTION></OPTION> "
	for ns=1:1:$l(listDSN,",") { continue:$p(listDSN,",",ns)=""
		continue:$p(listDSN,",",ns)["%"
  		s selected=$select(DSN=$p(listDSN,",",ns):"selected",1:"")
  		s selectDSN=selectDSN_" <OPTION "_$g(selected)_" VALUE="""_$p(listDSN,",",ns)_""">"_$p(listDSN,",",ns)_"</OPTION>"
	}
	s selectDSN=selectDSN_"</SELECT>"
	
	&html<
	<!-- ui-dialog -->
	<div id="dialog" title="Dialog Title">
		<div id=dialogContent></div>
	</div>
		<form name="loginfo" id="loginfo">
		<table width="90%" style="border-radius: 10px; border: 1px solid #72a7cf" cellpadding="2" cellspacing="0" class="DetailTable" bgcolor="#c4d6d6" >
		<tr>
			<td>
				#(##class(App.LogInfo).GetImg("tools"))#
				 #(##class(App.LogInfoPane).GetSysinfo(color))#
				 <a target='ccons' name='ccons' href='#("/csp/sys/op/UtilSysConsoleLog.csp#bottom")#' id='Param'>#($$$aText("Console log",""))#</a>
				 <a target='TabsPM' name='TabsPM' href='#("App.TabsPanelUikitPermissMatrx.cls?autoload=Matrix")#' title='#($$$aText("Sample Application Access Matrix",""))#' id='Param'>#($$$aText("Access Matrix",""))#</a>
			</td>
		</tr>
		<tr>
			<td>
				#(selectNS)# #(selectDSN)#
				 | <a name='Hist' href='#("App.LogInfo.cls?NSP="_$zu(5)_"&Next=-1&WHAT="_$zconvert($$$HISTORYGN,"O","URL")_"")#' id='Hist'>#($$$aText("History",""))#</a>
				 | <a target='Explore' name='Explore' href='#("App.FormExp.cls?NSP="_$zu(5))#' id='Explorer'>#($$$aText("Selection Classes",""))#</a>
				 | <a target='ExploreTab' name='ExploreTab' href='#("App.FormExp.cls?panel=AccordionExp&NSP="_$zu(5))#'  id='ExplorerTab'>#($$$aText("Explorer tables",""))#</a>
				 | <a target='Param' name='Param' href='#("App.FormExp.cls?NSP="_$zu(5)_"&SelClass=App.Parameter")#' title='#($$$aText("Go to the options table",""))#' id='Param'>#($$$aText("Parameters",""))#</a>
				 | <a target='Tabs' name='Tabs' href='#("App.TabsPanelSample.cls")#' id='Param'>#($$$aText("Sample Tabs Application",""))#</a>
				 
				 | <a target='Chart' name='Chart'  id='Chart' href='#("App.Chart.cls?panel=class(App.ChartPanel).ChartDbSize&NSP="_$zu(5))#'>#($$$aText("Database growth Chart",""))#</a>
				 | <a target='ChartAlert' name='ChartAlert'  id='ChartAlert' href='#("App.Chart.cls?panel=class(App.ChartPanel).ChartAlert&NSP="_$zu(5))#'>#($$$aText("Event Chart",""))#</a>
 			 | 
 			</td>
		</tr>
		<tr> 
			<td>
				#($$AddExp(title,what,$g(Next),$g(Filtr),$g(MaxNode)))#
			</td>
		</tr>
			#(##class(App.LogInfoPane).AddProdQuery($g(SDNum)))#
		<tr>
			<td>
				<span class='ui-icon ui-icon-play' name="show" id="show" onclick="document.forms['loginfo'].submit();" >#($$$aText("Execute",""))#</span>
				<input type="submit" name="show2" id="show2" value='#($$$aText("Execute",""))#'>
				#(##class(App.LogInfo).GetInfoImg("help"))# 
	 			#(##class(App.LogInfo).ClearFields("NSP,MaxNode,Filtr,Next,WHAT,tWHAT,exportXLS,exportXLSfile,exportXLSfileEmail,selectDSN,SDNum"))# 
		 		#($$$aText("Upload to file Excel",""))#  
		 		<input type="checkbox" name="exportXLS" id="exportXLS" #($s($g(exportXLS22222):"checked",1:""))#>
				<input type="text" size=30 name="exportXLSfile" id="exportXLSfile" value="#($g(exportXLSfile))#">
				#($$$aText("and send to",""))# 
				<input placeholder="email@mail.com,email2@mail.com" type="text" size=30 name="exportXLSfileEmail" id="exportXLSfileEmail" value="#($g(exportXLSfileEmail))#">
			</td>
		</tr>
		<tr> 
			<td>
				#($$$DRAWAllApp)#
			</td>
		</tr>	
		</table>
		</form>
	>
	d ##class(App.LogInfoPane).AddJS(NSpace) 
	if $g(execute)'="" {
		write "<H3>"_$$$aText("Executing the command","")_" "_execute_"</H3>"
		x execute
		q $$$OK
	}
	if what="trm" {
		if ##class(App.sys).ClassExist("WebTerminal.Engine") {
			write !,"<iframe style='width:95%; height:70%' id='terminal"_NSpace_"' src='/terminal/?ns="_NSpace_"&clean=1' ></iframe>"
		}
		quit $$$OK
	}
	#; Post request
	if $p($zconvert(what,"L")," ",1)="post" {
		set posturl=$p($p(what," ",2,*),$C(13,10),1)
		set server=$p(posturl,"/",3)
		if $p(server,"@")'="" set user=$p($p(server,"@"),":"),pass=$p($p(server,"@"),":",2),server=$p(server,"@",2)
		set postbody=$p($p(what," ",2,*),$C(13,10),2,*)
		s st=##class(App.net).PostHttp(server, $p($p(posturl,"/",4,*),"?"),user ,pass ,postbody,.out)
		w st w "<pre>" zw:$d(out("Data")) out("Data") w "</pre>" q $$$OK
	}
	if $p($zconvert(what,"L")," ",1)="get" {
		set url=$p($p(what," ",2,*),$C(13,10),1)
		s st=##class(App.net).GetHttp(url,.out)
		w "<pre>" zw out w ! if $d(out("content")) { while '(out("content").AtEnd) { w $zconvert(out("content").ReadLine(),"O","HTML") }} w "</pre>" q $$$OK
	}

	$$$SDNum
	
	set obj=""
	#; arbitrary query
	if $g(sql)'="" {
		if DSN'="" {
			set gnTemp=$na(@$$$TEMPORYGN@($username))
			KILL @gnTemp
			if $G(listDSN(DSN))'="" set st=##class(App.sys).SaveGateway(sql,$G(listDSN(DSN)),%request.Get("User"),%request.Get("Password"),gnTemp,MaxNode) 
			else  set st=##class(App.sys).SqlToDSN(sql,DSN,gnTemp,MaxNode)
			if $d(@gnTemp) {
				set st=..DrawSQL("result "_gnTemp,MaxNode,NSpace,"DSN: "_DSN_", Query: <br>"_$g(sql),$g(ExecuteDraw),$lb(exportXLS,exportXLSfile,exportXLSfileEmail))
			}
		}
		else {
			if exportXLS=1 { ;Running in the background
				job ..DrawSQL(sql,MaxNode,NSpace,"NameSpace: "_NSpace_" "_$g(msg),$g(ExecuteDraw),$lb(exportXLS,exportXLSfile,exportXLSfileEmail))::1
				if $T W $$$aText("The request will be executed in the background","") s st=1
			} else {
				set st=..DrawSQL(sql,MaxNode,NSpace,"Namespace: "_NSpace_" "_$g(msg),$g(ExecuteDraw),$lb(exportXLS,exportXLSfile,exportXLSfileEmail))
			}
		}
		if $$$ISERR(st) write "<br>Error :"_##class(%CSP.Page).EscapeHTML(sql_"; "_$SYSTEM.OBJ.DisplayError(st))_"<br>"
	}
	#; If the output of Global
	elseif $G(gn)'="" {
		s a=$lb(gn,MaxNode,NSpace,Next,$g(Message),$g(exp),Filtr,$g(ExecuteDraw),exportXLS,exportXLSfile,exportXLSfileEmail)
		;d ##class(App.LogInfoPane).DrawGN(a) ;debug 
		if exportXLS=1 { ;Running in the background
			job ..DrawGN(a)::1
			i $T W $$$aText("The request will be executed in the background","") s st=1
		} else {
			set st=..DrawGN(a)
		}
	}
	elseif (nsp'="")!(what'="") {
		&html<<center><b>#($$$aText("Commands not defined",""))#</b></center>>
	}
	write "<br><br>"
	quit $$$OK
  	///Extra options
AddExp(title,gn,Next="",Filtr="",MaxNode) 
	write "<textarea rows=3 cols=130 onblur=""document.getElementById('WHAT').value=document.getElementById('tWHAT').value;"" name='tWHAT' title='"_title_"' placeholder='? "_$$$aText("enter the command and","")_" Ctrl-Enter' id='tWHAT'>"_($zconvert(gn,"O","HTML"))_"</textarea>"
	write "<br><input size=80 type='hidden' name='WHAT' title='"_title_"' id='WHAT' value="""_($zconvert(gn,"O","HTML"))_""" placeholder='?'>"
	write " <input title="""_$$$aText("Number of nodes","")_""" type=""text"" name=""MaxNode"" id=""MaxNode"" value='"_MaxNode_"' size=""10px"" > "_
	" <input type=""hidden"" name=""Next"" id=""Next"" value='"_Next_"' size=""0px"" > "
	quit:$e(gn,1)'="^" ""
	if Next<1 set ButtNext=$$$aText("Reverse Lookup",""),NewVal=1
	else  set ButtNext=$$$aText("Direct View",""),NewVal=-1
	quit " <input type=""button"" name=""ButtNext"" id=""ButtNext"" onclick=""document.getElementById('Next').value="_NewVal_";document.forms['loginfo'].submit();"" value='"_$g(ButtNext)_"' size=""50px"" > "_
	"<input size='30px' type='text' placeholder='"_$$$aText("Filter: command argument if","")_"' name='Filtr' title='%gn - "_$$$aText("current reference global. For example:","")_" %gn[""3)""||(@%gn[""123"")' id='Filtr' value='"_Filtr_"' >"
errors
 	write !,$ze
 	quit $$$OK
]]></Implementation>
</Method>

<Method name="DrawGN">
<Description>
d ##class(App.LogInfoPane).DrawGN(a)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>a</FormalSpec>
<Implementation><![CDATA[
	s $lb(gn, MaxNode, NSpace, Next, Message ,exp, Filtr, ExecuteDraw, exportXLS, exportXLSfile, exportXLSfileEmail)=a
		if gn["*" {
			set mask=$e(gn,2,*)
			set ExecuteDraw="##class(App.LogInfoPane).AddRefViewEditGlob(.%AppLogInfoVal, %AppLogInfoCol, %AppLogInfoHead, .%AppLogInfoTemp,"""_$zu(5)_""")"
		 	s sql="%SYS.GlobalQuery:NameSpaceList "_NSpace_" "_$s(mask="*":"",1:mask)
		 	s GN="^||tmpGList" k @GN
		 	d ##class(App.sys).SaveQuery(sql,GN,0)
		 	for i=1:1 { q:'$d(@GN@(sql,0,i))
		 		s nameGL=$g(@GN@(sql,0,i,1))
		 		s dir=$g(@GN@(sql,0,i,2))
		 		continue:nameGL[":"
		 		s order(nameGL)=i ;sorted
		 		s dir(dir)=$g(dir(dir))+1
		 		s dir(dir,nameGL)=i ;stored
		 	}
		 	if gn["**" {
			 	s dir="" ,query="%SYS.GlobalQuery:Size "_dir_" "_$s(mask="*":"",1:mask)
			 	s FastFlag=gn'["***"
			 	for { s dir=$o(dir(dir)) q:dir=""
			 		set s = ##class(%SQL.Statement).%New()
	 				do s.%PrepareClassQuery("%SYS.GlobalQuery","Size")
					set r = s.%Execute(dir,,mask,0,,FastFlag )
					s @GN@(sql,0,0,14)="Allocated MB"
					s:gn["***" @GN@(sql,0,0,15)="Used MB"
	 				while r.%Next() { 
						if $d(dir(dir,r.%Get("Name"))) { 
							s row=dir(dir,r.%Get("Name"))
							s @GN@(sql,0,row,14)=r.%Get("Allocated MB")
							s:gn["***" @GN@(sql,0,row,15)=r.%Get("Used MB")
							
						}
					}
			 	}
		 	}
		 	set st=..DrawSQL("result "_$na(@GN@(sql,0)),MaxNode,NSpace,"Namespace: "_NSpace_" on mask: "_mask,$g(ExecuteDraw),$lb(exportXLS,exportXLSfile,exportXLSfileEmail))
		}
		else {
			set st=..DrawArray(gn,MaxNode,NSpace,Next,$g(Message),$g(exp),Filtr,$g(ExecuteDraw),$lb(exportXLS,exportXLSfile,exportXLSfileEmail))
		}
		q $$$OK
]]></Implementation>
</Method>

<Method name="DrawHelp">
<Description>
code for ison when outputting arrays</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Val,Col,Head,Temp,nspace,DSN</FormalSpec>
<Implementation><![CDATA[
	set res=Val
	if Head {
		 s %AppCol2="40%"
		 q:Col=1 ""  
		 if Col=2 {
			set res=$$$aText("Command","")
		 }
		 if Col=3 {
			set res=$$$aText("Discription","")
		 }
	}
	else {
		if Col=1 {
			set res=""
		}
		if Col=2 {
			set res=$p(Temp,"---",1)
		}
		if Col=3 {
			set res=$p(Temp,"---",2)
		}
	}
	quit res
]]></Implementation>
</Method>

<Method name="AddRefViewEditGlob">
<Description>
Generate active links for viewing and editing globals</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Val,Col,Head,Temp,nspace,DSN</FormalSpec>
<Implementation><![CDATA[
	set res=Val
	if $g(Head) {
		if $g(Val)="Name" s Temp("Name",Col)=""
		if $g(Val)="Permission" s Temp("Permission",Col)=""
	}
	else {
		if $D(Temp("Name",Col)) {
			set %globalName=$s($e(Val,1)="%":"%25"_$e(Val,2,*),1:Val)
			if $g(%globalName)[":" q res
			set href="App.LogInfo.cls?NSP="_nspace_"&selectDSN=&WHAT=^"_Val
			set res=$replace(Val,Val,"<a title='viewGlob' target='viewGlob' href='"_href_"'>"_Val_"</a>")
		}
		if $D(Temp("Permission",Col)) {
			if $g(%globalName)[":" q res
			set:Val["R" href2="<a title='View' target='View' href=""/csp/sys/exp/UtilExpGlobalView.csp?$ID2="_%globalName_"&$NAMESPACE="_nspace_""">R</a>"
			set:Val["W" href3="<a title='Edit' target='Edit' href=""/csp/sys/exp/UtilExpGlobalDrill.csp?$ID2="_%globalName_"&$NAMESPACE="_nspace_""">W</a>"
			set res=$g(href2)_$g(href3)
		}
	}
	quit res
]]></Implementation>
</Method>

<Method name="DrawArray">
<Description>
Output a list of array elements
set st=##class(App.LogInfoPane).DrawArray(res,100,$zu(5),"Output a list 1111")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>gn:%String="",MaxNode=$$$MAXSHOW,NSpace="",Next="1",msg="",exp="",Filtr="",Execute="",fileXLS=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
		; Check if there is a record of the stack
		if $e(gn,1,4)=($$$logdevGN)||($e(gn,1,6)=("^mtemp"))||($e(gn,1,4)="^tmp") {
			if $e($g(exp))="-" {
				set:gn[$$$logdevGN stackGN=($$$logdevGN)_$e(gn,5,7)_"stack"
				set:gn["mtemp" stackGN=("^mtemp")_$e(gn,7,9)_"stack"	
				set:gn["tmp" stackGN="astack"	
				set jo=$g(@gn@(0)) KILL @gn,exp,@stackGN set:jo @gn@(0)=jo  
			}
			#; Clean and initialize the debug isolation node
			if $g(exp)?1n.n set job=exp KILL @gn@(1) if job,$d(^$j(+job)) set @gn@(0)=+job
			if gn["stack(",$qs(gn,1)?1n.n,$g(@gn)'="",$lv(@gn) {
				;$ze,$h,$tl,$io,$j,$zu(110),stack,ipRemote
				set stack=$lfs($lg(@gn,7),"|")
				set href="href='App.LogInfo.cls?NSP="_NSpace_"&WHAT="_$na(@$replace($qs(gn,0),"stack","")@(1,$qs(gn,1)))_"'"
				set anc="<a  title='"_$$$aText("Go to the protocol node","")_"' "_href_" >"_gn_"</a>"
				&html<
				<h1>View stack : #(anc)# <font color=red>$ze:</font> #($lg(@gn,1))#<font color=red> $h: </font>#($$$LoggedDT($lg(@gn,2)))#<font color=red> $tl: </font>#($lg(@gn,3))#<font color=red> $io: </font>#($lg(@gn,4))#<font color=red> $j: </font>#($lg(@gn,5))#<font color=red>  $zu(110):</font> #($lg(@gn,6))# <font color=red> IP-Adress: </font> #($lg(@gn,8))#</h1>
				<table style="border-radius: 10px; border: 1px solid #72a7cf"  cellpadding="2" cellspacing="0" class="DetailTable" bgcolor="#c4d6d6" ><tbody>
				<tr>
					<th align="left" width="5px">#</th>
					<th align="left" width="50px">Code Link</th>
					<th align="left" width="50px">Code string</th>
				</tr>
				>
				for line2=2:1:$ll(stack) {
					set line=$lg(stack,line2)
					try {	set code=$t(@$p(line," ")) }
					catch {	set code=""	}
					quit:code["s zsr=$zr,zsG=" ;not derive itself a trap
					&html<
					<tr>
						<td>#(line2)#</td>
						<td>#(line)#</td>
						<td>#(code)#</td>
					</tr>
					>
				}
				&html<</tbody></table>>
				set gn=$q(@gn)
			}
		} 
		if fileXLS'="",$lg(fileXLS,1) {
			d ..OpenXLSfile(fileXLS, .exportXLSfileEmail, .exportXLSfile, .io)
		}
		s num="#"
		s ref=$$$aText("reference","")
		s data=$$$aText("Data","")
		s %AppCol2="9%"
		if Execute'="" {
			s %AppLogInfoHead=1
			s %AppLogInfoTemp=data
			s num=..AddExecute(Execute,num, 1, NSpace = "",.countEx) 
			s ref=..AddExecute(Execute,ref, 2, NSpace = "",.countEx) 
			s data=..AddExecute(Execute,data, 3, NSpace = "",.countEx) 
		}
			&html<
			<h1>#($s(msg="":$$$aText("View array","")_" : "_gn_" "_$$$aText("in namespace","")_" "_$zu(5),1:msg))#</h1>
			<table width="90%" style="border-radius: 10px; border: 1px solid #72a7cf" cellpadding="2" cellspacing="0" class="DetailTable" bgcolor="#c4d6d6" ><tbody>
			<tr>
				<th title='Edit nodes and values global' align="left" width="1%">#(num)#</th>
				<th align="left" width="#(%AppCol2)#">#(ref)#</th>
				<th align="left" width="*">#(data)#</th>
			</tr>
			>
			set (igg,ig)=gn
			set count=0,test=0
			#; The first line
			if ig'="",$g(@ig)'="",Execute="" d ..DrawNodeGN(ig,@ig,.count,,ig,$g(NSpace))
  			// For local interest arrays viewing - direct
  			set next=$s($e(gn,1)="%":1,Next["-1":-1,1:1)
  			if MaxNode<$$$MAXSHOW set MaxNode=$$$MAXSHOW
  			if $g(next)=-1 {	
  				for count2=1:1 { set ig=$q(@ig) quit:ig=""||(ig'[$e(igg,1,*-1))  set iglast=ig 
  					Quit:count2>(MaxNode*2) ##; Twice the limit
  				}
  				if $g(iglast)'="" set ig=iglast
  			}
  			if ig'="" {
	  			if next=-1 { 
	  				set NoDraw=0
		  			if $g(Filtr)'="" set NoDraw=$$ExpTestFiltr(ig,Filtr) 
		  			if $p(ig,"(",1)=$$$HISTORYGN,$g(NSpace)'="%SYS" set:$lg(@ig,2)'=$g(NSpace) NoDraw=1
		  			do:'NoDraw ..DrawNodeGN(ig,$g(@ig),.count,,ig,$g(NSpace),Execute)
	  			}
	  			for { set ig=$q(@ig,$g(next)) 
	  				quit:ig=""||(ig'[$e(igg,1,*-1))
	  				if $g(Filtr)'="" continue:$$ExpTestFiltr(ig,Filtr)
	  				set node=$e($p(ig,$e(igg,1,*-1),2),2,*)
					if $p(ig,"(",1)=$$$HISTORYGN,$g(NSpace)'="%SYS" continue:$lg(@ig,2)'=$g(NSpace)
					do ..DrawNodeGN(node,@ig,.count,$g(job),ig,$g(NSpace),Execute)
					Quit:count>MaxNode
	  			}
  			}
  			&html<</tbody></table>>
	if $g(exportXLSfile)'="" { 
		d ..CloseXLSfile(fileXLS, .exportXLSfileEmail, .exportXLSfile,.io, .count, .msg, .gn)
	}  	
	i '$d(%DrawArray) {
		$$$jsstart
		w "$('.trs').hover(function(){ " // set the function when you hover the cursor over the element and during its lead	ui-state-hover
		w "  $(this).toggleClass( 'ui-widget-content' )" 
		w " });"
		$$$jsstop
	 s %DrawArray=1
	}
  	quit $$$OK
	##; Filter conditions on a node and values
ExpTestFiltr(%gn,Filtr) set %test=0
	xecute "i '("_Filtr_") set %test=$t"   
 	quit %test
]]></Implementation>
</Method>

<Method name="AddHistory">
<Description>
Add command history</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>what,NSpace,DSN,MaxNode,Next,Filtr</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	if $$$HISTORYGN_",?,trm,log"'[what {
		s val=$o(@$$$HISTORYGN@(""),-1),lastcmd=""
		i val'="",$lv($g(@$$$HISTORYGN@(val))) s lastcmd=$lg($g(@$$$HISTORYGN@(val)),1)
			i $g(lastcmd)'=what { // If the commands are not repeated
			s dt=$$$AppDT($h)
			set @$$$HISTORYGN@(dt)=$lb(what,NSpace,DSN,MaxNode,Next,Filtr)
		}
	}
]]></Implementation>
</Method>

<Method name="getNode">
<Description>
Get global node</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&node,gn,NSpace=""]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	if $e(gn,1,4)=($$$logdevGN),$e(node,1)="(",$e(gn,*-4,*)'="stack" {	
		set gnSt=$$$logdevGN_$e(gn,5,7)_"stack"
		set lev2=$qs("a"_node,2)
		try {
			if lev2'="",$d(@gnSt@(lev2)) {
					set href="href='App.LogInfo.cls?NSP="_NSpace_"&WHAT="_$na(@gnSt@(lev2))_"'"
					set title=$$$aText("Show call stack","")
					try {
						set lv=@gnSt@(lev2)
						set title=title_$c(13,10)_$$$LoggedDT($lg(lv,2))
					} catch e {}
					set node=$replace(node,","_lev2_",","<a title='"_title_"' "_href_" >,"_lev2_",</a>")
			}
		} catch e {}
	}
]]></Implementation>
</Method>

<Method name="DrawNodeGN">
<Description>
Drawing the global node</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[node:%String="",val:%String="",&count,job="",gn,NSpace="",Execute=""]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set count=count+1
	do ..getNode(.node, gn, NSpace)
	set node=..ShowCell(node,NSpace)
	if $e(gn,1,4)=($$$logdevGN) {
		if $qs(gn,3)["%%%$$LOG^%ETN" {	
			try { set d=$zd($lg(@gn,1),1),inc=$lg(@gn,2)
			} catch e { set d="",inc=""}
			set href="href='/csp/sys/op/UtilSysAppError.csp?$ID1="_$namespace_"&$ID2="_d_"&$ID3="_inc_"'"
			set title=$$$aText("Show stack and variables","")_$c(13,10)_d_" # "_inc
			set node=$replace(node,"%%%$$LOG^%ETN","<a  title='"_title_"' "_href_" >"_"%%%$$LOG^%ETN"_"</a>")
		} 
		// If there is a serialized object, then open the browse window.
		elseif $e(val,1)="{"&&($e(val,*)="}")||($e(val,1,4)="""\""{") {
			set href="style='"_$$$styleurl_"' onclick=""WinOpen('"_NSpace_"','','ShowJson','"_$zconvert(gn,"O","URL")_"','','"_##class(App.Action).WriteWinOpenREST(%request)_"');"""
			set title=$$$aText("Show formatted json","")
			set node="<a title='"_title_"' "_href_" >"_node_"</a> "
		}
		elseif $e(val,1)="<"&&($e(val,*)=">") {
			set href="style='"_$$$styleurl_"' onclick=""WinOpen('"_NSpace_"','','ShowXML','"_$zconvert(gn,"O","URL")_"','','"_##class(App.Action).WriteWinOpenREST(%request)_"');"""
			set title=$$$aText("Show","")_" XML"
			set node="<a title='"_title_"' "_href_" >"_node_"</a> "
			set val=$zconvert(val,"O","HTML")
		}
		elseif $e(val,1)="<" {
			set val=$zconvert(val,"O","HTML")
		}
	}
	#; for process detail and dashboard systems
	i job'="",val=job,node="(0)" {
		set url=$p($g(%request.CgiEnvs("HTTP_REFERER")),"/",1,3)_"/"
		set title=$$$aText("Process control","")
		set val=$replace(val,val,"<a title='"_title_"' target='process' href='"_url_"csp/sys/op/%25CSP.UI.Portal.ProcessDetails.cls?PID="_val_"&DISPLAYID=&$ID1="_val_"'>"_val_"</a>")
		set title=$$$aText("DBMS panel","")
		set val=val_" <a title='"_title_"' target='system' href='"_url_"csp/sys/op/UtilDashboard.csp?$NAMESPACE='>"_$zu(110)_"</a>"
	}
	elseif node["%AppLogId",$D(%request) {
		set url=$p($g(%request.CgiEnvs("HTTP_REFERER")),"/",1,3)_"/"
		set href="href='App.LogInfo.cls?NSP="_NSpace_"&WHAT="_$zconvert("select * from App.Log where id="_val,"O","URL")_"'"
		set node=$replace(node,"%AppLogId","<a title='Load record' "_href_">%AppLogId</a>")
	}
	else {	
		set val=..ShowCell(val,NSpace)	
	}
	set bgcolor="#c4d6d6"
	if node[",""="")" set bgcolor="white" 
	
	/// Parsing and coloring history
	if $p(gn,"(",1)=$$$HISTORYGN {
		set node=$replace(node,node,"<a href=""App.LogInfo.cls?NSP="_$lg(@gn,2)_"&Filtr="_$zconvert($lg(@gn,6),"O","URL")_"&Next="_$lg(@gn,5)_"&MaxNode="_$lg(@gn,4)_"&selectDSN="_$lg(@gn,3)_"&WHAT="_$zconvert($lg(@gn,1),"O","URL")_""" title='"_$$$aText("Load and run command","")_"'>"_node_"</a>")
		set val=$replace(val,"$lb(","$lb(<font color=red>")
		set val=$replace(val,$c(34)_","_$c(34),"</font>"_$c(34)_","_$c(34))
	}
	if Execute'="" {
		s %AppLogInfoHead=0
		s %AppLogInfoTemp=val
		s count=..AddExecute(Execute,count, 1, NSpace = "",.countEx) 
		s node=..AddExecute(Execute,node, 2, NSpace = "",.countEx) 
		s val=..AddExecute(Execute,val, 3, NSpace = "",.countEx) 
	}
	s count2="<span title='Edit' style='"_$$$styleurl_"' onclick=""WinOpen('"_NSpace_"','"_..%ClassName(1)_"','WinOpenEditNode','&node="_$zconvert(gn,"O","URL")_"','EditNode','"_##class(App.Action).WriteWinOpenREST(%request)_"');"" >"_count_"</span>"
	&html<
	<tr class=trs >
		<td align="left" >#(count2)#</td>
		<td align="left" >#(node)#</td>
		<td align="left" >#(val)#</td>
	</tr>
	>
]]></Implementation>
</Method>

<Method name="WinOpenEditNode">
<Description>
WinOpenEditNode</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set gn=$zconvert($g(Par("node")),"I","URL")
	if gn="" w $$$appError("Global link is empty") q
	if '$d(@gn) w $$$appError("Global node does not exist") q
	set PrefixIdDIV="WinOpenEdit"
	set Node=$$$appText(PrefixIdDIV_"Node","size=80",gn)
	set Value=@gn
	set:$lv(Value) Value=##class(%Global).Quote(Value)
	set Value=$$$appTextarea(PrefixIdDIV_"Value","rows=6 cols=80",Value)
	
	set onclick="ActionJs('"_PrefixIdDIV_"MainForm','"_PrefixIdDIV_"MainContent','"_..%ClassName(1)_"','WinOpenNodeSaveOrKill','~mode=*');"

	set bsave=$$$appButton(PrefixIdDIV_"idButtSave","onclick="""_$replace(onclick,"*","Save")_"""","Save")
	set bkill=$$$appButton(PrefixIdDIV_"idButtKill","onclick=""if (prompt('Delete you sure ?','Yes')) {"_$replace(onclick,"*","Kill")_"}""","Delete")
	&html<
	<center>
	<form id='#(PrefixIdDIV_"MainForm")#'>
		<table>
			<tr>
				<td style='text-align: right;'>Node</td>
				<td style='text-align: left;'>#(Node)#</td>
			</tr>
			<tr>
				<td style='text-align: right;'>Data</td>
				<td style='text-align: left;'>#(Value)#</td>
			</tr>
			<tr>
				<td style='text-align: right;'>#(bsave)#</td>
				<td style='text-align: left;'>#(bkill)#</td>
			</tr>
		</table>
	</form><div id='#(PrefixIdDIV_"MainContent")#'></div>
	</center>
	>
	q $$$OK
]]></Implementation>
</Method>

<Method name="WinOpenNodeSaveOrKill">
<Description>
WinOpenNodeSaveOrKill</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set gn=$g(Par("%request.Data","WinOpenEditNode"))
	set val=$g(Par("%request.Data","WinOpenEditValue"))
	if $g(Par("mode"))="Save" {
		s @gn=val
		w $$$appMsg("Saved") q
	}
	elseif $g(Par("mode"))="Kill" {
		k @gn	
		w $$$appMsg("Killed") q
	}
]]></Implementation>
</Method>

<Method name="AddExecute">
<Description>
Add an active link for the terminal</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[Execute,data,col,NSpace="",&countEx]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set %AppLogInfoVal=data
	set %AppLogInfoCol=col
	try {
		xecute "set %AppLogInfoVal2="_Execute
		if %AppLogInfoVal'=%AppLogInfoVal2 set countEx=$g(countEx)+1
		set %AppLogInfoVal=%AppLogInfoVal2
	}
	catch e { w $ze}
	quit %AppLogInfoVal
]]></Implementation>
</Method>

<Method name="AddClassRef">
<Description>
Add an active link to view the class description.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[class,&str,NSpace=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	q:'$d(%request)
	if ##class(%Dictionary.ClassDefinition).%ExistsId(class) { 
		set url=$p($g(%request.CgiEnvs("HTTP_REFERER")),"/",1,3)_"/"
		set str=$replace(str,class,"<a title='"_$$$aText("Download class description","")_"' href='"_url_"csp/documatic/%25CSP.Documatic.cls?LIBRARY="_NSpace_"&CLASSNAME="_class_"'>"_class_"</a>")
	}
]]></Implementation>
</Method>

<Method name="AddClassId">
<Description>
Add an active link to view a class instance.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[classname,id,&str,NSpace=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if ##class(%Dictionary.ClassDefinition).%ExistsId(classname) { 
		try {set Obj=$classmethod(classname,"%OpenId",id)
			if $isobject(Obj) {
				set what="obj =##class("_classname_").%OpenId("_id_")"
			}
		} catch e {	}
		quit:$g(what)=""
		set href="href='App.LogInfo.cls?NSP="_NSpace_"&WHAT="_$zconvert(what,"O","URL")_"'"
		set str=$replace(str,"_id"":"_id,"<a title='"_$$$aText("Download a class instance","")_"' "_href_">"_"_id"":"_id_"</a>")
	}
]]></Implementation>
</Method>

<Method name="ShowCell">
<Description>
Cell drawing</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>str,NSpace=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set:$lv(str) str=##class(%Global).Quote(str)
	/*
	if $l(str,".")>2 {
		; TODO cycle through the line if there are a lot of classes
		if $p($p(str,"(",2),")",1)["." {
			set class=$p($p(str,"(",2),")",1)
			if class'="" d ..AddClassRef(class, .str, NSpace)
		}
	}*/
	if str["_class"":" {
			set class=$p($p(str,"_class"":",2),$c(34),2)
			set id=$p($p(str,"_id"":",2),",",1)
			if class'="" {
				if id'="" do ..AddClassId(class, id, .str, NSpace)
				else  d ..AddClassRef(class, .str, NSpace)
			}
	}
	;Add a link to go to the view stack
	elseif str["(",$e(str,1,4)=$$$logdevGN,str'["<a title" {
		set node="("_$p(str,"(",2,*)
		do ..getNode(.node, str, NSpace)
		quit $p(str,"(",1)_node
	}
	else {
		quit str
	}
	quit str
]]></Implementation>
</Method>

<Method name="OpenXLSfile">
<Description>
Open file XLS</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[fileXLS,&exportXLSfileEmail,&exportXLSfile,io]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	s exportXLSfileEmail=$lg(fileXLS,3)
	s exportXLSfile=$lg(fileXLS,2)
	set io=$i
	if '##class(App.files).OpenFile(exportXLSfile,1) use io write !,$$$aText("Do not open file","")_" "_exportXLSfile quit
	use exportXLSfile	
	&html<
	<html xmlns:v="urn:schemas-microsoft-com:vml"
	xmlns:o="urn:schemas-microsoft-com:office:office"
	xmlns:x="urn:schemas-microsoft-com:office:excel"
	xmlns="http://www.w3.org/TR/REC-html40">
	<head>
	<meta http-equiv=Content-Type content="text/html; charset=utf-8">
	<meta name=ProgId content=Excel.Sheet>
	<meta name=Generator content="Microsoft Excel 15">
	</head>
	<body>
	>
	quit
]]></Implementation>
</Method>

<Method name="CloseXLSfile">
<Description>
Close file XLS</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[fileXLS,&exportXLSfileEmail,&exportXLSfile,io,count,msg,SQL]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	&html<	
	</body>
	</html>>
	use io close exportXLSfile
	s slash=##class(App.files).getSlash()
	s path=$p(exportXLSfile,slash,1,*-1)
	s sc=##class(App.files).zipFile(path,$p(exportXLSfile,slash,*),$p(exportXLSfile,slash,*)_".zip",path)
	if sc s exportXLSfile=exportXLSfile_".zip"
	;i 'sc ;s $$$AppL("APP","CloseXLSfile-zipFile")=$System.Status.GetErrorText(sc) 
	// Send file to e-mail
	i exportXLSfileEmail'="" {
		s sc=##class(App.LogInfo).SendEmail(exportXLSfileEmail, $$$aText("Send file","")_" "_exportXLSfile, $g(msg)_"<br> "_$$$aText("Namespace","")_" :"_$zu(5)_"<br> "_$$$aText("Query","")_": "_SQL, exportXLSfile)
		;i 'sc ;s $$$AppL("APP","CloseXLSfile-SendEmail")=$System.Status.GetErrorText(sc) 
		}
	write !,"<br><h3>"_$$$aText("Query result","")_" ("_(+count)_" "_$$$aText("lines) uploaded to file","")_" "_exportXLSfile_"</h3>"
	quit
]]></Implementation>
</Method>

<Method name="DrawSQL">
<Description>
Query table output
fileXLS - list of parameters for uploading to Excel and sending by mail
 $lg(fileXLS,1) =1 flag 
	s exportXLSfileEmail=$lg(fileXLS,3) - parcel addresses separated by commas, to which to send the file
	s exportXLSfile=$lg(fileXLS,2) - full path to the file where to write the table</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>SQL:%String="",MaxNode=$$$MAXSHOW,NSpace="",msg="",Execute="",fileXLS="",Mode=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	if ($zconvert($e(SQL,1),"L")="q") {
		try { set st=1
			if $e($p(SQL," ",2,99),1,2)="##" {
				x "set %q2="_$p(SQL," ",2)
				set query=%q2
			}
			else {
				set query=##class(%Library.ResultSet).%New($p(SQL," ",2))
			}
			if $p(SQL," ",4)'="" {set st=query.Execute($p(SQL," ",3),$p(SQL," ",4))}
			elseif $p(SQL," ",3)'="" {set st=query.Execute($p(SQL," ",3))}
			else {set st=query.Execute()}
			set msg=SQL
		} catch e { 
			set errmsg=SQL_" "_$$$aText("Error","")_" "_$ze q ;$$$ERROR($$$GeneralError,msg) 
		}
		quit:'st st
		quit:$g(errmsg)'="" errmsg
	}
	elseif ($zconvert($e(SQL,1),"L")="r") {
		set resGN=$p(SQL," ",2,99)
		if '$d(@resGN) {
			set msg=SQL_" "_$$$aText("Link does not exist",""),ColCount=0
		}
		else {
			i $g(@resGN@(0))'="" {
				s ColCount=$ll(@resGN@(0)) //for local sql
			}
			else {
				 s ColCount=$o(@resGN@(0,""),-1)  //for sql via DSN
			}
		}
	}
	else {
		set query=##class(%ResultSet).%New()
		set st=query.Prepare(SQL)
		if 'st quit st
		set st=query.Execute()
		if 'st quit st
	}
	set (count)=0
	if $g(resGN)="" set ColCount=query.GetColumnCount()
	
	if fileXLS'="",$lg(fileXLS,1) {
		d ..OpenXLSfile(fileXLS, .exportXLSfileEmail, .exportXLSfile, .io)
	}

	&html<
	<h7>#($s(msg'="":msg,1:"Query: "_SQL))#</h7>
	<table style="border-radius: 10px; border: 1px solid #72a7cf" cellpadding="2" cellspacing="0" class="DetailTable" bgcolor="#c4d6d6" width="90%">
	<thead>
		<tr class=trs >
		>
	if 'Mode write "<th width=""1%"">#</th>"
	
	s %AppLogInfoHead=1 //Processing title
	For i=1:1:ColCount {
		&html<	<th width="5%">>
		set %AppLogInfoCol=i
		if $g(resGN)'="" {
			if $d(@resGN@(0,i)) {set %AppLogInfoVal=$g(@resGN@(0,i))	if $lv(%AppLogInfoVal) set %AppLogInfoVal=$lg(%AppLogInfoVal,1)
			}
			else { set %AppLogInfoVal=$lg($g(@resGN@(0)),i)
			}
		}
		else {
			set %AppLogInfoVal=query.GetColumnName(i)
		}
			if Execute'="" {
				try {
					xecute "set %AppLogInfoVal2="_Execute
					if %AppLogInfoVal'=%AppLogInfoVal2 set countEx=$g(countEx)+1
					set %AppLogInfoVal=%AppLogInfoVal2
				}
				catch e {
					set %AppLogInfoVal=$zconvert($ze,"O","HTML")
					}
			}
			else {set %AppLogInfoVal=..ShowCell(%AppLogInfoVal,NSpace)	
			}
			write %AppLogInfoVal
		&html<&nbsp;</th>>	
	}
	&html<	</tr></thead><tbody>	>
	s %AppLogInfoHead=0 //We process lines
	if $g(resGN)'="" { set i=0
		for { set i=$order(@resGN@(i))   quit:i=""
			for ii=1:1:ColCount set GetData(ii)=$s($lv($GET(@resGN@(i),"?")):$lg(@resGN@(i),ii),1:$GET(@resGN@(i,ii)))
			d qNext(.GetData) q:$g(stopWrite)
		}
	}
	else {
		while query.Next() { 
			for ii=1:1:ColCount set GetData(ii)=query.GetData(ii)
			d qNext(.GetData) q:$g(stopWrite)
		}
	}
	&html<</tbody></table>>
	if msg=" " {}
	else {
		Write !,$$$aText("Number of records found","")_" :"_+$g(count)
		if Execute'="" {
			Write !,$$$aText("Contextual changes or allotments","")_" :"_+$g(countEx)
		}
	}
	if $g(exportXLSfile)'="" { 
		d ..CloseXLSfile(fileXLS, .exportXLSfileEmail, .exportXLSfile,.io, .count, .msg, .SQL)
	}
	;Set the hover for table rows
	i '$d(%DrawSQL) {
	$$$jsstart
		w "$('.trs').hover(function(){ " // set the function when you hover the cursor over the element and during its lead	ui-state-hover
		w "  $(this).toggleClass( 'ui-widget-content' )" 
		w " });"
	$$$jsstop
	 s %DrawSQL=1
	}
	quit $$$OK
 // Handling one query string
qNext(GetData)
		set count=count+1
		write "<tr class=trs >"
		if 'Mode write "<th>"_(count)_"</th>"
		if count>MaxNode w "<th style='color:red'>... "_$$$aText("More entries","")_" "_MaxNode_"</th></tr>" s stopWrite=1 QUIT
		for ii=1:1:ColCount {	
			set %AppLogInfoVal=$g(GetData(ii))
			set %AppLogInfoCol=ii
			if Execute'="" {
				try {
					xecute "set %AppLogInfoVal2="_Execute
					if %AppLogInfoVal'=%AppLogInfoVal2 set countEx=$g(countEx)+1
					set %AppLogInfoVal=%AppLogInfoVal2
				}
				catch e {}
			}
			else {
				set %AppLogInfoVal=..ShowCell(%AppLogInfoVal,NSpace)	
			}
			if $g(exportXLSfile)'="",%AppLogInfoVal?1.N s %AppLogInfoVal="&nbsp;"_%AppLogInfoVal
			write "<t"_$s(ii=1:"h",1:"d")_">"_(%AppLogInfoVal)_"</t"_$s(ii=1:"h",1:"d")_">"	
		}
			&html<</tr> >
	quit
]]></Implementation>
</Method>

<Method name="GetPathStack">
<Description>
Get call stack</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set $ECODE=""
	set Path=""
	for loop=0:1:$STACK	{
		if Path'="" set Path=Path_"~"
		set Path=Path_$case(Path,"":"",:"|")_$STACK(loop,"PLACE")
		if $l(Path)>32000 quit
	}
	set Path=$tr(Path,$c(9),"")
	quit Path
]]></Implementation>
</Method>

<Method name="GetValueObj">
<Description><![CDATA[
/*! \brief The method implements getting values
<br>\defgroup class_definition Class definition
<br>\ingroup class_definition
<br>\param in - class property description
<br>\param out - result of values 
<br>\example 	d ##class(App.LogInfoPane).GetClassDef(classname,Obj,.out)
<br>	 				d ##class(App.LogInfoPane).GetValueObj(Obj,.out,.res) */]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>obj,in,out</FormalSpec>
<Implementation><![CDATA[
	set p="" for  { set p=$o(in(p)) quit:p=""
		set n="" for { set n=$o(in(p,n)) quit:n=""
			try {
				set val=$c(1,2,3)
				if p="Methods" { i n'="getname" continue:$e(n,*-2,*)'="Get"
					set val=$METHOD(obj,n)
				}
				elseif p="Parameters" { 
					set val=$PARAMETER(obj,n)
				}
				elseif p="Properties" { 
					set val=$PROPERTY(obj, n)
				}
				set:val'=$c(1,2,3) out(p,n,"=")=val
			}
			catch (e) {
			}
		}
	}
	quit $$$OK
]]></Implementation>
</Method>

<Method name="GetClassDef">
<Description><![CDATA[
/*! \brief Parse class description into methods and properties
<br>\ingroup class_definition
\example d ##class(App.LogInfoPane).GetClassDef("utils.Log","",.out) */]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[aClassName:%String="",doc,&out,inSuper=1]]></FormalSpec>
<Implementation><![CDATA[
	if $g(doc)'="", $isobject(doc) set aClassName=doc.%ClassName(1)
	set classDefinition=##class(%Dictionary.ClassDefinition).%OpenId(aClassName)
	if ('$isobject(classDefinition)) {
		quit $g(%objlasterror)
	}

	// class description
	set classDescription=$zstrip(classDefinition.Description,"<>W")
	set out("ClassName",aClassName)=classDescription
	if classDefinition.Super'="" {
		set out("ClassName",aClassName,"super")=classDefinition.Super
		if inSuper {
			for sup=1:1:$l(classDefinition.Super,",") {  continue:$p(classDefinition.Super,",",sup)=""
				do ..GetClassDef($p(classDefinition.Super,",",sup),,.out)
			}
		}
	}
	// description of methods
	if (classDefinition.Methods.Count()>0) {
		set key=""
		while(1) {
			set methodDefinition=classDefinition.Methods.GetNext(.key)
			quit:(key="")
			set out("Methods",methodDefinition.Name,"Description")=methodDefinition.Description
		} 
	}
	// Property descriptions
	if (classDefinition.Properties.Count()>0) {
		set key=""
		while(1) {
			set propertyDefinition=classDefinition.Properties.GetNext(.key)
			quit:(key="")
			set out("Properties",propertyDefinition.Name,"Description")=propertyDefinition.Description
			set out("Properties",propertyDefinition.Name,"Name")=propertyDefinition.Name
			set out("Properties",propertyDefinition.Name,"Type")=propertyDefinition.Type
			set out("Properties",propertyDefinition.Name,"ReadOnly")=propertyDefinition.ReadOnly
			set out("Properties",propertyDefinition.Name,"Required")=propertyDefinition.Required
			set out("Properties",propertyDefinition.Name,"Parameters")=$$$AppObJs(propertyDefinition.Parameters)
		}
	}
	// Parameter Descriptions
	if (classDefinition.Parameters.Count()>0) {
		set key=""
		while(1) {
			set parameterDefinition=classDefinition.Parameters.GetNext(.key)
			quit:(key="")
			set out("Parameters",parameterDefinition.Name,"Description")=parameterDefinition.Description
			set out("Parameters",parameterDefinition.Name,"Default")=parameterDefinition.Default
		}
	}
	q $$$OK
]]></Implementation>
</Method>

<Method name="GetSysinfo">
<Description>
 d ##class(App.LogInfoPane).GetSysinfo()</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>color</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set sys=" <a target='license' href=""/csp/sys/op/UtilDashboard.csp?$NAMESPACE=%25SYS""> "_$$$aText("System Dashboard","")_"</a>"
	set sysinfo=" "_$$$aText("Server","")_": <font color="_color_">"_$zu(110)_"</font> "_$$$aText("NameSpace","")_": <font color="_color_">"_$zu(5)_"</font> $JOB: <font color="_color_">"_$j_"</font> "_$g(sys)
	set lang=$g(@$$$GNEnsConf@("Language"))
	if lang="" s lang=##class(%MessageDictionary).GetSessionLanguage()
	set list=##class(%MessageDictionary).GetLanguages()
	set key=$lb(""),gGN=""
	for i=1:1:list.Count() {
		s key=key_$lb(list.GetAt(i))
	}
	if 'list.Count() s key=$lb($mvv(58))
	do ##class(App.Form).SelectField(key,"document.getElementById(""AppLang"").value=this.options[this.selectedIndex].value;document.forms[""loginfo""].submit();",key,.gGN,,"ChangeLang",lang,50,1)
	set key="" for i=1:1 {q:'$DATA(gGN(i))  s key=key_gGN(i)}
	q sysinfo_" <input type='hidden' id='AppLang' name='AppLang'>"_key
]]></Implementation>
</Method>

<Method name="AddAction">
<Description>
/*! \example d ##class(App.LogInfoPane)AddAction()*/</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>nameElem="NSP,MaxNode,Filtr,Next,WHAT,tWHAT,exportXLS,exportXLSfile,exportXLSfileEmail,selectDSN,SDNum"</FormalSpec>
<Implementation><![CDATA[
	&html<
	<table>
	 <tr style='vertical-align: middle;' >
	   <td>
		<span class='ui-icon ui-icon-play' name="show" id="show" onclick="document.forms['loginfo'].submit();" title='#($$$aText("Execute and Show",""))#'></span>
		<input type="submit" name="show" id="show" value='#($$$aText("Execute",""))#'>
		<span class='ui-icon ui-icon-arrowreturnthick-1-w' onclick='window.history.back(); return false' title='#($$$aText("Go back",""))#'></span>
		#(##class(App.LogInfo).ClearFields(nameElem))# 
	  </td>
	  <td>
	  	#(##class(App.LogInfo).GetInfoImg("tools"))# 
	 </td>
    </tr>
   </table>
	>
	q ""
]]></Implementation>
</Method>

<Method name="AddProdQuery">
<Description>

/*! \example ##class(App.LogInfoPane).AddProdQuery() */</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>SDNum,csp="csp"</FormalSpec>
<Implementation><![CDATA[
	&html< <tr style='vertical-align: middle;' >
	<td> | <a target="ensprod" href='#("/"_csp_"/"_$zconvert($zu(5),"L")_"/EnsPortal.ProductionConfig.zen?$NAMESPACE="_$zu(5))#' > #($$$aText("Production",""))#</a> 
	 | <a target="ensproderr" href='#("/"_csp_"/"_$zconvert($zu(5),"L")_"/EnsPortal.EventLog.zen?$NAMESPACE="_$zu(5))#' > #($$$aText("Production Errors",""))#</a> 
	 | <a target="ensqueues" href='#("/"_csp_"/"_$zconvert($zu(5),"L")_"/EnsPortal.Queues.zen?$NAMESPACE="_$zu(5))#' > #($$$aText("Production Queues",""))#</a> 
	 | <a target="query" href='#("/csp/sys/exp/%25CSP.UI.Portal.SQL.Home.zen?$NAMESPACE="_$zu(5))#' > #($$$aText("Query",""))# </a> 
	 | <a target="globals" href='#("/csp/sys/exp/%25CSP.UI.Portal.GlobalList.zen?$NAMESPACE="_$zu(5))#' > #($$$aText("Globals",""))# </a> 
	#($s(##class(App.sys).ClassExist("WebTerminal.Engine"):" | "_$$$addAppLog($$$aText("WebTerminal",""),$$$aText("Load WebTerminal",""),"trm",""),1:""))#
	 | 
	</td></tr>>
	q ""
]]></Implementation>
</Method>

<Method name="ExportProjects">
<ClassMethod>1</ClassMethod>
<FormalSpec>Dir,files</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	q $$$OK
]]></Implementation>
</Method>

<Method name="GetHelp">
<ClassMethod>1</ClassMethod>
<FormalSpec>help</FormalSpec>
<Implementation><![CDATA[
	#define sH(%msg) set help($i(help))=%msg
	$$$sH($$$aText("Call examples",""))
	$$$sH(" ")
	$$$sH(" "_$$$addAppLog("^%App.Setting","","^%App.Setting","")_" --- "_$$$aText("View global with the basic settings panel",""))
	$$$sH(" "_$$$addAppL("obj ##class(App.Log).%New()")_" --- "_$$$aText("To obtain information on the class",""))
	$$$sH(" "_$$$addAppL("obj ##class(App.Log).%OpenId(2)")_" --- "_$$$aText("To obtain information on class and object",""))
	$$$sH(" "_$$$addAppL("obj =##class(App.Log).%OpenId(2)")_" --- "_$$$aText("To obtain information only on the object values",""))
	$$$sH(" ")
	$$$sH(" "_$$$addAppL("xec set obj=##class(App.Log).%OpenId(2) write ""<pre>"" zw obj w ""</pre>"" ")_"--- "_$$$aText("Execute command : to Show dump of the object ",""))
	$$$sH(" "_$$$addAppL("xec do ##class(App.sys).SaveQuery(""%SYSTEM.License:Counts"",""^GN"",0)")_"--- "_$$$aText("Run the command : Save the query result in the global ^GN",""))
	$$$sH(" "_$$$addAppL("result ^GN(""%SYSTEM.License:Counts"",0)")_" --- "_$$$aText("Bring recorded in the global result of the query","")_" ##class(App.sys).SaveQuery")
	$$$sH(" ")
	$$$sH(" "_$$$addAppL("query ##class(%Library.ResultSet).%New(""%SYS.Portal.Users:List"")")_"--- "_$$$aText("Run the query and show the favorites page for the user",""))
	$$$sH(" "_$$$addAppL("query ##class(%Library.ResultSet).%New(""%SYSTEM.License:Counts"")")_"--- "_$$$aText("Run the query and show license usage",""))
	$$$sH(" "_$$$addAppL("query %SYSTEM.License:Counts")_"--- "_$$$aText("Run the query and show license usage",""))
	$$$sH(" "_$$$addAppL("query %SYS.GlobalQuery:NameSpaceList USER")_" --- "_$$$aText("show the list globalaw in the USER area",""))
	$$$sH(" "_$$$addAppL("query %SYS.GlobalQuery:Size /opt/isc/ensemble/mgr/USER/")_" --- "_$$$aText("to calculate the size globalaw our database USER",""))
	$$$sH(" ")
	$$$sH(" "_$$$addAppL("select * FROM App.Log order by id desc")_" --- "_$$$aText("To execute arbitrary sql query",""))
	$$$sH(" ")
	set fio=$g(@$$$MgtPortalSettings@($Username,"DeveloperName"),"DEV")
	set gn=$$$logdevGN_fio
	$$$sH(" "_$$$addAppLog("^*","","^*","")_" --- "_$$$aText("show a list of all globalaw in the current scope",""))
	$$$sH(" "_$$$addAppLog("^log*","","^log*","")_" --- "_$$$aText("show the list globalaw mask",""))
	$$$sH(" "_$$$addAppLog("^log**","","^log**","")_" --- "_$$$aText("show the list globalaw with the occupied size Allocated MB",""))
	$$$sH(" "_$$$addAppLog("^log***","","^log***","")_" --- "_$$$aText("show the list globalaw with the occupied size Allocated MB Used MB and",""))
	$$$sH(" "_$$$addAppLog("^tmp**","","^tmp**","")_" --- "_$$$aText("show the list globalaw with the occupied size Allocated MB",""))
	$$$sH(" "_$$$addAppLog("^ISCSOAP","","^ISCSOAP","")_" --- "_$$$aText("Global SOAP (on the prod should be removed)",""))
	
	$$$sH(" ")
	if ##class(App.sys).ClassExist("WebTerminal.Engine") {
		$$$sH(" "_$$$addAppLog("trm","","trm","")_" --- "_$$$aText("Open the built-in Web Terminal ",""))
	}
	$$$sH("--- "_$$$aText("If this macro is to insert in the test program","")_" $$$LogDebug(""Debug info"") "_$$$aText("table App.Log pojawia new record",""))
	$$$sH("---  $$$AppL("""_fio_""",""node"")=$$$AppObJs(object) "_$$$aText("will record in global","")_" "_gn_" "_$$$aText("an object in the format","")_" json")
	
	$$$sH("--- "_$$$aText("To run in the background scanning logs to collect information about modifiable globalaw yesterday",""))
	$$$sH(" "_$$$addAppL("xec job ##class(App.files).OneDayJournalCount()::0 if $test write ""Processing""")_" --- "_$$$aText("Attention! The process can be long. Information about globalo default written in ","")_$$$TEMPJRNL)
	$$$sH(" "_$$$addAppL("xec do ##class(App.files).Export2CSV()")_" --- "_$$$aText("Display information about globalo of","")_" "_$$$TEMPJRNL_" in "_$$$EMAILXLSPATH_"JrnCount*.csv")
	$$$sH(" "_$$$addAppL("xec Set tSC = ##class(%SYS.Portal.Users).%AddFavorite(""AppTools"",""/apptools/App.LogInfo.cls?WHAT=%3F"") zw tSC")_" --- "_$$$aText("Add a link to AppTools in the management portal",""))
	;$$$sH(" "_$$$addAppL("post http://User:pass@localhost:57772/apptoolsrest/jsonrpc"_$c(13,10)_"{""jsonrpc"":""2.0"",""method"":""server.shutdown"",""params"":{""server"":""42""},""id"":1}")_" --- Perform http request with POST method with a JSON body")
	;$$$sH(" "_$$$addAppL("get https://openexchange.intersystems.com/index.html")_" --- to Perform http request with POST method with a JSON body")
	$$$sH(" ")
]]></Implementation>
</Method>
</Class>


<Routine name="App.LogMacro" type="INC" timestamp="65322,31033.529333"><![CDATA[
#Include %occMessages
#Include App.JsonUtils
#;Include %msql $$$MaxStringLength
#;		;2016.2<= set title={}.%FromJSON(json).title 
#;		;2016.1 set title={}.$fromJSON(json).title
#;		set title={}.$$$jsonFromJSON(json).title

#define aText(%en,%ru) ##Expression(##class(App.msg).AddLangMsg(%en,%ru))

#define R(%property) %request.Content.##Expression(%property)
#define RG(%property) %request.Get(%property)
#define StackPlace 		$st($st(-1),"PLACE")
#define CurrentClass 	##Expression($$$quote(%classname))
#define CurrentMethod 	##Expression($$$quote(%methodname))
#define slash $s($zversion(1)=3:"/",1:"\")

#define MethodArguments ##Expression(##class(App.Log).GetMethodArguments(%classname,%methodname))

#define LogEvent(%type, %message) Do ##class(App.Log).AddRecord($$$CurrentClass,$$$CurrentMethod,$$$StackPlace,%type,$$$MethodArguments,%message)
#define LogNone(%message) 		$$$LogEvent("NONE", %message)
#define LogError(%message) 		$$$LogEvent("ERROR", %message)
#define LogFatal(%message) 		$$$LogEvent("FATAL", %message)
#define LogWarn(%message) 		$$$LogEvent("WARN", %message)
#define LogInfo(%message) 		$$$LogEvent("INFO", %message)
#define LogStat(%message) 		$$$LogEvent("STAT", %message)
#define LogDebug(%message) 		$$$LogEvent("DEBUG", %message)
#define LogRaw(%message) 		$$$LogEvent("RAW", %message)

#; To obtain the date and time in $h
#define LoggedDT(%h) $s(%h[",":$tr($zd(%h,4),"/",".")_" "_$zt(+$p(%h,",",2),1),1:"")

#; the macro saves the node in the global call stack and all local variables 
#; Example of usage: /apptools/App.LogInfo.cls?WHAT=?
#; If you need a trap for a particular process, to assign s ^logFIO(0)=Number of process
#define LogEventAddGN(%debubGN, %message) s %AppLogId=##class(App.Log).AddRecord($$$CurrentClass,$$$CurrentMethod,$$$StackPlace,"DEBUG",%debubGN,%message)
#define logdevGN 	"^log"
#define MgtPortalSettings 	"^CacheTemp.MgtPortalSettings"
#define AppLogTab(%type,%message,%desc) Do ##class(App.Log).AddRecord($$$CurrentClass,$$$CurrentMethod,$$$StackPlace,%type,%desc,%message)
#define AppLog(%dev,%node,%list,%mode) s zsr=$zr,zsG=$$$logdevGN_%dev  if $g(@zsG@(0))=$j||($g(@zsG@(0))="") { s @zsG@(1,$i(@zsG),%node)=%list,zsGzr=$zr if %mode["t" { $$$LogEventAddGN(zsGzr,%list) } if %mode["s" {s zsG=$na(@($qs(zsGzr,0)_"stack")@($qs(zsGzr,2))),@zsG=$lb($ze,$h,$tl,$io,$j,$zu(110),##class(App.LogInfoPane).GetPathStack(),##class(App.Log).GetClientAddress()) S zs1="",zsG=$na(@zsG@("varList")),zsii=0 k @zsG s:%mode["e" @zsG@("%%%$$LOG^%ETN")=$$LOG^%ETN  if %mode["v" { f { s zs1=$O(@zs1) q:zs1=""  continue:$e(zs1,1,2)="zs"&&(zs1'="zs")  if $d(@zs1)'["0",$isobject(@zs1) { s @zsG@(zs1)=##class(App.Log).SerializeObject(@zs1,$na(@zsG@(zs1))),zsii=zsii+1 } elseif $d(@zs1)>9 {s:$d(@zs1)=11 @zsG@(zs1)=@zs1,zsii=zsii+1 MERGE @zsG@(zs1)=@zs1 if zs1="%zlog" {s zs2="" for {s zs2=$o(@zs1@(zs2)) q:zs2=""   s @zsG@(zs1,zs2)=##class(App.Log).SerializeObject($G(@zs1@(zs2)),$na(@zsG@(zs1,zs2)),%mode)   }}}	 elseif $d(@zs1)=1 {s @zsG@(zs1)=@zs1,zsii=zsii+1}} s @zsG=zsii KILL zsii,zsG,zs1,zs2}else{KILL zsii,zsG,zs1,zs2,zsGzr}} try{ if $d(@zsr) KILL zsr} catch e { KILL zsr}}
#; To add an active link to the panel
#define addAppLog(%text,%title,%input,%target) "<a title='"_%title_"' "_$g(%target)_" href=""App.LogInfo.cls?NSP="_$zu(5)_"&WHAT="_$zconvert(%input,"O","URL")_""">"_%text_"</a>"
#define addAppL(%text) "<a target="""_$ZCRC(%text,7)_""" href=""App.LogInfo.cls?NSP="_$zu(5)_"&WHAT="_$zconvert(%text,"O","URL")_""">"_%text_"</a>"

#; To obtain the date and time YYYY-MM-DD HH:MM:SS
#define AppDT(%h) $zd(+%h,3)_" "_##class(App.type).GetValidZT(%h)
#define AppObJs(%ob)  $s($isobject(%ob):##class(App.Log).WriteJSONFromObject(%ob),1:%ob)
#define ApplogGN(%fio) ("^log"_$zconvert($e(%fio,1,3),"U"))
#;define AppL(%fio,%node) @$$$ApplogGN(%fio)@($i(@$$$ApplogGN(%fio)),$$$AppDT($h)_" "_%node)
#define AppL(%fio,%node) @$$$ApplogGN(%fio)@($i(@$$$ApplogGN(%fio)),$$$AppDT($h)_" ("_$classname()_")."_%node)

#define forAll(%in,%gn) s gn%in=$na(%gn) s %in="" f { s %in=$o(@gn%in@(%in)) q:%in=""
#define forAllk(%in,%kn,%gn) s gn%in=$na(%gn) s %in="" f %kn=1:1 { s %in=$o(@gn%in@(%in)) q:%in=""
#define forEnd  }

#; keep the name of the current region
#define NspGoto(%cur,%ns)  s %cur=$zu(5) try {zn %ns} catch e {} 
#; to return to the current region
#define NspReturn(%cur)  zn %cur
#;---------- layout
#;
#define appStyleInput " style='border: none;	background: none;	color: inherit;	padding: .222em 0;	margin: .2em 0;	vertical-align: middle;	margin-left: .4em;	margin-right: .4em;' "
#define appInputHidden(%id,%attr,%val) "<input type=hidden "_%attr_" id='"_%id_"' name='"_%id_"' value='"_%val_"'>"
#define appText(%id,%attr,%val) "<span class='ui-spinner ui-corner-all ui-widget ui-widget-content'><input autocomplete='off' "_$$$appStyleInput_" type=text "_%attr_" id='"_%id_"' name='"_%id_"' value='"_%val_"'></span>"
#define appAutocomplete(%id,%attr,%val) "<span class='ui-spinner ui-corner-all ui-widget ui-widget-content'><input id='"_%id_"' name='"_%id_"' "_%attr_" "_$$$appStyleInput_" autocomplete='off' value='"_%val_"'>"
#define appAutocomplete2(%id,%attr,%val) "<input id='"_%id_"' name='"_%id_"' "_%attr_" class='ui-autocomplete-input' autocomplete='off' value='"_%val_"'>"
#define appInput(%id,%attr,%val) "<span class='ui-spinner ui-corner-all ui-widget ui-widget-content'><input autocomplete='off' "_$$$appStyleInput_" "_%attr_" id='"_%id_"' name='"_%id_"' value='"_%val_"'></span>"
#define appButton(%id,%attr,%val) $s($g(%ui):"<button class='uk-button uk-button-default uk-margin-small-right' type='button' "_%attr_" id='"_%id_"' name='"_%id_"' >"_%val_"</button>",1:"<input class='ui-button ui-corner-all ui-widget' type=button id='"_%id_"' name='"_%id_"' "_%attr_" value='"_%val_"'>")
#define appTextarea(%id,%attr,%val) "<span class='ui-spinner ui-corner-all ui-widget ui-widget-content'><textarea autocomplete='off' "_$$$appStyleInput_" "_%attr_" id='"_%id_"' name='"_%id_"' >"_%val_"</textarea></span>"
#define appDate(%id,%attr,%val) "<span class='ui-spinner ui-corner-all ui-widget ui-widget-content'><input autocomplete='off' "_$$$appStyleInput_" type=date "_%attr_" id='"_%id_"' name='"_%id_"' value='"_%val_"'></span>"
#define appDateTime(%id,%attr,%val) "<span class='ui-spinner ui-corner-all ui-widget ui-widget-content'><input autocomplete='off' "_$$$appStyleInput_" type=datetime-local "_%attr_" id='"_%id_"' name='"_%id_"' value='"_%val_"'></span>"
#;define appCheck(%id,%attr,%val) "<input class='ui-button ui-corner-all ui-widget' type=checkbox id='"_%id_"' name='"_%id_"' "_%attr_" value='"_%val_"'>"
#define appCheck(%id,%attr,%val) "<input class='bigbox' type=checkbox id='"_%id_"' name='"_%id_"' "_%attr_" value='"_%val_"'>"
#define appSelect(%id,%attr,%val) ""
#define appError(%val) "<div class='ui-widget'><div class='ui-state-error ui-corner-all' style='margin-top: 20px; padding: 1em;'><p><span class='ui-icon ui-icon-alert' style='float: left; margin-right: 3em;'></span>"_%val_"</p></div></div>"
#define appMsg(%val) "<div class='ui-widget'><div class='ui-state-highlight ui-corner-all' style='margin-top: 20px; padding: 1em;'><p><span class='ui-icon ui-icon-info' style='float: left; margin-right: 3em;'></span>"_%val_"</p></div></div>"

#define appTable1(%n1) "<table style=""border-radius: 10px; border: 1px solid #72a7cf"" cellpadding=2 cellspacing=0 class=""DetailTable"" bgcolor=""#c4d6d6"" width=""90%""><tbody><tr><th>"_%n1_"</th></tr>"
#define appTableTrTd1(%n1) "<tr class=""trs"" ><td align=""center"" >"_%n1_"</td></tr>"
#define appTableEnd1 "</tbody></table>"_$s('$d(%DrawArray):"<script language='javascript'>$('.trs').hover(function(){ $(this).toggleClass( 'ui-widget-content' ) });</script>",1:"")

#define appTable2(%n1,%n2) "<table style=""border-radius: 10px; border: 1px solid #72a7cf"" cellpadding=2 cellspacing=0 class=""DetailTable"" bgcolor=""#c4d6d6"" width=""90%""><tbody><tr><th align=""left"" width=""5px"">"_%n1_"</th><th align=""left"" width=""50px"">"_%n2_"</th></tr>"
#define appTableTrTd2(%n1,%n2) "<tr class=""trs"" ><td align=""left"" >"_%n1_"</td><td>"_%n2_"</td></tr>"
#define appTableEnd2 "</tbody></table>"_$s('$d(%DrawArray):"<script language='javascript'>$('.trs').hover(function(){ $(this).toggleClass( 'ui-widget-content' ) });</script>",1:"")

#define appTable3(%n1,%n2,%n3) "<table style=""border-radius: 10px; border: 1px solid #72a7cf"" cellpadding=2 cellspacing=0 class=""DetailTable"" bgcolor=""#c4d6d6"" width=""90%""><tbody><tr><th align=""left"" width=""5px"">"_%n1_"</th><th align=""left"" width=""50px"">"_%n2_"</th><th align=""left"" width=""50px"">"_%n3_"</th></tr>"
#define appTableTrTd3(%n1,%n2,%n3) "<tr class=""trs"" ><td style=""text-align:left"" >"_%n1_"</td><td style=""text-align:left"" >"_%n2_"</td><td style=""text-align:left"" >"_%n3_"</td></tr>"
#define appTableEnd3 "</tbody></table>"_$s('$d(%DrawArray):"<script language='javascript'>$('.trs').hover(function(){ $(this).toggleClass( 'ui-widget-content' ) });</script>",1:"")

#define appTab3(%n1,%n2,%n3) "<table cellpadding=2 cellspacing=0 border=1 class=""DetailTable"" width=""90%""><tbody><tr><th align=""left"" width=""5px"">"_%n1_"</th><th align=""left"" width=""50px"">"_%n2_"</th><th align=""left"" width=""50px"">"_%n3_"</th></tr>"

#define jsstart w "<script language='javascript'>"
#define jsstop w "</script>"
#define styleurl "text-decoration:underline; color:blue; cursor:hand;"
#define blockui(%msg)  "$.blockUI( { message: '"_%msg_"' , css: { border: 'none', padding: '15px', backgroundColor: '#000', '-webkit-border-radius': '10px','-moz-border-radius': '10px', opacity: .5, color: '#fff' }} );"

#;	Localization
#define GNLangDOMAIN "AppTools"

#define GNEnsConf "^%App.Setting"
/// Global history of command
#define HISTORYGN "^%App.History"
/// Global tempory data
#define TEMPORYGN "^mtempAppData"
/// Global projects in the system
#define PROJGN "^%App.Proj"
/// Global tempory data for Journals
#define TEMPJRNL "^%App.JRNL"
/// Limiting the number of nodes in a global or query result for output
#define MAXSHOW 10000

#;;; Parameters dependent on the installation server
#define GNLang "^%AppCacheMsg"
#; Path to CSP apps "/apptools/"
#define  PATHCSP $GET(@$$$GNEnsConf@("PATHCSP")) 
#; Mail Server Settings
#define  EMAILSERVERIP $GET(@$$$GNEnsConf@("EMAILSERVERIP"))
#define  EMAILSERVERPORT $GET(@$$$GNEnsConf@("EMAILSERVERPORT"))
#; Authorization in the mail server
#define  EMAILAUTH $GET(@$$$GNEnsConf@("EMAILAUTH")) 
#define  EMAILAUTHPASS $GET(@$$$GNEnsConf@("EMAILAUTHPASS"))
#; Technical support admin address
#define  EMAILSUPPORT $G(@$$$GNEnsConf@("EMAILSUPPORT")) 
#; Path for temporary xls file before sending to mail
#define  EMAILXLSPATH $G(@$$$GNEnsConf@("EMAILXLSPATH"))
#; Path to storing project sources
#define  EXPORTPROJPATH $G(@$$$GNEnsConf@("EXPORTPROJPATH")) 
#; List of databases to monitor free space in App..Chart.cls?panel=class(App.ChartPanel).ChartDbSize
#define DBCACHESizeMon $G(@$$$GNEnsConf@("DBCACHESizeMon"))


#; --------------- Application section
#define GNmessages "^%App.cconsolelog"
#define DubledQuote(%s)	$replace(%s,"'","''")



#If $DATA(^%App.Proj("INFOBANKS"))
#define  TESTSERVER "cip-test.mvk.ru"
#define DEVELOPER "mihaylenko_sv"
#; The module display links to the administrative application panel
#define  DRAWAllApp ##class(App.MVK.docbook).GetAllApp(0)
#define SDNum if $g(SDNum)'="" write:##class(App.sys).ClassExist("App.MVK.docbook") "<br>"_##class(App.MVK.docbook).FindSDRef(SDNum)
#Else 
#define  TESTSERVER " "
#define DEVELOPER "admin"
#; The module display links to the administrative application panel
#define  DRAWAllApp " "
#define SDNum  
#EndIf



]]></Routine>


<Class name="App.Parameter">
<Description>
Example Parameters</Description>
<Super>%Persistent</Super>
<TimeChanged>65311,37086.005128</TimeChanged>
<TimeCreated>64695,66336.883011</TimeCreated>

<Parameter name="AppORDERPROPERTY">
<Description>
The order of the properties in the output in the form</Description>
<Default>Name,Description,Value,Types,Namespace,DateStart,DateFinish,File,isEnabled,isEnabledCheck,OfficeFile</Default>
</Parameter>

<Property name="Namespace">
<Description>
Namespace $zu(5) use parameter</Description>
<Type>%String</Type>
<InitialExpression>$zu(5)</InitialExpression>
<Parameter name="MAXLEN"/>
</Property>

<Property name="Name">
<Description>
The name of the parameter</Description>
<Type>%String</Type>
<Required>1</Required>
<Parameter name="MAXLEN"/>
</Property>

<Property name="Value">
<Description>
Parameter value default</Description>
<Type>%String</Type>
<Parameter name="MAXLEN"/>
</Property>

<Property name="Description">
<Description>
The description of the parameter
{"displayname":"Description of option","title":"parameter Description","inputpattern":"textarea"}</Description>
<Type>%String</Type>
<Parameter name="MAXLEN"/>
</Property>

<Property name="DateStart">
<Description>
Date of sampling Protocol
{"displayname":"date of sampling Protocol","title":"enter date","inputtype":"date"}</Description>
<Type>%String</Type>
<InitialExpression>##class(App.type).GetYear($h)_"-01-01"</InitialExpression>
<Parameter name="MAXLEN"/>
</Property>

<Property name="DateFinish">
<Description>
Date of sampling Protocol on
{"displayname":"date of sampling Protocol","title":"enter the date and time","inputtype":"datetime-local"}</Description>
<Type>%String</Type>
<InitialExpression>##class(App.type).GetYear($h)_"-12-31"</InitialExpression>
<Parameter name="MAXLEN"/>
</Property>

<Property name="isEnabledCheck">
<Description>
Type Boolean in a checkbox
{"displayname":"Enabled","inputtype":"checkbox"}</Description>
<Type>%Boolean</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Property name="isEnabled">
<Description>
Type Boolean in a list
{"displayname":"Included","title":"enter (1 or 0)"}</Description>
<Type>%Boolean</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="File">
<Description>
Select the file to upload to drive TempDir = ##class(%File).GetDirectory(##class(%File).TempFilename())
{"displayname":"Select template file","title":"the Choice sablona","inputpattern":"files","filesMethod":"##class(App.type).UploadFilesJS(%id)","attr":"accept='.xls,.xlsx'","filesStore":"TempDir"}</Description>
<Type>%String</Type>
<Parameter name="MAXLEN"/>
</Property>

<Property name="Types">
<Description>
The list of parameter types
{"displayname":"parameter Types","title":"Select a Type"}</Description>
<Type>%String</Type>
<InitialExpression>"AppOption"</InitialExpression>
<Required>1</Required>
<Parameter name="DISPLAYLIST" value=",Project,Application Parameter,System Parameter"/>
<Parameter name="MAXLEN" value="1"/>
<Parameter name="VALUELIST" value=",Projecr,AppOption,SysOption"/>
</Property>

<Property name="OfficeFile">
<Description>
Select the file to download to disk TempDir
{"displayname":"Select file","title":"Select file","inputpattern":"files"}</Description>
<Type>%String</Type>
<Parameter name="MAXLEN"/>
</Property>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^%App.ParameterD</DataLocation>
<DefaultData>ParameterDefaultData</DefaultData>
<IdLocation>^%App.ParameterD</IdLocation>
<IndexLocation>^%App.ParameterI</IndexLocation>
<StreamLocation>^%App.ParameterS</StreamLocation>
<Data name="ParameterDefaultData">
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>name</Value>
</Value>
<Value name="3">
<Value>dob</Value>
</Value>
<Value name="4">
<Value>ts</Value>
</Value>
<Value name="5">
<Value>num</Value>
</Value>
<Value name="6">
<Value>Namespace</Value>
</Value>
<Value name="7">
<Value>TESTSERVER</Value>
</Value>
<Value name="8">
<Value>EMAILSERVERIP</Value>
</Value>
<Value name="9">
<Value>EMAILSERVERPORT</Value>
</Value>
<Value name="10">
<Value>EMAILAUTH</Value>
</Value>
<Value name="11">
<Value>EMAILAUTHPASS</Value>
</Value>
<Value name="12">
<Value>EMAILSUPPORT</Value>
</Value>
<Value name="13">
<Value>EMAILXLSPATH</Value>
</Value>
<Value name="14">
<Value>PATHCSPUI</Value>
</Value>
<Value name="15">
<Value>ServerName</Value>
</Value>
<Value name="16">
<Value>DateStart</Value>
</Value>
<Value name="17">
<Value>DateFinish</Value>
</Value>
<Value name="18">
<Value>Description</Value>
</Value>
<Value name="19">
<Value>Name</Value>
</Value>
<Value name="20">
<Value>isBiddingByOne</Value>
</Value>
<Value name="21">
<Value>FileOther</Value>
</Value>
<Value name="22">
<Value>FileOtherOriginalFileName</Value>
</Value>
<Value name="23">
<Value>contractType</Value>
</Value>
<Value name="24">
<Value>Types</Value>
</Value>
<Value name="25">
<Value>isEnabled</Value>
</Value>
<Value name="26">
<Value>File</Value>
</Value>
<Value name="27">
<Value>FileName</Value>
</Value>
<Value name="28">
<Value>ImageFile</Value>
</Value>
<Value name="29">
<Value>ImageGlobal</Value>
</Value>
<Value name="30">
<Value>isEnabledCheck</Value>
</Value>
<Value name="31">
<Value>OfficeFile</Value>
</Value>
<Value name="32">
<Value>Value</Value>
</Value>
<Value name="33">
<Value>ImageFileName</Value>
</Value>
<Value name="34">
<Value>ImageGlobalName</Value>
</Value>
<Value name="35">
<Value>CustomFile</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="App.RestMetrics">
<IncludeCode>App.LogMacro</IncludeCode>
<Super>%CSP.REST</Super>
<TimeChanged>65395,40278.126027</TimeChanged>
<TimeCreated>64939,46779.170246</TimeCreated>

<Parameter name="CONTENTTYPE">
<Default>application/json</Default>
</Parameter>

<Parameter name="CHARSET">
<Default>UTF-8</Default>
</Parameter>

<Parameter name="ISCPREFIX">
<Default>isc_cache</Default>
</Parameter>

<Parameter name="DASHPREFIX">
<Expression>..#ISCPREFIX_"_dashboard"</Expression>
</Parameter>

<XData name="UrlMap">
<XMLNamespace>http://www.intersystems.com/urlmap</XMLNamespace>
<Data><![CDATA[
<Routes>
<Route Url="/get-html/:text" Method="GET" Call="App.rest:Index"/>
<Route Url="/post-json" Method="POST" Call="App.rest:jsonrpc"/>
<Route Url="/get-files/:text" Method="GET" Call="App.rest:Files"/>

<Route Url="/finduser/:text" Method="GET" Call="App.rest:FindUser"/>
<Route Url="/jsonrpc" Method="POST" Call="App.rest:jsonrpc"/>
<Route Url="/getrpc" Method="GET" Call="App.rest:getrpc"/>
<Route Url="/index/:text" Method="GET" Call="App.rest:Index"/>

<Route Url="/cache" Method="GET" Call="getMetrics"/>
<Route Url="/mgstat/:delay" Method="GET" Call="getMgstat"/>
<Route Url="/db" Method="GET" Call="getDBsize"/>
<Route Url="/dirsize/:path" Method="GET" Call="getDirSize"/>
<Route Url="/proj/:proj/:metrics/:mode" Method="GET" Call="App.MVK.Metrics:getProj"/>

<Route Url="/test" Method="POST" Call="Test"/>  
</Routes>
]]></Data>
</XData>

<Method name="getDirSize">
<Description>
To sorted sizes podkatalogu for Linux
w ##class(App.RestMetrics).getDirSize("/opt/isc/ensemble/mgr/")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[path="",&res,minsize=10]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	s gn = "^||tmpfile"
	d ##class(App.files).getPathcconsole(.dir,.logname)
	i $g(path)="" s path=dir ;location of default database
	i $zv'["Linux" q $$$OK  ;for other OS not implemented
	s st=$$$OK
	s curNs=$zu(5)
	zn "%sys"
	s prefix = ..#ISCPREFIX_"_dirsize"
	s tempfile=$SYSTEM.Util.InstallDirectory()_"mgr/Temp/dirsize.log"
	k @gn set nl = $c(10)
	try {
		s cmd="du -sm "_path_"*| sort -nr >"_tempfile
		set result = $zf(-1, cmd)
		if (result '= 0) { 
			w !,$System.Status.GetErrorText(result)
			$$$ThrowStatus($$$ERROR($$$GeneralError, "Error:" _ result_", "_cmd)) 
		}
		else {
			s size=##class(App.files).File2Arr(tempfile,gn,"RSK\UTF8\")
			f i=1:1 { q:'$d(@gn@(i))   ;pass the loop through the entire report
				continue:$p(@gn@(i),$c(9))'>minsize ;eliminate small and empty directories
				s str=$g(@gn@(i))
				i $d(res) s res(i)=$P(str,$c(9),2)_" "_$P(str,$c(9),1)
				else  w prefix_"_"_$P(str,$c(9),2)_" "_$P(str,$c(9),1)_nl
			}
		}
	} catch ex {
		set st = ex.AsStatus()
		;$$$TRACE($system.Status.GetErrorText(st))
	}
	zn curNs
	quit st
]]></Implementation>
</Method>

<Method name="getDBsize">
<Description>
The size of the database in Gigabytes
d ##class(App.RestMetrics).getDBsize("dbsize",.list)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>prefix=..#ISCPREFIX_"_dbsize",dbname,int=1,all=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set nl = $c(10)
	s curNs=$zu(5)
	zn "%sys"
	s st=##class(App.sys).SaveQuery("SYS.Database:FreeSpace","^||db")
	s r=$q(^||db("")) ;to the first link
	s r=$na(^||db($qs(r,1),$qs(r,2))) ;take the first 2 of the index in the link
	s listDb=$$$DBCACHESizeMon
	i listDb="" s listDb=##class(App.sys).ListDB(.info,"NotPre,NotTemp")
	f i=1:1 { q:'$d(@r@(i))   ;pass the loop through the entire report
		continue:$g(@r@(i,1))=""
		;by default, we give all sizes to Gigabytes
		s free=$g(@r@(i,8))
		s dir=$g(@r@(i,2))
		s name=$g(@r@(i,1))
		i 'all,(","_listDb_",")'[(","_name_",") continue
		i 'all,(dir)[("secondary/")||((dir)[("temp/")) continue
		s size=$g(@r@(i,4))
		if size["MB" {s size=$j(size/(1024),"",3) ;if in MB, then divide
		}
		elseif size["TB" {s size=size*1024  ;if TB then multiply
		}
		else {
			s size=+size  ;if GB then translate into the number
		}
		s dbname(dir)=size
		s dbname(dir,"name")=name
		s dbname(dir,"free")=+free
		;i $p(dir,"/")'=""  s total($p(dir,"/"))=$g(total($p(dir,"/")))+size
		w:'int prefix_"_"_name_" "_size_nl
		w:'int prefix_"_"_name_"_DiskFreeSpace "_(+free)_nl
	}
	zn curNs
	write nl
	quit $$$OK
]]></Implementation>
</Method>

<Method name="getMgstat">
<Description>
Metrics databases Habra...</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>delay:%Integer=2</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	// By default, we use 2 second interval for averaging
	quit ##class(App.MVK.Metrics).getSamples(delay)
]]></Implementation>
</Method>

<Method name="getMetrics">
<Description>
Output should obey the Prometheus exposition formats. Docs:
https://prometheus.io/docs/instrumenting/exposition_formats/

The protocol is line-oriented. A line-feed character (\n) separates lines. 
The last line must end with a line-feed character. Empty lines are ignored.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set nl = $c(10)
	s curNs=$zu(5)
	zn "%sys"
	do ..getDashboardSample(.dashboard)
	do ..getClassProperties(dashboard.%ClassName(1), .propList, .descrList)
	
	for i=1:1:$ll(propList) {
		set descr = $lg(descrList,i)
		set propertyName = $lg(propList,i)
		set propertyValue = $property(dashboard, propertyName)
		
		// Prometheus supports time series database 
		// so if we get empty (for example, backup metrics) or non-digital metrics 
		// we just omit them.
		if ((propertyValue '= "") && ('$match(propertyValue, ".*[-A-Za-z ]+.*"))) {
			set metricsName = ..#DASHPREFIX_..camelCase2Underscore(propertyName)
			set metricsValue = propertyValue
			
			// Write description (help) for each metrics.
			// Format is that the Prometheus requires.
			// Multiline descriptions we have to join in one string.
			write "# HELP "_metricsName_" "_$replace(descr,nl," ")_nl
			write metricsName_" "_metricsValue_nl
		}
	}
	zn curNs
	write nl
	quit $$$OK
]]></Implementation>
</Method>

<Method name="getDashboardSample">
<ClassMethod>1</ClassMethod>
<FormalSpec>*dashboard</FormalSpec>
<Implementation><![CDATA[
	new $namespace
	set $namespace = "%SYS"
	set dashboard = ##class(SYS.Stats.Dashboard).Sample()
]]></Implementation>
</Method>

<Method name="getClassProperties">
<ClassMethod>1</ClassMethod>
<FormalSpec>className:%String,*propList:%List,*descrList:%List</FormalSpec>
<Implementation><![CDATA[
	new $namespace
	set $namespace = "%SYS"
	
	set propList = "", descrList = ""
	set properties = ##class(%Dictionary.ClassDefinition).%OpenId(className).Properties
	
	for i=1:1:properties.Count() {
		set property = properties.GetAt(i)
		set propList = propList_$lb(property.Name)
		set descrList = descrList_$lb(property.Description)
	}
]]></Implementation>
</Method>

<Method name="camelCase2Underscore">
<Description>
Converts metrics name in camel case to underscore name with lower case
Sample: input = WriteDaemon, output = _write_daemon</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>metrics:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set result = metrics
	set regexp = "([A-Z])"
	set matcher = ##class(%Regex.Matcher).%New(regexp, metrics)
	while (matcher.Locate()) {
		set result = matcher.ReplaceAll("_"_"$1")
	}
	
	// To lower case
	set result = $zcvt(result, "l")
	
	// _e_c_p (_c_s_p) to _ecp (_csp)
	set result = $replace(result, "_e_c_p", "_ecp")
	set result = $replace(result, "_c_s_p", "_csp")
	
	quit result
]]></Implementation>
</Method>

<Method name="Test">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	&html<<h1>Status: OK!</h1><br>>
	zw %request
	&html<<br><br>>
	zw %response
	quit $$$OK
]]></Implementation>
</Method>
</Class>


<Class name="App.TabsPanel">
<Description>
The template GUI of the application selector and tabs on the basis jQueryUi</Description>
<ClassType/>
<IncludeCode>App.LogMacro</IncludeCode>
<ProcedureBlock>1</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeChanged>65387,34502</TimeChanged>
<TimeCreated>65065,36454.902831</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Parameter name="HeaderText">
<Description>
The application title</Description>
<Default>Tabs Application title</Default>
</Parameter>

<Method name="OnPage">
<Description>
Main method generate the content of page</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 s NSpace=$zu(5)
 // Save the session parameters debugging mode (implies extended disclosure)
 s %session.Data("debug")=%request.Get("debug")
 &html<
 <html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>#(..#HeaderText)#</title>
>
	write ##class(App.LogInfoPane).GetLink()
	write ##class(App.LogInfoPane).AddJsScripts() 
   	   do ##class(App.LogInfoPane).AddJS(NSpace,..%ClassName(1))
   	   do ##class(App.LogInfoPane).AddStyle()
 &html< 
</head>
<body>
 <div id="MainBody">
  <nav style='background: #d7ebf9;' > 
  &nbsp;&nbsp;&nbsp;  
  <span class="uk-margin-small-right uk-icon" uk-icon="album"></span>
  &nbsp;&nbsp;&nbsp; 
 	<div id="MainControlgroup" > </div>
 	<span id='status_nav'> Status session </span>
  </nav> 
 <div id="tabs"> </div>
</div>
>
 // Debug mode 1
 q:..IsDebugMode(0) $$$OK
 $$$jsstart
    // Download available modes menu
 	w "$('#MainControlgroup').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=DrawMenu&appNsp="_NSpace_"&appPar=');"
 	//Download status
 	w "$('#status_nav').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=DrawStatus&appNsp="_NSpace_"&appPar=');"
    //To download Taba
 	w "$('#tabs').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=DrawTabs&appNsp="_NSpace_"&appPar=');"
 $$$jsstop
 
 &html< 	
 <script language="javascript">
$( ".tip" ).tooltip();
</script>
<div id='MainHidden' style='display:none;'></div>
<div id="dialog" title="Dialog Title">
	<div id=dialogContent></div>
</div>
</body>
</html>
	>
 quit $$$OK
]]></Implementation>
</Method>

<Method name="GetSupportInfo">
<Description>
To obtain information on the support</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	s msg=$$$aText("Software complex to debug. Try to log in later, or contact tech support:","")
	q msg_"Support info mailto: sergey.mikhaylenko@gmail.com <div id=test></div><button onclick=""$('#test').load('/apprest/getrpc/aaa:::label%5EApp.routine(3333,%22green%22)');"" >test</button>"
]]></Implementation>
</Method>

<Method name="IsDebugMode">
<Description>
To add to the form js code if development mode</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>mode=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 i mode,'%request.Get("debug") { 
	$$$jsstart
	  w $$$blockui(..GetSupportInfo())
	$$$jsstop
	w "</body></html>"
  q $$$OK
 }
	q 0
]]></Implementation>
</Method>

<Method name="DrawStatus">
<Description>
rendering status of the user</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	;do ##class(App.Form).BlockUI(0)
	w $s(%request.Get("debug"):"<font color=red><b>"_$$$aText("Administrator mode","")_"</b></font>",1:"")_" <span class='tip' title='"_$username_"-"_$j_"'>"_$$$aText("User","")_": "_##class(App.sys).GetFullName($username)_"</span>, "_$tr(##class(App.type).GetDateTime($h),"T"," ")
 	$$$jsstart
	w "$('.tip').tooltip();"
	$$$jsstop
 q $$$OK
]]></Implementation>
</Method>

<Method name="GetAllApps">
<Description>
what are the available modes</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>opt</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	;TODO access rights to pages
	;TODO save in database table
	s key="menu-first"
	s opt(key)="Finding" ;The name of the menu
	s opt(key,"id")="Find"
	s opt(key,"TabName")="Tab Finding out" ;the name of the tab
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabSample"
	s opt(key,"Disable")=0 ;developed

	s key="menu-second"
	s opt(key)="About the program"
	s opt(key,"id")="About"
	s opt(key,"TabName")="About the program"
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabAbout"
	s opt(key,"Disable")=1 ;developed
	
	q $$$OK
]]></Implementation>
</Method>

<Method name="ShowTabAbout">
<Description>
the render Tab On the program"
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	d ..GetAllApps(.opt) 
	i $g(opt(Par,"Disable")) w ..GetSupportInfo() q $$$OK
	s divId=$g(opt(Par,"id"))
	w "Hello world! Parameter: "_Par
	w ..ButtonAgain(divId,,Par)
]]></Implementation>
</Method>

<Method name="ShowTabSample">
<Description>
rendering the Tab previously submitted
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>key=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 d ..GetAllApps(.opt) 
 i $g(opt(key,"Disable")) w ..GetSupportInfo() q $$$OK
 s NSpace=$zu(5)
 s pref=$g(opt(key,"id"))
 s mhead=pref_"MainHeader"
 s mcont=pref_"MainContent"
 &html<
<form id="#(pref_"MainForm")#">


<table id="tbpage" cellspacing="0" width='100%' >
  <tbody>
   <tr height='10%' >
   	<td>
   		<DIV id="#(mhead)#"></div>
	</td>
   </tr>
   <tr height='90%' >
   	<td>
 		<div style='overflow: auto;' id="#(mcont)#"></div>
	</td>
 </tr>
</tbody>
</table>
</form>
>
 ;d ##class(App.LogInfoPane).AddJS(NSpace,..%ClassName(1))
 $$$jsstart
  	; to calculate the height of the container as a result of wijetunge victory container-Taba height of the container header
 	w "$('#"_mcont_"').height($('#tabs-"_pref_"').height()-$('#"_pref_"MainHeader').height()-150);"
  	w $$$blockui($$$aText("Loading...",""))
	w "ActionJs('"_pref_"MainForm','"_mhead_"','','"_pref_"FirstHead','divId="_pref_"~key="_key_"');"
 $$$jsstop
 ;d ..AddToForm()
 quit $$$OK
]]></Implementation>
</Method>

<Method name="FindFirstHead">
<Description>
download template forms search</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	s key=Par("key")
	s divId=Par("divId")
	set onclick=$$$blockui("Loading...")_";ActionJs('"_divId_"MainForm','"_divId_"MainContent','','"_divId_"Result','key="_key_"~divId="_divId_"~mode=*');"
		&html<
		<table width="90%" style="border-radius: 10px; border: 1px solid #72a7cf" cellpadding="2" cellspacing="0" class="DetailTable" bgcolor="#c4d6d6" >
		<tr>
			<td>
			Context film name
			</td>
			<td>
			#($$$appText(divId_"Name","","New"))#
			</td>
			<td>

			</td>
			<td>

			</td>
			<td>
		
			</td>
			<td>

			</td>
		</tr>
		<tr>
			<td>
			
			</td>
			<td>
			#($$$appButton(divId_"appButtonResult1","onclick="""_$tr(onclick,"*",1)_"""","Find film in namespase SAMPLES"))#
			</td>
			<td>

			</td>
			<td>
			</td>
			<td>
			
			</td>
			<td>

			</td>
		</tr>
		</table>
	>
	q $$$OK
]]></Implementation>
</Method>

<Method name="FindResult">
<Description>
Search result</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set mode=Par("mode")
	set Name=$g(Par("%request.Data",divId_"Name"))
	set Desc=$g(Par("%request.Data",divId_"Desc"))
	set Date=$g(Par("%request.Data",divId_"Date"))
	write ..ButtonAgain(divId,,key)
	if mode=1 {
		if Name="" w $$$appError($$$aText("Context is empty","")) q $$$OK
		zn "samples"
		set sql="select * from Cinema.Film where title is not null "
		if Name'="" s sql=sql_" and (title like '%"_Name_"%') "
		if Desc'="" s sql=sql_" and (Description like '%"_Desc_"%') "
		set msg="Query: "_sql
		set exec="##class(App.LogInfo).MarkRed(%AppLogInfoVal,"""_Name_","_Desc_""")"
		set st=##class(App.LogInfoPane).DrawSQL(sql,100000,$zu(5),msg,exec)
		quit $$$OK
	} 
	elseif mode=2 {

	}
	w "<br>"

	;i 'st  w $$$appError($System.Status.GetErrorText(st))
	q $$$OK
]]></Implementation>
</Method>

<Method name="ShowTab">
<Description>
rendering Tabs
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	d ..GetAllApps(.opt) 
	s tabId="tabs-"_opt(Par,"id")
 	$$$jsstart
 		w "var a = $('#li-"_tabId_"'); a.show();" ; open the tab
 		w "var index = $('#tabs a[href=""#"_tabId_"""]').parent().index();"
		w "$('#tabs').tabs({'active':index});" ;make it active
 		if $g(opt(Par,"Url"))'="" {
	 		w "$('#"_tabId_"').load('"_$g(opt(Par,"Url"))_"');"
 		}
 		else {
	 		w "$('#"_tabId_"').load('App.Action.cls','appClass="_$g(opt(Par,"ClassName"))_"&appMethod="_$g(opt(Par,"Method"))_"&appNsp="_$zu(5)_"&appPar="_Par_"');"
 		}
	$$$jsstop
]]></Implementation>
</Method>

<Method name="DrawMenu">
<Description>
rendering menu</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	
	d ..GetAllApps(.opt) 
	s onc="$('#MainHidden').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=ShowTab&appNsp="_$zu(5)_"&appPar='+this.options[this.selectedIndex].value);"
	w "<select id=""menu-spgz"" >"
	s i="" w "<option VALUE=0> </option>"
	f { s i=$o(opt(i)) q:i=""  
		w "<option VALUE="""_i_""">"_opt(i)_"</option>"
	}
 	w "</select>"
 	w ..ButtonExit("MainBody")
 	$$$jsstart
		w "$( ""#MainControlgroup"" ).controlgroup();"
 		w "$( ""#menu-spgz"" ).selectmenu({ change: function( event, data ) { "_onc_" }, width:600 }).selectmenu('menuWidget');"
	$$$jsstop
  q $$$OK
]]></Implementation>
</Method>

<Method name="DrawTabs">
<Description>
rendering tabs</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	d ..GetAllApps(.opt)
	w "<ul>"
	s i="" f { s i=$o(opt(i)) q:i=""  
		s tabs(i)="tabs-"_$g(opt(i,"id"))
		w "<li id=""li-"_tabs(i)_"""><a href=""#"_tabs(i)_""">"_opt(i,"TabName")_"</a></li>"
	}
 	w "</ul>"
 	s i="" f { s i=$o(tabs(i)) q:i=""  
 		w "<div id='"_tabs(i)_"' style='height: 85%' ></div>"
 	}
 	$$$jsstart
		w "$( ""#tabs"" ).tabs();"
		;All tabs will immediately hide after initialization, they will be open as a choice
		s i="" f { s i=$o(tabs(i)) q:i=""  
			w "var a = $('#li-"_tabs(i)_"'); a.hide();"
		}
	$$$jsstop
	q $$$OK
]]></Implementation>
</Method>

<Method name="ButtonExit">
<Description>
Output exit button</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>formName</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set onclick="$('#"_formName_"').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=Logout&appNsp="_$zu(5)_"&appPar="_$$$aText("Exit complete","")_"');"
	q $$$appButton("appButtonExit","onclick="""_$g(onclick)_"""",$$$aText("Exit",""))
]]></Implementation>
</Method>

<Method name="AddToForm">
<Description>
To add to the form js code</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	q $$$OK
]]></Implementation>
</Method>

<Method name="Logout">
<Description>
Return in a single string</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	d ##class(App.sys).logout()
	w $$$appMsg($g(Par)) w "<br>"
	d ##class(App.Form).ButtonRef($$$aText("Entrance",""))
  	q $$$OK
]]></Implementation>
</Method>

<Method name="ButtonAgain">
<Description>
The output of the First button</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Prefix="",Method="",appPar=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	i Method="" s Method="ShowTab"
	s onc="$('#MainHidden').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=ShowTab&appNsp="_$zu(5)_"&appPar='+this.options[this.selectedIndex].value);"
	set onclick="$('#MainHidden').load('App.Action.cls','"_Prefix_"appClass="_..%ClassName(1)_"&"_Prefix_"appMethod="_Method_"&"_Prefix_"appNsp="_$zu(5)_"&"_Prefix_"appPar="_appPar_"');"
	q $$$appButton("appButtonExit","onclick="""_$g(onclick)_"""",$$$aText("First",""))
]]></Implementation>
</Method>
</Class>


<Class name="App.TabsPanelSample">
<Description>
The template GUI of the application selector and tabs</Description>
<IncludeCode>App.LogMacro</IncludeCode>
<Super>App.TabsPanel</Super>
<TimeChanged>65317,30981</TimeChanged>
<TimeCreated>65098,29527.199416</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Parameter name="HeaderText">
<Description>
The application title</Description>
<Default>Tabs Application Sample</Default>
</Parameter>

<Method name="GetAllApps">
<Description>
what are the available applications</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>opt</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	s key="menu-first"
	s opt(key)="Find" ;The name of the menu
	s opt(key,"id")="Find"
	s opt(key,"TabName")="Tab Find" ;the name of the tab
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabSample"
	s opt(key,"Disable")=0 ;developed

	s key="menu-second"
	s opt(key)="About the program"
	s opt(key,"id")="About"
	s opt(key,"TabName")="About the program"
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabAbout"
	s opt(key,"Disable")=1 ;developed
	
	s key="menu-param"
	s opt(key)="Parameter"
	s opt(key,"id")="Param"
	s opt(key,"TabName")="Edit parameters"
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabSample"
	s opt(key,"Disable")=0
	q $$$OK
]]></Implementation>
</Method>

<Method name="ShowTabAbout">
<Description>
the render Tab On the program"
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	d ..GetAllApps(.opt) 
	$$$AppLogTab("INFO","Loading file","d:\!\wwww.txt")
	w "<pre>" w  w "</pre>"
	i $g(opt(Par,"Disable")) w ..GetSupportInfo() q $$$OK
	s divId=$g(opt(Par,"id"))
	w "Hello world! Parameter: "_Par
	w ..ButtonAgain(divId,,Par)
]]></Implementation>
</Method>

<Method name="ShowTabSample">
<Description>
rendering Tabs
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>key=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 d ..GetAllApps(.opt) 
 i $g(opt(key,"Disable")) w ..GetSupportInfo() q $$$OK
 s NSpace=$zu(5)
 s pref=$g(opt(key,"id"))
 s mhead=pref_"MainHeader"
 s mcont=pref_"MainContent"
 &html<
<form id="#(pref_"MainForm")#">
<div class="uk-grid">
    <div class="uk-width-1-1 " style='overflow: auto;' id="#(mhead)#" ></div>
    <div class="uk-width-1-1 uk-margin-top uk-margin-bottom" style='overflow: auto;' id="#(mcont)#"></div>
</div>
</form>

>
 $$$jsstart
 	;For the tab Param to change the height of the container
 	;if pref="Param" w "$('#"_pref_"MainHeader').height($('#tabs-"_pref_"').height());"
 	; to calculate the height of the container as a result of wijetunge victory container-Taba height of the container header
 	w "$('#"_pref_"MainContent').height($('#tabs-"_pref_"').height()-$('#"_pref_"MainHeader').height()-150);"
  	;w "console.log($('#"_pref_"MainHeader').height());"
  	;Dimming of the screen that says Download
  	w $$$blockui($$$aText("Loading...",""))
	
	;For the organization of execution by clicking on the apply button AppAct js function(From,To,Act), where
	;From - the ID of the container where will we get the items from the form method serialize
	;To - ID container where we deduce resultat run
	;AppAct=NameSpace:Packet.ClassName:Method:&Par1=Val1&Par2=Val2...
	w "AppAct('"_pref_"MainForm','"_mhead_"','AppAct="_$zu(5)_":"_..%ClassName(1)_":"_pref_"FirstHead:&divId="_pref_"&key="_key_"');"
	
 $$$jsstop
 quit $$$OK
]]></Implementation>
</Method>

<Method name="ParamFirstHead">
<Description>
to download a form for editing</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set class="App.Parameter"
	
	set sql="select * from "_class_" where Name is not null order by id desc"
	;The list of fields displayed in the Value attribute of the Option tag, 
	;The first field of the query must be an identifier
	set listFields="ID,ID,Name,Description"
	write "Choice parameters:"
	s ONCHANGE=";$('#"_divId_"SelectId').attr('value',data.item.value);"
	do ##class(App.Form).SelectObj(sql,ONCHANGE,listFields,.gn,divId_"Select")
	
	write "<br>"_$$$appInputHidden(divId_"SelectId","","")_"<br>"
	
	set onclick=$$$blockui("Loading...")_";AppAct('"_divId_"MainForm','"_divId_"MainContent','AppAct="_$zu(5)_":"_..%ClassName(1)_":"_divId_"Result:&key="_key_"&divId="_divId_"&class="_class_"&mode=*');"
	write $$$appTable1(class)
	set butt1=$$$appButton(divId_"appButtonResult1","onclick="""_$tr(onclick,"*",1)_"""",$$$aText("Preview mode in two columns",""))
	set butt2=$$$appButton(divId_"appButtonResult2","onclick="""_$tr(onclick,"*",2)_"""",$$$aText("Edit mode in one column",""))
	set butt3=$$$appButton(divId_"appButtonResult2","onclick="""_$tr(onclick,"*",3)_"""",$$$aText("The view mode from table",""))
	write $$$appTableTrTd1(butt1_butt2_butt3)
	write $$$appTableEnd1
	quit $$$OK
]]></Implementation>
</Method>

<Method name="ParamResult">
<Description>
The result of selecting the edit mode settings</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set mode=Par("mode")
	set class=Par("class")
	set SelectId=$g(Par("%request.Data",divId_"SelectId"))
	write ..ButtonAgain(divId,,key)
	if mode=1 {
		;the order of the fields in two columns by the delimiter :
		set order="Name,Description:Value,Types:DateStart,DateFinish:isEnabled,isEnabledCheck:File,OfficeFile:ImageFile,ImageGlobal::,"
		do Show(0,order)
		quit $$$OK
	} 
	elseif mode=2 {
		;the order of fields by default
		set order=""
		do Show("1,ShowFieldName",order)
		quit $$$OK
	} 
	elseif mode=3 {
		set sql="select * from "_class
		set exec="##class(App.FormExplorer).WinEditObj(.%AppLogInfoVal, %AppLogInfoCol, %AppLogInfoHead, .%AppLogInfoTemp,"""_$zu(5)_""")"
		set st=##class(App.FormExplorer).SelectObjects(class,sql,exec)
		;write 'st w $$$appError($System.Status.GetErrorText(st)) 
	}
	q $$$OK
Show(modeShow,order)
	set obj=##class(App.Form).GetObj(SelectId_","_class)
	if '$isobject(obj) { 
		set msg=$$$aText("Failed to open object","")_" "_SelectId_","_class
		write $$$appError(msg) q $$$ERROR($$$GeneralError,msg)
	}
	do ##class(App.Form).Show(obj,modeShow,divId,order)
 q
]]></Implementation>
</Method>

<Method name="FindFirstHead">
<Description>
download template forms search</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	s key=Par("key")
	s divId=Par("divId")

	set onclick=$$$blockui("Loading...")_";AppAct('"_divId_"MainForm','"_divId_"MainContent','AppAct="_$zu(5)_":"_..%ClassName(1)_":"_divId_"Result:&key="_key_"&divId="_divId_"&mode=*');"
	
	s fullPath="/opt/isc/ensemble/csp/spgz/template/samples-order-MSW-.docx"
	if ##class(App.DownloadCSP).GetFileId(fullPath,.url) {
		set fileDownload="<a href="""_url_"&log=App.Log"">fileDownload</a>"
	}
	&html<
		<table width="90%" style="border-radius: 10px; border: 1px solid #72a7cf" cellpadding="2" cellspacing="0" class="DetailTable" bgcolor="#c4d6d6" >
		<tr>
			<td>
			Login
			</td>
			<td>
			#($$$appText(divId_"Name","","su"))#
			</td>
			<td>
			fullname
			</td>
			<td>
			#($$$appTextarea(divId_"fullName","rows=5",""))#
			</td>
			<td>
			Date
			</td>
			<td>
			#($$$appDate(divId_"Date","",""))#
			</td>
		</tr>
		<tr>
			<td>
			
			</td>
			<td>
			#($$$appButton(divId_"appButtonResult1","onclick="""_$tr(onclick,"*",1)_"""","Find user"))#
			</td>
			<td>
			#($$$appButton(divId_"appButtonResult2","onclick="""_$tr(onclick,"*",2)_"""","Get items from the form"))#
			</td>
			<td>
			#($g(fileDownload))#
			</td>
			<td>
			date time
			</td>
			<td>
			#($$$appDateTime(divId_"DateTime","",""))#
			</td>
		</tr>
		</table>
	>
	q $$$OK
]]></Implementation>
</Method>

<Method name="FindResult">
<Description>
Search result</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set mode=Par("mode")
	set Name=$g(Par("%request.Data",divId_"Name"))
	set fullName=$g(Par("%request.Data",divId_"fullName"))
	set Date=$g(Par("%request.Data",divId_"Date"))
	set DateTime=$g(Par("%request.Data",divId_"DateTime"))
	write ..ButtonAgain(divId,,key)
	if mode=1 {
		if Name="" w $$$appError($$$aText("Context is empty","")) q $$$OK
		zn "%SYS"
		set sql="select ID,name,EmailAddress,fullName from Security.Users where Enabled [ '1' "
		if Name'="" s sql=sql_" and (name like '%"_Name_"%') "
		if fullName'="" s sql=sql_" and (fullName like '%"_fullName_"%') "
		set msg="Query: "_sql
		set exec="##class(App.LogInfo).MarkRed(%AppLogInfoVal,"""_Name_","_fullName_""")"
		set st=##class(App.LogInfoPane).DrawSQL(sql,100000,$zu(5),msg,exec)
		if 'st  w $$$appError($System.Status.GetErrorText(st)) 
		quit $$$OK
	} 
	elseif mode=2 {
		w "<br>" w $$$appMsg(Name_" "_fullName_" "_Date_" "_DateTime)
	}
	q $$$OK
]]></Implementation>
</Method>

<Method name="AddToForm">
<Description>
To add to the form js code</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	q $$$OK
]]></Implementation>
</Method>

<Method name="GetSupportInfo">
<Description>
To obtain information on the support</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	s msg=$$$aText("Software complex to debug. Try to log in later, or contact tech support:","")
	q msg_"Support info mailto: sample@server.com"
]]></Implementation>
</Method>
</Class>


<Class name="App.TabsPanelUikit">
<Description>
Template GUI based application Uikit</Description>
<ClassType/>
<IncludeCode>App.LogMacro</IncludeCode>
<ProcedureBlock>1</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeChanged>65387,34502</TimeChanged>
<TimeCreated>65065,36454.902831</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Parameter name="JSLIB">
<Description>
Javascript library</Description>
<Default>Uikit-3, jQueryUi-2</Default>
</Parameter>

<Parameter name="HeaderText">
<Description>
The application title</Description>
<Default>Tabs Application title</Default>
</Parameter>

<Method name="OnPage">
<Description>
Main method generate the content of page</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 set namespace=$zu(5)
 // Save the session parameters debugging mode (implies extended disclosure)
 set %session.Data("debug")=%request.Get("debug")
 set autoloadmenu=%request.Get("autoload")
 &html<
<html>
 <head>
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
 <title>#(..#HeaderText)#</title>
>
	write ##class(App.LogInfoPane).GetLink()
	write ##class(App.LogInfoPane).AddJsScripts() 
   	   do ##class(App.LogInfoPane).AddJS(namespace,..%ClassName(1))
   	   do ##class(App.LogInfoPane).AddStyle()
   	set onclick="$('#MainBody').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=Logout&appNsp="_$zu(5)_"&appPar="_$$$aText("Exit complete","")_"');"
	set menu=..DrawMenu()
 &html<

</head>
<bogy>
<div id="MainBody">
<nav id=MainNavbar class="uk-navbar-container" uk-navbar>
    <div class="uk-navbar-left">
        <ul class="uk-navbar-nav">
			<li><a href="#"><span class="uk-margin-small-right uk-icon" uk-icon="album"></span></a></li>
            <li><a href="#">#(..#HeaderText)#</a></li>
            <li class="uk-active">
                <a href="#"><span class="uk-margin-small-left uk-icon" uk-icon="menu"></span> Modes</a>
                <div class="uk-navbar-dropdown">
                    <ul class="uk-nav uk-navbar-dropdown-nav">
                    #(menu)#
                    </ul>
                </div>
            </li>
			<li><a href="#"><span id='status_nav'></span></a></li>
        </ul>
    </div>
    <div class="uk-navbar-right">
        <ul class="uk-navbar-nav">
            <li class="uk-active"><a href="#" onclick="#(onclick)#"><span class="uk-margin-small-left uk-icon" uk-icon="sign-out"></span>#($$$aText("Exit",""))#</a></li>
        </ul>
    </div>
</nav>

<div class="uk-grid">
    <div class="uk-width-1-1 uk-margin-left uk-margin-right " style='overflow: auto;' id="mainApp" >
		<ul id='tabMenu' class="uk-tab uk-tab-grid uk-tab-top" data-uk-tab="{connect:'#tabList', animation: 'fade'}">
			<li id='t1' class="uk-active"><a href="#">Welcom</a></li>
		</ul>
		<ul id="tabList" class="uk-switcher uk-margin uk-tab-content">
			<li id='ta1' >
			 <div class="uk-alert-success" uk-alert>
				<p> Sample of simple application</p>
			 </div>
			</li>
		</ul>
	</div>
</div>
>
 $$$jsstart
 	//Download status
 	write "$(document).ready(function(){"
 	write "$('#status_nav').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=DrawStatus&appNsp="_namespace_"&appPar=');"
 	if autoloadmenu="" {
	 	d ..GetAllApps(.opt) 
	 	set i="" 
	 	for { set i=$o(opt(i)) q:i=""
	 		if $GET(opt(i,"Active")) write "$('#Menu"_opt(i,"id")_"').trigger('click');"
	 	}
 	} else {
	 	write "$('#Menu"_autoloadmenu_"').trigger('click');"
 	}
 	write "});"
 $$$jsstop
 
 &html< 	
 <script language="javascript">
///$( ".tip" ).tooltip();
</script>

<div id='MainHidden' style='display:none;'></div>
<div id="dialog" title="Dialog Title">
	<div id=dialogContent></div>
</div>
</div>
</body>
</html>
	>
 quit $$$OK
]]></Implementation>
</Method>

<Method name="GetSupportInfo">
<Description>
To obtain information on the support</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set msg=$$$aText("Software complex to debug. Try to log in later, or contact tech support:","")
	quit msg_"Support info mailto: sergey.mikhaylenko@gmail.com"
]]></Implementation>
</Method>

<Method name="DrawStatus">
<Description>
rendering status of the user</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 write $s(%request.Get("debug"):"<font color=red><b>"_$$$aText("Administrator mode","")_"</b></font>",1:"")_" <span title='"_$username_"-"_$j_"'>"_$$$aText("User","")_": "_##class(App.sys).GetFullName($username)_"</span>, "_$tr(##class(App.type).GetDateTime($h),"T"," ")
 quit $$$OK
]]></Implementation>
</Method>

<Method name="GetAllApps">
<Description>
what are the available modes</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>opt</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	;TODO access rights to pages
	;TODO save in database table
	set key="menu-first"
	set opt(key)="Example search in Namespace Samples" ;The name of the menu
	set opt(key,"id")="Find"
	set opt(key,"TabName")="Example search in Namespace Samples" ;the name of the tab
	set opt(key,"ClassName")=..%ClassName(1)
	set opt(key,"Method")="ShowTabSample"
	set opt(key,"Disable")=0 ;developed
	set opt(key,"TabMenu","Close")=1

	set key="menuZ-about"
	set opt(key)="About the program"
	set opt(key,"id")="About"
	set opt(key,"TabName")="About the program"
	set opt(key,"ClassName")=..%ClassName(1)
	set opt(key,"Method")="ShowTabAbout"
	set opt(key,"Disable")=1 ;developed

	quit $$$OK
]]></Implementation>
</Method>

<Method name="ShowTab">
<Description>
rendering Tabs
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ..GetAllApps(.opt) 
	set tabId="tab-"_opt(Par,"id")
	set tabIdMenu="tabMenu-"_opt(Par,"id")
	if $g(opt(Par,"TabMenu","Close"))'="" s IconMenu="<span class=""uk-margin-small-left uk-icon uk-close"" uk-icon=""close"" onclick=""$(\'#"_tabIdMenu_",#"_tabId_"\').remove();""></span>"
 	if $DATA(opt(Par,"TabMenu","Close"))>9 { //there are more points
 		;TODO
 	}
 	$$$jsstart
 	 write "if (!$('li').is('#"_tabId_"')) { $('.uk-active').removeClass('uk-active');"
 		write " $('#tabList').append('<li id="_tabId_"></li>');"
 		write " $('#tabMenu').append('<li id="_tabIdMenu_"><a>"_$g(opt(Par,"TabName"))_$g(IconMenu)_"</a></li>');"
 		write " $('#t1,#ta1').hide();" //" $('#t1').prop('disabled',true);"
 		if $g(opt(Par,"Url"))'="" {
	 		write "$('#"_tabId_"').load('"_$g(opt(Par,"Url"))_"');"
 		}
 		else {
	 		write "$('#"_tabId_"').load('App.Action.cls','appClass="_$g(opt(Par,"ClassName"))_"&appMethod="_$g(opt(Par,"Method"))_"&appNsp="_$zu(5)_"&appPar="_Par_"');"
 		}
 	 write "};"
 	write " UIkit.tab('#tabMenu').show($('#"_tabIdMenu_"'));"
	$$$jsstop
]]></Implementation>
</Method>

<Method name="DrawMenu">
<Description>
rendering menu</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	do ..GetAllApps(.opt) 
	set i="",ret=""
	for { set i=$o(opt(i)) quit:i=""  
	   	set onclick="$('#MainHidden').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=ShowTab&appNsp="_$zu(5)_"&appPar="_i_"');"
		set ret=ret_"<li><a id='Menu"_$g(opt(i,"id"))_"' href='#' onclick="""_onclick_""">"_$g(opt(i))_"</a></li>"
	}
  quit ret
]]></Implementation>
</Method>

<Method name="Logout">
<Description>
Return in a single string</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 do ##class(App.sys).logout()
 set onclick = "top.document.location.reload();"
 &html<
 <br>
 <div class="uk-align-center uk-width-1-1 uk-margin-left uk-margin-right " style='overflow: auto;'>
	<div class="uk-alert-warning" uk-alert>
		<p>#($g(Par))#</p>
	</div>
	<center><button class="uk-button uk-button-default uk-margin-small-right" type="button" onclick="#(onclick)#" ><span class="uk-margin-small-left uk-icon" uk-icon="sign-in"></span>#($$$aText("Log in",""))#</button>
	</center>
</div>
>
 	quit $$$OK
]]></Implementation>
</Method>

<Method name="ButtonAgain">
<Description>
The output of the First button</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>divId="",key=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set mhead=divId_"MainHeader"
	set mcont=divId_"MainContent"
	set onclick="$('#"_mcont_"').empty();AppAct('"_divId_"MainForm','"_mhead_"','AppAct="_$zu(5)_":"_..%ClassName(1)_":"_divId_"FirstHead:&divId="_divId_"&key="_key_"');"
	quit $$$appButton("appButtonExit","onclick="""_$g(onclick)_"""",$$$aText("First",""))
]]></Implementation>
</Method>

<Method name="ShowTabAbout">
<Description>
the render Tab On the program"
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ..GetAllApps(.opt) 
	if $g(opt(Par,"Disable")) write ..GetSupportInfo() quit $$$OK
	set divId=$g(opt(Par,"id"))
	write "Hello world! Parameter: "_Par
	write ..ButtonAgain(divId,Par)
]]></Implementation>
</Method>

<Method name="ShowTabSample">
<Description>
rendering the Tab previously submitted
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>key=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 do ..GetAllApps(.opt) 
 if $g(opt(key,"Disable")) write ..GetSupportInfo() quit $$$OK
 set NSpace=$zu(5)
 set pref=$g(opt(key,"id"))
 set mhead=pref_"MainHeader"
 set mcont=pref_"MainContent"
 &html<
<form id="#(pref_"MainForm")#">
<div class="uk-grid">
    <div class="uk-width-1-1 "id="#(mhead)#" ></div>
    <div style='overflow: auto;' class="uk-width-1-1 uk-margin-top uk-margin-left" id="#(mcont)#"></div>
</div>
</form>
>
 ;d ##class(App.LogInfoPane).AddJS(NSpace,..%ClassName(1))
 $$$jsstart
  	w "ActionJs('"_pref_"MainForm','"_mhead_"','','"_pref_"FirstHead','divId="_pref_"~key="_key_"');"
	w "$('#"_mcont_"').height($(window).height()-($('#"_mhead_"').height()+$('#t1').height()+$('#MainNavbar').height()+200));"
  	w $$$blockui($$$aText("Loading...",""))
 $$$jsstop
 quit $$$OK
]]></Implementation>
</Method>

<Method name="FindFirstHead">
<Description>
download template forms search</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set onclick=$$$blockui("Loading...")_";ActionJs('"_divId_"MainForm','"_divId_"MainContent','','"_divId_"Result','key="_key_"~divId="_divId_"~mode=*');"
		&html<
		<table width="90%" style="border-radius: 10px; border: 1px solid #72a7cf" cellpadding="2" cellspacing="0" class="DetailTable" bgcolor="#c4d6d6" >
		<tr>
			<td>
		Context film name
			</td>
			<td>
			#($$$appText(divId_"Name","","New"))#
			</td>
			<td>

			</td>
			<td>

			</td>
			<td>
		
			</td>
			<td>

			</td>
		</tr>
		<tr>
			<td>
			
			</td>
			<td>
			#($$$appButton(divId_"appButtonResult1","onclick="""_$tr(onclick,"*",1)_"""","Find film in namespase SAMPLES"))#
			</td>
			<td>

			</td>
			<td>
			</td>
			<td>
			
			</td>
			<td>

			</td>
		</tr>
		</table>
	>
	quit $$$OK
]]></Implementation>
</Method>

<Method name="FindResult">
<Description>
Search result</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set mode=Par("mode")
	set Name=$g(Par("%request.Data",divId_"Name"))
	set Desc=$g(Par("%request.Data",divId_"Desc"))
	set Date=$g(Par("%request.Data",divId_"Date"))
	set st=$$$OK
	write ..ButtonAgain(divId,key)
	if mode=1 {
		if Name="" w $$$appError($$$aText("Context is empty","")) quit $$$OK
		zn "samples"
		set sql="select * from Cinema.Film where title is not null "
		if Name'="" s sql=sql_" and (title like '%"_Name_"%') "
		if Desc'="" s sql=sql_" and (Description like '%"_Desc_"%') "
		set msg="Query: "_sql
		set exec="##class(App.LogInfo).MarkRed(%AppLogInfoVal,"""_Name_","_Desc_""")"
		set st=##class(App.LogInfoPane).DrawSQL(sql,100000,$zu(5),msg,exec)
		if 'st  w $$$appError($System.Status.GetErrorText(st))
		quit $$$OK

	} 
	elseif mode=2 {

	}
	write "<br>"
	quit $$$OK
]]></Implementation>
</Method>
</Class>


<Class name="App.TabsPanelUikitAdmin">
<Description>
The template GUI of the application selector and tabs on the basis jQueryUi, Uikit</Description>
<ClassType/>
<IncludeCode>App.LogMacro</IncludeCode>
<ProcedureBlock>1</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeChanged>65400,39443.701964</TimeChanged>
<TimeCreated>65065,36454.902831</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Parameter name="HeaderText">
<Description>
The application title</Description>
<Default>AdminTabsApplication</Default>
</Parameter>

<Parameter name="GNStoreRef">
<Description>
Global Name Store Referens files and id sessions</Description>
<Default>^%App.ui</Default>
</Parameter>

<Method name="IsPermiss">
<Description>
is there a right to work with this form</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>role</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	q $roles[role||($roles["%All")
]]></Implementation>
</Method>

<Method name="GetAppIcon">
<Description>
Icons for the application</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>path</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[ 	q "<link rel=""icon"" href="""_path_"favicon.ico"" type=""image/x-icon""/><link rel=""shortcut icon"" href="""_path_"favicon.ico"" type=""image/x-icon""/>"
]]></Implementation>
</Method>

<Method name="OnPage">
<Description>
Main method generate the content of page
TODO #2c3136 - 6699CC , 33383e - #6FA6DE , ffffff - #0048BA
#3e454c - 2185D0 , 1c1f22 - 0FC0FC , 656a70 - </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>parameter=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 set NSpace=##class(App.Action).GetParam(.%request,"ns",parameter)
 s:$g(NSpace)="" NSpace=$zu(5)
 zn NSpace
 // Save the session parameters debugging mode (implies extended disclosure)
 ;s %session.Data("debug")=%request.Get("debug")
 
 // http://cip.mvk.ru/csp/spgz/App.MVK.gisui.cls?ns=MVK&autoload=Find# - Find the first startup
 // http://localhost:57773/apptoolsrest/get-html/App.TabsPanelUikitAdmin?ns=APP&autoload=Find
 ;if $d(%request) {  set autoloadmenu=$p(%request.Get("autoload"),"#")
 set autoload=##class(App.Action).GetParam(.%request,"autoload",parameter)
 
 ;do ##class(App.Log).AddRecord(..%ClassName(1), "OnPage", "Login", "INFO", "","")
 &html<
 <!doctype html>
 <html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>#(..#HeaderText)#</title>
>
 	write ##class(App.LogInfoPane).GetLink()
 	write ##class(App.LogInfoPane).AddJsScripts() 
   	   do ##class(App.LogInfoPane).AddJS(NSpace,..%ClassName(1))
   	   do ##class(App.LogInfoPane).AddStyle()
 	set menu=..DrawMenu() ;sidebar
	set menuTop=..DrawMenuTop() ;top think
	set path=$$$PATHCSP
	write ..GetAppIcon(path)
 &html<
	
<link rel="stylesheet" href="#(path)#/uikit-dark-admin/css/nav.css"> <!-- CSS reset -->
	
</head>
<body>
	<header class="cd-main-header">
		<a href="#" class="cd-logo">
			<font color=#E4F2FB>#(..#HeaderText)#</font>
		</a>
		
		<div class="cd-search is-hidden">
			<input type="search" placeholder="search.." id="searchstr" name="searchstr">
		</div> <!-- cd-search -->

		<a href="#" class="cd-nav-trigger"><span></span></a>

		<nav class="cd-nav">
			<ul class="cd-top-nav">
				#(menuTop)#
			</ul>
		</nav>
	</header> <!-- .cd-main-header -->

	<main class="cd-main-content">
		<nav class="cd-side-nav">
			
			<ul class="uk-nav uk-nav-default">
				<li class="cd-label">...</li>
					#(menu)#
			</ul>

		</nav>

		<div id=MainBody class="content-wrapper">
        <!-- Page Content -->
		<br />
			
<div class="uk-grid">
    <div class="uk-width-1-1 uk-margin-left uk-margin-right " style='overflow: auto;' id="mainApp" >
		<ul id='tabMenu' class="uk-tab uk-tab-grid uk-tab-top" data-uk-tab="{connect:'#tabList', animation: 'fade'}">
			<li id='t1' class="uk-active"><a href="#">About</a></li>
		</ul>
		<ul id="tabList" class="uk-switcher uk-margin uk-tab-content">
			<li id='ta1' >
			 <div class="uk-alert-success" uk-alert>
				<p title='#($username)#'> #($$$aText("If you are not available to any single menu item",""))#</p>
			 </div>
			</li>
		</ul>
	</div>
</div>
        <!-- /#page-content-wrapper -->
		</div> <!-- .content-wrapper -->
	</main> <!-- .cd-main-content -->

<script src="#(path)#/uikit-dark-admin/js/main.js"></script> <!-- Resource jQuery -->

 <script language="javascript">

(function($) {
    var $window = $(window),
        $html = $('#wrapper');

    function resize() {
        if ($window.width() < 768) {
            return $html.removeClass('toggled');
        }
		
        $html.addClass('toggled');
    }

    $window
        .resize(resize)
        .trigger('resize');
})(jQuery);

</script>
<div id='MainHidden' style='display:none;'></div>
<div id="dialog" title="Dialog Title">
	<div id=dialogContent></div>
</div>
>
 $$$jsstart
 	;w "$('#account_status').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=DrawStatus&appNsp="_NSpace_"&appPar=');"_$c(13,10)
 	;w "$('#searchstr').keydown(function (e) { if (e.keyCode == 13) { $('#MainHidden').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=ShowTab&appNsp="_$zu(5)_"&appPar=Search&Searchstr='+document.getElementById('searchstr').value); }});"_$c(13,10)
 	write ##class(App.Action).WriteActJs(%request,"","account_status",..%ClassName(1),"DrawStatus","")_$c(13,10)
 	set enter=##class(App.Action).WriteActJs(%request,"","MainHidden",..%ClassName(1),"ShowTab","&appPar=Search&Searchstr='+document.getElementById('searchstr').value")_$c(13,10)
 	write "$('#searchstr').keydown(function (e) { if (e.keyCode == 13) { "_enter_" }});"_$c(13,10)

  	if autoload="" {
	 	do ..GetAllApps(.opt) 
	 	set i="" 
	 	for { set i=$o(opt(i)) q:i=""
	 		if $GET(opt(i,"Active")) write "$('#Menu"_opt(i,"id")_"').trigger('click');"_$c(13,10)
	 	}
 	} else {
	 	write "$('#Menu"_autoload_"').trigger('click');"_$c(13,10)
 	}
 $$$jsstop
 
 &html<
</body>
</html>
	>
 quit $$$OK
]]></Implementation>
</Method>

<Method name="DrawMenuTop">
<Description>
the rendering top menu </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	do ..GetAllApps(.opt) 
	do ..GetAllMenu(.opt,.menu,1)
	set m="",ret=""
	for { set m=$o(menu(m)) quit:m=""
		s i=""
		if m=99 { ;account - with submenu
			s ret=ret_"<li class='has-children account'><a href='#'><span id='account_status'>"_$lg(menu(m),2)_"</span></a><ul>"
			for { set i=$o(menu(m,i)) quit:i=""
		   		;set onclick="$('#MainHidden').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=ShowTab&appNsp="_$zu(5)_"&appPar="_i_"');"
				set onclick=##class(App.Action).WriteActJs(%request,"","MainHidden",..%ClassName(1),"ShowTab","&appPar="_i)
				set ret=ret_"<li><a id='Menu"_$g(opt(i,"id"))_"' href='#' onclick="""_onclick_""">"_$g(opt(i))_"</a></li>"
			}
			s ret=ret_"</ul></li>"
		}
		else {
			for { set i=$o(menu(m,i)) quit:i=""
		   		;set onclick="$('#MainHidden').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=ShowTab&appNsp="_$zu(5)_"&appPar="_i_"');"
		   		set onclick=##class(App.Action).WriteActJs(%request,"","MainHidden",..%ClassName(1),"ShowTab","&appPar="_i)
				set ret=ret_"<li><a id='Menu"_$g(opt(i,"id"))_"' href='#' onclick="""_onclick_""">"_$g(opt(i))_"</a></li>"
			}
		}
	}
  quit ret
]]></Implementation>
</Method>

<Method name="DrawMenu">
<Description>
render side menu </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	do ..GetAllApps(.opt) 
	do ..GetAllMenu(.opt,.menu)
	set m="",ret=""
	for { set m=$o(menu(m)) quit:m=""
		s i=""
		s active=$s($lg(menu(m),3):"active",1:"")
		s ret=ret_"<li class='has-children overview "_active_"'><a href='#'>"_$lg(menu(m),2)_"</a><ul>"
		for { set i=$o(menu(m,i)) quit:i=""
	   		;set onclick="$('#MainHidden').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=ShowTab&appNsp="_$zu(5)_"&appPar="_i_"');"
	   		set onclick=##class(App.Action).WriteActJs(%request,"","MainHidden",..%ClassName(1),"ShowTab","&appPar="_i)
			set ret=ret_"<li><a id='Menu"_$g(opt(i,"id"))_"' href='#' onclick="""_onclick_""">"_$g(opt(i))_"</a></li>"
		}
		s ret=ret_"</ul></li>"
	}
  quit ret
]]></Implementation>
</Method>

<Method name="GetSupportInfo">
<Description>
To obtain information on the support</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	s msg=$$$aText("Software complex to debug. Try to log in later, or contact tech support:","")
	q msg_"Support info mailto: sergey.mikhaylenko@gmail.com"
]]></Implementation>
</Method>

<Method name="IsDebugMode">
<Description>
To add to the form js code if development mode</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>mode=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 i mode,'%request.Get("debug") { 
	$$$jsstart
	  w $$$blockui(..GetSupportInfo())
	$$$jsstop
  q $$$OK
 }
	q 0
]]></Implementation>
</Method>

<Method name="DrawStatus">
<Description>
rendering status of the user</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	;do ##class(App.Form).BlockUI(0)
	s fio=##class(App.sys).GetFullName($username)
	s:fio="" fio=$$$aText("The user","")
	;w $s(%request.Get("debug"):"<font color=red><b>"_$$$aText("Administrator mode","")_"</b></font>",1:"")_" <span class='tip' title='"_$username_"-"_$j_"-"_$zu(5)_"'>"_$$$aText("User","")_": "_fio_"</span>, "_$tr(##class(App.type).GetDateTime($h),"T"," ")
	write "<span class='tip' title='"_fio_"-"_$j_"-"_$zu(5)_"'>"_$username_"</span>"
 	;$$$jsstart
	;	w "$('.tip').tooltip();"
	;$$$jsstop
 q $$$OK
]]></Implementation>
</Method>

<Method name="GetAllMenu">
<Description>
To menu</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>opt,menu,top=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 s i="" for { s i=$o(opt(i)) q:i=""
	if 'top,$d(opt(i,"Menu")) { 
		s m=$lg(opt(i,"Menu"),1)
		s:'$d(menu(m)) menu(m)=opt(i,"Menu")
		s menu(m,i)=""
	}
	if top,$d(opt(i,"MenuTop")) { 
		s m=$lg(opt(i,"MenuTop"),1)
		s:'$d(menu(m)) menu(m)=opt(i,"MenuTop")
		s menu(m,i)=""
	} else {
		;s:'$d(menu(99)) menu(99)=$lb(0,"---",0)
		;s menu(99,i)=""
	}
  }
]]></Implementation>
</Method>

<Method name="GetAllApps">
<Description>
what are the available modes</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>opt</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	;make them zavisimye from the area
	;------------ sidebar
	s key="menu-first"
	s opt(key)="Find users" ;The name of the menu
	s opt(key,"id")="Find" ;use methods: FindFirstHead FindResult
	s opt(key,"TabName")="finding users" ;the name of the tab
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabSample"
	s opt(key,"Disable")=0 ;developed
	s opt(key,"TabMenu","Close")=1
	s opt(key,"Menu")=$lb(1,"Mode",1) ;$lg(,3)=1 - open menu level 1
	s opt(key,"Active")=1 ;active menu item

	s key="menu-first2"
	s opt(key)="Sample gallery" ;The name of the menu
	s opt(key,"id")="Lighbox" ;use methods: LighboxFirstHead LighboxResult
	s opt(key,"TabName")="Gallery" ;the name of the tab
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabSample"
	s opt(key,"Disable")=0 ;developed
	s opt(key,"TabMenu","Close")=1
	s opt(key,"Menu")=$lb(1,"Mode",1) ;$lg(,3)=1 - open menu level 1
	
	s key="menu-second"
	s opt(key)="Help"
	s opt(key,"id")="Help"
	s opt(key,"TabName")="Help"
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"MethodUrl")="http://ShowTabAbout.cls"
	s opt(key,"Disable")=1 ;developed
	s opt(key,"Menu")=$lb(2,"About the program",0)

	s key="menu-second2"
	s opt(key)="Menu 3"
	s opt(key,"id")="About"
	s opt(key,"TabName")="Menu 3"
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabAbout"
	s opt(key,"Disable")=1 ;developed
	s opt(key,"Menu")=$lb(2,"About the program")

	s key="menu-second3"
	s opt(key)="Support"
	s opt(key,"id")="Support"
	s opt(key,"TabName")="Support"
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"MethodUrlNewWin")="http://ShowTabAbout.cls"
	s opt(key,"Disable")=1 ;developed
	s opt(key,"Menu")=$lb(2,"About the program")
	
	;------------ one-level upper menu 
	s key="menu-topLern"
	s opt(key)="Menu 2"
	s opt(key,"id")="Menu2"
	s opt(key,"TabName")="Menu 2"
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabAbout"
	s opt(key,"MenuTop")=$lb(1,"Menu 2") ;has no sub-items

	s key="menu-topOpt"
	s opt(key)="Option"
	s opt(key,"id")="Option"
	s opt(key,"TabName")="Option"
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabAbout"
	s opt(key,"MenuTop")=$lb(2,"Option") ;has no sub-items

	;------------ top menu the top-accoun
	s key="menu-top-accoun"
	s opt(key)=$$$aText("Profile","")
	s opt(key,"id")="AccountProf"
	s opt(key,"TabName")=$$$aText("Profile","")
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabAbout"
	s opt(key,"MenuTop")=$lb(99,"Account") ;only 99-account has sub-items

	s key="menu-top-account3"
	s opt(key)=$$$aText("Exit","")
	s opt(key,"id")="AccountExit"
	s opt(key,"TabName")=$$$aText("Exit","")
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="Logout"
	s opt(key,"MenuTop")=$lb(99,"Account") ;only 99-account has sub-items
	
	;----- Setup the search in the top menu
	s key="Search"
	s opt(key)=$$$aText("Search","")
	s opt(key,"id")="Search-"
	s opt(key,"TabName")=$$$aText("Search","")_"-"
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabSearch"
	s opt(key,"TabMenu","Close")=1
	s opt(key,"TabMenu","Mode")=0 ;1 - for each new search bar to make new tab, 0-tab is always the same
	
	q $$$OK
]]></Implementation>
</Method>

<Method name="ShowTabSearch">
<Description>
drawing Tabs search
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>key=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 ;do ..GetAllApps(.opt) 
 ;if $g(opt(key,"Disable")) write ..GetSupportInfo() quit $$$OK
 ;set NSpace=$zu(5)
 w $$$aText("Context","")_" :"_$g(key)
 ;set pref=$g(opt(key,"id"))
]]></Implementation>
</Method>

<Method name="ShowTab">
<Description>
the render Tab on the menu
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	if $g(Par("appPar"))'="" set Par=Par("appPar")
	do ..GetAllApps(.opt) 
	if Par="Search" {
		s Searchstr=$g(Par("%request.Data","Searchstr"),Par("Searchstr"))
		if Searchstr="" q $$$OK
		;s tr=$tr(##class(App.MSW.type).Transliteration(Searchstr)," `()\/*;'"":%","_N---")
		;s tr=$tr($zts,".,") 
		s tr=$e($tr(Searchstr," `()\/*;'"":%?$@&.,",""),1,10)_$i(@..#GNStoreRef@("jobs",$j))
		s key=tr ;Searchstr
		MERGE opt(key)=opt(Par)
		s opt(key)=opt(key)_tr ;Searchstr
		i $g(opt(Par,"TabMenu","Mode"))=1 { ;mode add a new tab 
			s opt(key,"id")=opt(key,"id")_tr
		} else { ;mode add a new replace the old 
			set tabId="tab-"_opt(Par,"id")
			set tabIdMenu="tabMenu-"_opt(Par,"id")
			$$$jsstart
		  	 w "$('#"_tabId_"').remove();"
		  	 w "$('#"_tabIdMenu_"').remove();"
		  	$$$jsstop
		}
		s opt(key,"TabName")=opt(key,"TabName")_tr 
		s Par=key
		s CGIvar="&Searchstr="_Searchstr ;$zconvert(Searchstr,"O","URI")
	}
	set tabId="tab-"_opt(Par,"id")
	set tabIdMenu="tabMenu-"_opt(Par,"id")
	if $g(opt(Par,"TabMenu","Close"))'="" s IconMenu="<span class=""uk-margin-small-left uk-icon uk-close"" uk-icon=""close"" onclick=""$(\'#"_tabIdMenu_",#"_tabId_"\').remove();""></span>"
 	if $DATA(opt(Par,"TabMenu","Close"))>9 { //there are more points
 		;TODO
 	}
 	$$$jsstart
 	 if $g(opt(Par,"MethodUrlNewWin"))'="" {
	 	 if $g(opt(Par,"Disable")) { w "alert('"_$$$aText("Mode debugging","")_"');"}
	 	 else {write "window.open('"_$g(opt(Par,"MethodUrlNewWin"))_"','_blank');"
	 	 }
 	}
	else {
 	 write "if (!$('li').is('#"_tabId_"')) { $('.uk-active').removeClass('uk-active');"_$c(13,10)
 		write " $('#tabList').append('<li id="_tabId_"></li>');"_$c(13,10)
 		write " $('#tabMenu').append('<li id="_tabIdMenu_"><a>"_$g(opt(Par,"TabName"))_$g(IconMenu)_"</a></li>');"_$c(13,10)
 		write " $('#t1,#ta1').hide();"_$c(13,10) //" $('#t1').prop('disabled',true);"
 		if $g(opt(Par,"Disable")) {
	 		;write "$('#"_tabId_"').load('App.Action.cls','appClass="_..%ClassName(1)_"&appMethod=ShowTabAbout&appNsp="_$zu(5)_"&appPar="_Par_"');"
	 		write ##class(App.Action).WriteActJs(%request,"",tabId,..%ClassName(1),"ShowTabAbout","&appPar="_Par_$g(CGIvar))
 		}
 		elseif $g(opt(Par,"MethodUrl"))'="" {
	 		write "$('#"_tabId_"').load('"_$g(opt(Par,"MethodUrl"))_"');"
 		}
 		else {
	 		;write "$('#"_tabId_"').load('App.Action.cls','appClass="_$g(opt(Par,"ClassName"))_"&appMethod="_$g(opt(Par,"Method"))_"&appNsp="_$zu(5)_"&appPar="_Par_"');"
	 		write ##class(App.Action).WriteActJs(%request,"",tabId,$g(opt(Par,"ClassName")),$g(opt(Par,"Method")),"&appPar="_Par_$g(CGIvar))
 		}
 	 write "};"
 	 write " UIkit.tab('#tabMenu').show($('#"_tabIdMenu_"'));"
	}
	$$$jsstop
]]></Implementation>
</Method>

<Method name="Logout">
<Description>
Return in a single string</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 if $g(Par("appPar"))'="" set Par=Par("appPar")
 do ##class(App.sys).logout()
 set onclick = "top.document.location.reload();"
 do ..GetAllApps(.opt) 
 $$$jsstart
 set i=""
 for { set i=$o(opt(i)) q:i=""
 	continue:i=Par
 	set tabId="tab-"_opt(i,"id")
	set tabIdMenu="tabMenu-"_opt(i,"id")
 	write "$('#"_tabIdMenu_",#"_tabId_"').remove();"
 }
 $$$jsstop
 &html<
 <br>
 <div class="uk-align-center uk-width-1-1 uk-margin-left uk-margin-right " style='overflow: auto;'>
	<div class="uk-alert-warning" uk-alert>
		<p>#($$$aText("The output of Sistema produced",""))#</p>
	</div>
	<center><button class="uk-button uk-button-default uk-margin-small-right" type="button" onclick="#(onclick)#" ><span class="uk-margin-small-left uk-icon" uk-icon="sign-in"></span>#($$$aText("Log in",""))#</button>
	</center>
</div><br><br>
>
 	quit $$$OK
]]></Implementation>
</Method>

<Method name="ButtonAgain">
<Description>
The output of the First button</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>divId="",key=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set mhead=divId_"MainHeader"
	set mcont=divId_"MainContent"
	set onclick="$('#"_mcont_"').empty();"_##class(App.Action).WriteActJs(%request,divId_"MainForm",mhead,..%ClassName(1),divId_"FirstHead","&key="_key_"&divId="_divId)
	;AppAct('"_divId_"MainForm','"_mhead_"','AppAct="_$zu(5)_":"_..%ClassName(1)_":"_divId_"FirstHead:&divId="_divId_"&key="_key_"');"
	quit $$$appButton("appButtonExit","onclick="""_$g(onclick)_"""",$$$aText("First",""))
]]></Implementation>
</Method>

<Method name="ShowTabAbout">
<Description>
the render Tab On the program"
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>key=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	if $g(key("appPar"))'="" set key=key("appPar")
	do ..GetAllApps(.opt) 
	if $g(opt(key,"Disable")) write ..GetSupportInfo() quit $$$OK
	set divId=$g(opt(key,"id"))
	write "Hello world! Parameter: "_key
	write ..ButtonAgain(divId,key)
]]></Implementation>
</Method>

<Method name="ShowInIFrame">
<Description>
rendering the Tab previously submitted
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>key=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 if $g(key("appPar"))'="" set key=key("appPar")
 do ..GetAllApps(.opt) 
 if $g(opt(key,"Disable")) write ..GetSupportInfo() quit $$$OK
 set NSpace=$zu(5)
 set pref=$g(opt(key,"id"))
 set mhead=pref_"MainHeader"
 set mcont=pref_"MainContent"
 &html<
<form id="#(pref_"MainForm")#">
<div class="uk-grid">
    <iframe id="#(mcont)#" width="100%" height="100%" style='overflow: auto;' src='#($g(opt(key,"InFrameUrl")))#' ></iframe>
    </div>
</div>
</form>
>
 $$$jsstart
  ;	; to calculate the height of the container as a result of wijetunge victory container-Taba height of the container header
 	w "$('#"_mcont_"').height($(window).height()-($('#t1').height()+$('#MainNavbar').height()+150));"
  ;	w $$$blockui($$$aText("Loading...",""))
 $$$jsstop
 quit $$$OK
]]></Implementation>
</Method>

<Method name="ShowTabSample">
<Description>
rendering the Tab previously submitted
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>key=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 if $g(key("appPar"))'="" set key=key("appPar")
 do ..GetAllApps(.opt) 
 if $g(opt(key,"Disable")) write ..GetSupportInfo() quit $$$OK
 set NSpace=$zu(5)
 set pref=$g(opt(key,"id"))
 set mhead=pref_"MainHeader"
 set mcont=pref_"MainContent"
 &html<
<form id="#(pref_"MainForm")#">
<div class="uk-grid">
    <div class="uk-width-1-1 "id="#(mhead)#" ></div>
    <div style='overflow: auto;' class="uk-width-1-1 uk-margin-top uk-margin-left" id="#(mcont)#"></div>
</div>
</form>
>
 ;d ##class(App.LogInfoPane).AddJS(NSpace,..%ClassName(1))
 
 $$$jsstart
  	; to calculate the height of the container as a result of wijetunge victory container-Taba height of the container header
    w ##class(App.Action).WriteActJs(%request,pref_"MainForm",mhead,..%ClassName(1),pref_"FirstHead","&divId="_pref_"&key="_key)
	w "$('#"_mcont_"').height($(window).height()-($('#"_mhead_"').height()+$('#t1').height()+$('#MainNavbar').height()+300));"_$c(13,10)
  	w $$$blockui($$$aText("Loading...",""))
 $$$jsstop
 quit $$$OK
]]></Implementation>
</Method>

<Method name="FindFirstHead">
<Description>
download template forms search</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set onclick=$$$blockui("Load...")_";"_##class(App.Action).WriteActJs(%request,divId_"MainForm",divId_"MainContent",..%ClassName(1),divId_"Result","~key="_key_"~divId="_divId_"~mode=*")
	;ActionJs('"_divId_"MainForm','"_divId_"MainContent','','"_divId_"Result','key="_key_"~divId="_divId_"~mode=*');"
		&html<
		<table width="90%" style="border-radius: 10px; border: 1px solid #72a7cf" cellpadding="2" cellspacing="0" class="DetailTable" bgcolor="#c4d6d6" >
		<tr>
			<td>
		Context name users
			</td>
			<td>
				#($$$appText(divId_"textName","title='context in Name'","m"_$username))#
			</td>		
			<td>
				#($$$appText(divId_"textDesc","title='context in FullName'","m"))#
			</td>
			<td>
			</td>
			<td>
		
			</td>
			<td>

			</td>
		</tr>
		<tr>
			<td>
			
			</td>
			<td>
			#($$$appButton(divId_"appButtonResult1","onclick="""_$tr(onclick,"*",1)_"""","Find USERS"))#
			</td>
			<td>
			</td>
			<td>
			</td>
			<td>
			
			</td>
			<td>

			</td>
		</tr>
		</table>
	>
 $$$jsstart
 	//for all identifiers starting with "_divId_"text by pressing Enter, click on the button (ending with $("[id$='txtTitle']"))
 	w "$('[id^="""_divId_"text""]').keydown(function (e) { if (e.keyCode == 13) { $('#"_divId_"appButtonResult1').click(); }});"_$c(13,10)
 $$$jsstop
	
	quit $$$OK
]]></Implementation>
</Method>

<Method name="FindResult">
<Description>
Search result</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set mode=Par("mode")
	;Geting elements from form and prepare array Par
	s Name=##class(App.Action).GetElemForm(%request,.Par,divId_"textName")	
	set Desc=$g(Par("%request.Data",divId_"textDesc"))
	set st=$$$OK
	if mode=1 {
		write ..ButtonAgain(divId,key)
		if Name="" w $$$appError($$$aText("Context is empty","")) quit $$$OK
		zn "%sys"
		set sql="select ID,name,EmailAddress,fullName from Security.Users where Enabled [ '1' "
		if Name'="" s sql=sql_" and (name like '%"_Name_"%') "
		if Desc'="" s sql=sql_" and (fullName like '%"_Desc_"%') "
		set msg="Query: "_sql

		set exec="##class(App.LogInfo).MarkRed(%AppLogInfoVal,"""_Name_","_Desc_""")"
		set st=##class(App.LogInfoPane).DrawSQL(sql,100000,$zu(5),msg,exec)
		if 'st  w $$$appError($System.Status.GetErrorText(st))
		quit $$$OK

	} 
	write "<br>"
	quit $$$OK
]]></Implementation>
</Method>

<Method name="LighboxFirstHead">
<Description>
download template forms search</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set onclick=$$$blockui("Load...")_";"_##class(App.Action).WriteActJs(%request,divId_"MainForm",divId_"MainContent",..%ClassName(1),divId_"Result","~key="_key_"~divId="_divId_"~mode=*")
	Set path=$p($p($zu(86),"*",1),$$$slash,1,*-1)
	Set path1=path_$tr("\csp\broker\images\","\",$$$slash)
	Set path2=path_$tr("\docs\","\",$$$slash)
		&html<
		<table width="90%" style="border-radius: 10px; border: 1px solid #72a7cf" cellpadding="2" cellspacing="0" class="DetailTable" bgcolor="#c4d6d6" >
		<tr>
			<td>
				#($$$appText(divId_"path1","size=50 title='path to images'",path1))#
			</td>
			<td>
				#($$$appText(divId_"path2","size=50 title='path to images docs'",path2))#
			</td>
		</tr>
		<tr>
			<td>
			#($$$appButton(divId_"appButtonResult1"," onclick="""_$tr(onclick,"*",1)_"""","Generate gallery via App /csp/broker"))#			
			</td>
			<td>
			#($$$appButton(divId_"appButtonResult2"," onclick="""_$tr(onclick,"*",2)_"""","Generate gallery dinamic rest"))#			
			</td>
		</tr>
		</table>
	>
 $$$jsstart
 	;for all identifiers starting with "_divId_"text by pressing Enter, click on the button (ending with $("[id$='txtTitle']"))
 	w "$('[id^="""_divId_"path""]').keydown(function (e) { if (e.keyCode == 13) { $('#"_divId_"appButtonResult2').click(); }});"_$c(13,10)
 $$$jsstop
	
	quit $$$OK
]]></Implementation>
</Method>

<Method name="LighboxResult">
<Description>
Its result</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set mode=Par("mode")
	;Geting elements from form and prepare array Par
	s path1=##class(App.Action).GetElemForm(%request,.Par,divId_"path1")	
	set path2=$g(Par("%request.Data",divId_"path2"))
	set st=$$$OK
	s wc=##class(App.filesMimeTypes).GetTypesWildcards("image")_##class(App.filesMimeTypes).GetTypesWildcards("video")
	if mode=1 {
	 d ##class(App.files).GetList(path1,wc,.List)
	 s cspappstatic="/csp/broker/images/"
	 ;zw List
	 $$$jsstart
 		w "UIkit.lightboxPanel({"
   		w "items: [ "
		  d ..LighboxDrawJson(.List,cspappstatic)
  		w " ] }).show();"
	 $$$jsstop
	} 
	elseIF mode=2 {
	;	w path2
	 d ##class(App.files).GetList(path2,wc,.List)
	 ;zw List
	 s appdinamic=%request.Application_"get-files/"
	 $$$jsstart
 		w "UIkit.lightboxPanel({"
   		w "items: [ "
		  d ..LighboxDrawJson(.List,,appdinamic,..#GNStoreRef)
  		w " ] }).show();"
	 $$$jsstop
	}
	write "<br>"
	quit $$$OK
]]></Implementation>
</Method>

<Method name="LighboxDrawJson">
<Description>
Lighbox Draw JSON
List - files array 
subdir - application static</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>List,subdir="",appdinamic,gn=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 s i=""
 for { s i=$o(List(i)) q:i=""
 	if $lv($g(List(i))),$lg($g(List(i)),2)="F" {
		 	s fullpath=$lg($g(List(i)),1)
		 	s ItemName=$lg($g(List(i)),4)
 	} else {
 		s ItemName=$g(List(i,"ItemName"))
 		s fullpath=$g(List(i,"Name"))
 	}
 	set ext=$p(ItemName,".",*)
 	s mimetype=##class(App.filesMimeTypes).GetMimeTypes4ext(ext)
 	s type=$s(mimetype[("video"):"video",(mimetype)[("image"):"image",1:"iframe")
 	if subdir'="" {
 		w "{source: '"_subdir_ItemName_"', caption: '"_ItemName_"', type: '"_type_"'}",$c(13,10)
 	} else {
	 	set fileId=##class(App.files).GetFileIdView(fullpath,gn) 
		w "{source: '"_appdinamic_fileId_"', caption: '"_ItemName_"', type: '"_type_"'}",$c(13,10)
 	}
	w:$o(List(i))'="" ","
 }
]]></Implementation>
</Method>
</Class>


<Class name="App.TabsPanelUikitPermissMatrx">
<Description>
The template GUI of the application selector and tabs</Description>
<IncludeCode>App.LogMacro</IncludeCode>
<Super>App.TabsPanelUikit</Super>
<TimeChanged>65317,30981</TimeChanged>
<TimeCreated>65098,29527.199416</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Parameter name="HeaderText">
<Description>
The application title</Description>
<Default>Tabs Application PermissMatrx</Default>
</Parameter>

<Method name="GetAllApps">
<Description>
what are the available applications</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>opt</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##super(.opt)
	s key="AmenuMatrix"
	s opt(key)=$$$aText("The matrix","") ;The name of the menu
	s opt(key,"id")="Matrix"
	s opt(key,"TabName")=$$$aText("The matrix","") ;the name of the tab
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabItem"
	s opt(key,"Disable")=0 ;developed
	s opt(key,"TabMenu","Close")=1

	s key="menuUser"
	s opt(key)=$$$aText("An example of a user search","") ;The name of the menu
	s opt(key,"id")="FindUsers"
	s opt(key,"TabName")=$$$aText("The search tab users","") ;the name of the tab
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabItem"
	s opt(key,"Disable")=0 ;developed
	s opt(key,"TabMenu","Close")=1

	s key="menuZ-about"
	s opt(key)="About the program"
	s opt(key,"id")="About"
	s opt(key,"TabName")="About the program"
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabAbout"
	s opt(key,"Disable")=0 ;developed
	
	s key="menu2-param"
	s opt(key)="Parameter"
	s opt(key,"id")="Param"
	s opt(key,"TabName")="Edit Parameter"
	s opt(key,"ClassName")=..%ClassName(1)
	s opt(key,"Method")="ShowTabItem"
	s opt(key,"Disable")=0
	s opt(key,"TabMenu","Close")=1
	s opt(key,"Active")=1 ;Download the tab immediately

	q $$$OK
]]></Implementation>
</Method>

<Method name="ShowTabAbout">
<Description>
the render Tab On the program"
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[

	d ..GetAllApps(.opt) 
	i $g(opt(Par,"Disable")) w ..GetSupportInfo() q $$$OK
	s divId=$g(opt(Par,"id"))
	w "Sample Program Based on jQueryUI, Uikit<br>"
	w ..ButtonAgain(divId,Par)
	;w "<pre>" w  w "</pre>"
]]></Implementation>
</Method>

<Method name="ShowTabItem">
<Description>
rendering Tabs
Par - code menu item from the GetAllApps ..</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>key=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 d ..GetAllApps(.opt) 
 i $g(opt(key,"Disable")) w ..GetSupportInfo() q $$$OK
 s NSpace=$zu(5)
 s divId=$g(opt(key,"id"))
 s mhead=divId_"MainHeader"
 s mcont=divId_"MainContent"
 &html<
<form id="#(divId_"MainForm")#">
<div class="uk-grid">
    <div class="uk-width-1-1 " style='overflow: auto;' id="#(mhead)#" ></div>
    <div class="uk-width-1-1 uk-margin-top uk-margin-bottom" style='overflow: auto;' id="#(mcont)#"></div>
</div>
</form>

>
 $$$jsstart
 	; to calculate the height of the container as a result of wijetunge victory container-Taba height of the container header
 	w "$('#"_mcont_"').height($(window).height()-($('#"_mhead_"').height()+$('#t1').height()+$('#MainNavbar').height()+200));"
 	;Dimming of the screen that says Download
  	w $$$blockui($$$aText("Loading...",""))
	
	;For the organization of execution by clicking on the apply button AppAct js function(From,To,Act), where
	;From - the ID of the container where will we get the items from the form method serialize
	;To - ID container where we deduce resultat run
	;AppAct=NameSpace:Packet.ClassName:Method:&Par1=Val1&Par2=Val2...
	w "AppAct('"_divId_"MainForm','"_mhead_"','AppAct="_$zu(5)_":"_..%ClassName(1)_":"_divId_"FirstHead:&divId="_divId_"&key="_key_"');"
	
 $$$jsstop
 quit $$$OK
]]></Implementation>
</Method>

<Method name="ParamFirstHead">
<Description>
to download a form for editing</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set class="App.Parameter"
	
	set sql="select * from "_class_" where Name is not null order by id desc"
	;The list of fields displayed in the Value attribute of the Option tag, 
	;The first field of the query must be an identifier
	set listFields="ID,ID,Name,Description"
	write $$$aText("Select settings","")
	s ONCHANGE=";$('#"_divId_"SelectId').attr('value',data.item.value);"
	do ##class(App.Form).SelectObj(sql,ONCHANGE,listFields,.gn,divId_"Select")
	
	write "<br>"_$$$appInputHidden(divId_"SelectId","","")_"<br>"
	
	set onclick=$$$blockui($$$aText("Loading...",""))_";AppAct('"_divId_"MainForm','"_divId_"MainContent','AppAct="_$zu(5)_":"_..%ClassName(1)_":"_divId_"Result:&key="_key_"&divId="_divId_"&class="_class_"&mode=*');"
	write $$$appTable1(class)
	set butt1=$$$appButton(divId_"appButtonResult1","onclick="""_$tr(onclick,"*",1)_"""",$$$aText("Preview mode in two columns",""))
	set butt2=$$$appButton(divId_"appButtonResult2","onclick="""_$tr(onclick,"*",2)_"""",$$$aText("Edit mode in one column",""))
	set butt3=$$$appButton(divId_"appButtonResult2","onclick="""_$tr(onclick,"*",3)_"""",$$$aText("The view mode from table",""))
	write $$$appTableTrTd1(butt1_butt2_butt3)
	write $$$appTableEnd1
	quit $$$OK
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// The result of selecting the edit mode settings

]]></Content>
</UDLText>

<Method name="ParamResult">
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set mode=Par("mode")
	set class=Par("class")
	set SelectId=$g(Par("%request.Data",divId_"SelectId"))
	write ..ButtonAgain(divId,key)
	if mode=1 {
		;the order of the fields in two columns by the delimiter :
		set order="Name,Description:Value,Types:DateStart,DateFinish:isEnabled,isEnabledCheck:File,OfficeFile:ImageFile,ImageGlobal::,"
		do Show(0,order)
		quit $$$OK
	} 
	elseif mode=2 {
		;the order of fields by default
		set order=""
		do Show("1,ShowFieldName",order)
		quit $$$OK
	} 
	elseif mode=3 {
		set sql="select * from "_class
		set exec="##class(App.FormExplorer).WinEditObj(.%AppLogInfoVal, %AppLogInfoCol, %AppLogInfoHead, .%AppLogInfoTemp,"""_$zu(5)_""")"
		set st=##class(App.FormExplorer).SelectObjects(class,sql,exec)
		;write 'st w $$$appError($System.Status.GetErrorText(st)) 
	}
	q $$$OK
Show(modeShow,order)
	set obj=##class(App.Form).GetObj(SelectId_","_class)
	if '$isobject(obj) { 
		set msg=$$$aText("Failed to open object ","")_SelectId_","_class
		write $$$appError(msg) q $$$ERROR($$$GeneralError,msg)
	}
	do ##class(App.Form).Show(obj,modeShow,divId,order)
 q
]]></Implementation>
</Method>

<Method name="FindUsersFirstHead">
<Description>
download template forms search</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	s key=Par("key")
	s divId=Par("divId")
	set onclick=$$$blockui($$$aText("Loading...",""))_";AppAct('"_divId_"MainForm','"_divId_"MainContent','AppAct="_$zu(5)_":"_..%ClassName(1)_":"_divId_"Result:&key="_key_"&divId="_divId_"&mode=*');"
	&html<
		<table width="90%" style="border-radius: 10px; border: 1px solid #72a7cf" cellpadding="2" cellspacing="0" class="DetailTable" bgcolor="#c4d6d6" >
		<tr>
			<td>
			Login
			</td>
			<td>
			#($$$appText(divId_"Name","","su"))#
			</td>
			<td>
			fullname
			</td>
			<td>
			#($$$appTextarea(divId_"fullName","rows=5",""))#
			</td>
			<td>
			Date
			</td>
			<td>
			#($$$appDate(divId_"Date","",""))#
			</td>
		</tr>
		<tr>
			<td>
			
			</td>
			<td>
			#($$$appButton(divId_"appButtonResult1","onclick="""_$tr(onclick,"*",1)_"""","Find user"))#
			</td>
			<td>
			#($$$appButton(divId_"appButtonResult2","onclick="""_$tr(onclick,"*",2)_"""","Get items from the form"))#
			</td>
			<td>
			#($g(fileDownload))#
			</td>
			<td>
			date time
			</td>
			<td>
			#($$$appDateTime(divId_"DateTime","",""))#
			</td>
		</tr>
		</table>
	>
	q $$$OK
]]></Implementation>
</Method>

<Method name="FindUsersResult">
<Description>
Search result</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set mode=Par("mode")
	set Name=$g(Par("%request.Data",divId_"Name"))
	set fullName=$g(Par("%request.Data",divId_"fullName"))
	set Date=$g(Par("%request.Data",divId_"Date"))
	set DateTime=$g(Par("%request.Data",divId_"DateTime"))
	write ..ButtonAgain(divId,key)
	if mode=1 {
		if Name="" w $$$appError($$$aText("Context is empty","")) q $$$OK
		zn "%SYS"
		set sql="select ID,name,EmailAddress,fullName from Security.Users where Enabled [ '1' "
		if Name'="" s sql=sql_" and (name like '%"_Name_"%') "
		if fullName'="" s sql=sql_" and (fullName like '%"_fullName_"%') "
		set msg="Query: "_sql
		set exec="##class(App.LogInfo).MarkRed(%AppLogInfoVal,"""_Name_","_fullName_""")"
		set st=##class(App.LogInfoPane).DrawSQL(sql,100000,$zu(5),msg,exec)
		if 'st  w $$$appError($System.Status.GetErrorText(st)) 
		quit $$$OK
	} 
	elseif mode=2 {
		w "<br>" w $$$appMsg(Name_" "_fullName_" "_Date_" "_DateTime)
	}
	q $$$OK
]]></Implementation>
</Method>

<Method name="GetSupportInfo">
<Description>
To obtain information on the support</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	s msg=$$$aText("Software complex to debug. Try to log in later, or contact tech support:","")
	q msg_"Support info mailto: sample@server.com"
]]></Implementation>
</Method>

<Method name="MatrixFirstHead">
<Description>
download form template search users and roles</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	s key=Par("key")
	s divId=Par("divId")
	s %ui=1
	set onclick=$$$blockui($$$aText("Loading...",""))_";AppAct('"_divId_"MainForm','"_divId_"MainContent','AppAct="_$zu(5)_":"_..%ClassName(1)_":"_divId_"Result:&key="_key_"&divId="_divId_"&mode=*');"
	&html<
		<table width="90%" style="border-radius: 10px; border: 1px solid #72a7cf" cellpadding="2" cellspacing="0" class="DetailTable" bgcolor="#c4d6d6" >
		<tr>
			<td>
 	Login <br>#($$$appText(divId_"name","title='"_$$$aText("Names separated by a comma or by context","")_"'","su"))#
			</td>
			<td>
	Roles <br>#($$$appText(divId_"roles","title='"_$$$aText("Roles separated by a comma or by context","")_"'","db"))#
			</td>
			<td>
	#($$$appButton(divId_"appButtonResult1","onclick="""_$tr(onclick,"*",1)_"""",""_$$$aText("User roles","")))#
			</td>
		</tr>
		</table>
	>
	q $$$OK
]]></Implementation>
</Method>

<Method name="MatrixResult">
<Description>
Search result </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	s %ui=1
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set mode=Par("mode")
	set name=$g(Par("%request.Data",divId_"name"))
	set roles=$g(Par("%request.Data",divId_"roles"))
	write ..ButtonAgain(divId,key)
	d ##class(App.security).UiMatrixPermission(name,roles,divId,key,"App.security","UiSavePermiss")
	q $$$OK
]]></Implementation>
</Method>
</Class>


<Class name="App.Task.CustomListBackup">
<Description>
Backup task class</Description>
<IncludeCode>%occKeyword</IncludeCode>
<Modified>0</Modified>
<Super>%SYS.Task.Definition</Super>
<TimeChanged>65404,77881.937749</TimeChanged>
<TimeCreated>64658,42115.283843</TimeCreated>
<LegacyInstanceContext>1</LegacyInstanceContext>

<Property name="AllDatabases">
<Description>
If ..AllDatabases=1, include all databases into the backup copy ..PrefixIncludeDB and ..IncludeDatabases are ignored</Description>
<Type>%Integer</Type>
<InitialExpression>0</InitialExpression>
</Property>

<Property name="IgnoreForAllDatabases">
<Description>
If ..AllDatabases=1, include all databases into the backup copy, excluding from ..IgnoreForAllDatabases (comma-delimited)</Description>
<Type>%String</Type>
<InitialExpression>"Not applied if AllDatabases=0 "</InitialExpression>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Property name="IgnoreTempDatabases">
<Description>
If ..IgnoreTempDatabases=1, exclude temporary databases</Description>
<Type>%Integer</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Property name="IgnorePreparedDatabases">
<Description>
If ..IgnorePreparedDatabases=1, exclude pre-installed databases</Description>
<Type>%Integer</Type>
<InitialExpression>1</InitialExpression>
</Property>

<Property name="PrefixIncludeDB">
<Description>
If ..AllDatabases=0 and PrefixIncludeDB is not empty, we will be backing up all databases starting with ..PrefixIncludeDB</Description>
<Type>%String</Type>
<SqlComputeCode>S {*}=..ListNS()</SqlComputeCode>
<SqlComputed>1</SqlComputed>
</Property>

<Property name="IncludeDatabases">
<Description>
If ..AllDatabases=0, back up all databases from ..IncludeDatabases (comma-delimited)</Description>
<Type>%String</Type>
<InitialExpression>"Not applied if AllDatabases=1"_..ListDB()</InitialExpression>
<Parameter name="MAXLEN" value="32000"/>
</Property>

<Parameter name="TaskName">
<Description>
Name of the task on the general list</Description>
<Default>CustomListBackup</Default>
</Parameter>

<Property name="DirBackup">
<Description>
Path for the backup file</Description>
<Type>%String</Type>
<InitialExpression>##class(%File).NormalizeDirectory("Backup")</InitialExpression>
<Parameter name="MAXLEN" value="1024"/>
</Property>

<Property name="DirBackupLog">
<Description>
Path for the log</Description>
<Type>%String</Type>
<InitialExpression>##class(%File).NormalizeDirectory("Backup")</InitialExpression>
<Parameter name="MAXLEN" value="1024"/>
</Property>

<Property name="TypeBackup">
<Description>
Backup type (Full, Incremental, Cumulative)</Description>
<Type>%String</Type>
<InitialExpression>"Full"</InitialExpression>
<SqlColumnNumber>4</SqlColumnNumber>
<Parameter name="DISPLAYLIST" value=",Full,Incremental,Cumulative"/>
<Parameter name="VALUELIST" value=",Full,Inc,Cum"/>
</Property>

<Property name="PrefixBackUpFile">
<Description>
Backup file name prefix</Description>
<Type>%String</Type>
<InitialExpression>"back"</InitialExpression>
</Property>

<Property name="MaxBackUpFiles">
<Description>
The maximum number of backup files, delete the oldest ones</Description>
<Type>%Integer</Type>
<InitialExpression>3</InitialExpression>
</Property>

<Method name="DeviceIsValid">
<ClassMethod>1</ClassMethod>
<FormalSpec>Directory:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	If '##class(%Library.File).DirectoryExists(Directory) quit $$$ERROR($$$GeneralError,"Directory does not exist")
	quit $$$OK
]]></Implementation>
</Method>

<Method name="CheckBackup">
<ClassMethod>1</ClassMethod>
<FormalSpec>Device,MaxBackUpFiles,del=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set path=##class(%File).NormalizeFilename(Device)
	quit:'##class(%File).DirectoryExists(path) $$$ERROR($$$GeneralError,"Folder "_path_" does not exist")
	set max=MaxBackUpFiles
	set result=##class(%ResultSet).%New("%File:FileSet")
	set st=result.Execute(path,"*.cbk",,1)
	while result.Next()
	{	If result.GetData(2)="F"	{
			continue:result.GetData(3)=0
			set ts=$tr(result.GetData(4),"-: ")
			set ts(ts)=$lb(result.GetData(1),result.GetData(3))			
		}
	}
	#; Lets traverse all the files starting from the newest one
	set i="" for count=1:1 { set i=$order(ts(i),-1) quit:i=""
		#; Get the increase in bytes as a size difference with the previous backup
		if $data(size),'$data(delta) set delta=size-$lg(ts(i),2)
		#; Get the size of the most recent backup file in bytes
		if '$data(size) set size=$lg(ts(i),2)
		#; If the number of backup files is larger or equals to the upper limit, delete the oldest ones along with logs
		if count'<max {
			set cbk=$lg(ts(i),1)
			set log=$replace($lg(ts(i),1),".cbk",".log")
			if del { if ##CLASS(%File).Delete(cbk)
					if ##CLASS(%File).Delete(log)
			}
		}
	}
	do result.%Close()
	If $$$isUNIX quit $$$OK ##; Skip for Linux	
	#; Calculate the available disk space in bytes
	set drive=$e(path,1)
	do ##CLASS(%File).GetDirectorySpace(drive_":/",.free,.total,0)
	#; Return an error if the size of the new backup file is larger than the available disk space
	quit:($g(size)+$g(delta))>$g(free) $$$ERROR($$$GeneralError,"Estimated size of the new backup file is larger than the available disk space:("_$g(size)_"+"_$g(delta)_")>"_$g(free))
	quit $$$OK
]]></Implementation>
</Method>

<Method name="OnTask">
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do $zu(5,"%SYS")
	set list=""
	merge oldDBList=^SYS("BACKUPDB")
	kill ^SYS("BACKUPDB")
	#; Adding new properties for the backup task
	set status=$$$OK
	try {
		##; Check the number of database copies, delete the oldest one, if necessary
		##; Check the remaining disk space and estimate the size of the new file
		set status=..CheckBackup(..DirBackup,..MaxBackUpFiles,1)
		quit:$$$ISERR(status)
		#; All databases
		if ..AllDatabases {
			set vals=""
			set disp=""
			set rss=##class(%ResultSet).%New("Config.Databases:List")
			do rss.Execute()
			while rss.Next(.sc) {
				if ..IgnoreForAllDatabases'="",(","_..IgnoreForAllDatabases_",")[(","_$zconvert(rss.Data("Name"),"U")_",") continue
				if ..IgnoreTempDatabases continue:..IsTempDB(rss.Data("Name"))
				if ..IgnorePreparedDatabases continue:..IsPreparedDB(rss.Data("Name"))
				set ^SYS("BACKUPDB",rss.Data("Name"))=""
			}
		}
		else {
			#; if the PrefixIncludeDB property is not empty, well back up all DBs with names starting from ..PrefixIncludeDB
			if ..PrefixIncludeDB'="" {
					set rss=##class(%ResultSet).%New("Config.Databases:List")
					do rss.Execute(..PrefixIncludeDB_"*")
					while rss.Next(.sc) {
						if ..IgnoreTempDatabases continue:..IsTempDB(rss.Data("Name"))
						set ^SYS("BACKUPDB",rss.Data("Name"))=""
					}
			}
			#; Include particular databases into the list
			if ..IncludeDatabases'="" {
				set rss=##class(%ResultSet).%New("Config.Databases:List")
				do rss.Execute("*")
				while rss.Next(.sc) {
					if ..IgnoreTempDatabases continue:..IsTempDB(rss.Data("Name"))
					if (","_..IncludeDatabases_",")'[(","_$zconvert(rss.Data("Name"),"U")_",") continue
					set ^SYS("BACKUPDB",rss.Data("Name"))=""
				}
			}
		}
		do ..GetFileName(.backFile,.logFile)
		set typeB=$zconvert($e(..TypeBackup,1),"U")
		set:"FIC"'[typeB typeB="F"
		set res=$$BACKUP^DBACK("",typeB,"",backFile,"Y",logFile,"NOINPUT","Y","Y","","","")
		if 'res set status=$$$ERROR($$$GeneralError,"Error: "_res)
	} catch {	set status=$$$ERROR($$$GeneralError,"Error: "_$ze)
				set $ze=""
	 }
	kill ^SYS("BACKUPDB")
	merge ^SYS("BACKUPDB")=oldDBList
	quit status
]]></Implementation>
</Method>

<Method name="GetFileName">
<Description>
Get file names</Description>
<FormalSpec><![CDATA[aBackupFile,&aLogFile]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set tmpName=..PrefixBackUpFile_"_"_..TypeBackup_"_"_$s(..AllDatabases:"All",1:"List")_"_"_$zd($h,8)_$tr($j($i(cnt),3)," ",0)
	do {
		s aBackupFile=##class(%File).NormalizeFilename(..DirBackup_"/"_tmpName_".cbk")
	} while ##class(%File).Exists(aBackupFile)
	set aLogFile=##class(%File).NormalizeFilename(..DirBackupLog_"/"_tmpName_".log")
	quit 1
]]></Implementation>
</Method>

<Method name="IsPreparedDB">
<Description>
Check if the database is pre-installed</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>name</FormalSpec>
<Implementation><![CDATA[
	if (",ENSDEMO,ENSEMBLE,ENSEMBLEENSTEMP,ENSEMBLESECONDARY,ENSLIB,CACHESYS,CACHELIB,CACHETEMP,CACHE,CACHEAUDIT,DOCBOOK,USER,SAMPLES,")[(","_$zconvert(name,"U")_",") quit 1
	quit 0
]]></Implementation>
</Method>

<Method name="IsTempDB">
<Description>
Check if the database is temporary</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>name</FormalSpec>
<Implementation><![CDATA[
	quit:$zconvert(name,"U")["TEMP" 1
	quit:$zconvert(name,"U")["SECONDARY" 1
	quit 0
]]></Implementation>
</Method>

<Method name="ListDB">
<Description>
Get a comma-delimited list of databases</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set list=""
	set rss=##class(%ResultSet).%New("Config.Databases:List")
	do rss.Execute()
	while rss.Next(.sc) {
		set list=list_","_rss.Data("Name")
	}
	quit list
]]></Implementation>
</Method>

<Method name="ListNS">
<ClassMethod>1</ClassMethod>
<Private>1</Private>
<Implementation><![CDATA[
	set disp=""
	set tRS = ##class(%ResultSet).%New("Config.Namespaces:List")
	set tSC = tRS.Execute()
	While tRS.Next() {	
				set disp=disp_","_tRS.GetData(1)
	}
	set %class=..%ClassName(1)
	$$$comSubMemberSet(%class,$$$cCLASSproperty,"PrefixIncludeDB",$$$cPROPparameter,"VALUELIST",disp)
	quit ""
]]></Implementation>
</Method>

<Method name="oncompile">
<ClassMethod>1</ClassMethod>
<CodeMode>generator</CodeMode>
<Implementation><![CDATA[
	$$$defMemberKeySet(%class,$$$cCLASSproperty,"PrefixIncludeDB",$$$cPROPtype,"%String")
	set updateClass=##class("%Dictionary.ClassDefinition").%OpenId(%class)
	set updateClass.Modified=0
	do updateClass.%Save()
	do updateClass.%Close()
]]></Implementation>
</Method>
</Class>


<Class name="App.Task.PurgeOldBackupFiles">
<Super>%SYS.Task.Definition</Super>
<TimeChanged>65220,27685</TimeChanged>
<TimeCreated>65184,36683.082794</TimeCreated>

<Property name="BackupsToKeep">
<Type>%Integer</Type>
<InitialExpression>30</InitialExpression>
<Required>1</Required>
<Parameter name="MAXVAL" value="30"/>
<Parameter name="MINVAL" value="1"/>
</Property>

<Property name="BackupFolder">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Property name="BackupFileType">
<Type>%String</Type>
<Required>1</Required>
</Property>

<Method name="OnTask">
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
     //s BackupsToKeep = 2
     //s Folder = "c:\backupfolder"
     //s BackupFileType = "FullAllDatabases" // or "FullDBList"

     s SortOrder = "DateModified"

     If ..BackupsToKeep<1 Quit $$$ERROR($$$GeneralError,"Invalid - Number of Backups to Keep must be greater than or equal to 1")
     If ..BackupFolder="" Quit $$$ERROR($$$GeneralError,"Invalid - BackupFolder - not supplied")
     if ..BackupFileType = "" Quit $$$ERROR($$$GeneralError,"Invalid - BackupFileType - not supplied")
     if (..BackupFileType '= "FullAllDatabases")&&(..BackupFileType '= "FullDBList") Quit $$$ERROR($$$GeneralError,"Invalid - BackupFileType")

     s BackupCount=0
     k zPurgeOldBackupFiles(..BackupFileType)
     Set rs=##class(%ResultSet).%New("%Library.File:FileSet")
     w !,"backuplist",!

     s BackupFileWildcard = ..BackupFileType _ "*.cbk"
     set status=rs.Execute(..BackupFolder, BackupFileWildcard, SortOrder)
     WHILE rs.Next() {
          Set FullFileName=rs.Data("Name")
          Set FName=##class(%File).GetFilename(FullFileName)
          Set FDateTime=##class(%File).GetFileDateModified(FullFileName)
          w "File "_FName_" "_FDateTime,!
          Set FDate=$PIECE(FDateTime,",")
          Set CDate=$PIECE($H,",")
          s BackupCount=$I(BackupCount)
          s zPurgeOldBackupFiles(..BackupFileType, BackupCount)=FullFileName 
     }
     s zPurgeOldBackupFiles(..BackupFileType, "BackupCount")=BackupCount
     do rs.Close()
     if BackupCount > ..BackupsToKeep {
          for i=1:1:BackupCount-..BackupsToKeep {
               s FullFileName = zPurgeOldBackupFiles(..BackupFileType, i)
               d ##class(%File).Delete(FullFileName)
               w "File Purged "_FullFileName_" Purged",!
          }
     }
     q status
]]></Implementation>
</Method>
</Class>


<Class name="App.UploadCSP">
<CompileAfter>App.msg</CompileAfter>
<IncludeCode>App.LogMacro</IncludeCode>
<Super>%CSP.Page</Super>
<TimeChanged>65371,57792.490737</TimeChanged>
<TimeCreated>65113,38880.765844</TimeCreated>

<Parameter name="pathfiles">
<Description>
The path to the directory on the server for storing files</Description>
<Expression>##class(%File).GetDirectory(##class(%File).TempFilename())</Expression>
</Parameter>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    s FieldName="loadFile"
    if $g(%loadFileSuccess)'="" {
	    if $lv(%loadFileSuccess) {
	        if $lg(%loadFileSuccess,1) {
		        if $lg(%loadFileSuccess,5)'=1 d WriteError q 1
	    		s orig=$lg(%loadFileSuccess,6)
	    		s orig=$p(orig,$$$slash,*)
	    		s orig=$tr(orig," `()\/*;'"":","_N---")
	    		w "<script>"
	    		w "window.opener.document.getElementById('"_$g(%request.Data("FieldName",1))_"').value='"_$lg(%loadFileSuccess,2)_"*"_orig_"';"
	    		w "window.close();"
	    		w "</script>"
	    		q 1
	        } else {
	            d WriteError
	            q 1
	        }
	        q $$$OK
	    }
    }
    &html<<!DOCTYPE HTML>
<html>
<head>
<title>Upload</title>
>
 write ##class(App.LogInfoPane).GetLink()
 set Upload=$$$aText("Upload","")
 set Cancel=$$$aText("Cancel","")
 &html<
    <script>
        $(document).ready(function(){
            $(this).keydown(function(eventObject){
                if (eventObject.which == 27)
                    window.close();
            });
        });
    </script>  
</head>
<body bgcolor="#f0f8ff" >
<form action="#(..%ClassName(1)_".cls")#" enctype="multipart/form-data" method="post">
    <br><center>
     #($$$aText("Select a file",""))#: <input class='ui-button ui-corner-all ui-widget' name='loadFile' id='loadFile' size=30 type='file' accept=".doc,.docx,.odt,.pdf,.xls,.xlsx" >
    <br><br>
    <input class='ui-button ui-corner-all ui-widget' type="submit" value="#(Upload)#"> 
    <input class='ui-button ui-corner-all ui-widget' type="button" value="#(Cancel)#" onclick='window.close();'>
    <input class='ui-button ui-corner-all ui-widget' type="hidden" name=FieldName id=FieldName value='#($g(%request.Data("idreturn",1)))#'>
    <input class='ui-button ui-corner-all ui-widget' type="hidden" name=idOrigNameReturn id=idOrigNameReturn value='#($g(%request.Data("idOrigNameReturn",1)))#'>
    <input class='ui-button ui-corner-all ui-widget' type="hidden" name=ServerDirPath id=ServerDirPath value='#($g(%request.Data("ServerDirPath",1)))#'>
    </center>
</form></body>
</html>
>
   Quit $$$OK
WriteError w "<H3>"_$$$aText("An error has occurred","")_"</h3>"_$System.Status.DisplayError($lg(%loadFileSuccess,5))_"<p><p>"_$$$aText("Try again, otherwise contact your administrator","")
 q
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<Description>
 [ ServerOnly = 1 ]</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set ServerDirPath=$zconvert($g(%request.Data("ServerDirPath",1)),"I","URL")
	if ServerDirPath="" set ServerDirPath=..#pathfiles
        s %loadFileSuccess=0
        s FieldName="loadFile"
        i %request.IsDefinedMimeData(FieldName,1) {
            s ContentType=%request.MimeData(FieldName,1).ContentType
            s Content=%request.MimeData(FieldName,1)
        } else {
            s ContentType=%request.ContentType
            s Content=%request.Content
        }
        i $isobject(Content),Content.Size>0 {
	        s fileName=Content.FileName
	        s name=$tr(##class(App.type).GetDateTime($h),"T: ","_")_"_"_$zcrc($p(fileName,$$$slash,*),7) //TODO tranlit
	        if fileName["." s name=name_"."_$p(fileName,".",*)
	        s %loadFileSuccess=$lb(1,$g(name),Content.Size)
	        s sc=##class(App.files).Stream2Log(Content, ServerDirPath,$zconvert( name,"O","UTF8"),.path) 
	        if sc s %loadFileSuccess=%loadFileSuccess_$lb($g(path),1,fileName)
	        else  s %loadFileSuccess=%loadFileSuccess_$lb($g(path),sc)
        }
        q 1
    q 1
]]></Implementation>
</Method>
</Class>


<Class name="App.Use">
<CompileAfter>App.msg</CompileAfter>
<IncludeCode>App.LogMacro</IncludeCode>
<TimeChanged>65317,30981</TimeChanged>
<TimeCreated>63691,73040.917631</TimeCreated>

<Method name="Test">
<Description>
do ##class(App.Use).Test()</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[a:%Integer=1,&b=2]]></FormalSpec>
<Implementation><![CDATA[	$$$LogWarn("User message") // just place this macro in user code you wish to log
]]></Implementation>
</Method>

<Method name="TestWithObjects">
<Description>
do ##class(App.Use).TestWithObjects()</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>a:%Integer=1,b:%ZEN.proxyObject</FormalSpec>
<Implementation><![CDATA[	$$$LogWarn("User message")
]]></Implementation>
</Method>

<Method name="TestLogObjects">
<Description>
do ##class(App.Use).TestLogObjects(4)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id</FormalSpec>
<Implementation><![CDATA[
	set object=##class(%SYS.Task).%OpenId(id)
	set $$$AppL("MSW","taskObjId")=$$$AppObJs(id)
 	set $$$AppL("MSW","taskObj")=$$$AppObJs(object)
]]></Implementation>
</Method>
</Class>


<Class name="App.XLSX">
<Description>
Report generation in a given directory upon request with a given field format</Description>
<IncludeCode>App.LogMacro,%occODBC</IncludeCode>
<TimeChanged>65339,36950.182019</TimeChanged>
<TimeCreated>64273,2606.599454</TimeCreated>

<Method name="Report2xlsx">
<Description>
Report generation in a given directory upon request with a given field format
set sc = ##class(App.XLSX).Report2xlsx("/backup/temp/","select top 10 id,ClassName  FROM App.Log order by id desc","AppLogReport",",N")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>directory:%String,sql="",filename="",format="",args...</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	q:sql="" $$$OK
	set directory = ##class(%File).NormalizeDirectory(directory)
	#dim sc As %Status = $$$OK

	if ('##class(%File).DirectoryExists(directory)) {
		do ##class(%File).CreateDirectoryChain(directory)
	}
	if ##class(%Dictionary.CompiledClass).%ExistsId("isc.SetEnv") {
		set env = "EXCELMEMSIZE"
		set sc = ##class(isc.SetEnv).Setup()
		quit:$$$ISERR(sc) sc
		set sc = ##class(isc.SetEnv).SetEnvVar(env, "4096m")
		quit:$$$ISERR(sc) sc
		set val = $system.Util.GetEnviron(env)
	}
	
	i filename="" s filename=query_"-"_$system.Util.CreateGUID()
	set file = filename_".xlsx"
	set $$$AppL("MSW",$username_" Generated in")=directory_file
	w !,"Generated in "_directory_file
	set sc = ..generateFileFromSQL(directory_file, sql,format,args...)
	if $$$ISERR(sc) w !,$System.Status.GetErrorText(sc) quit sc
	set $$$AppL("MSW",$username_" Compliet in")=directory_file
	w !,"Compliet "_directory_file
	;set ..reportStream.Filename = directory _ file 
	;set sc = ..%Save()
	quit sc
]]></Implementation>
</Method>

<Method name="generateFileFromSQL">
<Description>
Outputs Excel-compliant table from sql into file. args are sql arguments
Does not support
w ##class(mvk.util.XLSX).generateFileFromSQL(,"SELECT * FROM Sample.Person")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>file:%String=##class(%File).TempFilename("xlsx"),sql:%String,format="",args...</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#dim sc As %Status = $$$OK
	
	set xmlfile = ##class(%File).TempFilename("xml")
	set sc = ..generateXMLFromSQL(xmlfile, sql,format, args...)
	quit:$$$ISERR(sc) sc
	
	set sc = ..generateXLSXfromXML(xmlfile, file)
	
	do:$$$ISOK(sc) ##class(%File).Delete(xmlfile)

	
	quit sc
]]></Implementation>
</Method>

<Method name="generateXMLFromSQL">
<Description>
Outputs XML to be fed into %SYS.ZENReportExcelExporter Excel-compliant stream from sql into file. args are sql arguments</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>xmlfile:%String,sql:%String,format="",args...</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#dim sc As %Status = $$$OK
	set st = ##class(%SQL.Statement).%New()
	set sc = st.%Prepare(sql)
	quit:$$$ISERR(sc) sc
	#dim result As %SQL.StatementResult
	set result = st.%Execute(args...)
	set stream = ##class(%Stream.FileCharacter).%New()
	set sc=stream.LinkToFile(xmlfile)
	quit:$$$ISERR(sc) sc
	set header = ##class(%Dictionary.XDataDefinition).IDKEYOpen($classname(), "header").Data.Read(10000)
	do stream.Write(header)
	set $$$AppL("MSW",$username_"header")=header
	#dim metadata As SQL.StatementMetadata
	set metadata = result.%GetMetadata()
	set columnCount = metadata.columns.Count()
	for i=1:1:columnCount {
		#dim column As %SQL.StatementColumn
		set column = metadata.columns.GetAt(i)
		
		set class(i) = "<item excelName="""_ column.colName _ """"
		if $p(format,",",i)'="" {
			s type=$e($zconvert($p(format,",",i),"L"),1)
			set type="isExcel"_$s(type="n":"Number",type="d":"Date",type="t":"Time",1:"")_"=""1"" "
			set class(i) = class(i) _ " "_type
		}
		elseif column.IsNumeric() {
			set class(i) = class(i) _ " isExcelNumber=""1"""
		} elseif ..isDate(column.ODBCType) {
			set class(i) = class(i) _ " isExcelDate=""1"""
		} elseif ..isTime(column.ODBCType)  {
			set class(i) = class(i) _ " isExcelTime=""1"""	
		}
		set class(i) = class(i) _ ">"
	}
	while result.%Next() {
		do stream.WriteLine("<Row>")
		for i=1:1:columnCount {
			set data = result.%GetData(i)
			set:$lv(data) data = $lts(data)
			set data=$zstrip(data,"*C")
			do stream.WriteLine(class(i) _ $zcvt(data, "O", "XML") _ "</item>")
			if $i(row)
		}
		do stream.WriteLine("</Row>")
	}
	do stream.WriteLine("</sheet></MyReport>")
	set sc=stream.%Save()
	return sc
]]></Implementation>
</Method>

<Method name="generateXLSXfromXML">
<ClassMethod>1</ClassMethod>
<FormalSpec>xmlfile:%String,file:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set exportType = "xlsx"
	set outputdir = ##class(%File).GetDirectory(file)
	set outputfile = file
	set isMultiSheet = $$$YES
	set aggregateTag = ""
	set reportName = "Report"
	set logfile = ##class(%File).TempFilename("log")
	set suppresExcelHeaders = $$$NO
	set ExcelMode = "element"
	set DisplayLog= $$$NO
	
	set sc = ##class(%SYS.ZENReportExcelExporter).CommonExport(exportType, xmlfile, outputdir, outputfile, isMultiSheet, aggregateTag, reportName, logfile, suppresExcelHeaders, ExcelMode, DisplayLog)
	
	do:$$$ISOK(sc) ##class(%File).Delete(logfile)	
	
	return sc
]]></Implementation>
</Method>

<Method name="isDate">
<ClassMethod>1</ClassMethod>
<FormalSpec>odbcType:%Integer</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	return:odbcType=$$$ODBCTYPEtimestamp $$$YES
	return:odbcType=$$$ODBCTYPEdate $$$YES
	return $$$NO
]]></Implementation>
</Method>

<Method name="isTime">
<ClassMethod>1</ClassMethod>
<FormalSpec>odbcType:%Integer</FormalSpec>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	return:odbcType=$$$ODBCTYPEtime $$$YES
	return $$$NO
]]></Implementation>
</Method>

<XData name="header">
<MimeType>application/yaml</MimeType>
<Data><![CDATA[
<?xml version="1.0" encoding="UTF-8"?>
 <MyReport xmlns:fo="http://www.w3.org/1999/XSL/Format" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:zr="http://www.intersystems.com/zenreports" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:svg="http://www.w3.org/2000/svg">
 <sheet excelSheetName="Report">
]]></Data>
</XData>
</Class>


<Class name="App.files">
<Description>
Utilities working with files</Description>
<Abstract>1</Abstract>
<IncludeCode>App.LogMacro</IncludeCode>
<TimeChanged>65395,41131.760477</TimeChanged>
<TimeCreated>64765,51020.18498</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Method name="getSlash">
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	q $$$slash
]]></Implementation>
</Method>

<Method name="Stream2String">
<Description>
Stream convert to string
w ##class(App.files).Stream2String(resp,.str)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>resp:%Stream,StringValue:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st=$$$OK
	set StringValue=""
	i '$isobject(resp) q $$$ERROR($$$GeneralError,"An empty stream")
	d resp.Rewind() 
	set StringValue=resp.Read($$$MaxStringLength) 
	while '(resp.AtEnd) { 
		s StringValue($i(i))=resp.Read($$$MaxStringLength) 
	}
	q st
]]></Implementation>
</Method>

<Method name="UnzipToDirectory">
<Description>
Unpack the archive to a directory
w ##class(App.files).UnzipToDirectory("/backup/eaist/imported/3a308a20ff8e271ae3e063231a8df1ad.zip","/backup/eaist/last")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>fileName:%String,*dirName:%String,cmd</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	try {
		set:$g(dirName)="" dirName = ##class(%File).NormalizeDirectory(##class(%File).TempFilename())
		$$$TOE(st, ##class(%File).CreateDirectoryChain(dirName))
		
		set cmd = ..GetUzipCommand(fileName, dirName)
		
		;$$$TRACE(cmd)
		set result = $zf(-1, cmd)
		if (result '= 0) { $$$ThrowStatus($$$ERROR($$$GeneralError, $$$aText("Return code error","")_":" _ result_" cmd="_cmd)) }
	} catch ex {
		set st = ex.AsStatus()
		;$$$TRACE($system.Status.GetErrorText(st))
	}
	quit st
]]></Implementation>
</Method>

<Method name="zipFile">
<Description><![CDATA[
Packaging file in the archive
Directory tempdir need to assign write cacheusr >sudo chmod ugo+w .]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dir,fileName:%String,newfileName:%String,tempdir:%String=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	if tempdir="" set tempdir=dir
	try {
		if $zversion(1) { ;for Linux
			set cmd = "cd "_dir_"; zip -r "_tempdir_"/"_newfileName_" "_fileName_";"
			if dir'=tempdir s cmd=cmd_" cp -f "_tempdir_"/"_newfileName_" "_newfileName_";" 
		} else {
			;set cmd = "cd "_dir_"; zip -r "_tempdir_"/"_newfileName_" "_fileName_";"
			
		}
		set result = $zf(-1, cmd)
		if (result '= 0) { $$$ThrowStatus($$$ERROR($$$GeneralError, $$$aText("Return code error","")_":" _ result_" cmd="_cmd)) }
	} catch ex {
		set st = ex.AsStatus()
	}
	quit st
]]></Implementation>
</Method>

<Method name="GetList">
<Description>
Get all files in a directory without subdirectories
w ##class(App.files).GetList("D:\dev\app1\src\","*.xml",.List)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[directory:%String,ext:%String="*.*",&list]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set st = $$$OK
	try {
		set directory = ##class(%File).NormalizeDirectory(directory)
		set rs = ##class(%ResultSet).%New("%File:FileSet")
		s sc=rs.Execute(directory, ext)
		while (rs.Next()) {
			set fName = rs.Get("Name")
			m list(fName)=rs.Data
		}
	} catch ex {
		set st = ex.AsStatus()
	}
	quit st
]]></Implementation>
</Method>

<Method name="RemoveFiles">
<ClassMethod>1</ClassMethod>
<FormalSpec>pFile:%String,pDir:%String=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	// TODO: make error handling removal of
	i pDir'="" do ##class(%File).RemoveDirectoryTree(pDir)
	do ##class(%File).Delete(pFile)
	quit $$$OK
]]></Implementation>
</Method>

<Method name="GetUzipCommand">
<ClassMethod>1</ClassMethod>
<FormalSpec>file,dir</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if $zversion(1)=3 quit "unzip -o " _ file _ " -d " _ dir
	quit "7z x " _ file _ " -o" _ dir
]]></Implementation>
</Method>

<Method name="Stream2Log">
<Description>
Method unloads the stream aStream into a file folder aLogFolder. 
aLogFolder - directory of discharge /back/temp/
aFileName - name of the unloaded file
File - the full path to the file
w ##class(App.files).Stream2Log(HttpResponse.Data, TempDir, fileName,.File) s aDATA("pathfileName")=$g(path)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[aStream,aLogFolder,aFileName,&filename]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#dim sc As %Status = $$$OK
	quit:(aLogFolder="") sc
	
	s aLogFolder=##class(%File).NormalizeDirectory(aLogFolder)
	if '##class(%File).DirectoryExists(aLogFolder) {
		quit:'##class(%File).CreateDirectoryChain(aLogFolder) $$$ERROR($$$GeneralError,"Cann't create directory chain: "_aLogFolder)
	}
	// Define a prefix for the file name and the file name
	i (aFileName="") s filename = aLogFolder_"t"_$tr($zts,",.","")_".xml"
	e  s filename = aLogFolder_aFileName
	
	// Execute copy file to stream
	s ext=$p(filename,".",$l(filename,"."))
	
	i aStream.%ClassName(1)="%Stream.FileCharacterGzip" {
		s gzfileName=aStream.Filename
		set f2 = ##class(%Stream.FileBinary).%New()
		set f1 = ##class(%Stream.FileBinaryGzip).%New()
		do f1.LinkToFile(gzfileName)
		do f2.LinkToFile(filename)
		s sc=f2.CopyFromAndSave(f1)
		d aStream.Rewind() 
		quit sc
	}
	i "xml,txt,html,aspx,"[ext {
		s File = ##class(%Stream.FileCharacter).%New()
		s File.TranslateTable="UTF8"
	}
	else {
		 s File = ##class(%Stream.FileBinary).%New()
	}
	
	s File.Filename=filename
	s sc=File.CopyFromAndSave(aStream)

	// Return result
	d aStream.Rewind() quit sc
]]></Implementation>
</Method>

<Method name="ReadFile2Arr">
<Description>
To open a file and write to the array 
w ##class(App.files).ReadFile2Arr("/backup/temp/snmp/ruRunCmd2018-10-03_14:31:00.txt","RSK",,"%tmp")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>file,mode="RSK",code="UTF8",gn="tmp"</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	s io=$i
	Open file:(mode_"\"_code_"\"):1
	if $test {
		s $zt="endoffile"
		for i=1:1 use file read r s @gn@(i)=r
	}
	else {
		q $$$ERROR($$$GeneralError,"No open file "_file)
	}
endoffile u io close file
	q $$$OK
]]></Implementation>
</Method>

<Method name="OpenFile">
<Description>
To open a file for writing 
set fn="/backup/temp/log.txt" if ##class(App.files).OpenFile(fn) use fn write "test",! close fn</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>file,time=1,mode="WNSK",code="UTF8"</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Open file:(mode_"\"_code_"\"):time
	quit $test
]]></Implementation>
</Method>

<Method name="File2Arr">
<Description>
To read a file and write to global 
w ##class(App.files).File2Arr("/backup/eaist/work/SPGZ.xml_2018-05-07_14.56.26.461","^tmpFile")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>file,Mas,Param="RSU"</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 set f=##class(%File).%New(file)
 set ok=f.Open(Param)     if 'ok do f.%Close() Q ok
 set len=$zu(140,1,file)
 while 'f.AtEnd {
     set str = f.ReadLine()
     s @Mas@($i(@Mas))=str
  }
 do f.%Close()
 Q len_" byte"
]]></Implementation>
</Method>

<Method name="LoadXML">
<Description>
Loading XML into the feature class 
d ##class(App.files).LoadXML("d:\!\InfoObject.xml","infoObject","Model.InfoObject") </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>fn,tag,class</FormalSpec>
<Implementation><![CDATA[
	Set tReader = ##class(%XML.Reader).%New()
	s sc=tReader.OpenFile(fn)
	If $$$ISERR(sc) Do $system.OBJ.DisplayError(sc) Quit  
	Do tReader.Correlate(tag,class)
	Set Count=0
	While tReader.Next(.Object, .sc) {
	    Write Object_" imported.",!
	    Set Count=Count+1
	}
	If $$$ISERR(sc) Do $system.OBJ.DisplayError(sc) Quit  
	Write !,Count
	Quit
]]></Implementation>
</Method>

<Method name="getPathcconsole">
<Description>
To the system path Protocol
w ##class(App.files).getPathcconsole()</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&dir,&logname]]></FormalSpec>
<Implementation><![CDATA[
	s slash=$$$slash
	Set path=$p($zu(86),"*",1)
	s dir=$p(path,slash,1,$l(path,slash)-1)_slash_"mgr"_slash
	s logname=$s($zv["IRIS":"messages",1:"cconsole")
 quit dir_logname_".log"
]]></Implementation>
</Method>

<Method name="getDate">
<Description>
Search of time of the extension of the database</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Line,yyyy,mm,dd</FormalSpec>
<Implementation><![CDATA[
	Set mm=$p(Line,"/",1)
	;Set dd=$p(Line,"/",2)
	Set yyyy="20"_$p($p(Line,"/",3),"-")
	q mm'=""&&(yyyy'="")
]]></Implementation>
</Method>

<Method name="Alert">
<Description>
Search important events</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[Line,&bd]]></FormalSpec>
<Implementation><![CDATA[
	q:'..getDate(Line,.yyyy,.mm) $$$OK
	if Line["Shutdown complete"	{
		i $i(bd("Reboot",yyyy,mm))
	}
	elseif 0,Line["DELETE:",Line["journals"	{
		i $i(bd("DELETE journals",yyyy,mm))
	}
	elseif 0,Line["Automatic journal file roll"	{
		i $i(bd("Automatic journal file roll",yyyy,mm))
	}
	elseif Line["Paging Alert: Physical Memory is"	{
		i $i(bd("Paging Alert: Physical Memory is used",yyyy,mm))
	}
	elseif Line["Error reading from SNMP port"	{
		i $i(bd("Error reading from SNMP port",yyyy,mm))
	}
	elseif Line["Lock table full"	{
		i $i(bd("Lock table full",yyyy,mm))
	}
	q $$$OK
]]></Implementation>
</Method>

<Method name="ExpansionDB">
<Description>
Search of time of the extension of the database</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[Line,&bd]]></FormalSpec>
<Implementation><![CDATA[
	s context = "Expansion completed"
	if Line[context	{
		q:'..getDate(Line,.yyyy,.mm) $$$OK
		Set dbn=$p($p(Line,"database ",2),". Expanded",1)
		Set mb=$p($p(Line,"Expanded by ",2)," MB",1)
		;Set bd("total",yyyy,mm)=$g(bd("total",yyyy,mm))+mb
		;Set bd("total",yyyy)=$g(bd("total",yyyy))+mb
		Set bd(dbn,yyyy,mm)=$g(bd(dbn,yyyy,mm))+mb
		Set bd(dbn,yyyy)=$g(bd(dbn,yyyy))+mb
	}
	q $$$OK
]]></Implementation>
</Method>

<Method name="getPeriod">
<Description>
To date range in number of days from the current
w ##class(App.files).getPeriod(69,.FromDateTime,.ToDateTime,.df,.dt)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>days,FromDateTime,ToDateTime,df,dt</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	s FromDateTime="CurrentDay-"_days
	s ToDateTime="CurrentDay"

	if $$InterpretCurrentDay("added?DateFrom="_FromDateTime_"&DateTo="_ToDateTime,.res,.df,.dt) {
		 Set:$g(df)'="" FromDateTime=$p(df,".",2)_"/"_$p(df,".",1)_"/"_$e($p(df,".",3),3,4)_"-00:00:00"
		 Set:$g(dt)'="" ToDateTime=$p(dt,".",2)_"/"_$p(dt,".",1)_"/"_$e($p(dt,".",3),3,4)_"-23:59:59"
	}
	i $g(dt) q df_" "_dt
	q ""
 /// Interpreterpath string with the current date type
 /// Str= DateFrom=(CurrentDay-2)&DateTo=(CurrentDay-1)
 /// The result the computed value of the expression 
InterpretCurrentDay(Str, Result,df,dt) 
	#dim tSC As %Status = 1
	#dim e As %Exception.AbstractException
	
	Set exp=$p(Str,"?",2)
	quit:exp="" "0"
	Set exp="s "_$replace(exp,"CurrentDay",+$h)
	Set exp=$replace(exp,"&DateTo",",%tempTo")
	Set exp=$replace(exp,"DateFrom","%tempFrom")
	try {
		x exp
		Set df=$tr($zd(%tempFrom,4),"/",".")
		Set dt=$tr($zd(%tempTo,4),"/",".")
		Set Result=$p(Str,"?",1)_"?DateFrom="_df_"&DateTo="_dt
		kill %tempFrom,%tempTo
	} Catch e {
		Set tSC=e.AsStatus()
	}
  quit tSC
]]></Implementation>
</Method>

<Method name="FindContextInLog">
<Description>
To execute the method on each line of Protocol</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>days,method,bd</FormalSpec>
<PublicList>tProductionName,inf</PublicList>
<Implementation><![CDATA[
	Set gn=$$$GNmessages
	KILL res
	d ##class(App.files).getPathcconsole(.dir,.logname) ;w !,dir
	d ##class(App.files).GetList(dir,logname_"*",.List) ;zw List
	s i="" f { s i=$o(List(i)) q:i="" 
		do ParseFile(gn,i)
	}
	
	s bd=##class(App.files).getPeriod(days,.FromDateTime,.ToDateTime,.df,.dt) ;df_" "_dt
	
	if FromDateTime="" Set HFromDateTime="1.1"
	else  Set HFromDateTime=$$DataTimeCConsole2H(FromDateTime)
	if ToDateTime="" Set HToDateTime="99999999"
	else  Set HToDateTime=$$DataTimeCConsole2H(ToDateTime)
	
	;w !,HFromDateTime_" "_HToDateTime
	
	s hdt=HFromDateTime
	s class=$p($p(method,"(",2),")"),method=$p($p(method,")",2),".",2)
	f { s hdt=$o(@gn@(hdt),1,Line) q:hdt=""  q:hdt>HToDateTime
		// Search context 
		d $classmethod(class,method,Line,.bd)
	}
	quit $$$OK


/// Function parse Protocol of the file on the date required depth
/// To skanirovat cconsole.log the result to put 
ParseFile(gnTemp,InFile)
	if $g(@gnTemp)[InFile,InFile'["cconsole.log" q 1 ;already archive dismantled
	;w !,InFile
	Set File2 = ##class(%File).%New(InFile)
	Do File2.Open("RSK\UTF8\")
	Do {
		Set Line = File2.ReadLine()
		s H=$$DataTimeCConsole2H($p(Line,":",1,3))
		i H="",$g(zts)'="" {
			i $l($g(@gnTemp@(zts)))>32000 continue
			;i $i(@gnTemp@(0))
			s @gnTemp@(zts)=$g(@gnTemp@(zts))_" "_Line ;glue from the previous
			continue
		}
		s zts=H_","_$p($p(Line,":",4)," ")
		i $g(@gnTemp@(zts))'="",$g(@gnTemp@(zts))'=Line {
			 i $l($g(@gnTemp@(zts)))>32000 continue
			 ;i $i(@gnTemp@(0))
			 s @gnTemp@(zts)=$g(@gnTemp@(zts))_" "_Line  
			 continue
		}
		;i $i(@gnTemp@(0)) ;i '(@gnTemp@(0)#1000) w "."
		s @gnTemp@(zts)=Line
		} While 'File2.AtEnd
	Do File2.Close()
	s:$g(@gnTemp)'[InFile @gnTemp=$g(@gnTemp)_"*"_InFile ;add the name of zagolovok for exceptions in the following analysis
 quit $g(@gnTemp)

/// Transform the date 09/01/17-10:31:15 in $Horolog.
DataTimeCConsole2H(DT) 
		s dc=""
		Set Date1=$p(DT,"-")
		Set Time1=$p(DT,"-",2)
		try {
			Set dh=$zdh($p(Date1,"/",1,2)_"/20"_$p(Date1,"/",3),1)
			Set th=$zth(Time1,1)
			Set dc=dh_"."_th
		} catch {}
 quit $g(dc)


/// Check entry Date1=MM/DD/YY, Time1=HH:MM:SS in the range df,dt
IncludDataTime(DateTime1,df,dt,stop)
	Set z="0"
	try {
		Set dc=$$DataTimeCConsole2H(DateTime1)
		i dc>df,dc<dt s z=1
	} catch {
		Set z=$ze w !,$g(DateTime1)_","_$g(df)_","_$g(dt)_" "_$ze
	}
 quit z
]]></Implementation>
</Method>

<Method name="OneJournalCount">
<Description>
Count one journal as what globals modifierade
k ^tmpJRN d ##class(App.files).OneJournalCount("/sdb/journals/20181225.003","^tmpJRN")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>journal="",tempGlob=$$$TEMPJRNL</FormalSpec>
<Implementation><![CDATA[
	s TmpGN="^||log" k @TmpGN
	i '$isobject(journal) s journal=##class(%SYS.Journal.File).%OpenId(journal)	q:'$isobject(journal)
	w !,$$$FormatText($$$aText("Processed %1% 2 written in %3",""),journal.Name,$zdt($h,4),tempGlob),! 
	d JournalCount(journal)
	m @tempGlob@($P($zu(86),"*",2))=@TmpGN
    q
JournalCount(journal)
	  #dim record As %SYS.Journal.Record
	  set quit=0
	  i $isobject(journal) {
	    #; the first and last address, to calculate the progress in percent
	    set firstPos=journal.FirstRecord.Address
	    set lastPos=journal.LastRecord.Address
	    set opr=""
	    #; start with the end of the file
	    set record=journal.LastRecord
	    for {
	      if '(record.Address#500000) {
	      	#; the progress display processing
	      	set proc=$j((lastPos-record.Address)/(lastPos-firstPos)*100,5,1)
	      	if proc'=opr set opr=proc write $c(13),?10,proc,"%  "
	      }
	      s TimeStamp=$tr(record.TimeStampGet(),"-")
	      s date=$p(TimeStamp," ")
	      s hour=$p($p(TimeStamp," ",2),":",1)
	      #; Change record data
	      if record.%IsA("%SYS.Journal.SetKillRecord") {
	        ;set gref=record.GlobalReference
	    	s (OV,NV)=""
	    	i record.TypeName="SET" {
	    		s OV=record.OldValue
	    		s NV=record.NewValue
	    	}
	    	elseif record.TypeName="BitSET" {
		    	s NV=1
	    	}
	        d Count(record.TypeName,$l(OV),$l(NV),record.DatabaseName,record.GlobalNode)
	      }
	      #; move to the previous record in the log file
	      set record=record.Prev
	      quit:'$isobject(record)
	    }
	  }
	q  	
Count(TypeOp,OV,NV,base,gref)
	;q:$qs(gref,0)["CacheAuditD"
	;q:$qs(gref,0)["Ens."
	;s base=$qs(gref,-1)
	if $qs(gref,0)["SYS",$ql(gref)>0 {
		s gref=$na(@$qs(gref,0)@($qs(gref,1))) ;$qs(gref,2)))
	}
	elseif $e($qs(gref,0),*)="D"||($e($qs(gref,0),*)="I")||($e($qs(gref,0),*)="S") { //record objects
		s gref=$na(@$qs(gref,0))
	}
	elseif $qs(gref,0)["log"||($qs(gref,0)["tmp") { //protocols
		s gref=$na(@$qs(gref,0))
	}
	else {
		s gref=$na(@$qs(gref,0)) ;the name of the array
	}
	;s Log($lb(base,gref))=$g(Log($lb(base,gref)))+1
	i $i(@TmpGN@(date,hour,base,TypeOp,gref,"Counts"))
	;we assume the number of new would
	s @TmpGN@(date,hour,base,TypeOp,gref,"OldValue")=$g(@TmpGN@(date,hour,base,TypeOp,gref,"OldValue"))+OV
	s @TmpGN@(date,hour,base,TypeOp,gref,"NewValue")=$g(@TmpGN@(date,hour,base,TypeOp,gref,"NewValue"))+NV
 q
]]></Implementation>
</Method>

<Method name="OneDayJournalCount">
<Description>
To count in magazines which globals as modifierade for a specific date
 d ##class(App.files).OneDayJournalCount("/opt/isc/ensemble/mgr/journal/20181225","^tmpJRN")
 d ##class(App.files).OneDayJournalCount("/sdb/journals/20181225","^tmpJRN")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>fileYYYYMMDD="",tempGlob=$$$TEMPJRNL</FormalSpec>
<Implementation><![CDATA[
 i $g(@tempGlob)'="" w !,$$$aText("About is already underway","")_" "_$g(@tempGlob) q
 s @tempGlob=$zts ;the beginning of the formation

 s slash=$$$slash
 if fileYYYYMMDD="" { 
	w !,$$$aText("We assume for the previous day","")
	s file=##class(%SYS.Journal.System).GetCurrentFile()
	s fileYYYYMMDD=$p(file.Name,slash,1,*-1)_slash_$tr($zd($h-1,3),"-")
 }
 ;date for which we believe
 s date=$p($p(fileYYYYMMDD,slash,$l(fileYYYYMMDD,slash)),".")
 for j=1:1:999 {
	  s suf=$s($l(j)=1:"00",$l(j)=2:"0",1:"")_j
	  s jname=fileYYYYMMDD_"."_suf 
	  w !,jname
	  #dim journ As %SYS.Journal.File = ##class(%SYS.Journal.File).%OpenId(jname)
	  i $isobject(journ) {	  
		 d ..OneJournalCount(journ,tempGlob)
	  }
	  else { QUIT
	  }
 }
 s @tempGlob="" ;flag the end of nascet
 q
]]></Implementation>
</Method>

<Method name="Export2CSV">
<Description>
Export to CSV file
d ##class(App.files).Export2CSV("/backup/temp/JrnCount*.csv","^tmpJRN2")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>aFileName=$$$EMAILXLSPATH_"JrnCount*.csv",tmpGN=$$$TEMPJRNL,aCharset="CP1251"</FormalSpec>
<Implementation><![CDATA[
	s:aFileName["*" aFileName=$replace(aFileName,"*",$tr($zd($h,3)_$zt($p($h,",",2),-1),":- "))
	#dim FileStream As %FileCharacterStream = ##class(%FileCharacterStream).%New()
	s FileStream.Filename=aFileName
	w !,tmpGN_222
	s:(aCharset'="") FileStream.TranslateTable=aCharset
	d FileStream.WriteLine("Instance;Date;Hour;Drive;Base;TypeOperation;GlobalRef;Counts;ByteOldValue;ByteNewValue")
	s (c4,o4,n4)=0
		s s1="" f { s s1=$o(@tmpGN@(s1)) q:s1=""
			s s2="" f { s s2=$o(@tmpGN@(s1,s2)) q:s2=""      ; Date
				s s3="" f { s s3=$o(@tmpGN@(s1,s2,s3)) q:s3=""	; Hour
					s s4="" f { s s4=$o(@tmpGN@(s1,s2,s3,s4)) q:s4="" ; Base
						s (c4,o4,n4)=0
						s s5="" f { s s5=$o(@tmpGN@(s1,s2,s3,s4,s5)) q:s5="" ; TypeOperation
							s s6="" f { s s6=$o(@tmpGN@(s1,s2,s3,s4,s5,s6)) q:s6="" ; Ref
								continue:s6="^"
								s Count=$g(@tmpGN@(s1,s2,s3,s4,s5,s6,"Counts"))
								s Old=$g(@tmpGN@(s1,s2,s3,s4,s5,s6,"OldValue"))
								s New=$g(@tmpGN@(s1,s2,s3,s4,s5,s6,"NewValue"))
								s gref=s6
								#dim line As %String = $lb(s1,s2,s3,$p($p(s4,":"),"^^",2)_":",s4,s5,s6,Count,Old,New)
								d FileStream.WriteLine($lts(line,";"))
							}
						}
					}
				}
			}
		}
	
	s sc=FileStream.SaveStream()
	WRITE !,$$$aText("Written to the file","")_" "_aFileName,!
	KILL FileStream quit sc
	q
]]></Implementation>
</Method>

<Method name="GetAllDir">
<Description>
Get all files in a directory and subdirectories
d ##class(App.files).GetAllDir("d:\dev\app1\src\",,.a)
ext = "*.jpg;*.jpeg;*.3gp" </Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[dir,ext="",&out]]></FormalSpec>
<Implementation><![CDATA[
	set dir = ##class(%File).NormalizeDirectory(dir)
	set rs = ##class(%ResultSet).%New("%File:FileSet")
	s sc=rs.Execute(dir, ext)
	while (rs.Next()) {
		;w !,rs.Get("Name")
		set out($i(out)) = $lb(rs.Get("Name"),rs.Get("Type"),rs.Get("Size"),rs.Get("ItemName"),rs.Get("DateCreated"),rs.Get("DateModified"))
		i rs.Get("Type")="D" d ##class(App.files).GetAllDir($lg(out(out),1),ext,.out)
	}
	q $$$OK
]]></Implementation>
</Method>

<Method name="TransXLS2CSV">
<Description>
Convert XSL file to CSV format and upload to GD
d ##class(App.files).TransXLS2CSV
</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[fileXSL,FieldNameHead="QUANTITY",&out,&error,tempDir=##class(%File).GetDirectory(##class(%File).TempFilename())]]></FormalSpec>
<Implementation><![CDATA[
		;s path=;"/opt/isc/ensemble/csp/spgz/files/"
		s path=$p(fileXSL,$$$slash,1,*-1)
		if path="" s error="Empty "_path q $$$ERROR($$$GeneralError,error)
		;	s fileXSL=path_NameFileXLS
		;w "<br> xls "_fileXSL 
		s gn2=..tempGN("Xls2") k @gn2

		;Convert xls to csv in UTF8 format delimited by commas and field values enclosed in double quotes
		s cmd="cd "_path_"; export HOME=$(eval echo ~$(id -u -n)) && unset LD_LIBRARY_PATH && soffice --convert-to csv --infilter=CSV:44,34,76,1 --headless "_fileXSL

		d ##class(App.sys).RunCmd(cmd,gn2,0,tempDir) h 1
		k @gn2

		s fileCSV=$p(fileXSL,".",1,*-1)_".csv"
		;Load and parse the received CSV
		;w "<br> csv "_fileCSV
		s gn3=..tempGN("Xls3") k @gn3
		s st=##class(App.files).ReadFile2Arr(fileCSV,"RSK","UTF8",gn3)
		i 'st s error=$System.Status.GetErrorText(st) q st
		i '$d(@gn3) s error="Not file "_fileCSV q $$$ERROR($$$GeneralError,error)
		;zw @gn3
		if FieldNameHead="" m out=@gn3 k @gn3 q $$$OK
		s gn=..tempGN("CsvTable") kill @gn
		s i=""
		f { s i=$o(@gn3@(i),1,s) q:i=""
			s ss=""
			;First go through by double quotes and each even-numbered commas in Char broadcast=1
			f ii=1:1 { q:$p(s,$c(34),ii,ii+1)=""
				s ss=ss_$s('(ii#2):$tr($p(s,$c(34),ii),",",$c(1)),1:$p(s,$c(34),ii))
			}
			i s[FieldNameHead { ;make a hat once
				f ii=1:1 { q:$p(ss,",",ii,ii+1)=""
					s name=$tr($ZStrip($p(ss,",",ii),"<>WP"),$c(1),",") ;reverse stream
					continue:name=""
					s @gn@(0,ii)=$lb(name)
					s @gn@(-1,name)=ii
				}
			} elseif 1 { ;pass on all other rows
				;w "<br>"_ss
				s listval=""
				;We'll use the comma Char=1 return back to commas
				f ii=1:1 { q:$p(ss,",",ii,ii+1)=""
					s val=$tr($ZStrip($p(ss,",",ii),"<>W"),$c(1),",") ;reverse stream
					s listval=listval_$lb(val)
				}
				s row=$g(row)+1
				s @gn@(row)=listval
			}
		}
		m out=@gn k @gn q $$$OK
]]></Implementation>
</Method>

<Method name="tempGN">
<Description>
To globalnu a reference to a temporary global
w ##class(App.files).tempGN("GN")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>GN,NoKill=0</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	;not to do ^|| and ^mtemp
	s gn=$na(^tmpAppFile(GN,$j)) 
	if 'NoKill KILL @gn	s @gn=$$$AppDT($h)
	q gn
]]></Implementation>
</Method>

<Method name="tempDir">
<Description>
To a temporary directory
w ##class(App.files).tempDir()</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[ q ##class(%File).GetDirectory(##class(%File).TempFilename())
]]></Implementation>
</Method>

<Method name="XlsxTransChoiceLotResult">
<Description>
Generate the XLSX document template transforming field
f - the array of fields to replace
ParamData - the name Value of the parameter
node - the subnode of a temporary global
ParamClass - "Spgz.model.Param"
ParamField - field name ;"OfficeFile"</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>f,node,ParamData,ParamClass,ParamField,debug=0,newfile="",msg=""</FormalSpec>
<Implementation><![CDATA[
	///Forming Applications WG
	s st=##class(App.Form).GetValueByName(ParamClass,ParamData,ParamField,.Val,1)
	i 'st {
		w $System.Status.GetErrorText(st) q $$$OK
	} else {
		s desc=Val("obj").Description
		s file=$p($g(Val("fileName")),"*",1)
	}
	if $g(file)="" w $$$appError("Empty file "_file) q 1
	
	s gn=..tempGN(node) k @gn
	;d ##class(App.files).File2Arr(file,gn)
	i debug s msg=msg_"<br>"_gn_" "_file
	;Unzip
	s tempDir=..tempDir()_$j
	d ##class(App.files).UnzipToDirectory(file,tempDir)
	
	;Read the global source template
	s fileSource=tempDir_"/xl/sharedStrings.xml"
	s st=##class(App.files).ReadFile2Arr(fileSource,"RSK",,gn) ;read the file into an array

	i 'st s msg=msg_$$$appError($System.Status.GetErrorText(st)) w msg q 1
	i '$d(@gn) w $$$appError($$$aText("No file","")) q 1

	set fn=fileSource ;    $replace(file,"-doc","-order-"_$username_"-") ;_$tr($zts,",.")) 
	if '##class(App.files).OpenFile(fn) s msg=msg_$$$appError($$$aText("No access rights to write the file","")_" "_fn) w msg q 1
	s curIo=$i
	s i=""
	f { s i=$o(@gn@(i),1,str) q:i=""
		s fkey="" 
		f { s fkey=$o(f(fkey),1,fdata) q:fkey=""
			i str[fkey s str=$replace(str,fkey,fdata)
		}
		s @gn@(i)=str
		use fn 	write @gn@(i),!	use curIo
	}
	close fn
	
	i debug s msg=msg_"<br>fn="_fn_"<br>tempDir="_tempDir
	;Archived again under a new name
	;i ##class(App.files).zipFile(tempDir,tempDir,newfilename,"/backup/temp/spgz-zip")
	s newfile=..tempDir()_node_"-"_$username_"-"_$zd($h,3)_"-"_$tr($zt($p($h,",",2),1),":")_".xlsx"
	set cmd="cd "_tempDir_"; zip -r "_newfile_" * ; rm -R "_tempDir
	s gn=..tempGN(node_"Xlsx3") k @gn
	i debug s msg=msg_"<br>"_cmd
	d ##class(App.sys).RunCmd(cmd,gn) h 3
	i debug zw @gn
	;The link is temporary
	if ##class(App.DownloadCSP).GetFileId(newfile,.url) { 
		s msg=msg_"<li><a title="""_$$$aText("Save this file on your disk","")_""" href='"_url_"'>"_$$$aText("To the formed document file","")_" "_$g(desc)_"</a>"
		w msg
	}
]]></Implementation>
</Method>

<Method name="GetFileIdView">
<Description>
%request.Application_"get-files/"_id</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>FileName,gn=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set st=$$$OK
	if gn="" { //store referals is temporary
		s gn = ##class(App.DownloadCSP).GetGN()
		set id=$r(+$h)_$zcrc(7,FileName)_$r(+$h)_"."_$p(FileName,".",*)
		set @gn@(id)=FileName
	} else {
		set id=$SYSTEM.Encryption.Base64Encode($SYSTEM.Encryption.MD5Hash(FileName))_"."_$p(FileName,".",*)
		if $g(@gn@(id))=""	s @gn@(id)=FileName
	}
 		;set @gn@(id,"origname")=origname
 		;set URL=..%ClassName(1)_".cls?"_cgivar_"="_id
 	quit id
]]></Implementation>
</Method>
</Class>


<Class name="App.filesMimeTypes">
<Description>
Utilities working with files</Description>
<Abstract>1</Abstract>
<IncludeCode>App.LogMacro</IncludeCode>
<TimeChanged>65397,53611.247734</TimeChanged>
<TimeCreated>64765,51020.18498</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Method name="GetTypesWildcards">
<Description>
w ##class(App.filesMimeTypes).GetTypesWildcards()</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>type="image"</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set gn="^%App.MimeTypes"
	if '$d(@gn) d ..Create(gn)
	set i="",wildcards=""
	for { set i=$o(@gn@("type",type,i)) q:i=""
		set wildcards=wildcards_"*."_i_";"
	}
	q $e(wildcards,1,*-1)
]]></Implementation>
</Method>

<Method name="GetMimeTypes4ext">
<Description>
w ##class(App.filesMimeTypes).GetMimeTypes4ext()</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>ext="jpg"</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set gn="^%App.MimeTypes" ;k @gn
	if '$d(@gn) d ..Create(gn)
	q $g(@gn@("ext",ext))
]]></Implementation>
</Method>

<Method name="Create">
<Description>
Create global MimeTypes</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>gn</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	s txt=##class(App.sql).getSQL("App.filesMimeTypes:MimeTypes",0)
	for i=1:1:$l(txt,$c(13,10)) {
		s str=$tr($zstrip($p(txt,$c(13,10),i),"<>P")," "_$c(9),"**")
		continue:str=""
		continue:$e(str,1)="#"
		s type=$p(str,"*",1)
		continue:type=""
		for ii=2:1:$l(str,"*") {
			if $p(str,"*",ii)'="" {
				set @gn@("ext",$p(str,"*",ii))=type  
				set @gn@("typeext",type)=$p(str,"*",ii)
				set @gn@("type",$p(type,"/"),$p(str,"*",ii))=type
			}
		}
	}
]]></Implementation>
</Method>

<XData name="MimeTypes">
<Description>
MimeTypes from Apache</Description>
<MimeType>application/yaml</MimeType>
<Data><![CDATA[
# This file maps Internet media types to unique file extension(s).
# Although created for httpd, this file is used by many software systems
# and has been placed in the public domain for unlimited redisribution.
#
# The table below contains both registered and (common) unregistered types.
# A type that has no unique extension can be ignored -- they are listed
# here to guide configurations toward known types and to make it easier to
# identify "new" types.  File extensions are also commonly used to indicate
# content languages and encodings, so choose them carefully.
#
# Internet media types should be registered as described in RFC 4288.
# The registry is at <http://www.iana.org/assignments/media-types/>.
#
# MIME type (lowercased)			Extensions
# ============================================	==========
# application/1d-interleaved-parityfec
# application/3gpdash-qoe-report+xml
# application/3gpp-ims+xml
# application/a2l
# application/activemessage
# application/alto-costmap+json
# application/alto-costmapfilter+json
# application/alto-directory+json
# application/alto-endpointcost+json
# application/alto-endpointcostparams+json
# application/alto-endpointprop+json
# application/alto-endpointpropparams+json
# application/alto-error+json
# application/alto-networkmap+json
# application/alto-networkmapfilter+json
# application/aml
application/andrew-inset			ez
# application/applefile
application/applixware				aw
# application/atf
# application/atfx
application/atom+xml				atom
application/atomcat+xml				atomcat
# application/atomdeleted+xml
# application/atomicmail
application/atomsvc+xml				atomsvc
# application/atxml
# application/auth-policy+xml
# application/bacnet-xdd+zip
# application/batch-smtp
# application/beep+xml
# application/calendar+json
# application/calendar+xml
# application/call-completion
# application/cals-1840
# application/cbor
# application/ccmp+xml
application/ccxml+xml				ccxml
# application/cdfx+xml
application/cdmi-capability			cdmia
application/cdmi-container			cdmic
application/cdmi-domain				cdmid
application/cdmi-object				cdmio
application/cdmi-queue				cdmiq
# application/cdni
# application/cea
# application/cea-2018+xml
# application/cellml+xml
# application/cfw
# application/cms
# application/cnrp+xml
# application/coap-group+json
# application/commonground
# application/conference-info+xml
# application/cpl+xml
# application/csrattrs
# application/csta+xml
# application/cstadata+xml
# application/csvm+json
application/cu-seeme				cu
# application/cybercash
# application/dash+xml
# application/dashdelta
application/davmount+xml			davmount
# application/dca-rft
# application/dcd
# application/dec-dx
# application/dialog-info+xml
# application/dicom
# application/dii
# application/dit
# application/dns
application/docbook+xml				dbk
# application/dskpp+xml
application/dssc+der				dssc
application/dssc+xml				xdssc
# application/dvcs
application/ecmascript				ecma
# application/edi-consent
# application/edi-x12
# application/edifact
# application/efi
# application/emergencycalldata.comment+xml
# application/emergencycalldata.deviceinfo+xml
# application/emergencycalldata.providerinfo+xml
# application/emergencycalldata.serviceinfo+xml
# application/emergencycalldata.subscriberinfo+xml
application/emma+xml				emma
# application/emotionml+xml
# application/encaprtp
# application/epp+xml
application/epub+zip				epub
# application/eshop
# application/example
application/exi					exi
# application/fastinfoset
# application/fastsoap
# application/fdt+xml
# application/fits
application/font-tdpfr				pfr
# application/framework-attributes+xml
# application/geo+json
application/gml+xml				gml
application/gpx+xml				gpx
application/gxf					gxf
# application/gzip
# application/h224
# application/held+xml
# application/http
application/hyperstudio				stk
# application/ibe-key-request+xml
# application/ibe-pkg-reply+xml
# application/ibe-pp-data
# application/iges
# application/im-iscomposing+xml
# application/index
# application/index.cmd
# application/index.obj
# application/index.response
# application/index.vnd
application/inkml+xml				ink inkml
# application/iotp
application/ipfix				ipfix
# application/ipp
# application/isup
# application/its+xml
application/java-archive			jar
application/java-serialized-object		ser
application/java-vm				class
application/javascript				js
# application/jose
# application/jose+json
# application/jrd+json
application/json				json
# application/json-patch+json
# application/json-seq
application/jsonml+json				jsonml
# application/jwk+json
# application/jwk-set+json
# application/jwt
# application/kpml-request+xml
# application/kpml-response+xml
# application/ld+json
# application/lgr+xml
# application/link-format
# application/load-control+xml
application/lost+xml				lostxml
# application/lostsync+xml
# application/lxf
application/mac-binhex40			hqx
application/mac-compactpro			cpt
# application/macwriteii
application/mads+xml				mads
application/marc				mrc
application/marcxml+xml				mrcx
application/mathematica				ma nb mb
application/mathml+xml				mathml
# application/mathml-content+xml
# application/mathml-presentation+xml
# application/mbms-associated-procedure-description+xml
# application/mbms-deregister+xml
# application/mbms-envelope+xml
# application/mbms-msk+xml
# application/mbms-msk-response+xml
# application/mbms-protection-description+xml
# application/mbms-reception-report+xml
# application/mbms-register+xml
# application/mbms-register-response+xml
# application/mbms-schedule+xml
# application/mbms-user-service-description+xml
application/mbox				mbox
# application/media-policy-dataset+xml
# application/media_control+xml
application/mediaservercontrol+xml		mscml
# application/merge-patch+json
application/metalink+xml			metalink
application/metalink4+xml			meta4
application/mets+xml				mets
# application/mf4
# application/mikey
application/mods+xml				mods
# application/moss-keys
# application/moss-signature
# application/mosskey-data
# application/mosskey-request
application/mp21				m21 mp21
application/mp4					mp4s
# application/mpeg4-generic
# application/mpeg4-iod
# application/mpeg4-iod-xmt
# application/mrb-consumer+xml
# application/mrb-publish+xml
# application/msc-ivr+xml
# application/msc-mixer+xml
application/msword				doc dot
application/mxf					mxf
# application/nasdata
# application/news-checkgroups
# application/news-groupinfo
# application/news-transmission
# application/nlsml+xml
# application/nss
# application/ocsp-request
# application/ocsp-response
application/octet-stream	bin dms lrf mar so dist distz pkg bpk dump elc deploy
application/oda					oda
# application/odx
application/oebps-package+xml			opf
application/ogg					ogx
application/omdoc+xml				omdoc
application/onenote				onetoc onetoc2 onetmp onepkg
application/oxps				oxps
# application/p2p-overlay+xml
# application/parityfec
application/patch-ops-error+xml			xer
application/pdf					pdf
# application/pdx
application/pgp-encrypted			pgp
# application/pgp-keys
application/pgp-signature			asc sig
application/pics-rules				prf
# application/pidf+xml
# application/pidf-diff+xml
application/pkcs10				p10
# application/pkcs12
application/pkcs7-mime				p7m p7c
application/pkcs7-signature			p7s
application/pkcs8				p8
application/pkix-attr-cert			ac
application/pkix-cert				cer
application/pkix-crl				crl
application/pkix-pkipath			pkipath
application/pkixcmp				pki
application/pls+xml				pls
# application/poc-settings+xml
application/postscript				ai eps ps
# application/ppsp-tracker+json
# application/problem+json
# application/problem+xml
# application/provenance+xml
# application/prs.alvestrand.titrax-sheet
application/prs.cww				cww
# application/prs.hpub+zip
# application/prs.nprend
# application/prs.plucker
# application/prs.rdf-xml-crypt
# application/prs.xsf+xml
application/pskc+xml				pskcxml
# application/qsig
# application/raptorfec
# application/rdap+json
application/rdf+xml				rdf
application/reginfo+xml				rif
application/relax-ng-compact-syntax		rnc
# application/remote-printing
# application/reputon+json
application/resource-lists+xml			rl
application/resource-lists-diff+xml		rld
# application/rfc+xml
# application/riscos
# application/rlmi+xml
application/rls-services+xml			rs
application/rpki-ghostbusters			gbr
application/rpki-manifest			mft
application/rpki-roa				roa
# application/rpki-updown
application/rsd+xml				rsd
application/rss+xml				rss
application/rtf					rtf
# application/rtploopback
# application/rtx
# application/samlassertion+xml
# application/samlmetadata+xml
application/sbml+xml				sbml
# application/scaip+xml
# application/scim+json
application/scvp-cv-request			scq
application/scvp-cv-response			scs
application/scvp-vp-request			spq
application/scvp-vp-response			spp
application/sdp					sdp
# application/sep+xml
# application/sep-exi
# application/session-info
# application/set-payment
application/set-payment-initiation		setpay
# application/set-registration
application/set-registration-initiation		setreg
# application/sgml
# application/sgml-open-catalog
application/shf+xml				shf
# application/sieve
# application/simple-filter+xml
# application/simple-message-summary
# application/simplesymbolcontainer
# application/slate
# application/smil
application/smil+xml				smi smil
# application/smpte336m
# application/soap+fastinfoset
# application/soap+xml
application/sparql-query			rq
application/sparql-results+xml			srx
# application/spirits-event+xml
# application/sql
application/srgs				gram
application/srgs+xml				grxml
application/sru+xml				sru
application/ssdl+xml				ssdl
application/ssml+xml				ssml
# application/tamp-apex-update
# application/tamp-apex-update-confirm
# application/tamp-community-update
# application/tamp-community-update-confirm
# application/tamp-error
# application/tamp-sequence-adjust
# application/tamp-sequence-adjust-confirm
# application/tamp-status-query
# application/tamp-status-response
# application/tamp-update
# application/tamp-update-confirm
application/tei+xml				tei teicorpus
application/thraud+xml				tfi
# application/timestamp-query
# application/timestamp-reply
application/timestamped-data			tsd
# application/ttml+xml
# application/tve-trigger
# application/ulpfec
# application/urc-grpsheet+xml
# application/urc-ressheet+xml
# application/urc-targetdesc+xml
# application/urc-uisocketdesc+xml
# application/vcard+json
# application/vcard+xml
# application/vemmi
# application/vividence.scriptfile
# application/vnd.3gpp-prose+xml
# application/vnd.3gpp-prose-pc3ch+xml
# application/vnd.3gpp.access-transfer-events+xml
# application/vnd.3gpp.bsf+xml
# application/vnd.3gpp.mid-call+xml
application/vnd.3gpp.pic-bw-large		plb
application/vnd.3gpp.pic-bw-small		psb
application/vnd.3gpp.pic-bw-var			pvb
# application/vnd.3gpp.sms
# application/vnd.3gpp.sms+xml
# application/vnd.3gpp.srvcc-ext+xml
# application/vnd.3gpp.srvcc-info+xml
# application/vnd.3gpp.state-and-event-info+xml
# application/vnd.3gpp.ussd+xml
# application/vnd.3gpp2.bcmcsinfo+xml
# application/vnd.3gpp2.sms
application/vnd.3gpp2.tcap			tcap
# application/vnd.3lightssoftware.imagescal
application/vnd.3m.post-it-notes		pwn
application/vnd.accpac.simply.aso		aso
application/vnd.accpac.simply.imp		imp
application/vnd.acucobol			acu
application/vnd.acucorp				atc acutc
application/vnd.adobe.air-application-installer-package+zip	air
# application/vnd.adobe.flash.movie
application/vnd.adobe.formscentral.fcdt		fcdt
application/vnd.adobe.fxp			fxp fxpl
# application/vnd.adobe.partial-upload
application/vnd.adobe.xdp+xml			xdp
application/vnd.adobe.xfdf			xfdf
# application/vnd.aether.imp
# application/vnd.ah-barcode
application/vnd.ahead.space			ahead
application/vnd.airzip.filesecure.azf		azf
application/vnd.airzip.filesecure.azs		azs
application/vnd.amazon.ebook			azw
# application/vnd.amazon.mobi8-ebook
application/vnd.americandynamics.acc		acc
application/vnd.amiga.ami			ami
# application/vnd.amundsen.maze+xml
application/vnd.android.package-archive		apk
# application/vnd.anki
application/vnd.anser-web-certificate-issue-initiation	cii
application/vnd.anser-web-funds-transfer-initiation	fti
application/vnd.antix.game-component		atx
# application/vnd.apache.thrift.binary
# application/vnd.apache.thrift.compact
# application/vnd.apache.thrift.json
# application/vnd.api+json
application/vnd.apple.installer+xml		mpkg
application/vnd.apple.mpegurl			m3u8
# application/vnd.arastra.swi
application/vnd.aristanetworks.swi		swi
# application/vnd.artsquare
application/vnd.astraea-software.iota		iota
application/vnd.audiograph			aep
# application/vnd.autopackage
# application/vnd.avistar+xml
# application/vnd.balsamiq.bmml+xml
# application/vnd.balsamiq.bmpr
# application/vnd.bekitzur-stech+json
# application/vnd.biopax.rdf+xml
application/vnd.blueice.multipass		mpm
# application/vnd.bluetooth.ep.oob
# application/vnd.bluetooth.le.oob
application/vnd.bmi				bmi
application/vnd.businessobjects			rep
# application/vnd.cab-jscript
# application/vnd.canon-cpdl
# application/vnd.canon-lips
# application/vnd.cendio.thinlinc.clientconf
# application/vnd.century-systems.tcp_stream
application/vnd.chemdraw+xml			cdxml
# application/vnd.chess-pgn
application/vnd.chipnuts.karaoke-mmd		mmd
application/vnd.cinderella			cdy
# application/vnd.cirpack.isdn-ext
# application/vnd.citationstyles.style+xml
application/vnd.claymore			cla
application/vnd.cloanto.rp9			rp9
application/vnd.clonk.c4group			c4g c4d c4f c4p c4u
application/vnd.cluetrust.cartomobile-config		c11amc
application/vnd.cluetrust.cartomobile-config-pkg	c11amz
# application/vnd.coffeescript
# application/vnd.collection+json
# application/vnd.collection.doc+json
# application/vnd.collection.next+json
# application/vnd.comicbook+zip
# application/vnd.commerce-battelle
application/vnd.commonspace			csp
application/vnd.contact.cmsg			cdbcmsg
# application/vnd.coreos.ignition+json
application/vnd.cosmocaller			cmc
application/vnd.crick.clicker			clkx
application/vnd.crick.clicker.keyboard		clkk
application/vnd.crick.clicker.palette		clkp
application/vnd.crick.clicker.template		clkt
application/vnd.crick.clicker.wordbank		clkw
application/vnd.criticaltools.wbs+xml		wbs
application/vnd.ctc-posml			pml
# application/vnd.ctct.ws+xml
# application/vnd.cups-pdf
# application/vnd.cups-postscript
application/vnd.cups-ppd			ppd
# application/vnd.cups-raster
# application/vnd.cups-raw
# application/vnd.curl
application/vnd.curl.car			car
application/vnd.curl.pcurl			pcurl
# application/vnd.cyan.dean.root+xml
# application/vnd.cybank
application/vnd.dart				dart
application/vnd.data-vision.rdz			rdz
# application/vnd.debian.binary-package
application/vnd.dece.data			uvf uvvf uvd uvvd
application/vnd.dece.ttml+xml			uvt uvvt
application/vnd.dece.unspecified		uvx uvvx
application/vnd.dece.zip			uvz uvvz
application/vnd.denovo.fcselayout-link		fe_launch
# application/vnd.desmume.movie
# application/vnd.dir-bi.plate-dl-nosuffix
# application/vnd.dm.delegation+xml
application/vnd.dna				dna
# application/vnd.document+json
application/vnd.dolby.mlp			mlp
# application/vnd.dolby.mobile.1
# application/vnd.dolby.mobile.2
# application/vnd.doremir.scorecloud-binary-document
application/vnd.dpgraph				dpg
application/vnd.dreamfactory			dfac
# application/vnd.drive+json
application/vnd.ds-keypoint			kpxx
# application/vnd.dtg.local
# application/vnd.dtg.local.flash
# application/vnd.dtg.local.html
application/vnd.dvb.ait				ait
# application/vnd.dvb.dvbj
# application/vnd.dvb.esgcontainer
# application/vnd.dvb.ipdcdftnotifaccess
# application/vnd.dvb.ipdcesgaccess
# application/vnd.dvb.ipdcesgaccess2
# application/vnd.dvb.ipdcesgpdd
# application/vnd.dvb.ipdcroaming
# application/vnd.dvb.iptv.alfec-base
# application/vnd.dvb.iptv.alfec-enhancement
# application/vnd.dvb.notif-aggregate-root+xml
# application/vnd.dvb.notif-container+xml
# application/vnd.dvb.notif-generic+xml
# application/vnd.dvb.notif-ia-msglist+xml
# application/vnd.dvb.notif-ia-registration-request+xml
# application/vnd.dvb.notif-ia-registration-response+xml
# application/vnd.dvb.notif-init+xml
# application/vnd.dvb.pfr
application/vnd.dvb.service			svc
# application/vnd.dxr
application/vnd.dynageo				geo
# application/vnd.dzr
# application/vnd.easykaraoke.cdgdownload
# application/vnd.ecdis-update
application/vnd.ecowin.chart			mag
# application/vnd.ecowin.filerequest
# application/vnd.ecowin.fileupdate
# application/vnd.ecowin.series
# application/vnd.ecowin.seriesrequest
# application/vnd.ecowin.seriesupdate
# application/vnd.emclient.accessrequest+xml
application/vnd.enliven				nml
# application/vnd.enphase.envoy
# application/vnd.eprints.data+xml
application/vnd.epson.esf			esf
application/vnd.epson.msf			msf
application/vnd.epson.quickanime		qam
application/vnd.epson.salt			slt
application/vnd.epson.ssf			ssf
# application/vnd.ericsson.quickcall
application/vnd.eszigno3+xml			es3 et3
# application/vnd.etsi.aoc+xml
# application/vnd.etsi.asic-e+zip
# application/vnd.etsi.asic-s+zip
# application/vnd.etsi.cug+xml
# application/vnd.etsi.iptvcommand+xml
# application/vnd.etsi.iptvdiscovery+xml
# application/vnd.etsi.iptvprofile+xml
# application/vnd.etsi.iptvsad-bc+xml
# application/vnd.etsi.iptvsad-cod+xml
# application/vnd.etsi.iptvsad-npvr+xml
# application/vnd.etsi.iptvservice+xml
# application/vnd.etsi.iptvsync+xml
# application/vnd.etsi.iptvueprofile+xml
# application/vnd.etsi.mcid+xml
# application/vnd.etsi.mheg5
# application/vnd.etsi.overload-control-policy-dataset+xml
# application/vnd.etsi.pstn+xml
# application/vnd.etsi.sci+xml
# application/vnd.etsi.simservs+xml
# application/vnd.etsi.timestamp-token
# application/vnd.etsi.tsl+xml
# application/vnd.etsi.tsl.der
# application/vnd.eudora.data
application/vnd.ezpix-album			ez2
application/vnd.ezpix-package			ez3
# application/vnd.f-secure.mobile
# application/vnd.fastcopy-disk-image
application/vnd.fdf				fdf
application/vnd.fdsn.mseed			mseed
application/vnd.fdsn.seed			seed dataless
# application/vnd.ffsns
# application/vnd.filmit.zfc
# application/vnd.fints
# application/vnd.firemonkeys.cloudcell
application/vnd.flographit			gph
application/vnd.fluxtime.clip			ftc
# application/vnd.font-fontforge-sfd
application/vnd.framemaker			fm frame maker book
application/vnd.frogans.fnc			fnc
application/vnd.frogans.ltf			ltf
application/vnd.fsc.weblaunch			fsc
application/vnd.fujitsu.oasys			oas
application/vnd.fujitsu.oasys2			oa2
application/vnd.fujitsu.oasys3			oa3
application/vnd.fujitsu.oasysgp			fg5
application/vnd.fujitsu.oasysprs		bh2
# application/vnd.fujixerox.art-ex
# application/vnd.fujixerox.art4
application/vnd.fujixerox.ddd			ddd
application/vnd.fujixerox.docuworks		xdw
application/vnd.fujixerox.docuworks.binder	xbd
# application/vnd.fujixerox.docuworks.container
# application/vnd.fujixerox.hbpl
# application/vnd.fut-misnet
application/vnd.fuzzysheet			fzs
application/vnd.genomatix.tuxedo		txd
# application/vnd.geo+json
# application/vnd.geocube+xml
application/vnd.geogebra.file			ggb
application/vnd.geogebra.tool			ggt
application/vnd.geometry-explorer		gex gre
application/vnd.geonext				gxt
application/vnd.geoplan				g2w
application/vnd.geospace			g3w
# application/vnd.gerber
# application/vnd.globalplatform.card-content-mgt
# application/vnd.globalplatform.card-content-mgt-response
application/vnd.gmx				gmx
application/vnd.google-earth.kml+xml		kml
application/vnd.google-earth.kmz		kmz
# application/vnd.gov.sk.e-form+xml
# application/vnd.gov.sk.e-form+zip
# application/vnd.gov.sk.xmldatacontainer+xml
application/vnd.grafeq				gqf gqs
# application/vnd.gridmp
application/vnd.groove-account			gac
application/vnd.groove-help			ghf
application/vnd.groove-identity-message		gim
application/vnd.groove-injector			grv
application/vnd.groove-tool-message		gtm
application/vnd.groove-tool-template		tpl
application/vnd.groove-vcard			vcg
# application/vnd.hal+json
application/vnd.hal+xml				hal
application/vnd.handheld-entertainment+xml	zmm
application/vnd.hbci				hbci
# application/vnd.hcl-bireports
# application/vnd.hdt
# application/vnd.heroku+json
application/vnd.hhe.lesson-player		les
application/vnd.hp-hpgl				hpgl
application/vnd.hp-hpid				hpid
application/vnd.hp-hps				hps
application/vnd.hp-jlyt				jlt
application/vnd.hp-pcl				pcl
application/vnd.hp-pclxl			pclxl
# application/vnd.httphone
application/vnd.hydrostatix.sof-data		sfd-hdstx
# application/vnd.hyperdrive+json
# application/vnd.hzn-3d-crossword
# application/vnd.ibm.afplinedata
# application/vnd.ibm.electronic-media
application/vnd.ibm.minipay			mpy
application/vnd.ibm.modcap			afp listafp list3820
application/vnd.ibm.rights-management		irm
application/vnd.ibm.secure-container		sc
application/vnd.iccprofile			icc icm
# application/vnd.ieee.1905
application/vnd.igloader			igl
application/vnd.immervision-ivp			ivp
application/vnd.immervision-ivu			ivu
# application/vnd.ims.imsccv1p1
# application/vnd.ims.imsccv1p2
# application/vnd.ims.imsccv1p3
# application/vnd.ims.lis.v2.result+json
# application/vnd.ims.lti.v2.toolconsumerprofile+json
# application/vnd.ims.lti.v2.toolproxy+json
# application/vnd.ims.lti.v2.toolproxy.id+json
# application/vnd.ims.lti.v2.toolsettings+json
# application/vnd.ims.lti.v2.toolsettings.simple+json
# application/vnd.informedcontrol.rms+xml
# application/vnd.informix-visionary
# application/vnd.infotech.project
# application/vnd.infotech.project+xml
# application/vnd.innopath.wamp.notification
application/vnd.insors.igm			igm
application/vnd.intercon.formnet		xpw xpx
application/vnd.intergeo			i2g
# application/vnd.intertrust.digibox
# application/vnd.intertrust.nncp
application/vnd.intu.qbo			qbo
application/vnd.intu.qfx			qfx
# application/vnd.iptc.g2.catalogitem+xml
# application/vnd.iptc.g2.conceptitem+xml
# application/vnd.iptc.g2.knowledgeitem+xml
# application/vnd.iptc.g2.newsitem+xml
# application/vnd.iptc.g2.newsmessage+xml
# application/vnd.iptc.g2.packageitem+xml
# application/vnd.iptc.g2.planningitem+xml
application/vnd.ipunplugged.rcprofile		rcprofile
application/vnd.irepository.package+xml		irp
application/vnd.is-xpr				xpr
application/vnd.isac.fcs			fcs
application/vnd.jam				jam
# application/vnd.japannet-directory-service
# application/vnd.japannet-jpnstore-wakeup
# application/vnd.japannet-payment-wakeup
# application/vnd.japannet-registration
# application/vnd.japannet-registration-wakeup
# application/vnd.japannet-setstore-wakeup
# application/vnd.japannet-verification
# application/vnd.japannet-verification-wakeup
application/vnd.jcp.javame.midlet-rms		rms
application/vnd.jisp				jisp
application/vnd.joost.joda-archive		joda
# application/vnd.jsk.isdn-ngn
application/vnd.kahootz				ktz ktr
application/vnd.kde.karbon			karbon
application/vnd.kde.kchart			chrt
application/vnd.kde.kformula			kfo
application/vnd.kde.kivio			flw
application/vnd.kde.kontour			kon
application/vnd.kde.kpresenter			kpr kpt
application/vnd.kde.kspread			ksp
application/vnd.kde.kword			kwd kwt
application/vnd.kenameaapp			htke
application/vnd.kidspiration			kia
application/vnd.kinar				kne knp
application/vnd.koan				skp skd skt skm
application/vnd.kodak-descriptor		sse
application/vnd.las.las+xml			lasxml
# application/vnd.liberty-request+xml
application/vnd.llamagraphics.life-balance.desktop	lbd
application/vnd.llamagraphics.life-balance.exchange+xml	lbe
application/vnd.lotus-1-2-3			123
application/vnd.lotus-approach			apr
application/vnd.lotus-freelance			pre
application/vnd.lotus-notes			nsf
application/vnd.lotus-organizer			org
application/vnd.lotus-screencam			scm
application/vnd.lotus-wordpro			lwp
application/vnd.macports.portpkg		portpkg
# application/vnd.mapbox-vector-tile
# application/vnd.marlin.drm.actiontoken+xml
# application/vnd.marlin.drm.conftoken+xml
# application/vnd.marlin.drm.license+xml
# application/vnd.marlin.drm.mdcf
# application/vnd.mason+json
# application/vnd.maxmind.maxmind-db
application/vnd.mcd				mcd
application/vnd.medcalcdata			mc1
application/vnd.mediastation.cdkey		cdkey
# application/vnd.meridian-slingshot
application/vnd.mfer				mwf
application/vnd.mfmp				mfm
# application/vnd.micro+json
application/vnd.micrografx.flo			flo
application/vnd.micrografx.igx			igx
# application/vnd.microsoft.portable-executable
# application/vnd.miele+json
application/vnd.mif				mif
# application/vnd.minisoft-hp3000-save
# application/vnd.mitsubishi.misty-guard.trustweb
application/vnd.mobius.daf			daf
application/vnd.mobius.dis			dis
application/vnd.mobius.mbk			mbk
application/vnd.mobius.mqy			mqy
application/vnd.mobius.msl			msl
application/vnd.mobius.plc			plc
application/vnd.mobius.txf			txf
application/vnd.mophun.application		mpn
application/vnd.mophun.certificate		mpc
# application/vnd.motorola.flexsuite
# application/vnd.motorola.flexsuite.adsi
# application/vnd.motorola.flexsuite.fis
# application/vnd.motorola.flexsuite.gotap
# application/vnd.motorola.flexsuite.kmr
# application/vnd.motorola.flexsuite.ttc
# application/vnd.motorola.flexsuite.wem
# application/vnd.motorola.iprm
application/vnd.mozilla.xul+xml			xul
# application/vnd.ms-3mfdocument
application/vnd.ms-artgalry			cil
# application/vnd.ms-asf
application/vnd.ms-cab-compressed		cab
# application/vnd.ms-color.iccprofile
application/vnd.ms-excel			xls xlm xla xlc xlt xlw
application/vnd.ms-excel.addin.macroenabled.12		xlam
application/vnd.ms-excel.sheet.binary.macroenabled.12	xlsb
application/vnd.ms-excel.sheet.macroenabled.12		xlsm
application/vnd.ms-excel.template.macroenabled.12	xltm
application/vnd.ms-fontobject			eot
application/vnd.ms-htmlhelp			chm
application/vnd.ms-ims				ims
application/vnd.ms-lrm				lrm
# application/vnd.ms-office.activex+xml
application/vnd.ms-officetheme			thmx
# application/vnd.ms-opentype
# application/vnd.ms-package.obfuscated-opentype
application/vnd.ms-pki.seccat			cat
application/vnd.ms-pki.stl			stl
# application/vnd.ms-playready.initiator+xml
application/vnd.ms-powerpoint			ppt pps pot
application/vnd.ms-powerpoint.addin.macroenabled.12		ppam
application/vnd.ms-powerpoint.presentation.macroenabled.12	pptm
application/vnd.ms-powerpoint.slide.macroenabled.12		sldm
application/vnd.ms-powerpoint.slideshow.macroenabled.12		ppsm
application/vnd.ms-powerpoint.template.macroenabled.12		potm
# application/vnd.ms-printdevicecapabilities+xml
# application/vnd.ms-printing.printticket+xml
# application/vnd.ms-printschematicket+xml
application/vnd.ms-project			mpp mpt
# application/vnd.ms-tnef
# application/vnd.ms-windows.devicepairing
# application/vnd.ms-windows.nwprinting.oob
# application/vnd.ms-windows.printerpairing
# application/vnd.ms-windows.wsd.oob
# application/vnd.ms-wmdrm.lic-chlg-req
# application/vnd.ms-wmdrm.lic-resp
# application/vnd.ms-wmdrm.meter-chlg-req
# application/vnd.ms-wmdrm.meter-resp
application/vnd.ms-word.document.macroenabled.12	docm
application/vnd.ms-word.template.macroenabled.12	dotm
application/vnd.ms-works			wps wks wcm wdb
application/vnd.ms-wpl				wpl
application/vnd.ms-xpsdocument			xps
# application/vnd.msa-disk-image
application/vnd.mseq				mseq
# application/vnd.msign
# application/vnd.multiad.creator
# application/vnd.multiad.creator.cif
# application/vnd.music-niff
application/vnd.musician			mus
application/vnd.muvee.style			msty
application/vnd.mynfc				taglet
# application/vnd.ncd.control
# application/vnd.ncd.reference
# application/vnd.nervana
# application/vnd.netfpx
application/vnd.neurolanguage.nlu		nlu
# application/vnd.nintendo.nitro.rom
# application/vnd.nintendo.snes.rom
application/vnd.nitf				ntf nitf
application/vnd.noblenet-directory		nnd
application/vnd.noblenet-sealer			nns
application/vnd.noblenet-web			nnw
# application/vnd.nokia.catalogs
# application/vnd.nokia.conml+wbxml
# application/vnd.nokia.conml+xml
# application/vnd.nokia.iptv.config+xml
# application/vnd.nokia.isds-radio-presets
# application/vnd.nokia.landmark+wbxml
# application/vnd.nokia.landmark+xml
# application/vnd.nokia.landmarkcollection+xml
# application/vnd.nokia.n-gage.ac+xml
application/vnd.nokia.n-gage.data		ngdat
application/vnd.nokia.n-gage.symbian.install	n-gage
# application/vnd.nokia.ncd
# application/vnd.nokia.pcd+wbxml
# application/vnd.nokia.pcd+xml
application/vnd.nokia.radio-preset		rpst
application/vnd.nokia.radio-presets		rpss
application/vnd.novadigm.edm			edm
application/vnd.novadigm.edx			edx
application/vnd.novadigm.ext			ext
# application/vnd.ntt-local.content-share
# application/vnd.ntt-local.file-transfer
# application/vnd.ntt-local.ogw_remote-access
# application/vnd.ntt-local.sip-ta_remote
# application/vnd.ntt-local.sip-ta_tcp_stream
application/vnd.oasis.opendocument.chart		odc
application/vnd.oasis.opendocument.chart-template	otc
application/vnd.oasis.opendocument.database		odb
application/vnd.oasis.opendocument.formula		odf
application/vnd.oasis.opendocument.formula-template	odft
application/vnd.oasis.opendocument.graphics		odg
application/vnd.oasis.opendocument.graphics-template	otg
application/vnd.oasis.opendocument.image		odi
application/vnd.oasis.opendocument.image-template	oti
application/vnd.oasis.opendocument.presentation		odp
application/vnd.oasis.opendocument.presentation-template	otp
application/vnd.oasis.opendocument.spreadsheet		ods
application/vnd.oasis.opendocument.spreadsheet-template	ots
application/vnd.oasis.opendocument.text			odt
application/vnd.oasis.opendocument.text-master		odm
application/vnd.oasis.opendocument.text-template	ott
application/vnd.oasis.opendocument.text-web		oth
# application/vnd.obn
# application/vnd.oftn.l10n+json
# application/vnd.oipf.contentaccessdownload+xml
# application/vnd.oipf.contentaccessstreaming+xml
# application/vnd.oipf.cspg-hexbinary
# application/vnd.oipf.dae.svg+xml
# application/vnd.oipf.dae.xhtml+xml
# application/vnd.oipf.mippvcontrolmessage+xml
# application/vnd.oipf.pae.gem
# application/vnd.oipf.spdiscovery+xml
# application/vnd.oipf.spdlist+xml
# application/vnd.oipf.ueprofile+xml
# application/vnd.oipf.userprofile+xml
application/vnd.olpc-sugar			xo
# application/vnd.oma-scws-config
# application/vnd.oma-scws-http-request
# application/vnd.oma-scws-http-response
# application/vnd.oma.bcast.associated-procedure-parameter+xml
# application/vnd.oma.bcast.drm-trigger+xml
# application/vnd.oma.bcast.imd+xml
# application/vnd.oma.bcast.ltkm
# application/vnd.oma.bcast.notification+xml
# application/vnd.oma.bcast.provisioningtrigger
# application/vnd.oma.bcast.sgboot
# application/vnd.oma.bcast.sgdd+xml
# application/vnd.oma.bcast.sgdu
# application/vnd.oma.bcast.simple-symbol-container
# application/vnd.oma.bcast.smartcard-trigger+xml
# application/vnd.oma.bcast.sprov+xml
# application/vnd.oma.bcast.stkm
# application/vnd.oma.cab-address-book+xml
# application/vnd.oma.cab-feature-handler+xml
# application/vnd.oma.cab-pcc+xml
# application/vnd.oma.cab-subs-invite+xml
# application/vnd.oma.cab-user-prefs+xml
# application/vnd.oma.dcd
# application/vnd.oma.dcdc
application/vnd.oma.dd2+xml			dd2
# application/vnd.oma.drm.risd+xml
# application/vnd.oma.group-usage-list+xml
# application/vnd.oma.lwm2m+json
# application/vnd.oma.lwm2m+tlv
# application/vnd.oma.pal+xml
# application/vnd.oma.poc.detailed-progress-report+xml
# application/vnd.oma.poc.final-report+xml
# application/vnd.oma.poc.groups+xml
# application/vnd.oma.poc.invocation-descriptor+xml
# application/vnd.oma.poc.optimized-progress-report+xml
# application/vnd.oma.push
# application/vnd.oma.scidm.messages+xml
# application/vnd.oma.xcap-directory+xml
# application/vnd.omads-email+xml
# application/vnd.omads-file+xml
# application/vnd.omads-folder+xml
# application/vnd.omaloc-supl-init
# application/vnd.onepager
# application/vnd.openblox.game+xml
# application/vnd.openblox.game-binary
# application/vnd.openeye.oeb
application/vnd.openofficeorg.extension		oxt
# application/vnd.openxmlformats-officedocument.custom-properties+xml
# application/vnd.openxmlformats-officedocument.customxmlproperties+xml
# application/vnd.openxmlformats-officedocument.drawing+xml
# application/vnd.openxmlformats-officedocument.drawingml.chart+xml
# application/vnd.openxmlformats-officedocument.drawingml.chartshapes+xml
# application/vnd.openxmlformats-officedocument.drawingml.diagramcolors+xml
# application/vnd.openxmlformats-officedocument.drawingml.diagramdata+xml
# application/vnd.openxmlformats-officedocument.drawingml.diagramlayout+xml
# application/vnd.openxmlformats-officedocument.drawingml.diagramstyle+xml
# application/vnd.openxmlformats-officedocument.extended-properties+xml
# application/vnd.openxmlformats-officedocument.presentationml.commentauthors+xml
# application/vnd.openxmlformats-officedocument.presentationml.comments+xml
# application/vnd.openxmlformats-officedocument.presentationml.handoutmaster+xml
# application/vnd.openxmlformats-officedocument.presentationml.notesmaster+xml
# application/vnd.openxmlformats-officedocument.presentationml.notesslide+xml
application/vnd.openxmlformats-officedocument.presentationml.presentation	pptx
# application/vnd.openxmlformats-officedocument.presentationml.presentation.main+xml
# application/vnd.openxmlformats-officedocument.presentationml.presprops+xml
application/vnd.openxmlformats-officedocument.presentationml.slide	sldx
# application/vnd.openxmlformats-officedocument.presentationml.slide+xml
# application/vnd.openxmlformats-officedocument.presentationml.slidelayout+xml
# application/vnd.openxmlformats-officedocument.presentationml.slidemaster+xml
application/vnd.openxmlformats-officedocument.presentationml.slideshow	ppsx
# application/vnd.openxmlformats-officedocument.presentationml.slideshow.main+xml
# application/vnd.openxmlformats-officedocument.presentationml.slideupdateinfo+xml
# application/vnd.openxmlformats-officedocument.presentationml.tablestyles+xml
# application/vnd.openxmlformats-officedocument.presentationml.tags+xml
application/vnd.openxmlformats-officedocument.presentationml.template	potx
# application/vnd.openxmlformats-officedocument.presentationml.template.main+xml
# application/vnd.openxmlformats-officedocument.presentationml.viewprops+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.calcchain+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.chartsheet+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.comments+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.connections+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.dialogsheet+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.externallink+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.pivotcachedefinition+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.pivotcacherecords+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.pivottable+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.querytable+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.revisionheaders+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.revisionlog+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.sharedstrings+xml
application/vnd.openxmlformats-officedocument.spreadsheetml.sheet	xlsx
# application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.sheetmetadata+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.table+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.tablesinglecells+xml
application/vnd.openxmlformats-officedocument.spreadsheetml.template	xltx
# application/vnd.openxmlformats-officedocument.spreadsheetml.template.main+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.usernames+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.volatiledependencies+xml
# application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml
# application/vnd.openxmlformats-officedocument.theme+xml
# application/vnd.openxmlformats-officedocument.themeoverride+xml
# application/vnd.openxmlformats-officedocument.vmldrawing
# application/vnd.openxmlformats-officedocument.wordprocessingml.comments+xml
application/vnd.openxmlformats-officedocument.wordprocessingml.document	docx
# application/vnd.openxmlformats-officedocument.wordprocessingml.document.glossary+xml
# application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml
# application/vnd.openxmlformats-officedocument.wordprocessingml.endnotes+xml
# application/vnd.openxmlformats-officedocument.wordprocessingml.fonttable+xml
# application/vnd.openxmlformats-officedocument.wordprocessingml.footer+xml
# application/vnd.openxmlformats-officedocument.wordprocessingml.footnotes+xml
# application/vnd.openxmlformats-officedocument.wordprocessingml.numbering+xml
# application/vnd.openxmlformats-officedocument.wordprocessingml.settings+xml
# application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml
application/vnd.openxmlformats-officedocument.wordprocessingml.template	dotx
# application/vnd.openxmlformats-officedocument.wordprocessingml.template.main+xml
# application/vnd.openxmlformats-officedocument.wordprocessingml.websettings+xml
# application/vnd.openxmlformats-package.core-properties+xml
# application/vnd.openxmlformats-package.digital-signature-xmlsignature+xml
# application/vnd.openxmlformats-package.relationships+xml
# application/vnd.oracle.resource+json
# application/vnd.orange.indata
# application/vnd.osa.netdeploy
application/vnd.osgeo.mapguide.package		mgp
# application/vnd.osgi.bundle
application/vnd.osgi.dp				dp
application/vnd.osgi.subsystem			esa
# application/vnd.otps.ct-kip+xml
# application/vnd.oxli.countgraph
# application/vnd.pagerduty+json
application/vnd.palm				pdb pqa oprc
# application/vnd.panoply
# application/vnd.paos.xml
application/vnd.pawaafile			paw
# application/vnd.pcos
application/vnd.pg.format			str
application/vnd.pg.osasli			ei6
# application/vnd.piaccess.application-licence
application/vnd.picsel				efif
application/vnd.pmi.widget			wg
# application/vnd.poc.group-advertisement+xml
application/vnd.pocketlearn			plf
application/vnd.powerbuilder6			pbd
# application/vnd.powerbuilder6-s
# application/vnd.powerbuilder7
# application/vnd.powerbuilder7-s
# application/vnd.powerbuilder75
# application/vnd.powerbuilder75-s
# application/vnd.preminet
application/vnd.previewsystems.box		box
application/vnd.proteus.magazine		mgz
application/vnd.publishare-delta-tree		qps
application/vnd.pvi.ptid1			ptid
# application/vnd.pwg-multiplexed
# application/vnd.pwg-xhtml-print+xml
# application/vnd.qualcomm.brew-app-res
# application/vnd.quarantainenet
application/vnd.quark.quarkxpress		qxd qxt qwd qwt qxl qxb
# application/vnd.quobject-quoxdocument
# application/vnd.radisys.moml+xml
# application/vnd.radisys.msml+xml
# application/vnd.radisys.msml-audit+xml
# application/vnd.radisys.msml-audit-conf+xml
# application/vnd.radisys.msml-audit-conn+xml
# application/vnd.radisys.msml-audit-dialog+xml
# application/vnd.radisys.msml-audit-stream+xml
# application/vnd.radisys.msml-conf+xml
# application/vnd.radisys.msml-dialog+xml
# application/vnd.radisys.msml-dialog-base+xml
# application/vnd.radisys.msml-dialog-fax-detect+xml
# application/vnd.radisys.msml-dialog-fax-sendrecv+xml
# application/vnd.radisys.msml-dialog-group+xml
# application/vnd.radisys.msml-dialog-speech+xml
# application/vnd.radisys.msml-dialog-transform+xml
# application/vnd.rainstor.data
# application/vnd.rapid
# application/vnd.rar
application/vnd.realvnc.bed			bed
application/vnd.recordare.musicxml		mxl
application/vnd.recordare.musicxml+xml		musicxml
# application/vnd.renlearn.rlprint
application/vnd.rig.cryptonote			cryptonote
application/vnd.rim.cod				cod
application/vnd.rn-realmedia			rm
application/vnd.rn-realmedia-vbr		rmvb
application/vnd.route66.link66+xml		link66
# application/vnd.rs-274x
# application/vnd.ruckus.download
# application/vnd.s3sms
application/vnd.sailingtracker.track		st
# application/vnd.sbm.cid
# application/vnd.sbm.mid2
# application/vnd.scribus
# application/vnd.sealed.3df
# application/vnd.sealed.csf
# application/vnd.sealed.doc
# application/vnd.sealed.eml
# application/vnd.sealed.mht
# application/vnd.sealed.net
# application/vnd.sealed.ppt
# application/vnd.sealed.tiff
# application/vnd.sealed.xls
# application/vnd.sealedmedia.softseal.html
# application/vnd.sealedmedia.softseal.pdf
application/vnd.seemail				see
application/vnd.sema				sema
application/vnd.semd				semd
application/vnd.semf				semf
application/vnd.shana.informed.formdata		ifm
application/vnd.shana.informed.formtemplate	itp
application/vnd.shana.informed.interchange	iif
application/vnd.shana.informed.package		ipk
application/vnd.simtech-mindmapper		twd twds
# application/vnd.siren+json
application/vnd.smaf				mmf
# application/vnd.smart.notebook
application/vnd.smart.teacher			teacher
# application/vnd.software602.filler.form+xml
# application/vnd.software602.filler.form-xml-zip
application/vnd.solent.sdkm+xml			sdkm sdkd
application/vnd.spotfire.dxp			dxp
application/vnd.spotfire.sfs			sfs
# application/vnd.sss-cod
# application/vnd.sss-dtf
# application/vnd.sss-ntf
application/vnd.stardivision.calc		sdc
application/vnd.stardivision.draw		sda
application/vnd.stardivision.impress		sdd
application/vnd.stardivision.math		smf
application/vnd.stardivision.writer		sdw vor
application/vnd.stardivision.writer-global	sgl
application/vnd.stepmania.package		smzip
application/vnd.stepmania.stepchart		sm
# application/vnd.street-stream
# application/vnd.sun.wadl+xml
application/vnd.sun.xml.calc			sxc
application/vnd.sun.xml.calc.template		stc
application/vnd.sun.xml.draw			sxd
application/vnd.sun.xml.draw.template		std
application/vnd.sun.xml.impress			sxi
application/vnd.sun.xml.impress.template	sti
application/vnd.sun.xml.math			sxm
application/vnd.sun.xml.writer			sxw
application/vnd.sun.xml.writer.global		sxg
application/vnd.sun.xml.writer.template		stw
application/vnd.sus-calendar			sus susp
application/vnd.svd				svd
# application/vnd.swiftview-ics
application/vnd.symbian.install			sis sisx
application/vnd.syncml+xml			xsm
application/vnd.syncml.dm+wbxml			bdm
application/vnd.syncml.dm+xml			xdm
# application/vnd.syncml.dm.notification
# application/vnd.syncml.dmddf+wbxml
# application/vnd.syncml.dmddf+xml
# application/vnd.syncml.dmtnds+wbxml
# application/vnd.syncml.dmtnds+xml
# application/vnd.syncml.ds.notification
application/vnd.tao.intent-module-archive	tao
application/vnd.tcpdump.pcap			pcap cap dmp
# application/vnd.tmd.mediaflex.api+xml
# application/vnd.tml
application/vnd.tmobile-livetv			tmo
application/vnd.trid.tpt			tpt
application/vnd.triscape.mxs			mxs
application/vnd.trueapp				tra
# application/vnd.truedoc
# application/vnd.ubisoft.webplayer
application/vnd.ufdl				ufd ufdl
application/vnd.uiq.theme			utz
application/vnd.umajin				umj
application/vnd.unity				unityweb
application/vnd.uoml+xml			uoml
# application/vnd.uplanet.alert
# application/vnd.uplanet.alert-wbxml
# application/vnd.uplanet.bearer-choice
# application/vnd.uplanet.bearer-choice-wbxml
# application/vnd.uplanet.cacheop
# application/vnd.uplanet.cacheop-wbxml
# application/vnd.uplanet.channel
# application/vnd.uplanet.channel-wbxml
# application/vnd.uplanet.list
# application/vnd.uplanet.list-wbxml
# application/vnd.uplanet.listcmd
# application/vnd.uplanet.listcmd-wbxml
# application/vnd.uplanet.signal
# application/vnd.uri-map
# application/vnd.valve.source.material
application/vnd.vcx				vcx
# application/vnd.vd-study
# application/vnd.vectorworks
# application/vnd.vel+json
# application/vnd.verimatrix.vcas
# application/vnd.vidsoft.vidconference
application/vnd.visio				vsd vst vss vsw
application/vnd.visionary			vis
# application/vnd.vividence.scriptfile
application/vnd.vsf				vsf
# application/vnd.wap.sic
# application/vnd.wap.slc
application/vnd.wap.wbxml			wbxml
application/vnd.wap.wmlc			wmlc
application/vnd.wap.wmlscriptc			wmlsc
application/vnd.webturbo			wtb
# application/vnd.wfa.p2p
# application/vnd.wfa.wsc
# application/vnd.windows.devicepairing
# application/vnd.wmc
# application/vnd.wmf.bootstrap
# application/vnd.wolfram.mathematica
# application/vnd.wolfram.mathematica.package
application/vnd.wolfram.player			nbp
application/vnd.wordperfect			wpd
application/vnd.wqd				wqd
# application/vnd.wrq-hp3000-labelled
application/vnd.wt.stf				stf
# application/vnd.wv.csp+wbxml
# application/vnd.wv.csp+xml
# application/vnd.wv.ssp+xml
# application/vnd.xacml+json
application/vnd.xara				xar
application/vnd.xfdl				xfdl
# application/vnd.xfdl.webform
# application/vnd.xmi+xml
# application/vnd.xmpie.cpkg
# application/vnd.xmpie.dpkg
# application/vnd.xmpie.plan
# application/vnd.xmpie.ppkg
# application/vnd.xmpie.xlim
application/vnd.yamaha.hv-dic			hvd
application/vnd.yamaha.hv-script		hvs
application/vnd.yamaha.hv-voice			hvp
application/vnd.yamaha.openscoreformat			osf
application/vnd.yamaha.openscoreformat.osfpvg+xml	osfpvg
# application/vnd.yamaha.remote-setup
application/vnd.yamaha.smaf-audio		saf
application/vnd.yamaha.smaf-phrase		spf
# application/vnd.yamaha.through-ngn
# application/vnd.yamaha.tunnel-udpencap
# application/vnd.yaoweme
application/vnd.yellowriver-custom-menu		cmp
application/vnd.zul				zir zirz
application/vnd.zzazz.deck+xml			zaz
application/voicexml+xml			vxml
# application/vq-rtcpxr
# application/watcherinfo+xml
# application/whoispp-query
# application/whoispp-response
application/widget				wgt
application/winhlp				hlp
# application/wita
# application/wordperfect5.1
application/wsdl+xml				wsdl
application/wspolicy+xml			wspolicy
application/x-7z-compressed			7z
application/x-abiword				abw
application/x-ace-compressed			ace
# application/x-amf
application/x-apple-diskimage			dmg
application/x-authorware-bin			aab x32 u32 vox
application/x-authorware-map			aam
application/x-authorware-seg			aas
application/x-bcpio				bcpio
application/x-bittorrent			torrent
application/x-blorb				blb blorb
application/x-bzip				bz
application/x-bzip2				bz2 boz
application/x-cbr				cbr cba cbt cbz cb7
application/x-cdlink				vcd
application/x-cfs-compressed			cfs
application/x-chat				chat
application/x-chess-pgn				pgn
# application/x-compress
application/x-conference			nsc
application/x-cpio				cpio
application/x-csh				csh
application/x-debian-package			deb udeb
application/x-dgc-compressed			dgc
application/x-director			dir dcr dxr cst cct cxt w3d fgd swa
application/x-doom				wad
application/x-dtbncx+xml			ncx
application/x-dtbook+xml			dtb
application/x-dtbresource+xml			res
application/x-dvi				dvi
application/x-envoy				evy
application/x-eva				eva
application/x-font-bdf				bdf
# application/x-font-dos
# application/x-font-framemaker
application/x-font-ghostscript			gsf
# application/x-font-libgrx
application/x-font-linux-psf			psf
application/x-font-pcf				pcf
application/x-font-snf				snf
# application/x-font-speedo
# application/x-font-sunos-news
application/x-font-type1			pfa pfb pfm afm
# application/x-font-vfont
application/x-freearc				arc
application/x-futuresplash			spl
application/x-gca-compressed			gca
application/x-glulx				ulx
application/x-gnumeric				gnumeric
application/x-gramps-xml			gramps
application/x-gtar				gtar
# application/x-gzip
application/x-hdf				hdf
application/x-install-instructions		install
application/x-iso9660-image			iso
application/x-java-jnlp-file			jnlp
application/x-latex				latex
application/x-lzh-compressed			lzh lha
application/x-mie				mie
application/x-mobipocket-ebook			prc mobi
application/x-ms-application			application
application/x-ms-shortcut			lnk
application/x-ms-wmd				wmd
application/x-ms-wmz				wmz
application/x-ms-xbap				xbap
application/x-msaccess				mdb
application/x-msbinder				obd
application/x-mscardfile			crd
application/x-msclip				clp
application/x-msdownload			exe dll com bat msi
application/x-msmediaview			mvb m13 m14
application/x-msmetafile			wmf wmz emf emz
application/x-msmoney				mny
application/x-mspublisher			pub
application/x-msschedule			scd
application/x-msterminal			trm
application/x-mswrite				wri
application/x-netcdf				nc cdf
application/x-nzb				nzb
application/x-pkcs12				p12 pfx
application/x-pkcs7-certificates		p7b spc
application/x-pkcs7-certreqresp			p7r
application/x-rar-compressed			rar
application/x-research-info-systems		ris
application/x-sh				sh
application/x-shar				shar
application/x-shockwave-flash			swf
application/x-silverlight-app			xap
application/x-sql				sql
application/x-stuffit				sit
application/x-stuffitx				sitx
application/x-subrip				srt
application/x-sv4cpio				sv4cpio
application/x-sv4crc				sv4crc
application/x-t3vm-image			t3
application/x-tads				gam
application/x-tar				tar
application/x-tcl				tcl
application/x-tex				tex
application/x-tex-tfm				tfm
application/x-texinfo				texinfo texi
application/x-tgif				obj
application/x-ustar				ustar
application/x-wais-source			src
# application/x-www-form-urlencoded
application/x-x509-ca-cert			der crt
application/x-xfig				fig
application/x-xliff+xml				xlf
application/x-xpinstall				xpi
application/x-xz				xz
application/x-zmachine				z1 z2 z3 z4 z5 z6 z7 z8
# application/x400-bp
# application/xacml+xml
application/xaml+xml				xaml
# application/xcap-att+xml
# application/xcap-caps+xml
application/xcap-diff+xml			xdf
# application/xcap-el+xml
# application/xcap-error+xml
# application/xcap-ns+xml
# application/xcon-conference-info+xml
# application/xcon-conference-info-diff+xml
application/xenc+xml				xenc
application/xhtml+xml				xhtml xht
# application/xhtml-voice+xml
application/xml					xml xsl
application/xml-dtd				dtd
# application/xml-external-parsed-entity
# application/xml-patch+xml
# application/xmpp+xml
application/xop+xml				xop
application/xproc+xml				xpl
application/xslt+xml				xslt
application/xspf+xml				xspf
application/xv+xml				mxml xhvml xvml xvm
application/yang				yang
application/yin+xml				yin
application/zip					zip
# application/zlib
# audio/1d-interleaved-parityfec
# audio/32kadpcm
# audio/3gpp
# audio/3gpp2
# audio/ac3
audio/adpcm					adp
# audio/amr
# audio/amr-wb
# audio/amr-wb+
# audio/aptx
# audio/asc
# audio/atrac-advanced-lossless
# audio/atrac-x
# audio/atrac3
audio/basic					au snd
# audio/bv16
# audio/bv32
# audio/clearmode
# audio/cn
# audio/dat12
# audio/dls
# audio/dsr-es201108
# audio/dsr-es202050
# audio/dsr-es202211
# audio/dsr-es202212
# audio/dv
# audio/dvi4
# audio/eac3
# audio/encaprtp
# audio/evrc
# audio/evrc-qcp
# audio/evrc0
# audio/evrc1
# audio/evrcb
# audio/evrcb0
# audio/evrcb1
# audio/evrcnw
# audio/evrcnw0
# audio/evrcnw1
# audio/evrcwb
# audio/evrcwb0
# audio/evrcwb1
# audio/evs
# audio/example
# audio/fwdred
# audio/g711-0
# audio/g719
# audio/g722
# audio/g7221
# audio/g723
# audio/g726-16
# audio/g726-24
# audio/g726-32
# audio/g726-40
# audio/g728
# audio/g729
# audio/g7291
# audio/g729d
# audio/g729e
# audio/gsm
# audio/gsm-efr
# audio/gsm-hr-08
# audio/ilbc
# audio/ip-mr_v2.5
# audio/isac
# audio/l16
# audio/l20
# audio/l24
# audio/l8
# audio/lpc
audio/midi					mid midi kar rmi
# audio/mobile-xmf
audio/mp4					m4a mp4a
# audio/mp4a-latm
# audio/mpa
# audio/mpa-robust
audio/mpeg					mpga mp2 mp2a mp3 m2a m3a
# audio/mpeg4-generic
# audio/musepack
audio/ogg					oga ogg spx
# audio/opus
# audio/parityfec
# audio/pcma
# audio/pcma-wb
# audio/pcmu
# audio/pcmu-wb
# audio/prs.sid
# audio/qcelp
# audio/raptorfec
# audio/red
# audio/rtp-enc-aescm128
# audio/rtp-midi
# audio/rtploopback
# audio/rtx
audio/s3m					s3m
audio/silk					sil
# audio/smv
# audio/smv-qcp
# audio/smv0
# audio/sp-midi
# audio/speex
# audio/t140c
# audio/t38
# audio/telephone-event
# audio/tone
# audio/uemclip
# audio/ulpfec
# audio/vdvi
# audio/vmr-wb
# audio/vnd.3gpp.iufp
# audio/vnd.4sb
# audio/vnd.audiokoz
# audio/vnd.celp
# audio/vnd.cisco.nse
# audio/vnd.cmles.radio-events
# audio/vnd.cns.anp1
# audio/vnd.cns.inf1
audio/vnd.dece.audio				uva uvva
audio/vnd.digital-winds				eol
# audio/vnd.dlna.adts
# audio/vnd.dolby.heaac.1
# audio/vnd.dolby.heaac.2
# audio/vnd.dolby.mlp
# audio/vnd.dolby.mps
# audio/vnd.dolby.pl2
# audio/vnd.dolby.pl2x
# audio/vnd.dolby.pl2z
# audio/vnd.dolby.pulse.1
audio/vnd.dra					dra
audio/vnd.dts					dts
audio/vnd.dts.hd				dtshd
# audio/vnd.dvb.file
# audio/vnd.everad.plj
# audio/vnd.hns.audio
audio/vnd.lucent.voice				lvp
audio/vnd.ms-playready.media.pya		pya
# audio/vnd.nokia.mobile-xmf
# audio/vnd.nortel.vbk
audio/vnd.nuera.ecelp4800			ecelp4800
audio/vnd.nuera.ecelp7470			ecelp7470
audio/vnd.nuera.ecelp9600			ecelp9600
# audio/vnd.octel.sbc
# audio/vnd.qcelp
# audio/vnd.rhetorex.32kadpcm
audio/vnd.rip					rip
# audio/vnd.sealedmedia.softseal.mpeg
# audio/vnd.vmx.cvsd
# audio/vorbis
# audio/vorbis-config
audio/webm					weba
audio/x-aac					aac
audio/x-aiff					aif aiff aifc
audio/x-caf					caf
audio/x-flac					flac
audio/x-matroska				mka
audio/x-mpegurl					m3u
audio/x-ms-wax					wax
audio/x-ms-wma					wma
audio/x-pn-realaudio				ram ra
audio/x-pn-realaudio-plugin			rmp
# audio/x-tta
audio/x-wav					wav
audio/xm					xm
chemical/x-cdx					cdx
chemical/x-cif					cif
chemical/x-cmdf					cmdf
chemical/x-cml					cml
chemical/x-csml					csml
# chemical/x-pdb
chemical/x-xyz					xyz
font/collection					ttc
font/otf					otf
# font/sfnt
font/ttf					ttf
font/woff					woff
font/woff2					woff2
image/bmp					bmp
image/cgm					cgm
# image/dicom-rle
# image/emf
# image/example
# image/fits
image/g3fax					g3
image/gif					gif
image/ief					ief
# image/jls
# image/jp2
image/jpeg					jpeg jpg jpe
# image/jpm
# image/jpx
image/ktx					ktx
# image/naplps
image/png					png
image/prs.btif					btif
# image/prs.pti
# image/pwg-raster
image/sgi					sgi
image/svg+xml					svg svgz
# image/t38
image/tiff					tiff tif
# image/tiff-fx
image/vnd.adobe.photoshop			psd
# image/vnd.airzip.accelerator.azv
# image/vnd.cns.inf2
image/vnd.dece.graphic				uvi uvvi uvg uvvg
image/vnd.djvu					djvu djv
image/vnd.dvb.subtitle				sub
image/vnd.dwg					dwg
image/vnd.dxf					dxf
image/vnd.fastbidsheet				fbs
image/vnd.fpx					fpx
image/vnd.fst					fst
image/vnd.fujixerox.edmics-mmr			mmr
image/vnd.fujixerox.edmics-rlc			rlc
# image/vnd.globalgraphics.pgb
# image/vnd.microsoft.icon
# image/vnd.mix
# image/vnd.mozilla.apng
image/vnd.ms-modi				mdi
image/vnd.ms-photo				wdp
image/vnd.net-fpx				npx
# image/vnd.radiance
# image/vnd.sealed.png
# image/vnd.sealedmedia.softseal.gif
# image/vnd.sealedmedia.softseal.jpg
# image/vnd.svf
# image/vnd.tencent.tap
# image/vnd.valve.source.texture
image/vnd.wap.wbmp				wbmp
image/vnd.xiff					xif
# image/vnd.zbrush.pcx
image/webp					webp
# image/wmf
image/x-3ds					3ds
image/x-cmu-raster				ras
image/x-cmx					cmx
image/x-freehand				fh fhc fh4 fh5 fh7
image/x-icon					ico
image/x-mrsid-image				sid
image/x-pcx					pcx
image/x-pict					pic pct
image/x-portable-anymap				pnm
image/x-portable-bitmap				pbm
image/x-portable-graymap			pgm
image/x-portable-pixmap				ppm
image/x-rgb					rgb
image/x-tga					tga
image/x-xbitmap					xbm
image/x-xpixmap					xpm
image/x-xwindowdump				xwd
# message/cpim
# message/delivery-status
# message/disposition-notification
# message/example
# message/external-body
# message/feedback-report
# message/global
# message/global-delivery-status
# message/global-disposition-notification
# message/global-headers
# message/http
# message/imdn+xml
# message/news
# message/partial
message/rfc822					eml mime
# message/s-http
# message/sip
# message/sipfrag
# message/tracking-status
# message/vnd.si.simp
# message/vnd.wfa.wsc
# model/example
# model/gltf+json
model/iges					igs iges
model/mesh					msh mesh silo
model/vnd.collada+xml				dae
model/vnd.dwf					dwf
# model/vnd.flatland.3dml
model/vnd.gdl					gdl
# model/vnd.gs-gdl
# model/vnd.gs.gdl
model/vnd.gtw					gtw
# model/vnd.moml+xml
model/vnd.mts					mts
# model/vnd.opengex
# model/vnd.parasolid.transmit.binary
# model/vnd.parasolid.transmit.text
# model/vnd.rosette.annotated-data-model
# model/vnd.valve.source.compiled-map
model/vnd.vtu					vtu
model/vrml					wrl vrml
model/x3d+binary				x3db x3dbz
# model/x3d+fastinfoset
model/x3d+vrml					x3dv x3dvz
model/x3d+xml					x3d x3dz
# model/x3d-vrml
# multipart/alternative
# multipart/appledouble
# multipart/byteranges
# multipart/digest
# multipart/encrypted
# multipart/example
# multipart/form-data
# multipart/header-set
# multipart/mixed
# multipart/parallel
# multipart/related
# multipart/report
# multipart/signed
# multipart/voice-message
# multipart/x-mixed-replace
# text/1d-interleaved-parityfec
text/cache-manifest				appcache
text/calendar					ics ifb
text/css					css
text/csv					csv
# text/csv-schema
# text/directory
# text/dns
# text/ecmascript
# text/encaprtp
# text/enriched
# text/example
# text/fwdred
# text/grammar-ref-list
text/html					html htm
# text/javascript
# text/jcr-cnd
# text/markdown
# text/mizar
text/n3						n3
# text/parameters
# text/parityfec
text/plain					txt text conf def list log in
# text/provenance-notation
# text/prs.fallenstein.rst
text/prs.lines.tag				dsc
# text/prs.prop.logic
# text/raptorfec
# text/red
# text/rfc822-headers
text/richtext					rtx
# text/rtf
# text/rtp-enc-aescm128
# text/rtploopback
# text/rtx
text/sgml					sgml sgm
# text/t140
text/tab-separated-values			tsv
text/troff					t tr roff man me ms
text/turtle					ttl
# text/ulpfec
text/uri-list					uri uris urls
text/vcard					vcard
# text/vnd.a
# text/vnd.abc
text/vnd.curl					curl
text/vnd.curl.dcurl				dcurl
text/vnd.curl.mcurl				mcurl
text/vnd.curl.scurl				scurl
# text/vnd.debian.copyright
# text/vnd.dmclientscript
text/vnd.dvb.subtitle				sub
# text/vnd.esmertec.theme-descriptor
text/vnd.fly					fly
text/vnd.fmi.flexstor				flx
text/vnd.graphviz				gv
text/vnd.in3d.3dml				3dml
text/vnd.in3d.spot				spot
# text/vnd.iptc.newsml
# text/vnd.iptc.nitf
# text/vnd.latex-z
# text/vnd.motorola.reflex
# text/vnd.ms-mediapackage
# text/vnd.net2phone.commcenter.command
# text/vnd.radisys.msml-basic-layout
# text/vnd.si.uricatalogue
text/vnd.sun.j2me.app-descriptor		jad
# text/vnd.trolltech.linguist
# text/vnd.wap.si
# text/vnd.wap.sl
text/vnd.wap.wml				wml
text/vnd.wap.wmlscript				wmls
text/x-asm					s asm
text/x-c					c cc cxx cpp h hh dic
text/x-fortran					f for f77 f90
text/x-java-source				java
text/x-nfo					nfo
text/x-opml					opml
text/x-pascal					p pas
text/x-setext					etx
text/x-sfv					sfv
text/x-uuencode					uu
text/x-vcalendar				vcs
text/x-vcard					vcf
# text/xml
# text/xml-external-parsed-entity
# video/1d-interleaved-parityfec
video/3gpp					3gp
# video/3gpp-tt
video/3gpp2					3g2
# video/bmpeg
# video/bt656
# video/celb
# video/dv
# video/encaprtp
# video/example
video/h261					h261
video/h263					h263
# video/h263-1998
# video/h263-2000
video/h264					h264
# video/h264-rcdo
# video/h264-svc
# video/h265
# video/iso.segment
video/jpeg					jpgv
# video/jpeg2000
video/jpm					jpm jpgm
video/mj2					mj2 mjp2
# video/mp1s
# video/mp2p
# video/mp2t
video/mp4					mp4 mp4v mpg4
# video/mp4v-es
video/mpeg					mpeg mpg mpe m1v m2v
# video/mpeg4-generic
# video/mpv
# video/nv
video/ogg					ogv
# video/parityfec
# video/pointer
video/quicktime					qt mov
# video/raptorfec
# video/raw
# video/rtp-enc-aescm128
# video/rtploopback
# video/rtx
# video/smpte292m
# video/ulpfec
# video/vc1
# video/vnd.cctv
video/vnd.dece.hd				uvh uvvh
video/vnd.dece.mobile				uvm uvvm
# video/vnd.dece.mp4
video/vnd.dece.pd				uvp uvvp
video/vnd.dece.sd				uvs uvvs
video/vnd.dece.video				uvv uvvv
# video/vnd.directv.mpeg
# video/vnd.directv.mpeg-tts
# video/vnd.dlna.mpeg-tts
video/vnd.dvb.file				dvb
video/vnd.fvt					fvt
# video/vnd.hns.video
# video/vnd.iptvforum.1dparityfec-1010
# video/vnd.iptvforum.1dparityfec-2005
# video/vnd.iptvforum.2dparityfec-1010
# video/vnd.iptvforum.2dparityfec-2005
# video/vnd.iptvforum.ttsavc
# video/vnd.iptvforum.ttsmpeg2
# video/vnd.motorola.video
# video/vnd.motorola.videop
video/vnd.mpegurl				mxu m4u
video/vnd.ms-playready.media.pyv		pyv
# video/vnd.nokia.interleaved-multimedia
# video/vnd.nokia.videovoip
# video/vnd.objectvideo
# video/vnd.radgamettools.bink
# video/vnd.radgamettools.smacker
# video/vnd.sealed.mpeg1
# video/vnd.sealed.mpeg4
# video/vnd.sealed.swf
# video/vnd.sealedmedia.softseal.mov
video/vnd.uvvu.mp4				uvu uvvu
video/vnd.vivo					viv
# video/vp8
video/webm					webm
video/x-f4v					f4v
video/x-fli					fli
video/x-flv					flv
video/x-m4v					m4v
video/x-matroska				mkv mk3d mks
video/x-mng					mng
video/x-ms-asf					asf asx
video/x-ms-vob					vob
video/x-ms-wm					wm
video/x-ms-wmv					wmv
video/x-ms-wmx					wmx
video/x-ms-wvx					wvx
video/x-msvideo					avi
video/x-sgi-movie				movie
video/x-smv					smv
x-conference/x-cooltalk				ice
]]></Data>
</XData>
</Class>


<Class name="App.msg">
<Abstract>1</Abstract>
<IncludeCode>App.LogMacro</IncludeCode>
<TimeChanged>65317,30981</TimeChanged>
<TimeCreated>64734,80043.870644</TimeCreated>

<Method name="AddLangMsg">
<Description>
Add two languages to global translation
Samples ##Expression(##class(App.sys).AddLangMsg(%en,%ru))</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>en,other</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	s otherLang="ru"
	;s @$$$GNLang@($$$GNLangDOMAIN) = otherLang
	s @$$$GNLang@($$$GNLangDOMAIN,"en",$zcrc(en,7)) = en
	s:other'="" @$$$GNLang@($$$GNLangDOMAIN,otherLang,$zcrc(en,7)) = other
	q "$s("_$zcrc(en,7)_":$g("_$$$GNLang_"("""_$$$GNLangDOMAIN_""",$get("_$$$GNEnsConf_"(""Language""),$mvv(58)),"_$zcrc(en,7)_"),"""_en_"""),1:"""_other_""")"
]]></Implementation>
</Method>
</Class>


<Class name="App.net">
<Description>
Network Utility %Net.HttpRequest, %Net.SMTP, %Net.FTP</Description>
<Abstract>1</Abstract>
<IncludeCode>App.LogMacro</IncludeCode>
<TimeChanged>65359,47745.267658</TimeChanged>
<TimeCreated>64758,54536.238116</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Method name="SendFilesToEmail">
<Description>
Zip files and Send to email
w ##class(App.net).SendFilesToEmail()</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>subj,text,files,zip=1,email=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	;send files to email
	s f="" for { s f=$o(files(f)) q:f=""
		s path=$p(f,$$$slash,1,*-1)
		s file=$p(f,$$$slash,*)
		if zip {
			s sc=##class(App.files).zipFile(path,file,file_".zip",path)
			if sc {s file=file_".zip" 
			}
			i 'sc s $$$AppL("APP","SendFilesToEmail")=$System.Status.GetErrorText(sc) 
		}
		s filez($i(fil),"path")=path_$$$slash
		s filez(fil)=file
	}	
	s sc=##class(App.LogInfo).SendEmail(email, subj, text, .filez)
	i 'sc s $$$AppL("APP","SendFilesToEmail2")=$System.Status.GetErrorText(sc) 
	
	q $$$OK
]]></Implementation>
</Method>

<Method name="SendMail">
<Description>
To send email
subscrible - a comma separated list whom to send the letter
subj - subject
text - the text of the letter
attach - an array of files the link</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>server,port,ssl,UseSTARTTLS,timezone,username,psw,from,subscrible,subj,text,attach</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 #dim smtp As %Net.SMTP
 #; Define SMTP server for sending
 set smtp=##class(%Net.SMTP).%New()
 set smtp.smtpserver=server
 set:port smtp.port=port
 set:ssl||(port=465) smtp.SSLConfiguration=..CheckSSLCertificate("SSL4SMTP")
 set:UseSTARTTLS smtp.UseSTARTTLS=1
 set smtp.timezone=timezone
 if username'="" {
	set auth=##class(%Net.Authenticator).%New()
	set auth.UserName=username
	set auth.Password=psw
	set smtp.authenticator=auth
 }
 set smtp.timezone=$g(timezone,"0300")  ;Timezone by Grinwitch  +3 russia
 set mail=##class(%Net.MailMessage).%New() 
 set mail.From=$G(from)        ##; From 
 ##; List of emails to send this mail
 for i=1:1 {
	 q:$p(subscrible,",",i,i+1)=""  
	 set to=$p(subscrible,",",i) 
	 if to'="" do mail.To.Insert(to)
 }
 set mail.Subject=$s($g(subj)="":$g(Subj),1:$g(subj))     ; Subject - the subject
 set mail.Charset="windows-1251"
 set mail.IsHTML=$s(text["<html":1,1:0)
 set mail.IsMultiPart=1
 set mail.MultiPartType="related" 
 do mail.TextData.Write(text)
 set sc=$$$OK
 ; If a single file is transmitted in text format $lb
 if $g(attach)'="" {
	 set attach(1)=$lg(attach,2)
	 set attach(1,"path")=$lg(attach,1)
	 set:$lg(attach,3)'="" attach(1,"content-type")=$lg(attach,3) ;image/jpeg
 }
 ; A lot of files
 if $d(attach)>1 {
	set rec="" 
	for { s rec=$o(attach(rec),1,file) quit:rec=""
	 set sc=mail.AttachFile($g(attach(rec,"path")),file) ;  C:\!\","utl.zip")
	 if $$$ISERR(sc) q
	 set part=mail.Parts.GetAt(rec)
	 do part.Headers.SetAt(file,"Content-ID")
	 do part.Headers.SetAt($g(attach(rec,"content-type")),"Content-Type")
	}
 }
 if $$$ISERR(sc) quit sc ;##class(%Library.Status).LogicalToOdbc(sc)
 set sc=smtp.Send(mail) 
 if $$$ISERR(sc) quit sc ;##class(%Library.Status).LogicalToOdbc(sc)
 quit $$$OK
]]></Implementation>
</Method>

<Method name="LoadFileHttp">
<Description>
Download the file and put on the server by adding the name of the mark date and time</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>aURL="",aDATA,TempDir="",fileName</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	s st=##class(App.net).GetHttp(aURL,.aDATA)
	i 'st q st
	i $g(aDATA("status"))'=200 q $$$ERROR($$$GeneralError,"Status HTTP "_$g(aDATA("status")))
	s sc=1
	i TempDir'="" s sc=##class(App.files).Stream2Log(aDATA("content"), TempDir, fileName,.path) s aDATA("pathfileName")=$g(path)
	q sc
]]></Implementation>
</Method>

<Method name="GetHttp">
<Description>
To receive from the data server at the URL
If TempDir is specified, then the file will be written there 
w ##class(App.net).GetHttp("https://codeload.github.com/SergeyMi37/cache-iris-app-tools/zip/master",.out2,"D:\temp\")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>aURL="",aDATA,TempDir="",tmpGN=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set part1=$p(aURL,"/",3),part2=$p(aURL,"/",4,$l(aURL,"/")),params=$p(aURL,"?",2)
	#; Server
	set server=$p(part1,":",1) quit:(server="") $$$ERROR($$$GeneralError,"0:"_$$$aText("no server",""))
	#; Port
	set port=$p(part1,":",2)
	#; Address
	set location=$p(part2,"?",1) quit:(location="") $$$ERROR($$$GeneralError,"0:"_$$$aText("missing address","")_" - "_location)
	#; Create HTTP request to download the file
	set HttpRequest=##class(%Net.HttpRequest).%New()
	set HttpRequest.Server=server
	if $f($zcvt(aURL,"L"),"https://") {
		set:(port="") port=443
		set HttpRequest.Https=1
		;set HttpRequest.FollowRedirect = 1
		set HttpRequest.SSLConfiguration=..CheckSSLCertificate("DefaultSSL")
	
	#; Request HTTP
	} else {
		s:(port="") port=80
	}
	;w !,server,!,location,!,port,!,params
	set HttpRequest.Port=port
	
	#; Fill in the parameters
	for i=1:1:$l(params,"&") { s pair=$p(params,"&",i),name=$p(pair,"=",1),value=$p(pair,"=",2)
		continue:(name="")	
		;Conversion, to prevent double conversion
		s value=$zcvt(value,"I","URL") 
		d HttpRequest.SetParam(name,value)
	} ; /for i
	
	#; Execute the query
	Try { d HttpRequest.Get(location) } Catch Error { s err=Error.AsSystemError() }
	quit:($g(err)'="") $$$ERROR($$$GeneralError,err)
	#; The processed response is received
	set HttpResponse=HttpRequest.HttpResponse 
	quit:('$isobject(HttpResponse)) $$$ERROR($$$GeneralError,$$$aText("the server does not return a response",""))
	quit:(HttpResponse.StatusCode'=200) $$$ERROR($$$GeneralError,HttpResponse.ReasonPhrase)
	s aDATA("status")=HttpResponse.StatusCode
	#; Parse the response from the server, keeping the structure of the aDATA
	set aDATA("contentType")=HttpResponse.ContentType
	#; The name of the file received via the "content-disposition" as "attachment;filename="name.ext";"
	s fileName=HttpResponse.GetHeader("content-disposition")
	s aDATA("content-disposition")=fileName
	if ($l(fileName,"*=utf-8''")>1) {
		s fileName=$p(fileName,"*=utf-8''",2)
		s fileName=##CLASS(%CSP.Page).UnescapeURL(fileName)
		s fileName=$zcvt(fileName,"I","UTF8")
	} else { s fileName=$p(fileName,"filename=",2),fileName=$tr($p(fileName,";",1),"""'","") }
	
	#; If the file name is not specified, use as the name of the piece of the link
	s:(fileName="") fileName=$p(location,"/",$l(location,"/"))
	s aDATA("content")=HttpResponse.Data
	s aDATA("fileName")=$zcvt(fileName,"I","URL")
	i tmpGN'="" M @tmpGN=aDATA
	s sc=1
	i TempDir'="" s sc=##class(App.files).Stream2Log(HttpResponse.Data, TempDir, fileName,.path) s aDATA("pathfileName")=$g(path)
	quit sc
]]></Implementation>
</Method>

<Method name="CheckSSLCertificate">
<Description>
The method checks for the existence of the configured SSL configuration
and creates an empty configuration with that name if this yet
to connect to a https server, that's enough</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>name</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  NEW $NAMESPACE
  SET $NAMESPACE = "%SYS"
  
  IF '##class(Security.SSLConfigs).Exists(name) {
    DO ##class(Security.SSLConfigs).Create(name)
  }
  QUIT name
]]></Implementation>
</Method>

<Method name="GetListIP">
<Description>
To obtain the server's IP address
w ##class(App.net).GetIP()
$G(%request.CgiEnvs("REMOTE_ADDR")) - agrees client</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 set lsIface=##class(%SYSTEM.INetInfo).GetListOfConfiguredInterfaces()
 for iface=1:1:$ll(lsIface) { 
   s IPv4=$lg($lg(lsIface,iface),2)
   if $l(IPv4,":")>2 {set IPv4=$lg($lg(lsIface,iface),3) if $l(IPv4,":")>2 {set IPv4=""}}
   write IPv4,!
 }
]]></Implementation>
</Method>

<Method name="GetIP">
<Description>
Get IP address
w ##class(App.net).GetIP("google.com")
w $P($ZU(54,13,$zu(54,0)),",",1)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>host=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if host="" set host=$zu(54,0) ;current host
	q $P($ZU(54,13,host),",",1)
]]></Implementation>
</Method>

<Method name="PostHttp">
<Description>
To response to Http Post request</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[ServerPort,method,user,pass,&body,&out]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
    set ht = ##class(%Net.HttpRequest).%New()
	set ht.Server = $p(ServerPort,":")
	if user'="" {
		set ht.Username=user
		set ht.Password=pass
	}
	s ht.ContentType="text/html;  charset=UTF-8"
	;s ht.ContentType="application/json; charset=UTF-8"
	i $p(ServerPort,":",2)'="" set ht.Port = $p(ServerPort,":",2)
	
	;set ht.Https=1
	;set ht.Port = 443
	;set ht.SSLConfiguration=..CheckSSLCertificate("DefaultSSL")
	
	Do ht.EntityBody.Write($g(body))
	if $d(body)>1 s i="" f  s i=$o(body(i)) q:i=""  Do ht.EntityBody.Write(body(i))
	
	Do ht.Post(method)
	;Do ht.HttpResponse.OutputToDevice()
	S out=ht.HttpResponse.StatusLine
	;s ^z1=ht.HttpResponse.ContentLength
    set i="" for  S i=ht.HttpResponse.GetNextHeader(i) Q:i=""  S out("Header",i)=ht.HttpResponse.GetHeader(i)
    if ht.HttpResponse.Data.Size>0 {
	    set sc=##class(App.files).Stream2String(ht.HttpResponse.Data,.json)
	    m out("Data")=json
	}
 	do ht.%Close()
 	q $g(out)
]]></Implementation>
</Method>

<Method name="RunPage">
<Description>
d ##class(App.net).RunPage()</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Url:%String="http://intersystems.ru"</FormalSpec>
<Implementation><![CDATA[
    #Include %occOptions
    Set Browser = $s($$$isWINDOWS:"start", $$$isUNIX:"x-www-browser", 1:"x-www-browser")
    Set Command = Browser _ " " _ Url
    Do $ZF(-1, Command)
]]></Implementation>
</Method>

<Method name="ImportCSPFromGitHub">
<Description>
Import CSP-file from GitHub repository for 7z utility 
s repo="cache-iris-app-tools" d ##class(App.net).ImportCSPFromGitHub("https://codeload.github.com/SergeyMi37/"_repo_"/zip/master",repo,"d:\!\csptest")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>url,repo,target</FormalSpec>
<Implementation><![CDATA[
	s tempdir=$zu(12)_"Temp"_$$$slash_$p(##class(%File).TempFilename("zip"),$$$slash,*)
	w !,tempdir
	s st=##class(%File).CreateDirectory(tempdir)
	i 'st q st
 	s st=##class(App.net).GetHttp(url,.out,tempdir)
	s unzip=$zu(12)_"Temp"_$$$slash_$p(##class(%File).TempFilename("unzip"),$$$slash,*)
	s st=##class(%File).CreateDirectory(unzip)
	i 'st q st
	d ##class(App.files).UnzipToDirectory(tempdir_$$$slash_repo_"-master.zip",unzip)
	s source=unzip_$$$slash_repo_"-master"_$$$slash_"src"_$$$slash_"csp"
	w !,source_" copy to "_target,!
	s st=##class(%File).CopyDir(source,target,1,1,1)
	i 'st w !,st
	s source=unzip_$$$slash_repo_"-master"_$$$slash_"src"_$$$slash_"glb"_$$$slash_"appcachemsg.xml"
	do $system.OBJ.Load(source,"ck")
	d ##class(%File).RemoveDirectoryTree(tempdir)
	d ##class(%File).RemoveDirectoryTree(unzip)
	q $$$OK
]]></Implementation>
</Method>

<Method name="GetMailPOP3">
<Description>
 d ##class(App.net).GetMailPOP3()</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>MDEAM,BSmName,BSmPass,MASS,dir</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 ;MDEAM - MAIL SERVER NAME OR ITS IP
 ;,BSmName - USER NAME = "NAME_user@"_MDEAM
 ;,BSmPass - USER PASSWORD
 ;,MASS - THE ARRAY FROM WHICH TO CREATE THE PROGRAM, WHICH WILL BE BASED ON A LIST OF EMAILS
 ;dir - the PATH TO the DIRECTORY WHERE you DOWNLOADED the attached FILES
 ;new mailserver,status,from,to,date,subject,messagesize,m,hdrs,key,mailMsg,lined
 ;N mssg
 set mailserver=##class(%Net.POP3).%New()
 I $D(dir) set mailserver.AttachDir=dir
 set mailserver.Debug=0
 set mailserver.port=25
 set mailserver.StoreAttachToFile=1
 set status=mailserver.Connect(MDEAM,BSmName,BSmPass)
 if ('status) w !,$System.Status.GetErrorText(status) g clo
 f mssg=1:1 d  if ('status) Q
 .set status=mailserver.FetchMessage(mssg,.from,.to,.date,.subject,.messagesize,.hdrs,.mailMsg,0)
 .if ('status) Q
 .S MASS(mssg,"subject")=subject
 .S MASS(mssg,"date")=date
 .S MASS(mssg,"from")=from
 .S MASS(mssg,"messagesize")=messagesize
 .S MASS(mssg,"to")=to
 .K MAS
 .d Dump(mailMsg,.MAS)
 .M MASS(mssg,"z")=MAS
 .s status=mailMsg.%Close()
clo s status=mailserver.%Close()
	i 'status w !,$System.Status.GetErrorText(status)
 q $G(mssg)-1
 
Dump(msg,MASS) 
 ;new i,index,value
 if msg.IsMultiPart do  quit
 . for i=1:1:msg.Parts.Count() do Dump(msg.Parts.GetAt(i),.MASS)
 s index=""  f  s value=msg.Headers.GetNext(.index) q:index=""  S MASS(msg,"head",index)=value
 if msg.IsBinary do
 . S MASS(msg,"msg")="binary"
 . S MASS(msg,"msgFN")=msg.FileName
 . S MASS(msg,"msgGA")=msg.GetAttribute("content-disposition","filename")
 else  do
 . ;w !,"Dumping text msg Filename="_msg.FileName_" filename="_msg.GetAttribute("content-disposition","filename"),!
 . S MASS(msg,"msg")="text"
 . S MASS(msg,"msgFN")=msg.FileName
 . S MASS(msg,"msgGA")=msg.GetAttribute("content-disposition","filename")
 . set stream=msg.TextData
 . do stream.Rewind()
 . k len,line
 . for l=1:1 set len=32763,line=stream.Read(.len) do  quit:stream.AtEnd
 ..S MASS(msg,"msg",l)=line         ;write line
 quit
]]></Implementation>
</Method>

<Method name="KILLMAIL">
<ClassMethod>1</ClassMethod>
<FormalSpec>MDEAM,BSmName,BSmPass,MSGK,Kill</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 S OK=1,Kill=0
 set mailserver=##class(%Net.POP3).%New()
 set mailserver.port=$G(^%BScSMTP(MDEAM,"POP"),"110")
 set mailserver.Debug=0
 set mailserver.StoreAttachToFile=1
 set status=mailserver.Connect(MDEAM,BSmName,BSmPass)
 if ('status) S OK=status g Kclo
 S I="" F  S I=$O(MSGK(I)) Q:I=""  set OK=mailserver.DeleteMessage(I) S:OK Kill=Kill+1 I 'OK Q
 s status=mailserver.QuitAndCommit()
Kclo s status=mailserver.%Close()
 q $G(OK)
]]></Implementation>
</Method>
</Class>


<Class name="App.rest">
<Description>
// The REST interface: class that routes HTTP requests</Description>
<IncludeCode>App.LogMacro</IncludeCode>
<Super>%CSP.REST</Super>
<TimeChanged>65399,35089.324373</TimeChanged>
<TimeCreated>65090,49155.438126</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Parameter name="CONTENTTYPE">
<Default>application/json</Default>
</Parameter>

<Parameter name="CHARSET">
<Default>UTF-8</Default>
</Parameter>

<XData name="UrlMap">
<XMLNamespace>http://www.intersystems.com/urlmap</XMLNamespace>
<Data><![CDATA[
<Routes>
<Route Url="/get-html/:text" Method="GET" Call="Index"/>
<Route Url="/post-json" Method="POST" Call="jsonrpc"/>
<Route Url="/get-files/:text" Method="GET" Call="Files"/>

<Route Url="/testpost" Method="POST" Call="Test"/>
<Route Url="/testget/:text" Method="GET" Call="Test"/>  
<Route Url="/finduser/:text" Method="GET" Call="FindUser"/>

<Route Url="/auth" Method="GET" Call="Auth"/>
<Route Url="/css/index.css" Method="GET" Call="GetCss"/>
<Route Url="/css/themes/:theme" Method="GET" Call="GetTheme"/>
<Route Url="/js/index.js" Method="GET" Call="GetJs"/>
</Routes>
]]></Data>
</XData>

<UDLText name="T">
<Content><![CDATA[
/*
/// sample servise JSON-RPC 2.0 https://www.jsonrpc.org/specification

{"jsonrpc": "2.0", "result": {"likes": 123}, "id": 1}
If error:
{"jsonrpc": "2.0", "error": {"code": 666, "message": "Post not found"}, "id": "1"}
Request:
[
  {"jsonrpc":"2.0","method":"server.shutdown","params":{"server":"42"},"id":1},
  {"jsonrpc":"2.0","method":"server.remove","params":{"server":"24"},"id":2}
]
Response:
[
  {"jsonrpc":"2.0","result":{"status":"down"},"id":1}
  {"jsonrpc":"2.0","error":{"code":1234,"message":"Server not found"},"id": 2}
]
*/
]]></Content>
</UDLText>

<Method name="jsonrpc">
<Description>
post http://server:57772/rest/jsonrpc
{"jsonrpc":"2.0","method":"GetInfo","params":{"code":"5007092465"},"id":123}</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>ns="",class="",meth=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set sc = $$$OK
	try {
	 	;merge $$$AppL("MML","%request.Data")=%request.Data
		;set $$$AppL("MML","%request.AppData")=%request.AppData
		;set $$$AppL("MML","req")=$$$AppObJs(%request)
		;if %request.Get("Username")'="",'..Authorize(%request.Get("Username"),%request.Get("Password")) {
		; 	;set %response.Status = "401 Unauthorized" quit
		; 	d ..jsonrpcError(401,"Unauthorized "_%request.Content) 
		;}
		if $isobject(%request.Content) { //POST
			d %request.Content.Rewind() 
			set json=%request.Content.Read($$$MaxStringLength) 
			set json = $ZCVT(json,"I","UTF8") 
			s $$$AppL("MML","jsonrpc-json")=json
	 		if ($g(json)["{") {
	 			set method={}.$$$jsonFromJSON(json).method
	 			set params={}.$$$jsonFromJSON(json).params
	 			set jsonrpc={}.$$$jsonFromJSON(json).jsonrpc
	 			set id={}.$$$jsonFromJSON(json).id
	 			if jsonrpc'="2.0" w ..jsonrpcError(2,"Version not supported "_jsonrpc) q
	 			s appPar=""
	 			if method[":" { if $p(method,":",1)'="" s ns=$p(method,":",1)
					if $p(method,":",2)'="" s class=$p(method,":",2)
					if $p(method,":",3)'="" s meth=$p(method,":",3)
					if $p(method,":",4)'="" s appPar=$p(method,":",4,*)
				}
				if ns'="" zn ns
				if $e(class,1)="^" {
					do @(meth_class_"(.par,.json)") ;??? xec public 
				} else {
					if appPar["~" {
						do ##class(App.type).ParseURL(appPar,.appPar,"~")  ;parse in array
					}
					elseif appPar["&" {
						d ##class(App.type).ParseURL(appPar,.appPar,"&")
					}
				   ;set %response.CharSet = "utf-8"
    			;	set %response.ContentType = "text/html"
    				;s appPar("params")=params
    				if $isobject(params) d ##class(App.Action).GetElemParseForm(params.form,.appPar,"z",0)
      				do $classmethod(class,meth,.appPar) 
					quit
				}
				;w "{""text"":""Hello world"",""inn"":"""_params.inn_"""}" q
				;w $ZCVT(str,"O","UTF8") 
				;w resjson
	 			
	 		}
		} else {
			;s $$$AppL("MML","%request")=$$$AppObJs(%request)
			;m $$$AppL("MML","%request.Data")=%request.Data
			;m $$$AppL("MML","%request.Content")=%request.Content
			;set $$$AppL("MML","%request.AppData")=%request.AppData
			 d ..jsonrpcError(3,"Bad request "_%request.Content)
			 q
		}
	} catch ex {
		set sc = ex.AsStatus()
		;s $$$AppL("MML","jsonrpc-err")=$System.Status.GetErrorText(sc)
		d ..jsonrpcError(4,"exception: "_$zconvert($System.Status.GetErrorText(sc),"O","HTML"))
	}
	return $$$OK
]]></Implementation>
</Method>

<Method name="Authorize">
<ClassMethod>1</ClassMethod>
<FormalSpec>user,password</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	q $SYSTEM.Security.Login(user, password)
]]></Implementation>
</Method>

<Method name="jsonrpcError">
<ClassMethod>1</ClassMethod>
<FormalSpec>code,message</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	;w "{""jsonrpc"":""2.0"",""error"":{""code"":"""_code_""",""message"":"""_message_"""}}"
	Set json = $$$NewDynObj
 	s json.jsonrpc="2.0"
	s json.code=code
	s json.message=message
	$$$DynObjToJSON(json)
	q $$$OK
]]></Implementation>
</Method>

<Method name="Files">
<Description>
Method writes files.
/apptoolsrest/get-files/fileId</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>fileId</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 s file=##class(App.DownloadCSP).GetfileName(fileId)
 ;get date modification	file
 set dh=$zu(140,2,file)
 if dh<0 set dh=$now(0)
 set date=$zd(dh, 11) _ ", "_ $zdt(dh, 2,1) _ " GMT"
 
 ;do %response.SetHeader("Last-Modified", date)
 if (%request.GetCgiEnv("HTTP_IF_MODIFIED_SINCE")=date) {
	        set %response.Status = "304 Not Modified"
	    } 
 else {
	set %response.CharSet="raw"
	;d %response.SetHeader("Expires", "0")
	;d %response.SetHeader("Accept-Ranges","bytes")

	set ext=$p(file,".",*)
	set mimetype=##class(App.filesMimeTypes).GetMimeTypes4ext(ext)
	set %response.ContentType=mimetype
	
	set stream=##class(%FileBinaryStream).%New()
	set stream.Filename=file
	set size=stream.Size
	do %response.SetHeader("Content-Length",size)

	while 'stream.AtEnd {
		set line=stream.Read()
		write line
	}
 }
  return $$$OK
]]></Implementation>
</Method>

<Method name="Test">
<ClassMethod>1</ClassMethod>
<FormalSpec>parameter</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set %response.CharSet = "utf-8"
    set %response.ContentType = "text/html"
	&html<<h1>Status: OK!</h1><br>>
	zw %request
	&html<<br><br>>
	zw %response
	quit $$$OK
]]></Implementation>
</Method>

<Method name="FindUser">
<Description>
Search users by context
http://localhost:57772/apptoolsrest/finduser/super</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>text=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 i $l(text)<3 d ..jsonrpcError(5,$$$aText("Search string must be at least 3 characters","")) q $$$OK
 zn "%SYS"
 s sql="select Name,FullName,Comment,EmailAddress,Enabled,CreateDateTime,LastModifiedDateTime from Security.Users where UPPER(FullName) [ '"_$zconvert(text,"U")_"'"
	#if $$$comClassDefined("%ZEN.Auxiliary.jsonSQLProvider")
		set Provider = ##class(%ZEN.Auxiliary.jsonSQLProvider).%New()
		set Provider.sql = sql
		Set Provider.%Format = $$$formatJSONSQL
		Set Provider.maxRows = 10000
		set st = Provider.%DrawJSON()
	#else
		set st = $$$ERROR($$$GeneralError,"Class %ZEN.Auxiliary.jsonSQLProvider does not exist")
	#endif
	return st
]]></Implementation>
</Method>

<Method name="WriteStatic">
<Description>
Calls StaticContent.Write method or sends not modified header. Type have to be "css" or "js"</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>type:%String,ContentType:%String="",xDataClass="App.rest",ClassCSPPage="",IsCached=0</FormalSpec>
<Private>1</Private>
<Implementation><![CDATA[
    #define CompileTime ##Expression("""" _ $zd($h, 11) _ ", "_ $zdt($NOW(0), 2,1) _ " GMT""")
    set %response.CharSet = "utf-8"
    set %response.ContentType = $case(type,
        "css": "text/css",
        "js": "text/javascript",
        "html": "text/html",
        : $case(ContentType="", 1:"text/plain", :ContentType)
    )
    do %response.SetHeader("Last-Modified", $$$CompileTime)
    try{
		;if %request.Get("Username")'="",'..Authorize(%request.Get("Username"),%request.Get("Password")) {
		; 	set %response.Status = "401 Unauthorized" quit
		;}
	    if IsCached,(%request.GetCgiEnv("HTTP_IF_MODIFIED_SINCE")=$$$CompileTime) {
	        set %response.Status = "304 Not Modified"
	    } 
	    elseif ClassCSPPage'="" {
		    s param=$p(ClassCSPPage,"?",2,*)
		    s ClassCSPPage=$p(ClassCSPPage,"?")
		    s:ClassCSPPage[".cls" ClassCSPPage=$p(ClassCSPPage,".cls",1)
		    ;set $$$AppL("MMM","WriteStatic")=$lb(type,ClassCSPPage) ;$$$AppObJs(id)
		    ;set $$$AppL("MMM","%request")=$$$AppObJs(%request)
		    do $classmethod(ClassCSPPage,"OnPage",param)
	    }
	    else {
	        do ..WriteStaticContent(xDataClass,type)
	    }
    }
    catch e { 
    	w $ze
    	set %response.Status = "501 Not Implemented" ;"405 Method Not Allowed" ;"400 Bad Request"
    }
]]></Implementation>
</Method>

<Method name="GetCss">
<Description>
Method writes application CSS.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>class</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    do ..WriteStatic("css")
    return $$$OK
]]></Implementation>
</Method>

<Method name="GetTheme">
<Description>
Method writes application theme.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Theme:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    do ..WriteStatic("Theme"_$REPLACE(Theme, ".css", ""),"text/css")
    return $$$OK
]]></Implementation>
</Method>

<Method name="GetJs">
<Description>
Method writes application JavaScript.</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    do ..WriteStatic("js")
    return $$$OK
]]></Implementation>
</Method>

<Method name="Index">
<Description>
Method writes application HTML.</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>class</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    do ..WriteStatic("html","","",class)
    return $$$OK
]]></Implementation>
</Method>

<Method name="WriteStaticContent">
<Description>
Write the contents of xData tag</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Class:%String,Const:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    set obj = ##class(%Dictionary.CompiledXData).%OpenId(Class_"||"_Const)
    return:(obj = "") $$$OK
    set xdata = obj.Data
    set status = ##class(%XML.TextReader).ParseStream(xdata, .textreader)
    while textreader.Read() { if (textreader.NodeType="chars") {
        write textreader.Value
    } }
    return $$$OK
]]></Implementation>
</Method>

<XData name="Themecache">
<Data><![CDATA[
<data>
<![CDATA[<!-- @include client/css/themes/cache.css -->]]]]><![CDATA[>
</data>
]]></Data>
</XData>

<XData name="html">
<Data><![CDATA[
<data>
<![CDATA[
<!-- @include client/index.html -->]]]]><![CDATA[>
</data>
]]></Data>
</XData>

<XData name="css">
<Data><![CDATA[
<data>
<![CDATA[<!-- @include client/css/index.css -->]]]]><![CDATA[>
</data>
]]></Data>
</XData>

<XData name="js">
<Data><![CDATA[
<data>
<![CDATA[<!-- @include client/js/index.js -->]]]]><![CDATA[>
</data>
]]></Data>
</XData>
</Class>


<Class name="App.security">
<Abstract>1</Abstract>
<IncludeCode>App.LogMacro</IncludeCode>
<TimeChanged>65317,30981</TimeChanged>
<TimeCreated>64734,80043.870644</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Method name="LockDown">
<Description>
Increase system security to LockDown, except for InactiveLimit = 90
The method disables services and applications as in LockDown. Deletes the areas "DOCBOOK", "ENSDEMO", "SAMPLES"
The method enables auditing and configures registration of all events in the portal, except for switching the log
and modification of system properties
For all predefined users, change the password and change the properties as in LockDown
	newPassword - new single password instead of SYS. For LockDown security level, it has an 8.32ANP pattern
	sBindings = 1 Service% service_bindings enable
	sCachedirect = 1 Service% service_cachedirect enable
	sECP = 1 Service% service_ecp enable
	sBindingsIP - list of ip addresses with a semicolon for which to allow CacheStudio connection.
For ECP configurations, you need to add the addresses of all servers and clients to allow connection on% Net.RemoteConnection to remove "abandoned" tasks
	sCachedirectIP - list of ip addresses with a semicolon for which to allow CIMModeler connection.
	sECPIP - list of ip addresses with a semicolon for which to allow connection to the ECP server.
	AuthLDAP = 1 In addition to the password, also enable LDAP authentication
	Application example:
	d ##class(App.security).LockDown("qwe123!@#",.msg,1,1,0,"127.0.0.1","127.0.0.1")
	d ##class(App.security).LockDown("qwe123!@#",.msg,1,1,0,"127.0.0.1","127.0.0.1",,1)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>newPassword="",Warn,sBindings="",sCachedirect="",sECP="",sBindingsIP="",sCachedirectIP="",sECPIP="",AuthLDAP=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	if newPassword'?8.32ANP s text="Password does not match the pattern 8.32ANP" write !,text QUIT $$$ERROR(text)
	set ons = $zu(5)
	write !,"Applications and services will be authenticated by "_$s('AuthLDAP:"password",1:"password and LDAP")
	set AutheEnabled=$s(AuthLDAP:2080,1:32)
	zn "%sys"
	write !,"Password is reset to predefined users"
	set result=##CLASS(%ResultSet).%New("%DynamicQuery:SQL")
	set tSC=result.Prepare("select NameLowerCase FROM Security.Users")
	set:tSC tSC=result.Execute()
	if '$$$ISOK(tSC) {
		set text="User configuration error :"_$SYSTEM.Status.GetErrorText(tSC) write !,text
		QUIT $$$ERROR(text)
	}
	else {
		while result.Next() {
			set name=result.Data("NameLowerCase")
			kill prop
			set prop("Password")=newPassword
			if name="_system" s prop("Enabled")=0
			if name="unknownuser" s prop("Roles")="" ; delete all roles
			set tSC=##class(Security.Users).Modify(name,.prop)
			if '$$$ISOK(tSC) w !,name_": Error="_$SYSTEM.Status.GetErrorText(tSC)
		}
	}
	write !,"Modification of service properties:"
	set result=##CLASS(%ResultSet).%New("%DynamicQuery:SQL")
	set tSC=result.Prepare("select NameLowerCase,ClientSystems FROM Security.Services")
	set:tSC tSC=result.Execute()
	if '$$$ISOK(tSC) {
		set text="Service configuration error :"_$SYSTEM.Status.GetErrorText(tSC) write !,text
		QUIT $$$ERROR(text)
	}
	else {
		while result.Next() {
			set name=result.Data("NameLowerCase")
			#;skipping network services
			continue:(name="%service_mirror")||(name="%service_shadow")||(name="%service_datacheck")
			kill prop
			set prop("Enabled")=0
			if name="%service_csp"||(name="%service_console")||(name="%service_login") {
				set prop("Enabled")=1 ; turn on
				if name'="%service_csp" s prop("AutheEnabled")=AutheEnabled
				else  s prop("AutheEnabled")=96
			}
			if $G(sBindings),name="%service_bindings" {
				set prop("Enabled")=1
				set prop("AutheEnabled")=AutheEnabled
				set Warn($i(Warn))="If the current system does not intend to develop or edit the source code in CacheStudio, then it is better to turn off the service "_name
				set prop("ClientSystems")=sBindingsIP
			}
			if $G(sCachedirect),name="%service_cachedirect" {
				set prop("Enabled")=1 ; turn on
				set prop("AutheEnabled")=96
				set Warn($i(Warn))="If the current system does not intend to edit the transformation templates using the CIMModeler utility, then it is better to turn off the service "_name
				set prop("ClientSystems")=sCachedirectIP
			}
			if $G(sECP),name="%service_ecp" {
				set prop("Enabled")=1
				set Warn($i(Warn))="If the ECP configuration is not enabled on the current system, it is better to turn off the service "_name
				set:$g(sECPIP)="" Warn($i(Warn))="If ECP configuration is enabled, it is best to limit the connection of ECP clients to the ECP server"
				set prop("ClientSystems")=sECPIP
			}
			set tSC=##class(Security.Services).Modify(name,.prop)
			if '$$$ISOK(tSC) write !,name_": Error="_$SYSTEM.Status.GetErrorText(tSC)
		}
	}
	write !,"Passwords are created for all CSP applications."
	set result=##CLASS(%ResultSet).%New("%DynamicQuery:SQL")
	set tSC=result.Prepare("select Name FROM Security.Applications")
	set:tSC tSC=result.Execute()
	if '$$$ISOK(tSC) {
		set text="Application setup error :"_$SYSTEM.Status.GetErrorText(tSC)  write !,text QUIT $$$ERROR(text)
	}
	else {
		#; List of disconnected applications
		set appDisabled("/csp/ensdemo")=1
		set appDisabled("/csp/samples")=1
		set appDisabled("/csp/user")=1
		set appDisabled("/isc/studio/usertemplates")=1
		set appDisabled("/csp/docbook")=1  
		set appDisabled("/csp/documatic")=1
		set appDisabled("/isc/studio/rules")=1
		set appDisabled("/isc/studio/templates")=1
		while result.Next() {
			set CSP=result.Data("Name")
			set csp=$zconvert(CSP,"L")
			kill prop
			if $g(appDisabled(csp)) {
				set prop("Enabled")=0
			} else {
				  set prop("Enabled")=1
			}
		 set prop("AutheEnabled")=AutheEnabled 
		 set tSC=##class(Security.Applications).Modify(CSP,.prop)
		 if '$$$ISOK(tSC) write !,csp_" : Error="_$SYSTEM.Status.GetErrorText(tSC)
		}
	}
	write !,"Demo namespaces are being deleted."
	for name="ENSDEMO","SAMPLES" {
		do:##class(%Dictionary.CompiledClass).%ExistsId("%Library.EnsembleMgr")
		set tSC = ##class(Config.Namespaces).Delete(name)
		if $$$ISERR(tSC) set text="Delete Error "_name_" :"_$system.Status.GetErrorText(tSC) w !,text
		if $$$ISOK(tSC) write !,"Deleted "_name
	}
	write !,"There is a modification of the basic system settings"
	#dim ss As Security.System  = ##class(Security.System).%OpenId("SYSTEM")
	set ss.PasswordPattern="8.32ANP"
	set ss.AuditEnabled=1
	set ss.InactiveLimit=0
	set tSC=ss.%Save()
	if '$$$ISOK(tSC) s text="Error setting basic security settings :"_$SYSTEM.Status.GetErrorText(tSC)  write !,text QUIT $$$ERROR(text)
	write !,"Event Setup AUDIT :"
	Set rs = ##class(%ResultSet).%New("Security.Events:ListActivate")
	Set tSC = rs.Execute()
	if $$$ISERR(tSC) set text="Event setting error AUDIT:"_$system.Status.GetErrorText(tSC) write !,text QUIT $$$ERROR(text)
	set On("%Ensemble/%Message/ViewContents")=1
	set On("%System/%DirectMode/DirectMode")=1
	set On("%System/%Login/Login")=1
	set On("%System/%Login/LoginFailure")=1
	set On("%System/%Login/Logout")=1
	set On("%System/%Login/Terminate")=1
	set On("%System/%Security/ApplicationChange")=1
	set On("%System/%Security/AuditChange")=1
	set On("%System/%Security/AuditReport")=1
	set On("%System/%Security/DBEncChange")=1
	set On("%System/%Security/DomainChange")=1
	set On("%System/%Security/LoginRuleChange")=1
	set On("%System/%Security/Protect")=1
	set On("%System/%Security/ResourceChange")=1
	set On("%System/%Security/RoleChange")=1
	set On("%System/%Security/ServiceChange")=1
	set On("%System/%Security/SSLConfigChange")=1
	set On("%System/%Security/SystemChange")=1
	set On("%System/%Security/UserChange")=1
	set On("%System/%System/AuditRecordLost")=1
	set On("%System/%System/ConfigurationChange")=1
	set On("%System/%System/JournalChange")=0
	set On("%System/%System/RoutineChange")=1
	set On("%System/%System/Start")=1
	set On("%System/%System/Stop")=1
	set On("%System/%System/SuspendResume")=1
	set On("%System/%System/UserEventOverflow")=1
	While rs.Next() {
		set name = $G(rs.Data("Source"))_"/"_$G(rs.Data("Type"))_"/"_$G(rs.Data("Name"))
		if $DATA(On(name)) {
			kill pro
			do ##class(Security.Events).Get($g(rs.Data("Source")),$G(rs.Data("Type")),$G(rs.Data("Name")),.pro)
			if $d(pro) {
				if pro("Enabled")'=(+$G(On(name))) {
					if ##Class(Security.Events).Exists(name,,,.Event,.Status) {
						set Event.Enabled=+$G(On(name))
						set tSC=Event.%Save()
						if '$$$ISOK(tSC) w !,name_": Error="_$SYSTEM.Status.GetErrorText(tSC)
						else  write !,name_" changed"
					}
				}
			}
		}
	}
	do rs.Close()
	zn ons
	quit $$$OK
]]></Implementation>
</Method>

<Method name="UiSavePermiss">
<Description>
Save Access Rights
d ##class(App.security).UiSavePermiss(.Par)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Par=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	do ##class(App.Form).BlockUI(0)
	set key=Par("key")
	set divId=Par("divId")
	set mode=Par("mode")
	set i=""
	for { set i=$o(%request.Data(i)) quit:i=""
		if i[(divId_"Matr0"),$o(%request.Data(i,""),-1)'="" {
			set val=$g(%request.Data(i,$o(%request.Data(i,""),-1)))
			if val'["unchecked" {
				set chk(i)=val
				set us=$p(i,"0",2)
				set ro=$p(i,"0",3)
				if $e(ro,1)="p" s ro="%"_$e(ro,2,*)
				set users(us,ro)=val
			}
		}
	}
	new $NAMESPACE
  	set $NAMESPACE = "%SYS"
	set us=""
	for { set us=$o(users(us)) quit:us=""
			set tSC=##class(Security.Users).Get(us,.prop)
			if '$$$ISOK(tSC)  write $$$appError(us_": Error="_$SYSTEM.Status.GetErrorText(tSC)) quit
			set roles=","_prop("Roles")_","
			kill prop
			set ro=""
			for { set ro=$o(users(us,ro)) quit:ro=""
				if $g(users(us,ro)) {
					if roles'[(","_ro_",") set roles=roles_ro_","
				}else {
					if roles[(","_ro_",") set roles=$replace(roles,ro_",","") set:$e(roles,*)'="," roles=roles_","
				}
			}
			set:$e(roles,1)="," roles=$e(roles,2,*)
			set:$e(roles,*)="," roles=$e(roles,1,*-1)
			set prop("Roles")=roles
			;zw prop
			set tSC=##class(Security.Users).Modify(us,.prop)
			if '$$$ISOK(tSC) write $$$appError(us_": Error="_$SYSTEM.Status.GetErrorText(tSC)) quit
			;Check
			set tSC=##class(Security.Users).Get(us,.pro)
			if '$$$ISOK(tSC) write $$$appError(us_": Error="_$SYSTEM.Status.GetErrorText(tSC)) quit
			write $$$appMsg(us_": "_pro("Roles"))
	}
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="UiMatrixPermission">
<Description>
Get HTML content of access matrix form
d ##class(App.security).UiMatrixPermission("sm","sp","Ui","AnyKey","App.security","Ui"_"SavePermiss")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>name="",rolesmask="",divId="",key="",class="",Method="",blockui=1</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
		if name="" write $$$appError($$$aText("Select the filter by user option Login blank (Names separated by commas or by the context","")) q 1
		if rolesmask="" write $$$appError($$$aText("Select the filter control","")) q 1
		set msg=$$$aText("Matrix of access rights","")
		set:blockui onclick=$$$blockui($$$aText("Loading...",""))
		set onclick=$g(onclick)_";ActionJs('"_divId_"FormContentSave','"_divId_"ContentSave','"_class_"','"_Method_"','key="_key_"~divId="_divId_"~mode=Save');"
		set butt=$$$appButton(divId_"appButtonSavePermiss","onclick="""_onclick_"""",$$$aText("Save access rights",""))
		write butt_"<br><br>"
		write "<form id='"_divId_"FormContentSave' >"
		do ##class(App.sys).GetRoles(rolesmask,.roles)
		if '$d(roles) write $$$appError($$$aText("This filter was","")) quit 1
		;set roles("%all")=$lb("%All","The Super-User Role")
		do ##class(App.sys).GetUsers(name,.users)
		if '$d(users) write $$$appError($$$aText("This filter users not found","")) quit 1
		set r="UserName"
  		set gn="matrix"
 	    set @gn@(0,1)=$lb(r)
 		set @gn@(-1,r)=1
  		set col(1)=r
  		set r=""
        for col=2:1 { set r=$o(roles(r)) quit:r=""
        	set NameRole=$lg(roles(r),1)
   		    set @gn@(0,col)=$lb(NameRole)
	  		set @gn@(-1,NameRole)=col
	  		set col(col)=NameRole
        }
        set col=col-1
		set u=""		
		for row=1:1 { set u=$o(users(u)) quit:u=""
			set usroles=$lg(users(u),3)
			;zwrite usroles
			set @gn@(row)=$g(@gn@(row))_$lb(u)
			for c=2:1:col {
				set yes="unchecked"
				if $LISTFIND(usroles,col(c)) set yes="1unchecked"
				set ret=##class(App.Form).WebCompShowCheckbox(,,,divId_"Matr0"_u_"0"_$tr(col(c),"%","p")_"0",yes)
				set @gn@(row)=$g(@gn@(row))_$lb(ret)
			}
		}
		;write "$('#"_pref_"MainContent').height($('#tabs-"_pref_"').height()-$('#"_pref_"MainHeader').height()-150);"
		;write "<div id='TabViewCont' style='overflow: scroll;   max-width: 1200px;  max-height: 500px;'>"
		set st=##class(App.LogInfoPane).DrawSQL("result "_gn,100000,$zu(5),$g(msg),$g(exec),,1)
		;write "</div>"
		;TODO do ##class(App.Form).DrawTable(.matrix) 
		write "</form><div id='"_divId_"ContentSave'></div>"
		quit $$$OK
]]></Implementation>
</Method>
</Class>


<Class name="App.sql">
<Description>
Query and SQL statements</Description>
<Abstract>1</Abstract>
<IncludeCode>App.LogMacro</IncludeCode>
<TimeChanged>65387,52206.646787</TimeChanged>
<TimeCreated>64127,58953.319558</TimeCreated>

<Method name="getSQL">
<Description>
s sql=##class(App.sql).getSQL("App.sql:TestXData",0,.desc) w !,sql,!!,desc
s sql=##class(App.sql).getSQL("TestQuery",0,.desc) w !,sql,!!,desc</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[name:%String,removeNL=$$$NO,&Description]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#dim sc As %Status = $$$OK
	
	set class = $case($l(name, ":"), 2:$p(name, ":"), :$classname())
	set queryName = $p(name, ":", *)
	set Description=""
		
	if ##class(%Dictionary.QueryDefinition).IDKEYExists(class, queryName) {
		set query = ##class(%Dictionary.QueryDefinition).IDKEYOpen(class, queryName,,.sc)
		throw:$$$ISERR(sc) ##class(%Exception.StatusException).CreateFromStatus(sc)
		set sql = query.SqlQuery
		set Description=query.Description
	} elseif ##class(%Dictionary.XDataDefinition).IDKEYExists(class, queryName) {
		set stream = ##class(%Stream.TmpCharacter).%New()
		for i=1:1:$$$comMemberKeyGet(class,$$$cCLASSxdata,queryName,$$$cXDATAdata) {
			do stream.WriteLine($$$comMemberArrayGet(class,$$$cCLASSxdata,queryName,$$$cXDATAdata,i))
		}
		set sql = stream.Read($$$MaxLocalLength)
		set Description=$$$comMemberKeyGet(class,$$$cCLASSxdata,queryName,$$$cXDATAdescription)
		
	} else {
		throw ##class(%Exception.StatusException).CreateFromStatus($$$ERROR($$$GeneralError, $$$FormatText($$$aText("Class %1 does not have a Query or XData element named %2",""), class, queryName)))
	}
	
	set:(removeNL = $$$YES) sql = $replace(sql, $$$NL, " ")
	return sql_" -- Today "_$zd($h,3)_" "_$g(ssm)
]]></Implementation>
</Method>

<Query name="TestQuery">
<Description>
test query
stored in query</Description>
<Type>%Query</Type>
<SqlQuery>SELECT top 10 * from
  App.Log</SqlQuery>
</Query>

<XData name="TestXData">
<Description>
test query
stored in xdata</Description>
<MimeType>application/yaml</MimeType>
<Data><![CDATA[
SELECT
  c.contractNumber,
  TO_DATE(d."date", 'YYYY-MM-DD'),
  d.year,
  d.month,
  d.amount,
FROM mvk_model_payment.PayDoc d
  JOIN mvk_model_payment.PayDocSession s ON s.ID = d.session
  JOIN mvk_model_contract.Contract c ON d.contract = c.ID
WHERE s.ID = ?
ORDER BY c.contractNumber
]]></Data>
</XData>

<Method name="getViewOrQuerySQL">
<ClassMethod>1</ClassMethod>
<FormalSpec>viewOrQueryName:%String,*sql:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#dim sc As %Status = $$$OK
	set sql = ""
	
	if (viewOrQueryName [ ".")
	{
		set sql = "select * from " _ viewOrQueryName _ " where 1=1 "
	}
	else
	{
		try
		{
			set sql = ..getSQL(viewOrQueryName)
		}
		catch ex
		{
			set sql = ""
			set sc = $$$ADDSC($$$ERROR($$$GeneralError, "Error " _ viewOrQueryName), ex.AsStatus())
		}
	}
	
	quit sc
]]></Implementation>
</Method>
</Class>


<Class name="App.sys">
<Abstract>1</Abstract>
<IncludeCode>App.LogMacro</IncludeCode>
<TimeChanged>65364,31382</TimeChanged>
<TimeCreated>64734,80043.870644</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Method name="logout">
<Description>
Sign Out
d ##Expression(##class(App.sys).logout()</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    #dim %session As %CSP.Session
    set st = %session.Logout(1)
    set %session.EndSession = 1
    return st
]]></Implementation>
</Method>

<Method name="CreateTaskPurge">
<Description>
Create a task to clean the messages of the ensemble
for ns="AISGSASUMS","M112","SPGZ","RDID","RDIDPROD" try {zn ns w !,ns," ",##class(App.sys).CreateTaskPurge("Ensemble message cleaning",ns,90)}catch{}</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Name="",ns,days=90</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Set Task=##Class(%SYSTEM.Task).%New()
	Set Task.Name=Name
	Set Task.Type=0
	Set Task.Description="task to clean the messages of the ensemble"
	Set Task.TaskClass="Ens.Util.Tasks.Purge"
	#;Every day at 1:00 am
	Set Task.DailyStartTime=3600
	;Do Task.idSet(Number)
	Set Task.RunAsUser="SuperUser"
	Set Task.MirrorStatus=3
	Set t=##class(Ens.Util.Tasks.Purge).%New()
	Set t.KeepIntegrity=0
	Set t.NumberOfDaysToKeep=days
	Set t.BodiesToo=1
	Set t.TypesToPurge="all"
	Set Task.Settings=t.GetSettings()
	Set Task.NameSpace=ns
	quit Task.%Save()
]]></Implementation>
</Method>

<Method name="GetSysUserProp">
<Description>
Get system user properties
w ##class(App.sys).GetSysUserProp("Login",.Prop)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Name,Prop</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	$$$NspGoto(curNs,"%SYS")
	set Status=##Class(Security.Users).Get(Name,.Prop)
	$$$NspReturn(curNs)
	quit Status
]]></Implementation>
</Method>

<Method name="IsPreparedDB">
<Description>
Check whether the database is prepared
w ##class(App.sys).IsPreparedDB("ENSDEMO")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>name</FormalSpec>
<Implementation><![CDATA[
	i (",ENSDEMO,ENSEMBLE,ENSEMBLEENSTEMP,ENSEMBLESECONDARY,ENSLIB,CACHESYS,CACHELIB,CACHETEMP,CACHE,CACHEAUDIT,DOCBOOK,USER,SAMPLES,")[(","_$zconvert(name,"U")_",") q 1
	Q 0
]]></Implementation>
</Method>

<Method name="getEnsProd">
<Description>
Get a list of products in namespace
w ##class(App.sys).getEnsProd("ENSDEMO",.info)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>name,info</FormalSpec>
<Implementation><![CDATA[
	s sc=$$$OK
	try {
		$$$NspGoto(curNs,name) KILL info
		DO ##CLASS(Ens.Director).GetProductionSummary(.info,name)
	}
	catch e { s sc=$$$ERROR($$$GeneralError,$ze)}
	$$$NspReturn(curNs)
	Q sc
]]></Implementation>
</Method>

<Method name="IsPreparedNS">
<Description>
Check whether the namespace is prepared
w ##class(App.sys).IsPreparedNS("%SYS")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>name</FormalSpec>
<Implementation><![CDATA[
	i (",%SYS,%ALL,DOCBOOK,ENSDEMO,ENSEMBLE,SAMPLES,USER,")[(","_$zconvert(name,"U")_",") q 1
	Q 0
]]></Implementation>
</Method>

<Method name="getCSPapps">
<Description>
//get csp apps 
w ##class(App.sys).getCSPapps("/apptools","Path")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>csppapp,prop</FormalSpec>
<Implementation><![CDATA[
		
 $$$NspGoto(curNs,"%SYS")
	s result=##CLASS(%ResultSet).%New("%DynamicQuery:SQL")
	s tSC=result.Prepare("select * FROM Security.Applications where Name=?")
	s:tSC tSC=result.Execute(csppapp)
	i '$$$ISOK(tSC) {
		 QUIT tSC
	}
	else {
		while result.Next() {
			set res=result.Data(prop)
		}
	}
	d result.Close()
	$$$NspReturn(curNs)	
	Q $g(res)
]]></Implementation>
</Method>

<Method name="ListDB">
<Description>
Get a list of database names separated by commas
w ##class(App.sys).ListDB(.info,"NotPre")
Flag = "NotPre" - exclude prepared
Flag = "NotTemp" - exclude tempory</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>info,Flag=""</FormalSpec>
<Implementation><![CDATA[
	$$$NspGoto(curNs,"%SYS")	
	s list=""
	s rss=##class(%ResultSet).%New("Config.Databases:List")
	d rss.Execute()
	while rss.Next(.sc) { 
		s name=rss.Data("Name")
		if Flag["NotPre" continue:##class(App.sys).IsPreparedDB(name)
		if Flag["NotTemp" continue:(name_",")["SECONDARY,"||((name_",")["TEMP,")
		s list=list_","_name 
		m info(name)=rss.Data
	}
	
	d rss.Close()
	$$$NspReturn(curNs)	
	Q $g(list)
]]></Implementation>
</Method>

<Method name="ListNS">
<Description>
Get a list of domain namespaces separated by commas
w ##class(App.sys).ListNS(.info,"NotPre")
Flag = "Ens" - only where the ensemble is installed
Flag = "NotPre" - exclude prepared</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>info,Flag=""</FormalSpec>
<Implementation><![CDATA[
	s disp=""
	$$$NspGoto(curNs,"%SYS")	
	set tRS = ##class(%ResultSet).%New("Config.Namespaces:List")
	if '$isobject(tRS) q ""
	set tSC = tRS.Execute()
	While tRS.Next() {	
		s name=tRS.GetData(1) KILL ens
		if Flag["NotPre" continue:##class(App.sys).IsPreparedNS(name)
		if Flag["Ens",##class(App.sys).getEnsProd(name,.ens) k info("Ens") m info(name,"Ens")=ens
		s disp=disp_","_name
		m info(name)=tRS.Data
	}
	d tRS.Close()
	$$$NspReturn(curNs)	
	Q $g(disp)
]]></Implementation>
</Method>

<Method name="RunCmd">
<Description><![CDATA[
Function to call the OS command in the result output
%SYS>d ##class(App.sys).RunCmd("sudo du -sm /opt/isc/ensemble/mgr/*| sort -nr",$na(^%App.Cmd("mgr",$zd($h,3))),1,"/backup/temp/snmp/")]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>cmdOs="free",gn="^TaskGN",AddDateTime=0,dir="/backup/temp/"</FormalSpec>
<Implementation><![CDATA[
	s gnTask=gn
	set filename=dir_"RunCmd.log"
	if AddDateTime set datetime=$tr($$$AppDT($h)," ","_") set gnTask=$na(@gn@(datetime)),filename=dir_"RunCmd"_datetime_".log"
	if cmdOs'="",$zf(-1,cmdOs_" > "_filename)
	if ##class(App.files).ReadFile2Arr(filename,"RSK",,"^||tmpFile") MERGE @gnTask=^||tmpFile
	q $$$OK
]]></Implementation>
</Method>

<Method name="RunTask">
<Description><![CDATA[
Function to call from a regular task
%SYS>d ##class(App.sys).RunTask("snmpwalk -v 1 server.ru -c public 1.3.6.1.4.1.16563.1.1.1.1.10","^%App.TaskLic","%SYSTEM.License:Counts","/backup/temp/snmp/")]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>cmdOs="free",gn="^TaskGN",query="%SYSTEM.License:Counts",dir="/backup/temp/"</FormalSpec>
<Implementation><![CDATA[
	set datetime=$tr($$$AppDT($h)," ","_")
	set gnTask=$na(@gn@(datetime))
	set filename=dir_"RunTask"_datetime_".txt"
	if cmdOs'="",$zf(-1,cmdOs_" > "_filename)
	if query'="" d ##class(App.sys).SaveQuery(query,gn,datetime)
	q $$$OK
]]></Implementation>
</Method>

<Method name="getSQLConnection">
<Description>
  w ##class(App.sys).getSQLConnection(.list)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&List:%String=""]]></FormalSpec>
<Implementation><![CDATA[
	set res=""
	$$$NspGoto(curNs,"%SYS")	
	Set result=##CLASS(%ResultSet).%New("%DynamicQuery:SQL")
	Set tSC=result.Prepare("select Connection_Name,isJDBC,DSN from %Library.sys_SQLConnection") ; where isJDBC=1")
	Set:tSC tSC=result.Execute()
	
	if '(tSC) {
		s text=$$$aText("Application Setup Error","")_" :"_$SYSTEM.Status.GetErrorText(tSC)  w !,text QUIT $$Error^%apiOBJ(text)
	}
	else {
		while result.Next() {
			if result.Data("Connection_Name")'="" {
				set List(result.Data("Connection_Name"))=$s('result.Data("isJDBC"):result.Data("DSN"),1:"")
				set res=res_result.Data("Connection_Name")_","
			}
		}
	}
	$$$NspReturn(curNs)	
	Q $g(res)
]]></Implementation>
</Method>

<Method name="GetValueGN">
<Description>
Get the value of a field by its name from GN or a list of values
Format $listbuild
w a=##class(App.sys).GetValueGN(gn,2,"QUANTITY,PRIMARY_UNIT_OF_MEASURE")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>gn,row,NameFields</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	i NameFields'["," q $lb(..GetValue(gn,row,NameFields))
	set ret=""
	for i=1:1:$l(NameFields,",") { continue:$p(NameFields,",",i)=""
		set ret=ret_$lb(..GetValue(gn,row,$p(NameFields,",",i)))
	}
	q ret
]]></Implementation>
</Method>

<Method name="GetValue">
<Description>
Get one field value by its name from GN
w a=##class(App.sys).GetValue(gn,2,"QUANTITY")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>gn,row,NameField</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 i $g(@gn@(-1,NameField))="" q "" ;undefined field: "_NameField
 i '$d(@gn@(row)) q "undefined row: "_row
 q $lg(@gn@(row),@gn@(-1,NameField))
]]></Implementation>
</Method>

<Method name="SaveQuery">
<Description><![CDATA[
Procedure for calling from a regular job and storing reports in the global
%SYS>d ##class(App.sys).SaveQuery("SYS.Database:FreeSpace")
%SYS>d ##class(App.sys).SaveQuery("%SYSTEM.License:Counts")]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>query="%SYSTEM.License:Counts",gn="^%App.Task",datetime=""</FormalSpec>
<Implementation><![CDATA[
	set:datetime="" datetime=$$$AppDT($h)
	set gnTask=$na(@gn@(query,datetime))
	Set rset=##class(%Library.ResultSet).%New($p(query," ",1))
	If rset="" s @gnTask@("Create Query failed")= $System.Status.DisplayError(%objlasterror) q %objlasterror
	if $p(query," ",3)'=""	{Set status=rset.Execute($p(query," ",2),$p(query," ",3))}
	elseif $p(query," ",2)'=""	{Set status=rset.Execute($p(query," ",2))}
	else { Set status=rset.Execute()}
	If $$$ISERR(status) s @gnTask@("Execute Query failed:")= $System.Status.DisplayError(status) q status
	Set colcnt=rset.GetColumnCount()
	For i=1:1:colcnt s @gnTask@(0,i)=rset.GetColumnName(i)
	while rset.Next() {	if $I(row)
	   For i=1:1:colcnt s @gnTask@(row,i)=rset.GetData(i)
	}
	q $$$OK
]]></Implementation>
</Method>

<Method name="SaveSQL">
<Description><![CDATA[
/*! \brief Procedure query executing and storing reports in the global
<br>\ingroup query
<br>\param ext=1 add saving column and row positions
<br>\return count rows
<br>\example d ##class(App.sys).SaveSQL("select * from Ens.MessageHeader where id=1461","^logMSW2") */]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>SQL,gn="^mtempSQLGN",ext=0</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	s st=$$$OK,hr=$h,ts=$$$AppDT(hr)
	s myQuery = ##CLASS(%ResultSet).%New("%DynamicQuery:SQL")
	s st=myQuery.Prepare(SQL)
	i 'st q st
	s st=myQuery.Execute()
	i 'st q st
	s (count)=0
	k @gn
	s ColCount=myQuery.GetColumnCount()
	F i=1:1:ColCount {	s @gn@(0)=$g(@gn@(0))_$lb(myQuery.GetColumnName(i))	
		s @gn@(-1,$ZStrip(myQuery.GetColumnName(i),"<>WCP"))=i //Name = Number
	}
	while (myQuery.Next())	{
		s count=count+1
		if ext s @gn@(-2,$ZStrip(myQuery.Get("Name"),"<>WCP"))=count  ; w "<li>"_myQuery.Get("Name")_" "_count_" "_$zr
		f ii=1:1:ColCount {
			s @gn@(count)=$g(@gn@(count))_$lb(myQuery.GetData(ii))
			}
	}
	s @gn@(-3,"sql")=$lb(SQL)
	s @gn@(-3,"timestamp")=$lb(ts,$$$AppDT($h),##class(App.type).GetCountSec($h)-##class(App.type).GetCountSec(hr))
	q count
]]></Implementation>
</Method>

<Method name="ClassExist">
<Description>
Is there such a class
w ##class(App.sys).ClassExist("Spgz.model.spgz")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>class</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	q:class="" ""
	try {
		s st=$d($$$comClassRaw(class))
	} catch e { s st=$ze }
  q $g(st)
]]></Implementation>
</Method>

<Method name="GlobalList">
<Description>
Global list
d ##class(App.sys).GlobalList("SAMPLES",.L)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[ns,&list,SystemGlobals=0,Mapped=1]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
/// Returns a list of the Globals in a Cache NameSpace (used for GUI display)<br>
/// <br>
/// <b>Parameters:</b> <br>
/// NameSpace - a Cache namespace. Default is current namespace. <br>
/// Mask - a mask, or comma-separated list of masks, to select globals. Default is "*" for all.<br>
/// SystemGlobals - boolean flag to include system globals in the results. Default is "0".<br>
/// UnavailableDatabases - a returned local array of any databases not currently accessible, i.e. array(name)=status.<br>
/// Index - Internal use only.<br>
/// IgnoreHasData - For faster list of Globals set this to 1 and the HasData column will always be FALSE.<br>
/// Mapped - Return all mapped global nodes when set to 1, the default value of this parameter is 1.
/// <br>
/// Valid masks are as follows:
/// <br>
/// ABC* - All strings starting with ABC<br>
/// A:D - All strings between A and D<br>
/// A:D,Y* - All strings between A and D, and all strings starting with Y<br>
/// A:D,'C* - All strings between A and D, except those starting with C
/// Query NameSpaceList(  NameSpace As %String,  Mask As %String,  SystemGlobals As %Boolean,  ByRef UnavailableDatabases As %String,  Index As %Integer,  IgnoreHasData As %Boolean = 0,  Mapped As %Boolean = 1) As %Query(ROWSPEC = "Name:%String,Location:%String,ResourceName:%String,Permission:%String,Empty:%String,Keep:%String,Collation:%String,PointerBlock:%String,GrowthBlock:%String,HasData:%Boolean,Journal:%String,LockLocation:%String,HasSubscripts:%Boolean") [ SqlProc ]
 set s = ##class(%SQL.Statement).%New()
 do s.%PrepareClassQuery("%SYS.GlobalQuery", "NameSpaceList")
 set r = s.%Execute(ns, "*",SystemGlobals,,,,Mapped)
 ;set $namespace = ns
 while r.%Next() { 
	;w !,r.%Get("Name")
	s list(r.%Get("Name"))=""
 }
]]></Implementation>
</Method>

<Method name="GlobalSize">
<Description>
Global list
d ##class(App.sys).GlobalList("SAMPLES",.L)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[dir,&list,SystemGlobals=0,FastFlag=1]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
/// Size(Directory As %String, System As %String = "", Mask As %String, SystemGlobals As %Boolean, Index As %Integer, FastFlag As %Boolean)
/// Selects Name As %String, Allocated MB As %Float, Used MB As %Float
 set s = ##class(%SQL.Statement).%New()
 do s.%PrepareClassQuery("%SYS.GlobalQuery", "Size")
 set r = s.%Execute(dir,,"*",SystemGlobals,,FastFlag )
 ;set $namespace = ns
 while r.%Next() { 
	;w !,r.%Get("Name")
	s list(r.%Get("Name"))=""
 }
]]></Implementation>
</Method>

<Method name="GetObj">
<Description>
s a=##class(App.sys).GetObj("select top 1 * from model.SP where deletedDate is null order by importDate desc") zw a</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Query</FormalSpec>
<Implementation><![CDATA[
	#dim rs As %ResultSet.SQL = ##class(%ResultSet.SQL).%Prepare(Query)
	if 'rs.%Next() q $$$NULLOREF
	q rs
]]></Implementation>
</Method>

<Method name="SqlToDSN">
<Description>
Get a DSN request
w $System.Status.GetErrorText(##class(App.sys).SqlToDSN("SELECT * FROM xxmv.xx_t359_pzn","OEBS-Daily","^tmMSWq"))</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>sql,DSN,result,top=100000</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#dim %JDBCGateway As %Net.Remote.Java.JDBCGateway
	s hr=$h,ts=$$$AppDT(hr)
	set conn = $system.SQLGateway.GetJDBCConnection(DSN)
	if (conn = "") quit 0
	set st = %JDBCGateway.prepareStatement(conn, sql)
	set %JDBCGateway.StatementCache(conn) = st
	set query = %JDBCGateway.execQuery(st)
	
	if (query = -1)	{
		;w %JDBCGateway.getErrorText() q 0
		set sc = $$$ERROR($$$GeneralError, %JDBCGateway.getErrorText())
		do %JDBCGateway.removeStatement(conn)
		;if $isObject($g(%JDBCGateway)) do %JDBCGateway.closeAll()
		quit sc
	}
	i $g(result)'="" s gn=result k @gn
	e  s gn="result" 
	
	set columns = %JDBCGateway.getColumnCount(st)
	
	;set pos = 0
	for i=1:1:columns 
	{
	  set name = $ZStrip(%JDBCGateway.getColumnName(st,i),"<>WCP")
	  set size = %JDBCGateway.getColumnDisplaySize(st,i)
	  set Type= %JDBCGateway.getColumnType(st,i)
	  set TypeName= %JDBCGateway.getColumnTypeName(st,i)
	  s @gn@(0,i)=$lb(name,size,Type,TypeName)
	  set @gn@(-1,name)=i //	  ;s @gn@(-1)=$g(@gn@(-1))_$lb($lb(size,Type,TypeName))
	  ;set pos(i) = pos
	  ;set pos = pos + size + 1
	  ;w name,!
	}

	set cnt = 1
	while %JDBCGateway.next(st)
	{
		;write !
		for i=1:1:columns {
			;write "!",%JDBCGateway.getString(st, i) 
			s @gn@(cnt)=$g(@gn@(cnt))_$lb(%JDBCGateway.getString(st, i))
		}
		set cnt = cnt + 1
		q:cnt>top
	}
	;w !,cnt,!
	;if $isObject($g(%JDBCGateway)) do %JDBCGateway.closeAll()
	do %JDBCGateway.removeStatement(conn)
	s @gn=cnt-1
	s @gn@(-3,"sql")=$lb(sql,DSN,top)
	s @gn@(-3,"timestamp")=$lb(ts,$$$AppDT($h),##class(App.type).GetCountSec($h)-##class(App.type).GetCountSec(hr))
	quit $$$OK
]]></Implementation>
</Method>

<Method name="SaveGateway">
<Description>
s a=##class(App.sys).SaveGateway("select * from Sample.Person","Ensemble Samples","_system","") zw a
TODO save to gn</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>sql,pDSN,usr,pwd,result,top=100000</FormalSpec>
<Implementation><![CDATA[
 #include %occInclude
 	s hr=$h,ts=$$$AppDT(hr)
 	//Create new Gateway connection object
 	set gc=##class(%SQLGatewayConnection).%New()
 	If gc=$$$NULLOREF quit $$$ERROR($$$GeneralError,"Cannot create %SQLGatewayConnection.")
 		  
 	//Make connection to target DSN
 	set sc=gc.Connect(pDSN,usr,pwd,0) 
 	If $$$ISERR(sc) quit sc
 	if gc.ConnectionHandle="" quit $$$ERROR($$$GeneralError,"Connection failed")
 		  
 	set sc=gc.AllocateStatement(.hstmt) 
 	if $$$ISERR(sc) quit sc
		  
 	//Prepare statement for execution
 	set sc=gc.Prepare(hstmt,sql) 
 	if $$$ISERR(sc) quit sc
 	//Execute statement
 	set sc=gc.Execute(hstmt)
 	if $$$ISERR(sc) quit sc
 	//Get list of columns returned by query
 	set sc=gc.DescribeColumns(hstmt, .columnlist) 
 	if $$$ISERR(sc) quit sc
 	
 	if $g(result)'="" s gn=result k @gn
	else  s gn="result" 
 	//display column headers delimited by ":"
 	set numcols=$listlength(columnlist)-1  //get number of columns
 	for colnum=2:1:numcols+1 {
 		    ;Write $listget($listget(columnlist,colnum),1),":"
 		    set name=$listget($listget(columnlist,colnum),1)
 		    set @gn@(0,colnum-1)=$lb(name)
	  		set @gn@(-1,name)=colnum-1 
 	  		}
 	;write !
 	 
 	//Return first 200 rows	  
 	set sc=gc.Fetch(hstmt)
 	if $$$ISERR(sc) quit sc
 	set rownum=1
 	while((gc.sqlcode'=100) && (rownum<=top)) {
 	      	for ii=1:1:numcols {
 		      	set sc=gc.GetData(hstmt, ii, 1, .val)
 		      	;w " "_val
 		      	set @gn@(rownum)=$g(@gn@(rownum))_$lb(val)
 		      	if $$$ISERR(sc) break
 	      	}
 	      	set rownum=rownum+1
 	 		;write !
 	 		set sc=gc.Fetch(hstmt)
 			if $$$ISERR(sc) break
 
 	  		}
 	    
 	  //Close cursor and then disconnect
 	set sc=gc.CloseCursor(hstmt)
 	if $$$ISERR(sc) quit sc
 	set sc=gc.Disconnect()
	set @gn=rownum-1
	set @gn@(-3,"sql")=$lb(sql,pDSN,top,usr,pwd)
	set @gn@(-3,"timestamp")=$lb(ts,$$$AppDT($h),##class(App.type).GetCountSec($h)-##class(App.type).GetCountSec(hr))
 	Quit sc
]]></Implementation>
</Method>

<Method name="GetFullName">
<Description>
Sample  w ##class(App.sys).GetFullName("superuser")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>login</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 try {
	$$$NspGoto(curNs,"%SYS")
	if ##class(Security.Users).Exists(login,.User,.Status) {
			if $isobject(User) {
				s fullName=User.FullName 
			}
		}
  $$$NspReturn(curNs) 
 } catch e {}
  q $g(fullName)
]]></Implementation>
</Method>

<Method name="GetRoles">
<Description>
Sample  w ##class(App.sys).GetRoles(mask,.roles)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[mask="",&list]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  NEW $NAMESPACE
  SET $NAMESPACE = "%SYS"
  set mask=$zconvert(mask,"L")
  set sql="select NameLowerCase,Description,Name FROM Security.Roles"
  if mask["," { set mask=$replace($ZStrip(mask,"<>W"),",","','")
  	set sql=sql_" where ID in ('"_mask_"')"
  } 
  elseif mask'="" {
	  set sql=sql_" where NameLowerCase like '%"_mask_"%'"
  }
	set result=##CLASS(%ResultSet).%New("%DynamicQuery:SQL")
	set tSC=result.Prepare(sql)
	set:tSC tSC=result.Execute()
	if '$$$ISOK(tSC) {
	 	QUIT tSC
	}
	else {
		while result.Next() {
			set list(result.Data("NameLowerCase"))=$lb(result.Data("Name"),result.Data("Description"))
		}
	}
	quit $$$OK
]]></Implementation>
</Method>

<Method name="GetUsers">
<Description>
Get system users
w ##class(App.sys).GetUsers("super",.users)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[mask="",&list]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  NEW $NAMESPACE
  SET $NAMESPACE = "%SYS"
  set mask=$zconvert(mask,"L")
  set sql="select NameLowerCase,FullName,Comment,Roles,EmailAddress FROM Security.Users"
  if mask["," { set mask=$replace($ZStrip(mask,"<>W"),",","','")
  	set sql=sql_" where NameLowerCase in ('"_mask_"')"
  } 
  elseif mask'="" {
	  set sql=sql_" where NameLowerCase like '%"_mask_"%'"
  }
	set result=##CLASS(%ResultSet).%New("%DynamicQuery:SQL")
	set tSC=result.Prepare(sql)
	set:tSC tSC=result.Execute()
	if '$$$ISOK(tSC) {
	 	QUIT tSC
	}
	else {
		while result.Next() {
			set list(result.Data("NameLowerCase"))=$lb(result.Data("FullName"),result.Data("Comment"),result.Data("Roles"),result.Data("EmailAddress"))
		}
	}
	quit $$$OK
]]></Implementation>
</Method>

<Method name="Export">
<Description>
Delete and Export the table in oeBS when the match is in Description
Sample d ##class(App.sys).Export("OEBS",.msg,"Mvk.model.Characteristic")
s class="Spgz.model.PP.Files" d ##class(App.sys).Export("OEBS",.msg,class,1,"select * from "_##class(App.type).GetTableName(class)_" where FileID='127'")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>jdbc="OEBS",msg,class,NoDel=0,sql="",write=0</FormalSpec>
<Implementation><![CDATA[
	#define addQuote(%s) $replace(%s,"'","''")
	d ##class(App.LogInfoPane).GetClassDef(class,"",.out,0)
	;zw out
	q:'$d(out) 1
	s gn="^||tmpExp"_$p(class,".",*)  ;^||
	kill @gn	
	s:sql="" sql="select * from "_##class(App.type).GetTableName(class)
	s st=##class(App.sys).SaveSQL(sql,gn)
	i 'st q st
	s rowcount=$o(@gn@(""),-1) 
	w:write !,$$$FormatText($$$aText("On request %1 found %2 records",""),sql,rowcount)_" "_gn_" "_$System.Status.GetErrorText(st)
	i 'rowcount w:write !,$$$aText("there is nothing to export","") q 1

	s tab=$g(out("Parameters","OEBSTAB","Default"))
	w:write !,tab
	if 'NoDel { ;do not delete the table
		s del="delete "_tab
		s gnDel="^||tmpExpDel"
		s st=##class(App.sys).SqlToDSN(del,jdbc,gnDel)
		;i 'st s err=$System.Status.GetErrorText(st) q st
		kill @gnDel
	}
	i write { ;check the types in oeBS
		s sqltest="select * from "_tab_" where 1=0"
		s gnD="^||tmpExpD"
		s st=##class(App.sys).SqlToDSN(sqltest,jdbc,gnD)
		zw @gnD
	}
	s f="" ;Create an array of unequivocal conformity between oeBS and instrumentation fields
	f ff=1:1 { s f=$o(out("Properties",f)) q:f=""
		i $e(out("Properties",f,"Description"))="=" {
			w:write !,ff_". "_$$$aText("field","")_" ",f
			s desc=$p(out("Properties",f,"Description"),";",1)
			w:write " "_$$$aText("review","")_" ",desc
			s oefield=$p($p(desc,"=",2)," ")
			s oetype=$ZStrip($p(desc," ",2,*),"<>WCP")
			
			if " "[oefield {	s oefield=f	}
			if oetype="" {	s oetype="NUMBER"	}
			if $zconvert(oefield,"L")["date" {	s oetype="DATE"	}
			
			i write {w " -> "_oefield_" "_oetype_" "
			 s num=$g(@gnD@(-1,$zconvert(oefield,"U")))
			 if 'num {w $$$aText("not found","")_" "_$zconvert(oefield,"U")}
			 else { s typ=$lg(@gnD@(0,num),4) w typ
			 	i oetype'[typ w $$$aText("not the same","")
			 }
			}
			s array(f)=oefield
			s array(f,"type")=oetype
		}
	}
	i '$d(array) w !,$$$aText("Not configured-to-one correspondence","") q 1
	s f="" ;A new pass through the array, sorting may differ
	s pattIns="insert into "_tab_"("
	f { s f=$o(array(f)) q:f=""
		s pattIns=pattIns_array(f)_$s($o(array(f))="":"",1:",")_" "
	}	
	s pattIns=pattIns_") values "
	;w !,pattIns 
	s ins="",coun=0,gnIns="^||tmpExpIns"
	s chank=2000 ;1000 batch of transmission records
	m fields=@gn@(-1)
	for row=1:1:rowcount { 
		s coun=coun+1
		
		s f="" ;Get the values to be written
		s values="("
		f { s f=$o(array(f)) q:f=""
			 s val=$$$addQuote($lg(@gn@(row),fields(f))) 
			 if array(f,"type")["DATE" {
				 s val="TO_DATE('"_val_"','YYYY-MM-DD HH24:MI:SS')"
			 } else {
				 s val="'"_val_"'"
			 }
			s values=values_val_$s($o(array(f))="":"",1:",")_" "
		}	
		s ins=ins_pattIns_values_");"		
		;w:row=1 !,ins ;q:row=1
		i '(coun#chank) {
			w:write !,ins
			s st=##class(App.sys).SqlToDSN("BEGIN "_ins_" COMMIT; END;",jdbc,gnIns)
			s ins=""
		}
	}
	;q 1
	i ins'="" w:write !,ins s st=##class(App.sys).SqlToDSN("BEGIN "_ins_" COMMIT; END;",jdbc,gnIns)
	s st=##class(App.sys).SqlToDSN("select count(*) from "_tab,jdbc,gnIns)
	i $d(%objlasterror) w:write !,$System.Status.GetErrorText(%objlasterror)
	s inscount=$lg($g(@gnIns@(1)),1) ;from the first record to take the first field
	s msg=$$$FormatText($$$aText("Unloaded %1 from %2",""),inscount,rowcount)
	k @gnIns,@gn
	w:write !,msg
	q $$$OK
]]></Implementation>
</Method>

<Method name="DismountListDB">
<Description>
zn "app" w $System.Status.GetErrorText(##class(App.sys).DismountListDB("DOJO"))</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Database,write=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	s st=##class(App.sys).DismountDB(Database)
	if st {
		s st1=##class(App.sys).DismountDB(Database_"ENSTEMP")
		if 'st1 q st1
		s st2=##class(App.sys).DismountDB(Database_"SECONDARY")
		if st2 q st2
	} else { q st }
	q $$$OK
]]></Implementation>
</Method>

<Method name="DismountDB">
<Description>
w $System.Status.GetErrorText(##class(App.sys).DismountDB("ASURPROD"))</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Database</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	new $namespace
	zn "%sys"
	s st=$$$OK
	If ##Class(Config.Databases).Get(Database,.Properties) {
		Set Directory = $G(Properties("Directory"))
  		Set st = ##class(SYS.Database).DismountDatabase(Directory)
	}
	q st
]]></Implementation>
</Method>

<Method name="MountDB">
<Description>
zn "app" w ##class(App.sys).MountDB("DOJO")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Database</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	new $namespace
	zn "%sys"
	If ##Class(Config.Databases).Get(Database,.Properties) {
		Set Directory = $G(Properties("Directory"))
  		q ##class(SYS.Database).MountDatabase(Directory)
	}
	q $$$OK
]]></Implementation>
</Method>

<Method name="MountListDB">
<Description>
zn "app" w $System.Status.GetErrorText(##class(App.sys).MountListDB("DOJO"))</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Database</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	s st=##class(App.sys).MountDB(Database)
	if st {
		s st1=##class(App.sys).MountDB(Database_"ENSTEMP")
		if 'st1 q st1
		s st2=##class(App.sys).MountDB(Database_"SECONDARY")
		if st2 q st2
	} else { q st }
	q $$$OK
]]></Implementation>
</Method>
</Class>


<Class name="App.type">
<Description>
Utility types</Description>
<Abstract>1</Abstract>
<IncludeCode>App.LogMacro</IncludeCode>
<TimeChanged>65377,32764</TimeChanged>
<TimeCreated>64735,32446.061315</TimeCreated>
<DependsOn>App.msg</DependsOn>

<Method name="Date3">
<Description>
To return the date in the format 3 
App.type_Date3(DateFrom)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>h:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<SqlProc>1</SqlProc>
<Implementation><![CDATA[	return $zd(h,3)
]]></Implementation>
</Method>

<Method name="GetYYYYMM">
<Description>
To count the number of seconds to YYYY-MM-DD HH:MM:SS or the $HOROLOG
w ##class(App.type).GetYYYYMM("2018-07-06 08:14:47",-1)
w ##class(App.type).GetYYYYMM($h,-1)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>h,plusMM=0</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	i h["-" s h=..GetHorYYYYMMDD(h)
	s MM=$p($zd(+h,3),"-",2)+plusMM,YYYY=$p($zd(+h,3),"-",1)
	i MM<1 s MM=12+MM,YYYY=YYYY-1 ;running for less than 12 plusMM
	i MM>12 s MM=MM-12,YYYY=YYYY+1
	i $l(MM)=1 s MM="0"_MM
	q YYYY_"-"_MM
]]></Implementation>
</Method>

<Method name="GetCountSec">
<Description>
To count the number of seconds to YYYY-MM-DD HH:MM:SS or the $HOROLOG
w ##class(App.type).GetCountSec("2018-07-06 08:14:47")
w ##class(App.type).GetCountSec($h)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>h</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	i h["-" s h=..GetHorYYYYMMDD(h)
	i h'["," q ""
	q $p(h,",",1)*86400+$p(h,",",2)
]]></Implementation>
</Method>

<Method name="GetTextMonth">
<Description>
w ##class(App.type).GetTextMonth("05")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>mm</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	q $s(+mm="1":$$$aText("January",""),+mm="2":$$$aText("February",""),+mm="3":$$$aText("March",""),+mm="4":$$$aText("April",""),+mm="5":$$$aText("may",""),+mm="6":$$$aText("June",""),+mm="7":$$$aText("July",""),+mm="8":$$$aText("August",""),+mm="9":$$$aText("September",""),+mm="10":$$$aText("October",""),+mm="11":$$$aText("November",""),1:$$$aText("December",""))
]]></Implementation>
</Method>

<Method name="GetMonth">
<Description>
To month
w ##class(App.type).GetMonth($h)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>h</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	q $p($zd(h,3),"-",2)
]]></Implementation>
</Method>

<Method name="GetHorYYYYMMDD">
<Description>
Translate YYYY-MM-DD HH:MM:SS in $HOROLOG
w ##class(App.type).GetHorYYYYMMDD("2018-07-06 08:14:47")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>dt</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	try{ 
		s d=$zdh($p(dt," "),3)
		s c=$zth($p(dt," ",2),1)
		s res=d_","_c
	}
	catch e { s res="" }
	q $g(res)
]]></Implementation>
</Method>

<Method name="GetValidZD">
<Description>
To check the validity and display the date
w ##class(App.type).GetValidZD(+$h)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>hr</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	try{ s res=$tr($zd(hr,4),"/",".") }
	catch e { s res="" }
	q res
]]></Implementation>
</Method>

<Method name="GetYear">
<Description>
To year format 2018
w ##class(App.type).GetYear($h)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>h</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	q $p($zd(h,3),"-",1)
]]></Implementation>
</Method>

<Method name="GetDateTime">
<Description>
To get a date in the format 2018-04-03T16:40:30
w ##class(App.type).GetDateTime($h)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>h</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[	q $zd(h,3)_"T"_##class(App.type).GetValidZT(h)
]]></Implementation>
</Method>

<Method name="GetValidZT">
<Description>
To check the validity and display the time
w ##class(App.type).GetValidZT($h)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>hr</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	try{ s res=$zt(+$p(hr,",",2),1) }
	catch e { s res="" }
	q res
]]></Implementation>
</Method>

<Method name="getDDMMYY">
<Description>
Translate the date to the format DD.MM.YY
w ##class(App.type).getDDMMYY("2016-05-05")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pStringDate:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	try {
		i pStringDate?1n.n s pStringDate=$zd(pStringDate,3)
		i pStringDate["." s date=pStringDate s:$p(date,".",3)?4n date=$p(date,".",1,2)_"."_$e($p(date,".",3),3,4)
		i pStringDate["-" s date=$p(pStringDate,"-",3)_"."_$p(pStringDate,"-",2)_"."_$e($p(pStringDate,"-",1),3,4)
		i pStringDate["/" s date=$p(pStringDate,"/",2)_"."_$p(pStringDate,"/",1)_"."_$e($p(pStringDate,"/",3),3,4)
	} catch e {}
	q $g(date)
]]></Implementation>
</Method>

<Method name="getDDMMYYYY">
<Description>
Translate the date to the format DD.MM.YYYY
w ##class(App.type).getDDMMYYYY("2016-05-05")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pStringDate:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	try {
		i pStringDate?1n.n s pStringDate=$zd(pStringDate,3)
		i pStringDate["." s date=pStringDate
		i pStringDate["-" s date=$p(pStringDate,"-",3)_"."_$p(pStringDate,"-",2)_"."_$p(pStringDate,"-",1)
		i pStringDate["/" s date=$p(pStringDate,"/",2)_"."_$p(pStringDate,"/",1)_"."_$p(pStringDate,"/",3)
	} catch e {}
	q $g(date)
]]></Implementation>
</Method>

<Method name="GetInpretDate">
<Description>
Translate the date to the format YYYY-MM-DD FORMAT=3 passing a formula of the type "CurrentDay+1"
w ##class(App.type).GetInpretDate("CurrentDay+1","12:00")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pStringDate:%String,time=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	try {
		i pStringDate["CurrentDay" s pStringDate=$replace(pStringDate,"CurrentDay","$h")
		i pStringDate["$h"||(pStringDate["$H") {
			s %Date=""
			x "s %Date="_pStringDate
			s pStringDate=%Date
		}
		i pStringDate?1n.n s date=$zd(pStringDate,3) q
		i pStringDate["." s date=$p(pStringDate,".",3)_"-"_$p(pStringDate,".",2)_"-"_$p(pStringDate,".",1)
		i pStringDate["-" s date=pStringDate q
		i pStringDate["/" s date=..AddZerro($p(pStringDate,"/",3))_"-"_..AddZerro($p(pStringDate,"/",1))_"-"_..AddZerro($p(pStringDate,"/",2))
	} catch e {}
	q $g(date)_$s($g(date)'=""&&(time'=""):" "_time,1:"")
]]></Implementation>
</Method>

<Method name="getYYYYMMDD">
<Description>
Translate the date to the format YYYY-MM-DD FORMAT=3
w ##class(App.type).getYYYYMMDD(+$h)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pStringDate:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	try {
		i pStringDate?1n.n s date=$zd(pStringDate,3) q
		i pStringDate["." s date=$p(pStringDate,".",3)_"-"_$p(pStringDate,".",2)_"-"_$p(pStringDate,".",1)
		i pStringDate["-" s date=pStringDate q
		i pStringDate["/" s date=..AddZerro($p(pStringDate,"/",3))_"-"_..AddZerro($p(pStringDate,"/",1))_"-"_..AddZerro($p(pStringDate,"/",2))
	} catch e {}
	q $g(date)
]]></Implementation>
</Method>

<Method name="AddZerro">
<ClassMethod>1</ClassMethod>
<FormalSpec>m:%String</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if $l(m)=1 q "0"_m
	q m
]]></Implementation>
</Method>

<Method name="InterpretCurrentDay">
<Description><![CDATA[
Interpreterpath string with the current date type
Str= DateFrom=(CurrentDay-2)&DateTo=(CurrentDay-1)
The result of the computed expression value "added?DateFrom=06.06.2018&DateTo=07.06.2018"
w ##class(App.type).InterpretCurrentDay("added?DateFrom=(CurrentDay-2)&DateTo=(CurrentDay-1)",.res)]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Str:%String,Result:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	#dim tSC As %Status = $$$OK
	#dim e As %Exception.AbstractException
	
	s exp=$p(Str,"?",2)
	q:exp="" "0"
	s exp="s "_$replace(exp,"CurrentDay",+$h)
	s exp=$replace(exp,"&DateTo",",%tempTo")
	s exp=$replace(exp,"DateFrom","%tempFrom")
	try {
		x exp
		s Result=$p(Str,"?",1)_"?DateFrom="_$tr($zd(%tempFrom,4),"/",".")_"&DateTo="_$tr($zd(%tempTo,4),"/",".")
		k %tempFrom,%tempTo
	} Catch e {
		Set tSC=e.AsStatus()
	}
	q tSC
]]></Implementation>
</Method>

<Method name="ParseURL">
<Description><![CDATA[
Parse a string of CGI variable 
w ##class(App.type).ParseURL("aaa=111&bbb=222")]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[str:%String,&out,del="&"]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	f i=1:1:$l(str,del) {
		continue:$p(str,del,i)=""
		continue:$p($p(str,del,i),"=")=""
		s out($p($p(str,del,i),"="))=$p($p(str,del,i),"=",2)
	}
]]></Implementation>
</Method>

<Method name="UploadFilesJS">
<Description>
Output the js code to select a file in a new window and download it to the server
##class(App.type).UploadFilesJS(%id)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>id,%id</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	s onclick="win=window.open('App.UploadCSP.cls?idreturn="_id_"&ServerDirPath="_$zconvert($g(%id("filesStore")),"O","URL")_"', 'winupload', 'location=no,left=200,top=300,width=800,height=300,scrollbars=no,status=no,toolbar=no,menubar=no');"
	q $$$appButton("appButtonUpload"_id,"onclick="""_$g(onclick)_"""",$$$aText("Download file",""))
]]></Implementation>
</Method>

<Method name="GetTableName">
<Description>
To obtain the table name from the Class
w ##class(App.type).GetTableName("App.sss.user")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>SelectClass</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set (tab,table)=$p(SelectClass,".",*)
	//If the table name is the key words, frame it in quotation marks
	set:$SYSTEM.SQL.IsReservedWord(table) table = """"_table_""""
	set tab=$tr($p(SelectClass,"."_tab,1),".","_")_"."_table
	q tab
]]></Implementation>
</Method>

<Method name="GetValidNumeric">
<Description>
The number to the normal mind
w ##class(App.type).GetValidNumeric("14,650.00")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>price</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	i price[","&&(price[".") s price=$tr(price,",")
	i price["," s price=$tr(price,",",".")
	q $tr(price," "_$c(160)) ;remove the spaces
]]></Implementation>
</Method>
</Class>
</Export>
